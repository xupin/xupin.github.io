[{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - Spineæ¢è£…","date":"2024-05-09T16:00:00.000Z","path":"2024/05/10/game-spine-change-attach/","text":"å‰è¨€æƒ³ç»™å°æ¸¸æˆåšä¸ªæ—¶è£…åŠŸèƒ½ï¼Œåœ¨æ¸¸æˆä¸­ä¸€èˆ¬æ¥è¯´æ¢è£…åˆ†ä¸ºä¸¤ç§ï¼š æ•´ä½“æ—¶è£… å±€éƒ¨æ¢è£… 2D æ¸¸æˆä¸­ä¸€èˆ¬ç”¨åˆ°çš„éª¨éª¼åŠ¨ç”» Spine å’Œ DragonBone(é¾™éª¨)ã€‚è¿™é‡Œä¸»è¦å­¦ä¹ ä¸€ä¸‹ Spine æ¢è£…çš„ç›¸å…³å®ç° SpineSpine æ˜¯ä¸€å¥—é’ˆå¯¹ 2D éª¨éª¼åŠ¨ç”»ç¼–è¾‘å·¥å…·ï¼Œæœ€ç»ˆå¯¼å‡ºçš„åŠ¨ç”»æ–‡ä»¶ç»“æ„: .png æ–‡ä»¶ éª¨éª¼è´´å›¾é›†åˆ atlas éª¨éª¼æ–‡ä»¶ä¿¡æ¯ json éª¨éª¼åŠ¨ç”»ä¿¡æ¯ ä½¿ç”¨æ—¶åˆ›å»º sp.Skeleton ç»„ä»¶ï¼Œå¯¼å…¥åŠ¨ç”»æ–‡ä»¶å³å¯ã€‚ Spine åŠ¨ç”»ä¿¡æ¯åˆåˆ†ä¸ºï¼šbone -&gt; slot -&gt; attach è¿™æ ·çš„ç»“æ„ï¼Œå…¶ä¸­ attach å¯ä»¥å’Œè´´å›¾ç”»ä¸Šç­‰å·ã€‚ æ•´ä½“æ—¶è£…è¿™ç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œ2 ç§åšæ³•ï¼š Spine åŠ¨ç”»ä¸­åˆ›å»ºçš®è‚¤ï¼Œé€šè¿‡ api setSkin æ¥è®¾ç½®å³å¯ã€‚ æ—¶è£…ç‹¬ç«‹å¯¼å‡ºåŠ¨ç”»ï¼Œä»£ç ç›´æ¥æ›¿æ¢æ–°çš„ sp.SkeletonData å±€éƒ¨æ—¶è£…å±€éƒ¨æ¢è£…ç›¸æ¯”è¾ƒæ•´ä½“æ—¶è£…ï¼Œç¨å¾®éº»çƒ¦ä¸€äº›ï¼Œä¹Ÿæœ‰ 2 ç§åšæ³•ï¼š ç”ŸæˆæŒ‚ç‚¹ Cocos å®˜æ–¹ spine æ‰©å±• AttachUtil.js 12345678910111213141516171819202122232425262728293031323334353637383940414243444546/** * !#en Traverse all bones to generate the minimum node tree containing the given bone names, NOTE that make sure the skeleton has initialized before calling this interface. * !#zh éå†æ‰€æœ‰æ’æ§½ï¼Œç”ŸæˆåŒ…å«æ‰€æœ‰ç»™å®šæ’æ§½åç§°çš„æœ€å°èŠ‚ç‚¹æ ‘ï¼Œæ³¨æ„ï¼Œè°ƒç”¨è¯¥æ¥å£å‰è¯·ç¡®ä¿éª¨éª¼åŠ¨ç”»å·²ç»åˆå§‹åŒ–å¥½ã€‚ * @method generateAttachedNodes * @param &#123;String&#125; boneName * @return &#123;Node[]&#125; attached node array */generateAttachedNodes (boneName) &#123; let targetNodes = []; if (!this._inited) return targetNodes; let rootNode = this._prepareAttachNode(); if (!rootNode) return targetNodes; let res = []; let bones = this._skeleton.bones; for (let i = 0, n = bones.length; i &lt; n; i++) &#123; let bone = bones[i]; let boneData = bone.data; if (boneData.name == boneName) &#123; res.push(bone); &#125; &#125; let buildBoneTree = function (bone) &#123; if (!bone) return; let boneData = bone.data; let boneNode = this._getNodeByBoneIndex(boneData.index); if (boneNode) return boneNode; boneNode = this._buildBoneAttachedNode(bone, boneData.index); let parentBoneNode = buildBoneTree(bone.parent) || rootNode; boneNode.parent = parentBoneNode; return boneNode; &#125;.bind(this); for (let i = 0, n = res.length; i &lt; n; i++) &#123; let targetNode = buildBoneTree(res[i]); targetNodes.push(targetNode); &#125; this._sortNodeArray(); return targetNodes;&#125;, ä½¿ç”¨ç¤ºä¾‹ 123456789101112131415161718192021const skel: sp.Skeleton = this.skelNode.getComponent(sp.Skeleton);skel.animation = &quot;idle&quot;;skel.loop = true;// @ts-ignorelet attachUtil = skel.attachUtil;attachUtil.generateAllAttachedNodes();let node = new cc.Node();cc.resources.load&lt;cc.SpriteFrame&gt;(`icon/icon_dayanta`, cc.SpriteFrame, (e: Error, asset: cc.SpriteFrame) =&gt; &#123; if (e) &#123; cc.error(e); return; &#125; let sprite = node.addComponent(cc.Sprite); sprite.spriteFrame = asset; let bones = attachUtil.getAttachedNodes(&quot;jiuhu_3&quot;); bones[0].destroyAllChildren(); bones[0].addChild(node);&#125;); æ›¿æ¢ attach 1234567891011121314151617181920212223242526272829function updateRegion(attach: sp.spine.RegionAttachment | sp.spine.MeshAttachment, tex2d: cc.Texture2D) &#123; // @ts-ignore const skeTexture = new sp.SkeletonTexture(&#123; width: tex2d.width, height: tex2d.height &#125; as ImageBitmap); skeTexture.setRealTexture(tex2d); const region: sp.spine.TextureAtlasRegion = attach.region as sp.spine.TextureAtlasRegion; region.width = tex2d.width; region.height = tex2d.height; region.originalWidth = tex2d.width; region.originalHeight = tex2d.height; region.rotate = false; region.u = 0; region.v = 0; region.u2 = 1; region.v2 = 1; region.texture = skeTexture; region.renderObject = region; attach.region = region; attach.width = tex2d.width; attach.height = tex2d.height; if (attach instanceof sp.spine.MeshAttachment) &#123; attach.updateUVs(); &#125; else &#123; attach.setRegion(region); attach.updateOffset(); &#125;&#125; ä½¿ç”¨ç¤ºä¾‹ 12345678910111213141516171819function async updateAttach(skel: sp.Skeleton, slotName: string, texture2d: cc.Texture2D) &#123; this.deepCopy(skel); const slot: sp.spine.Slot = skel!.findSlot(slotName); if (!slot) &#123; cc.error(&quot;findSlot is null&quot;); return; &#125; const attach: sp.spine.RegionAttachment | sp.spine.MeshAttachment = slot.getAttachment() as sp.spine.RegionAttachment | sp.spine.MeshAttachment; if (attach === null) &#123; cc.error(&quot;getAttachment is null&quot;); return; &#125; // @ts-ignore skel.updateRegion(attach, texture2d); skel.invalidAnimationCache();&#125; æ›¿æ¢ç´ æåŠæ•ˆæœ: æœ€åDemospine-change-attach","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"},{"name":"spine","slug":"spine","permalink":"http://xupin.im/tags/spine/"}]},{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - NPCéšæœºåç§°","date":"2024-04-08T16:00:00.000Z","path":"2024/04/09/game-task-opt/","text":"å‰è¨€å› ä¸ºä¹‹å‰è®¾è®¡çš„ç³»ç»Ÿå¾ˆç²—ç³™ï¼Œä»»åŠ¡çœ‹èµ·æ¥å¾ˆå•è°ƒï¼Œæ¯”å¦‚ NPC åç§°éƒ½æ˜¯ä¸€æˆä¸å˜çš„ï¼Œæ‰€ä»¥è¿›è¡Œä¸€äº›å°æ”¹åŠ¨ã€‚ æ€è·¯æ€è·¯å¾ˆç®€å•ï¼Œé¢„è®¾å­—å…¸åº“éšæœºåˆ†é…åç§°ã€‚ åå­—ç»„æˆå­—å…¸ 12345&#123; &quot;ç”·å¼Ÿå­&quot;: [&quot;å¼Ÿå­å§“&quot;, &quot;å¼Ÿå­ç”·å&quot;], &quot;å¥³å¼Ÿå­&quot;: [&quot;å¼Ÿå­å§“&quot;, &quot;å¼Ÿå­å¥³å&quot;], &quot;å¼Ÿå­&quot;: [&quot;å¼Ÿå­ç”·å&quot;, &quot;å¼Ÿå­å§“&quot;, &quot;å¼Ÿå­å¥³å&quot;]&#125; åå­—å­—å…¸ 12345&#123; &quot;å¼Ÿå­å§“&quot;: [&quot;é¦–å¸­&quot;, &quot;ç‰›é€¼&quot;, &quot;æ¨Š&quot;, &quot;èƒ¡&quot;, &quot;å‡Œ&quot;, &quot;éœ&quot;, &quot;ä¸‡&quot;, &quot;æŸ¯&quot;, &quot;åº”&quot;, &quot;å®—&quot;, &quot;å•&quot;, &quot;é™ˆ&quot;, &quot;æˆ&quot;, &quot;ç”„&quot;], &quot;å¼Ÿå­å¥³å&quot;: [&quot;å‰ç«¯&quot;, &quot;æµ‹è¯•&quot;, &quot;äº§å“&quot;, &quot;æ¢…æ¢…&quot;, &quot;æ¸…æ—¶&quot;, &quot;å«£ç„¶&quot;, &quot;ç¢§å½¤&quot;, &quot;ä¹‹æ¡ƒ&quot;, &quot;è‹¥å…°&quot;, &quot;æ—§é›¨&quot;], &quot;å¼Ÿå­ç”·å&quot;: [&quot;æ¥è™&quot;, &quot;å®¶é¡º&quot;, &quot;é“å“¥&quot;, &quot;é•¿æ “&quot;, &quot;åˆ€ç–¤&quot;, &quot;éº»å­&quot;, &quot;ç«‹å±±&quot;, &quot;è€€ç¥–&quot;, &quot;æ¥ç¦&quot;, &quot;æ˜¥å–œ&quot;, &quot;é“æŸ±&quot;]&#125; å®ç°å®ç°èµ·æ¥è¿‡äºç®€å•ï¼Œç›´æ¥ä¸Šä»£ç  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667type randomNameMgr struct &#123; names map[string][]string rand *rand.Rand&#125;var ( once sync.Once RandomNameMgr *randomNameMgr)func Load() &#123; once.Do(func() &#123; mgr := &amp;randomNameMgr&#123; names: make(map[string][]string, 0), rand: rand.New(rand.NewSource(time.Now().Unix())), &#125; var ( types, parts map[string][]string ) if err := parseJSONFile(&quot;random_types&quot;, &amp;types); err != nil &#123; panic(err) &#125; if err := parseJSONFile(&quot;random_parts&quot;, &amp;parts); err != nil &#123; panic(err) &#125; for t, partKs := range types &#123; var compose [][]string for _, partK := range partKs &#123; part, ok := parts[partK] if !ok &#123; continue &#125; compose = append(compose, part) &#125; // æ’åˆ—ç»„åˆ list := utils.Product(compose) for _, v := range list &#123; mgr.names[t] = append(mgr.names[t], strings.Join(v, &quot;&quot;)) &#125; &#125; RandomNameMgr = mgr &#125;)&#125;func (r *randomNameMgr) GetRandomName(t string) string &#123; names, ok := r.names[t] if !ok &#123; return t &#125; l := len(names) if l == 0 &#123; return t &#125; return names[r.rand.Intn(l)]&#125;func parseJSONFile(file string, v any) (err error) &#123; if !strings.Contains(file, &quot;.json&quot;) &#123; file += &quot;.json&quot; &#125; bytes, err := os.ReadFile(&quot;./config/data/&quot; + file) if err != nil &#123; return &#125; err = json.Unmarshal(bytes, &amp;v) return&#125; 123456789101112131415func main() &#123; config.Load() fmt.Println(time.Now().Unix()) for i := 1; i &lt;= 5; i++ &#123; name := config.RandomNameMgr.GetRandomName(&quot;å¥³å¼Ÿå­&quot;) fmt.Println(name) // é¦–å¸­å‰ç«¯ // ç‰›é€¼æµ‹è¯• // å¸­å«£ç„¶ // ç”„æ¢…æ¢… // é¦–å¸­äº§å“ &#125; fmt.Println(time.Now().Unix())&#125;","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"}]},{"title":"é€†å‘å­¦ä¹ ç¬”è®° - Cocos2d Luaé€†å‘æå–èµ„æº","date":"2024-04-07T16:00:00.000Z","path":"2024/04/08/reverse-cocos2dlua/","text":"è®°ä¸€æ¬¡åŠåŠå­é€†å‘å·¥ç¨‹çš„â€¦è‰°éš¾è¿‡ç¨‹ å‰è¨€åœ¨æå°æ¸¸æˆçš„è¿‡ç¨‹ä¸­éœ€è¦ä¸€äº›ç¾æœ¯èµ„æºï¼Œä»ç½‘ä¸Šè´­ä¹°äº†ä¸€äº›ä¸æ˜¯å¾ˆæ»¡æ„ï¼Œæ‰€ä»¥å‡†å¤‡å¯¹å‡ ä¸ªç²¾å“åŒç±»æ‰‹æ¸¸ä¸‹æ‰‹ï¼Œæä¸€æ‰‹ç¾æœ¯èµ„æºã€‚ ä¸‹æ‰‹ä¸€ä¸ªæŸå¤§è¯ç§æœæ‰‹æ¸¸ï¼Œè§£å‹å®‰è£…åŒ…ï¼š 123456789101112131415â”œâ”€â”€ AndroidManifest.xmlâ”œâ”€â”€ META-INFâ”‚ â”œâ”€â”€ MANIFEST.MFâ”‚ â”œâ”€â”€ SAMPLE.RSAâ”‚ â””â”€â”€ SAMPLE.SFâ”œâ”€â”€ assetsâ”‚ â””â”€â”€ resâ”œâ”€â”€ classes.dexâ”œâ”€â”€ libâ”‚ â”œâ”€â”€ arm64-v8aâ”‚ â”œâ”€â”€ armeabi-v7aâ”‚ â””â”€â”€ x86â”œâ”€â”€ resâ”‚ â””â”€â”€ ...â””â”€â”€ resources.arsc æ‰“å¼€ lib ç›®å½•ï¼Œä¸‹é¢ä¸‰ä¸ªç›®å½•å¯¹åº”ä¸åŒ CPU æ¶æ„ã€‚ arm64-v8aç¬¬ 8 ä»£ 64 ä½ ARM å¤„ç†å™¨ï¼Œæ˜¯ä»¥åçš„æ¶æ„çš„è¶‹åŠ¿ã€‚ armeabiv-v7aç¬¬ 7 ä»£åŠä»¥ä¸Šçš„ ARM å¤„ç†å™¨ï¼Œç›®å‰æ˜¯ä¸»æµæ¶æ„ã€‚ x86 &#x2F; x86_6432 ä½æ¶æ„ï¼Œæ¨¡æ‹Ÿå™¨ç”¨çš„æ¯”è¾ƒå¤š 123456â”œâ”€â”€ arm64-v8aâ”‚ â””â”€â”€ libcocos2dlua.soâ”œâ”€â”€ armeabi-v7aâ”‚ â””â”€â”€ libcocos2dlua.soâ””â”€â”€ x86 â””â”€â”€ libcocos2dlua.so é€šè¿‡libcocos2dlua.soå¯ä»¥ç¡®å®šæ¸¸æˆå¼•æ“æ˜¯ Cocos2d-Lua ã€‚ å¦‚æœæœ‰libmono.so,libil2cpp.soç­‰æ–‡ä»¶ï¼Œåˆ™å¯èƒ½æ˜¯ Unity ã€‚ res ç›®å½•ä¸€èˆ¬æ˜¯ Android å·¥ç¨‹çš„ Iconã€Logo ç­‰æ–‡ä»¶ï¼ˆå¿½ç•¥ï¼‰ã€‚assets&#x2F;res æ˜¯æˆ‘ä»¬è¦æ‰¾çš„èµ„æºç›®å½•ï¼Œéšä¾¿æŒ‘ä¸€å¼ å›¾ç‰‡æ–‡ä»¶æ‰“å¼€æ˜¯è¿™æ ·çš„ï¼š é€šè¿‡æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å†…å®¹æ˜¯è¿™æ ·çš„ï¼š æ‰“å¼€å¤šä¸ªæ–‡ä»¶å‘ç°å¤´éƒ½æ˜¯sm!fd9%3nX4@è¿™å‡ ä¸ªå­—ç¬¦ï¼ŒåŸºæœ¬ç¡®å®šæ˜¯ XXTEA ç®—æ³•ï¼ˆè¿™æ˜¯ Signï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ° Key å°±å¯ä»¥è¿›è¡Œè§£å¯†èµ„æºï¼‰ã€‚ åˆ†æé€šè¿‡ IDA å·¥å…·è¿›è¡Œåˆ†æï¼Œæ‹–å…¥ libcocos2dlua.so ç­‰å¾…åˆ†æå®Œæˆã€‚ ç‚¹å‡» View-&gt;Open Subviews-&gt;Stringsï¼ŒCTRL + F æœç´¢sm!fd9%3nX4@ï¼Œå¦‚æœèƒ½å¤Ÿæœåˆ°å°±æœ€ç®€å•ï¼ŒåŒå‡»sm!fd9%3nX4@è¿›å…¥ Hex View é¡µé¢èƒ½çœ‹åˆ° Key å°±åœ¨é™„è¿‘ã€‚ å¦‚æœæ²¡æœ‰æœç´¢åˆ°ï¼Œé‡æ–°æœç´¢xxteaï¼Œåˆ—è¡¨ä¸­_Z13xxtea_encryptPhjS_jPjã€_Z13xxtea_decryptPhjS_jPjè¿™ä¿©å°±æ˜¯ xxtea åŠ è§£å¯†çš„å‡½æ•°ã€‚ é€†å‘æ–¹æ¡ˆç¡®å®šæ˜¯ XXTEA ç®—æ³•ä¹‹åï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥è·å– Key IDA åŠ¨æ€è°ƒè¯•é™„åŠ è¿›ç¨‹è¿›è¡Œæ–­ç‚¹è°ƒè¯•è·å– Fridaæ³¨å…¥ Hook è„šæœ¬è·å– ä¸¤ç§æ–¹å¼æµç¨‹å¤§è‡´ç›¸åŒï¼Œå…¶åŸç†éƒ½æ˜¯æ³¨å…¥ç¨‹åºè¯»å–å†…å­˜ä¹‹åé€šè¿‡ç«¯å£è¿›è¡Œè½¬å‘ï¼Œä½†æ˜¯ Frida Hook ç›¸æ¯”è¾ƒå®¹æ˜“ä¸€äº›ã€‚ å‡†å¤‡å·¥ä½œï¼š å®‰å“è®¾å¤‡ &#x2F; æ¨¡æ‹Ÿå™¨ï¼ˆæœ¬æ–‡ä½¿ç”¨çš„ Mumu æ¨¡æ‹Ÿå™¨ï¼‰ æ¸¸æˆå®‰è£…åŒ…ï¼ˆéœ€è¦å¼€å¯ debug æ¨¡å¼ï¼‰ å…¶ä»– IDA åŠ¨æ€è°ƒè¯•ï¼šJava 1.8ã€Android SDKã€Android Device Monitor Frida Hookï¼šPython Frida Hook å®‰è£… Frida ç¯å¢ƒ 1234$ pip3 install frida$ pip3 install frida-tools$ frida --version16.2.1 ä¸‹è½½ Frida Server https://github.com/frida/frida/releases frida-server-16.2.1-linux-x86_64.xz æ¨¡æ‹Ÿå™¨å¼€å¯ root æƒé™ï¼Œæ‰“å¼€ USB è°ƒè¯•æ¨¡å¼ã€‚ 12345$ cd /Applications/NemuPlayer.app/Contents/MacOS$ ./adb push /Users/mark/Downloads/frida-server-16.2.1-android-x86_64 /data/adb/frida-server-16.2.1$ ./adb forward tcp:27042 tcp:27042$ ./adb root # å¼€å¯rootæƒé™$ ./adb shell # è¿›å…¥æ¨¡æ‹Ÿå™¨ adb shell æŸ¥çœ‹æ¸¸æˆåŒ…å 12345678# cd /data/app# ls -acode_cachecom.mumu.acc-1com.mumu.launcher-1com.mumu.store-1com.netease.mumu.cloner-1www.cocos.game-1 # è¿™æ˜¯æˆ‘ä»¬è¦æ‰¾çš„æ¸¸æˆ å¯åŠ¨ Frida Server 123# cd /data/adb# chmod +x ./frida-server-16.2.1# nohup ./frida-server-16.2.1 &amp; æµ‹è¯•æœåŠ¡ 1234567891011$ frida-ps -U 268 adbd 976 android.process.acore1069 android.process.media1224 com.android.keychain1247 com.android.providers.calendar 763 com.android.systemui 287 debuggerd 288 debuggerd64 290 drmserver1360 frida-server-16.2.1 # è¯´æ˜æ³¨å…¥ç¨‹åºä¹ŸæˆåŠŸå¯åŠ¨ è¿è¡Œ Hook è„šæœ¬ 123456789101112const libName = &quot;libcocos2dlua.so&quot;;const funcName = &quot;_Z13xxtea_decryptPhjS_jPj&quot;;const ptr = Module.findExportByName(libName, funcName);if (!ptr) &#123; return;&#125;Interceptor.attach(ptr, &#123; onEnter: function (args) &#123; console.log(&quot;Key:&quot;, args[2].readCString(16)); // è¿™é‡Œä¸ºä»€ä¹ˆå–ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå¦ä¸€ç§IDAæ–¹å¼ä¼šæœ‰è§£é‡Šã€‚ &#125;, onLeave: function (retval) &#123;&#125;,&#125;); 1234567891011121314151617181920212223$ frida -U -f www.cocos.game -l ./key.js ____ / _ | Frida 16.2.1 - A world-class dynamic instrumentation toolkit | (_| | &gt; _ | Commands: /_/ |_| help -&gt; Displays the help system . . . . object? -&gt; Display information about &#x27;object&#x27; . . . . exit/quit -&gt; Exit . . . . . . . . More info at https://frida.re/docs/home/ . . . . . . . . Connected to Android Emulator 5554 (id=emulator-5554)Spawned `www.cocos.game`. Resuming main thread![Android Emulator 5554::www.cocos.game ]-&gt; Key: gb4sZzoV/fP2P)t3Key: gb4sZzoV/fP2P)t3Key: gb4sZzoV/fP2P)t3Key: gb4sZzoV/fP2P)t3Key: gb4sZzoV/fP2P)t3...Process terminated[Android Emulator 5554::www.cocos.game ]-&gt;Thank you for using Frida! gb4sZzoV/fP2P)t3 è¿™ä¸ªå°±æ˜¯ XXTEA ç®—æ³•çš„ Keyã€‚ IDA åŠ¨æ€è°ƒè¯•æœ‰æ—¶é—´è¡¥å……è¿›æ¥ è§£å¯†èµ„æºCocos2d-x å…³äº XXTEA çš„ Lua èµ„æºè§£å¯†æµç¨‹ CCLuaStack.cpp 123456789101112131415161718192021222324252627282930int LuaStack::luaLoadBuffer(lua_State *L, const char *chunk, int chunkSize, const char *chunkName)&#123; int r = 0; if (_xxteaEnabled &amp;&amp; strncmp(chunk, _xxteaSign, _xxteaSignLen) == 0) &#123; // decrypt XXTEA xxtea_long len = 0; unsigned char* result = xxtea_decrypt((unsigned char*)chunk + _xxteaSignLen, (xxtea_long)chunkSize - _xxteaSignLen, (unsigned char*)_xxteaKey, (xxtea_long)_xxteaKeyLen, &amp;len); unsigned char* content = result; xxtea_long contentSize = len; skipBOM((const char*&amp;)content, (int&amp;)contentSize); r = luaL_loadbuffer(L, (char*)content, contentSize, chunkName); free(result); &#125; else &#123; skipBOM(chunk, chunkSize); r = luaL_loadbuffer(L, chunk, chunkSize, chunkName); &#125;#if defined(COCOS2D_DEBUG) &amp;&amp; COCOS2D_DEBUG &gt; 0 // ...#endif return r;&#125; æ ¹æ®é€»è¾‘å¯ä»¥æ¨å‡ºï¼Œæ ¹æ®åŠ å¯†èµ„æºå¤´éƒ¨ Sign æ¥ç¡®å®šæ˜¯å¦ XXTEA åŠ å¯†ï¼Œè§£å¯†æ—¶æŠŠ Sign å¿½ç•¥ã€‚å®ç°å¦‚ä¸‹ï¼š 12345678910sign := &quot;sm!fd9%3nX4@&quot;key := &quot;gb4sZzoV/fP2P)t3&quot;bs, err := os.ReadFile(&quot;/Users/mark/Downloads/aaa/assets/res/9325.png&quot;)if err != nil &#123; panic(err)&#125;bs = bs[len(sign):]nBs := xxtea.Decrypt(bs, key)os.WriteFile(&quot;/Users/mark/Downloads/aaa/assets/res/9325_decry.png&quot;, nBs, os.ModePerm) æœ€åç¤ºä¾‹ä»£ç ï¼šcocos2d-reverse Q&amp;A adb shell æç¤º error: no devices&#x2F;emulators found 12$ ./adb kill-server$ ./adb start-server","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"reverse engineering","slug":"reverse-engineering","permalink":"http://xupin.im/tags/reverse-engineering/"}]},{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - æœåŠ¡å™¨ä¸åœæœºæ›´æ–°","date":"2024-01-28T16:00:00.000Z","path":"2024/01/29/game-server-reload/","text":"ç®€å•å®ç°æœåŠ¡å™¨ä¸åœæœºæ›´æ–°çš„æœºåˆ¶ å‰è¨€ä¹‹å‰æ¥è§¦è¿‡æŸ moba æ¸¸æˆï¼Œé™¤äº†å…¶ä¸°å¯Œçš„æ¸¸æˆå†…å®¹ä¹‹å¤–ï¼Œå¯¹å…¶æœåŠ¡å™¨æ›´æ–°æœºåˆ¶éå¸¸å¥½å¥‡ã€‚ä»–ä»¬çš„æœåŠ¡å™¨å¾ˆå°‘è¿›è¡Œåœæœºæ›´æ–°ï¼Œå¤§éƒ¨åˆ†æ˜¯ä¸åœæœºæ›´æ–°å†…å®¹ã€‚è¿™æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ æ€è·¯æœåŠ¡å™¨æ›´æ–°åœºæ™¯ï¼Œä¸€èˆ¬æ˜¯ä¸šåŠ¡ä»£ç è¿­ä»£æˆ–è€…é…ç½®è¡¨éœ€è¦é‡è½½ã€‚moba æ¸¸æˆä¸€èˆ¬æ˜¯ä¸€ä¸ªæœåŠ¡å™¨æ‰¿è½½ 1 æˆ–å¤šä¸ªæˆ¿é—´ï¼Œæ‰€ä»¥çƒ­æ›´æ–°æœºåˆ¶æœ‰å¯èƒ½æ˜¯è¿™æ ·ä¸€ä¸ªè®¾è®¡ï¼š æ­£åœ¨ä½¿ç”¨çš„æœåŠ¡å™¨ å…ˆåœæ­¢æ¥æ”¶æ–°çš„è¯·æ±‚ï¼Œç­‰å¾…å¤„ç†å®Œå·²æœ‰çš„æˆ˜æ–—åé‡å¯ æœªä½¿ç”¨çš„æœåŠ¡å™¨ æœ‰åºé‡å¯ï¼Œé˜²æ­¢æ— æœåŠ¡å™¨å¯ç”¨ å½“ç„¶ï¼Œå®ç°ä¸Šè‚¯å®šä¸æ˜¯è¿™ä¹ˆç®€å•ã€‚å¦‚æœæŒ‰ç…§ä¸Šé¢çš„æ€è·¯æ¥å®ç°ï¼Œæµç¨‹å¦‚ä¸‹ï¼š ç›‘å¬çƒ­æ›´æ–°çš„ä¿¡å·ã€‚ æ”¶åˆ°çƒ­æ›´æ–°çš„ä¿¡å·ï¼Œåˆ›å»ºæœåŠ¡å™¨å­è¿›ç¨‹ï¼ŒåŒæ—¶æŠŠ Socket æ–‡ä»¶æè¿°ç¬¦ä¼ ï¼ˆfile descriptorï¼‰é€’ç»™å­è¿›ç¨‹ã€‚ å¯åŠ¨æœåŠ¡å™¨å­è¿›ç¨‹ï¼Œå¯åŠ¨æˆåŠŸåå‘é€åœæœºä¿¡å·ç»™çˆ¶è¿›ç¨‹ã€‚ çˆ¶è¿›ç¨‹å¤„ç†å®Œè¯·æ±‚ï¼Œé€€å‡ºã€‚ å®ç°å®šä¹‰æœåŠ¡ 123456type Server struct &#123; http http.Server listener net.Listener pid int conns map[int64]*network.WsConn&#125; æœåŠ¡é€»è¾‘ï¼Œåˆ†åˆ«ç›‘å¬ 3 ä¸ªä¿¡é“ï¼š 2-SIGINT, 15-SIGTERM, 1-SIGHUPï¼Œå¯åŠ¨æœåŠ¡å‰åˆ¤æ–­æ˜¯å¦å­è¿›ç¨‹ï¼Œå¦‚æœæ˜¯å­è¿›ç¨‹åˆ™ä½¿ç”¨çˆ¶è¿›ç¨‹ä¼ é€’è¿›æ¥çš„æ–‡ä»¶æè¿°ç¬¦ç»§ç»­ç›‘å¬ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364func NewServer(addr string) (svr *Server) &#123; svr = &amp;Server&#123; exit: make(chan bool, 1), conns: make(map[string]*network.WsConn, 0), &#125; svr.http.Addr = addr return&#125;func (r *Server) ListenAndServe() &#123; var err error if r.isChild() &#123; // fdé¢„ç•™ï¼š0stdinã€1stdoutã€2stderr f := os.NewFile(3, &quot;&quot;) r.listener, err = net.FileListener(f) &#125; else &#123; r.listener, err = net.Listen(&quot;tcp&quot;, r.http.Addr) &#125; if err != nil &#123; panic(err) &#125; // ç›‘å¬ä¿¡é“ go r.handleSignals() // é€šçŸ¥çˆ¶è¿›ç¨‹é€€å‡º if r.isChild() &#123; syscall.Kill(syscall.Getppid(), syscall.SIGTERM) &#125; // å¯åŠ¨æœåŠ¡ if err = r.http.Serve(r.listener); err != nil &#123; log.Printf(&quot;æœåŠ¡[%d]å¼‚å¸¸ %v&quot;, syscall.Getpid(), err) &#125; select &#123; case &lt;-r.exit: case &lt;-time.After(120 * time.Second): &#125; log.Printf(&quot;æœåŠ¡[%d]å·²å…³é—­&quot;, syscall.Getpid())&#125;// ç›‘å¬ä¿¡é“func (r *Server) handleSignals() &#123; ch := make(chan os.Signal, 1) signal.Notify(ch, syscall.SIGINT, syscall.SIGTERM, syscall.SIGHUP) for &#123; sig := &lt;-ch log.Printf(&quot;æœåŠ¡[%d]æ¥æ”¶ä¿¡å· %v&quot;, syscall.Getpid(), sig) switch sig &#123; case syscall.SIGINT: // å¤–éƒ¨åœæœº r.shutdown() case syscall.SIGTERM: // å­è¿›ç¨‹é€šçŸ¥åœæœº r.shutdown() case syscall.SIGHUP: if err := r.reload(); err != nil &#123; panic(err) &#125; &#125; &#125;&#125;// æ˜¯å¦å­è¿›ç¨‹func (r *Server) isChild() bool &#123; return os.Getenv(&quot;SERVER_RELOAD&quot;) != &quot;&quot;&#125; ä¿¡é“å¤„ç†ï¼Œ2&#x2F;15 ç›´æ¥å…³é—­æœåŠ¡ã€‚å¦‚æœæ˜¯ 1 åˆ™åˆ›å»ºå­è¿›ç¨‹ï¼Œå¹¶æŠŠå½“å‰è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™å­è¿›ç¨‹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455// forkfunc (r *Server) reload() error &#123; listener, ok := r.listener.(*net.TCPListener) if !ok &#123; return errors.New(&quot;listener is not tcp listener&quot;) &#125; f, err := listener.File() if err != nil &#123; return err &#125; cmd := exec.Command(os.Args[0]) cmd.Env = []string&#123; &quot;SERVER_RELOAD=1&quot;, &#125; cmd.Stdout = os.Stdout cmd.Stderr = os.Stderr // æ–‡ä»¶æè¿° cmd.ExtraFiles = []*os.File&#123;f&#125; // æ‰§è¡Œ return cmd.Start()&#125;// åœæœºfunc (r *Server) shutdown() &#123; // å…³é—­ç›‘å¬ r.listener.Close() done := make(chan bool, 1) go func() &#123; for &#123; if len(r.conns) &gt; 0 &#123; continue &#125; break &#125; done &lt;- true &#125;() select &#123; case &lt;-done: log.Printf(&quot;è¿æ¥æ± å·²æ¸…ç©º&quot;) case &lt;-time.After(60 * time.Second): wg := sync.WaitGroup&#123;&#125; for _, conn := range r.conns &#123; wg.Add(1) go func(conn *network.WsConn) &#123; defer wg.Done() conn.Close() &#125;(conn) &#125; wg.Wait() log.Printf(&quot;è¶…æ—¶å…³é—­è¿æ¥&quot;) &#125; // å…³é—­æœåŠ¡ r.http.Close() r.exit &lt;- true&#125; æµ‹è¯•æ•ˆæœç‰ˆæœ¬ 1 æœåŠ¡ç‰ˆæœ¬ 2 æœåŠ¡ å®Œæ•´ç¤ºä¾‹ï¼šserver-hot-update å‚è€ƒGraceful Restart in GolangFlorian von Bock&#x2F;endless","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"}]},{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - æ’è¡Œæ¦œè®¾è®¡","date":"2024-01-02T16:00:00.000Z","path":"2024/01/03/game-rank/","text":"å¤§éƒ¨åˆ†æ¸¸æˆä¸­éƒ½æœ‰æ’è¡Œæ¦œçš„å­˜åœ¨ï¼Œæ—¢å¯ä»¥å±•ç¤ºç©å®¶åˆ†æ•°ä¹‹é—´çš„æ’åï¼Œä¹Ÿå¯ä»¥ç”¨äºæ¿€å‘ç©å®¶çš„èƒœè´Ÿæ¬²ã€‚ æ€è·¯æ’è¡Œæ¦œçš„è®¾è®¡æ€è·¯æ¯”è¾ƒç²—æš´ï¼Œè°çš„åˆ†æ•°é«˜è°åœ¨å‰ï¼Œåˆ†æ•°ä¸€è‡´è°å…ˆè¾¾æˆè°åœ¨å‰ã€‚å®ç°æ–¹å¼æœ‰å¤šç§ï¼Œè¿™é‡Œåˆ—ä¸¾å¸¸è§çš„2ç§ï¼š æ•°æ®åº“ é€šè¿‡ä»»åŠ¡å®šæ—¶æŸ¥è¯¢æ•°æ®åº“è¿›è¡Œæ’åºï¼Œç„¶åå‚¨å­˜åœ¨å†…å­˜ä¸­ã€‚ä¼˜ç‚¹æ˜¯é€»è¾‘ç®€å•ï¼Œç¼ºç‚¹æ˜¯ä¸èƒ½å®æ—¶æ’åã€‚ Redis ä½¿ç”¨zsetï¼ˆæœ‰åºé›†åˆï¼‰å­˜å‚¨æ•°æ®ï¼Œåˆ©ç”¨scoreå­˜å‚¨ä¸åŒçš„æŒ‡æ ‡æ¥å®ç°å„ç§æ’è¡Œæ¦œã€‚ä¼˜ç‚¹æ˜¯èƒ½å®æ—¶æŸ¥è¯¢ï¼Œç¼ºç‚¹æ˜¯é€»è¾‘ç›¸å¯¹å¤æ‚ã€‚ æ•°æ®åº“1select `id`,`score` from `roles` order by score desc limit 200; -- æŒ‰ç…§scoreæ’åï¼Œå–top200 Redisæ’å…¥&#x2F;æ›´æ–°æ•°æ® zAdd {key} {score float} {member string} 1234&gt; zAdd rank:score 60.5 pp&gt; zAdd rank:score 83 lt&gt; zAdd rank:score 92 wx&gt; zAdd rank:score 81.5 wl æŸ¥è¯¢åˆ—è¡¨ zRevRange {key} {min int} {max int} minå’ŒmaxæŒ‡çš„æ˜¯æ•°æ®ä¸‹æ ‡ï¼Œä»0å¼€å§‹ 12345&gt; zRevRange rank:score 0 -11) &quot;wx&quot;2) &quot;lt&quot;3) &quot;wl&quot;4) &quot;pp&quot; æŸ¥è¯¢æ’å zRevRank {key} {member string} 12&gt; zRevRank rank:score pp(integer) 3 å®ç°é€»è¾‘12345678910111213141516171819202122232425262728293031323334func setRank(key string, roleId uint32, score float64) &#123; roleIdStr := RoleId2Str(roleId) ctx := context.Background() db.Redis.ZAdd(ctx, key, redis.Z&#123; Score: score, Member: roleIdStr, &#125;)&#125;func getRankList(key string) []uint32 &#123; ctx := context.Background() // TODO æ’è¡Œæ¦œåªä¿ç•™å‰200å i := db.Redis.ZCard(ctx, key) if l := i.Val(); l &gt; enums.RANK_MAX_NUM &#123; db.Redis.ZRemRangeByRank(ctx, key, 0, l-enums.RANK_MAX_NUM-1) &#125; s := db.Redis.ZRevRange(ctx, key, 0, -1) roleIds := make([]uint32, 0) for _, v := range s.Val() &#123; roleIds = append(roleIds, Str2RoleId(v)) &#125; return roleIds&#125;func getMyRank(key string, roleId uint32) uint32 &#123; roleIdStr := RoleId2Str(roleId) ctx := context.Background() s := db.Redis.ZRevRank(ctx, key, roleIdStr) if s.Val() &gt;= enums.RANK_MAX_NUM &#123; return 0 &#125; // TODO ä¸‹æ ‡ä»0å¼€å§‹æ‰€ä»¥åŠ 1 return uint32(s.Val() + 1)&#125; æ’è¡Œæ¦œåˆ†é¡µ 12345678910111213141516171819202122232425262728293031func SlicePage(page, pageSize, total int) (s, e int) &#123; if page &lt; 0 &#123; page = 1 &#125; if pageSize &lt; 0 &#123; pageSize = 20 &#125; if pageSize &gt; total &#123; return 0, total &#125; pageMax := int(math.Ceil(float64(total) / float64(pageSize))) if page &gt; pageMax &#123; return 0, 0 &#125; s = (page - 1) * pageSize e = s + pageSize - 1 if e &gt; total &#123; e = total &#125; return s, e&#125;list := []string&#123; &quot;wx&quot;, &quot;lt&quot;, &quot;wl&quot;, &quot;pp&quot;,&#125;page := 1pageSize := 10s, e := helpers.SlicePage(page, pageSize, len(list))fmt.Printf(&quot;%+v \\n&quot;, list[s:e]) è¿™æ ·ä¹Ÿæœ‰ä¸€ä¸ªå¯èƒ½å­˜åœ¨çš„ç“¶é¢ˆé—®é¢˜ï¼Œå½“å•ä¸ªæ’è¡Œæ¦œçš„æ•°æ®é‡è¿‡å¤§æ—¶ä¼šå½±å“æ¯æ¬¡çš„æŸ¥è¯¢æ•ˆç‡ã€‚è¿™é‡Œå¯ä»¥é‡‡ç”¨è·³æ•°ç´¢å¼•çš„æ¦‚å¿µæ¥è¿›è¡Œä¼˜åŒ–ï¼ŒåŸç†å¾ˆç®€å•ã€‚ ç©å®¶æŒ‰ç…§åˆ†æ•°è¿›è¡Œåˆ†keyå­˜å‚¨ï¼Œå³æ¯ä¸ªåˆ†æ•°åŒºé—´éƒ½æœ‰å¯¹åº”çš„keyã€‚ æ¯”å¦‚: key å®šä¹‰ rank:score:100 å°äº100åˆ† rank:score:500 å°äº500åˆ†&amp;å¤§äº100åˆ† rank:score:1000 å°äº1000åˆ†&amp;å¤§äº500åˆ† rank:score:1000more å¤§äº1000åˆ† è¿›è¡Œåˆ†æ®µå­˜å‚¨åï¼Œä¼˜ç‚¹æ˜¯æŸ¥è¯¢ä¸åŒåŒºé—´çš„æ’åæ—¶æ£€ç´¢çš„æ•°æ®é‡æ˜¾è‘—ä¸‹é™ï¼Œç¼ºç‚¹æ˜¯æŸ¥è¯¢é€»è¾‘æ¯”è¾ƒå¤æ‚ã€‚æ¯”å¦‚æŸ¥è¯¢æ’åï¼Œéœ€è¦è®¡ç®—é«˜äºå½“å‰åˆ†æ•°åŒºé—´çš„ç©å®¶æ•°é‡ã€‚ æœ€å2024ï¼Œæ–°çš„ä¸€å¹´ï½ç¥èº«ä½“å¥åº·ã€è´¢æºæ»šæ»šã€ä¸‡äº‹é¡ºå¿ƒã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"}]},{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - é“¾è¡¨ä¼˜åŒ–ï¼ˆå¿«æ…¢æŒ‡é’ˆï¼‰","date":"2023-11-20T16:00:00.000Z","path":"2023/11/21/game-aoi-list-fast/","text":"ä¼˜åŒ–é“¾è¡¨æŸ¥è¯¢æ•ˆç‡ å‰è¨€é“¾è¡¨åœ¨æ“ä½œçš„æ—¶å€™éœ€è¦ä»å¤´èŠ‚ç‚¹éå†åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œå¦‚æœæ•°æ®é‡å¤§æ¯”è¾ƒè€—æ—¶ã€‚å½“é“¾è¡¨åº”ç”¨åœ¨ AOI ç®—æ³•ï¼ˆåå­—é“¾è¡¨ï¼ŒåŒæœ‰åºé“¾è¡¨ï¼‰æ—¶è¿™ä¸ªæ•ˆç‡é—®é¢˜æ›´ä¼šå‡¸æ˜¾ï¼Œæœ€åçš„æƒ…å†µæ˜¯éå† x*y*{v}ä¸ªèŠ‚ç‚¹ã€‚ ä¼˜åŒ–æ–¹æ¡ˆå¸¸è§çš„ 2 ç§ä¼˜åŒ–æ–¹å¼ï¼š å¿«æ…¢é’ˆ åˆ›å»º 2 ä¸ªæŒ‡é’ˆåŒæ—¶æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œå¿«æŒ‡é’ˆç§»åŠ¨æ­¥é•¿å¤§ã€æ…¢æŒ‡é’ˆç§»åŠ¨æ­¥é•¿å°ï¼ŒæŸ¥è¯¢æ—¶é€šè¿‡å¿«æ…¢æŒ‡é’ˆç¡®å®šç›®æ ‡èŠ‚ç‚¹çš„èŒƒå›´ã€‚ è·³è¡¨ é“¾è¡¨æ¯å›ºå®šæ­¥é•¿çš„èŠ‚ç‚¹ä¸ºç´¢å¼•èŠ‚ç‚¹ï¼Œè¿™äº›ç´¢å¼•èŠ‚ç‚¹å†ç»„æˆä¸€ä¸ªç´¢å¼•é“¾è¡¨ï¼ŒæŸ¥è¯¢æ—¶é€šè¿‡ç´¢å¼•é“¾è¡¨ç¡®å®šç›®æ ‡èŠ‚ç‚¹çš„èŒƒå›´ã€‚ åŸç†ç±»ä¼¼ ClickHouse çš„è·³æ•°ç´¢å¼•ï¼Œå¯ä»¥å­˜åœ¨å¤šä¸ªç´¢å¼•é“¾è¡¨ã€‚ å¿«æ…¢é’ˆå‡è®¾ä¸€ä¸ªä»å°åˆ°å¤§çš„æœ‰åºé“¾è¡¨ï¼Œæ£€ç´¢æµç¨‹ åˆ›å»º 2 ä¸ªæŒ‡é’ˆåŒæ—¶æŒ‡å‘å¤´èŠ‚ç‚¹ å¿«æŒ‡é’ˆç§»åŠ¨ä¸€æ¬¡ æ£€æŸ¥ç›®æ ‡èŠ‚ç‚¹å€¼æ˜¯å¦å°äºå¿«æŒ‡é’ˆçš„èŠ‚ç‚¹å€¼ å°äºï¼ŒæŠŠæ…¢æŒ‡é’ˆçš„ä½ç½®ç§»åŠ¨åˆ°å¿«æŒ‡é’ˆçš„ä½ç½®ï¼Œä»æ­¥éª¤ 2 ç»§ç»­æ‰§è¡Œã€‚ å¤§äºï¼Œè¯´æ˜ç›®æ ‡èŠ‚ç‚¹å€¼åœ¨æ…¢æŒ‡é’ˆçš„èŠ‚ç‚¹ä½ç½®å’Œå¿«æŒ‡é’ˆçš„èŠ‚ç‚¹ä½ç½®ä¸­é—´ï¼Œä»æ…¢æŒ‡é’ˆå¼€å§‹éå†ã€‚ å¿«æ…¢é’ˆå®ç°ç®€å•ï¼Œä¸”ä¸éœ€è¦ä¿®æ”¹é“¾è¡¨ç»“æ„ã€‚ä½†æŸ¥è¯¢æ•ˆç‡ä¸å¤Ÿç¨³å®šï¼Œä¸é“¾è¡¨æ•°æ®å¤§å°ã€å¿«æ…¢é’ˆæ­¥é•¿çš„è®¾è®¡æœ‰ä¸€å®šå…³ç³»ã€‚ é“¾è¡¨ç»“æ„ 1234567891011121314151617181920212223type Aoi struct &#123; nodes map[uint32]*node xList *list yList *list visibleRange uint step int&#125;type list struct &#123; head *node tail *node size int&#125;type node struct &#123; Id uint32 xPrev *node xNext *node yPrev *node yNext *node x, y uint player *entity.Player&#125; x è½´æ’å…¥èŠ‚ç‚¹ï¼ˆy è½´é€»è¾‘ä¸€è‡´ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576func (r *Aoi) addX(targetNode *node) &#123; // ç›´æ¥æ’å…¥å°¾éƒ¨ if r.xList.tail.x &lt;= targetNode.x &#123; r.xList.tail.xNext = targetNode targetNode.xPrev = r.xList.tail r.xList.tail = targetNode return &#125; var ( prev *node slow = r.xList.head skip = int(math.Ceil(float64(r.xList.size) / float64(r.step))) ) for i := 0; i &lt; r.step; i++ &#123; // ç§»åŠ¨å¿«æŒ‡é’ˆ fast := r.xFastMove(slow, skip) // å¿«æŒ‡é’ˆçš„åæ ‡å°äºæ’å…¥åæ ‡ï¼Œç§»åŠ¨æ…¢æŒ‡é’ˆè‡³å¿«æŒ‡é’ˆä½ç½® if fast.x &lt; targetNode.x &#123; slow = fast continue &#125; for ; slow != nil; slow = slow.xNext &#123; // æ’å…¥curä¹‹å‰ if slow.x &gt;= targetNode.x &#123; // æ ¹èŠ‚ç‚¹ if slow.xPrev == nil &#123; r.xList.head = targetNode &#125; else &#123; targetNode.xPrev = slow.xPrev // å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ slow.xPrev.xNext = targetNode // æ–°èŠ‚ç‚¹æˆä¸ºå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ &#125; slow.xPrev = targetNode // æ–°èŠ‚ç‚¹ä½œä¸ºå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ targetNode.xNext = slow // å½“å‰èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ break &#125; prev = slow &#125; // æ’å…¥å°¾éƒ¨ if prev != nil &amp;&amp; slow == nil &#123; prev.xNext = targetNode targetNode.xPrev = prev &#125; break &#125;&#125;func (r *AoiMgr) removeX(delNode *aoiNode) &#123; // æ ¹èŠ‚ç‚¹ if delNode.xPrev == nil &#123; if delNode.xNext == nil &#123; r.xList.head = nil &#125; else &#123; r.xList.head = delNode.xNext r.xList.head.xPrev = nil &#125; &#125; else if delNode.xNext == nil &#123; // å°¾èŠ‚ç‚¹ delNode.xPrev.xNext = nil r.xList.tail = delNode.xPrev &#125; else if delNode.xNext != nil &#123; delNode.xPrev.xNext = delNode.xNext delNode.xNext.xPrev = delNode.xPrev &#125; else &#123; delNode.xPrev.xNext = nil &#125; delNode.xPrev, delNode.xNext = nil, nil&#125;func (r *Aoi) xFastMove(cur *node, skip int) *node &#123; for i := 1; i &lt;= skip; i++ &#123; if cur.xNext == nil &#123; break &#125; cur = cur.xNext &#125; return cur&#125;","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"}]},{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - åŒå±äººæ•°è£å‰ª","date":"2023-11-07T16:00:00.000Z","path":"2023/11/08/game-aoi-cut/","text":"ç®€å•ä¼˜åŒ–ä¸‹AOIæ¨¡å— å‰è¨€å½“æ¸¸æˆå¼€å¯æ´»åŠ¨è®©å¤§é‡ç©å®¶èšé›†åœ¨æŒ‡å®šåœ°å›¾èŒƒå›´å†…æ—¶ï¼Œç»™æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¸¦æ¥æœ€ç›´æ¥çš„éº»çƒ¦å°±æ˜¯ï¼š æœåŠ¡å™¨å¸¦å®½å ç”¨ç‡é«˜ å‡è®¾åŒå±æœ‰1000ä¸ªç©å®¶ï¼Œé‚£ä¹ˆä»»æ„ä¸€ä¸ªç©å®¶ç§»åŠ¨ä¸€æ¬¡éœ€è¦åŒæ­¥å…¶ä»–999ä¸ªç©å®¶ã€‚è¿™å¯¼è‡´æœåŠ¡å™¨æ¶ˆæ¯æ•°é‡æŒ‡æ•°çº§å¢é•¿ï¼Œå¸¦å®½æ‰¿å—å‹åŠ›æé«˜ã€‚ å®¢æˆ·ç«¯æ¸²æŸ“å¡é¡¿ å› ä¸ºåŒå±äººæ•°è¶Šå¤šï¼Œå®¢æˆ·ç«¯éœ€è¦æ¸²æŸ“çš„æ¨¡å‹å°±è¶Šå¤šã€‚è¿™æ ·åœ¨ä¸€äº›æ™®é€šçš„ç¡¬ä»¶è®¾å¤‡ä¸‹ä¼šç›´æ¥å¯¼è‡´å¡é¡¿ã€å‘çƒ­ã€‚ æ€è·¯é™¤äº†å‡çº§ç¡¬ä»¶ï¼Œè¿˜å¯ä»¥åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢è¿›è¡Œä¼˜åŒ–: æœåŠ¡å™¨æ§åˆ¶AOIæ¶ˆæ¯é¢‘ç‡ å®¢æˆ·ç«¯è£å‰ªåŒå±äººæ•° å®ç°é€»è¾‘AOIåŒæ­¥è¢«åŠ¨æ¨é€æ”¹æˆä¸»åŠ¨æ¨é€ï¼ŒåŸæ¥çš„è®¾è®¡æ˜¯ç©å®¶ç§»åŠ¨åï¼ˆMoveæ¶ˆæ¯ï¼‰ï¼Œç„¶åå‘è¯¥ç©å®¶æ¨é€å‘¨å›´ç©å®¶çš„ä¿¡æ¯ã€‚æ–°çš„æ–¹å¼æ˜¯åœ°å›¾AOIæ¨¡å—å›ºå®šé¢‘ç‡åŒæ­¥ä¿¡æ¯ï¼ˆæ¯”å¦‚1så‘é€ä¸€æ¬¡ï¼‰ï¼ŒæŠŠéœ€è¦åŒæ­¥çš„ä¿¡æ¯åˆ†ç±»ï¼š ç§»é™¤ ä¸åœ¨è§†é‡èŒƒå›´å†…çš„ç‰©ä½“ï¼Œä¸éœ€è¦æ˜¾ç¤ºåœ¨å±å¹•å†… æ–°å¢ æ–°å¢çš„ç‰©ä½“ï¼Œéœ€è¦æ˜¾ç¤ºåœ¨å±å¹•å†… éœ€è¦æ›´æ–° åŸæ¥åœ¨å±å¹•å†…çš„ç‰©ä½“ï¼Œéœ€è¦æ›´æ–°ä¿¡æ¯ ï¼ˆå¦‚æœåŸæ¥åœ¨å±å¹•å†…çš„ç‰©ä½“ï¼Œä¸éœ€è¦æ›´æ–°ä¿¡æ¯åˆ™ä¸ä¼šå‘é€ï¼‰ åŒæ—¶è®¾ç½®åŒå±äººæ•°ä¸Šé™ï¼Œè¶…è¿‡çš„æ•°é‡è£å‰ªæ‰ã€‚ä¸è¿‡è¿™é‡Œé¢ä¹Ÿæœ‰äº›å‘éœ€è¦æ³¨æ„ï¼Œæ¯”å¦‚ï¼šNPCä¸èƒ½è¢«è£å‰ªã€é˜Ÿå‹ä¸èƒ½è¢«è£å‰ªåŠè¢«è£å‰ªçš„ç‰©ä½“å°½é‡åˆ†æ•£é¿å…â€œç§ƒå¤´â€ã€‚ å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647func (r *Map) Init() &#123; r.aoiMgr = NewAoiMgr(r.config.Cols, r.config.Rows) r.aoiNodes = make(map[uint32]*aoiNode, 0) r.ticker = time.NewTicker(1 * time.Second) // 1s go func() &#123; for &#123; &lt;-r.ticker.C r.Update() &#125; &#125;()&#125;func (r *Map) Update() &#123; for _, node := range r.aoiNodes &#123; if node.Type != enums.LIVING_TYPE_PLAYER &#123; continue &#125; go r.send(node) &#125;&#125;func (r *Map) send(role interfaces.IMapRole) &#123; player := playersvr.Ins.Get(node.MapRole.GetId()) if player == nil &#123; return &#125; // æ‰çº¿æˆ–æˆ˜æ–—ä¸­ä¸åŒæ­¥è§†é‡ if !player.IsOnline() || player.IsInBattle() &#123; return &#125; // å¤„ç†å‘¨å›´èŠ‚ç‚¹ä¿¡æ¯ node.UpdateNodes(r.aoiNodes) // å‘¨å›´èŠ‚ç‚¹ä¿¡æ¯ dels := node.GetLeaveNodes() adds := r.buildMapDatas(node.GetEnterNodes(), true) keeps := r.buildMapDatas(node.GetKeepNodes(), false) if len(adds) == 0 &amp;&amp; len(dels) == 0 &amp;&amp; len(keeps) == 0 &#123; return &#125; bytes, _ := proto.Marshal(&amp;pb.S2C_MapSyncView&#123; Adds: adds, Dels: dels, Keeps: keeps, &#125;) player.Send(enums.Cmd_S2C_MapSyncView, bytes)&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293type aoiNode struct &#123; Id uint32 Name string X int32 Y int32 AoiModel string Type int32 Blink bool MapRole interfaces.IMapRole MaxViewNodes int enterNodes map[uint32]bool keepNodes map[uint32]bool leaveNodes []uint32&#125;func (r *aoiNode) UpdateNodes(nodes map[uint32]*aoiNode) &#123; // è¶…è¿‡æœ€å¤§æ˜¾ç¤ºæ•°é‡ if len(r.enterNodes)+len(r.keepNodes) &lt;= r.MaxViewNodes &#123; return &#125; var ( delNum int delKeep bool ) // ä¼˜å…ˆåˆ¤æ–­keep nodes if l := len(r.keepNodes); l &gt; r.MaxViewNodes &#123; delNum = l - r.MaxViewNodes delKeep = true for id := range r.enterNodes &#123; node, ok := nodes[id] if !ok &#123; delete(r.enterNodes, id) continue &#125; // NPCä¸è£å‰ª if node.Type == enums.LIVING_TYPE_NPC &#123; continue &#125; // é˜Ÿå‹ä¸è£å‰ª if teamId := r.MapRole.GetTeamId(); teamId &gt; 0 &amp;&amp; teamId == node.MapRole.GetTeamId() &#123; continue &#125; delete(r.enterNodes, id) &#125; &#125; else &#123; delNum = len(r.enterNodes) - (r.MaxViewNodes - len(r.keepNodes)) &#125; // æ‰¾å‡ºå¯ä»¥è¢«è£å‡çš„ç‰©ä½“ var ( mayDelIds = make([]uint32, 0) fromNodes = make(map[uint32]bool, 0) ) if delKeep &#123; fromNodes = r.keepNodes &#125; else &#123; fromNodes = r.enterNodes &#125; for id := range fromNodes &#123; node, ok := nodes[id] if !ok &#123; delete(r.enterNodes, id) continue &#125; // NPCä¸è£å‰ª if node.Type == enums.LIVING_TYPE_NPC &#123; continue &#125; // é˜Ÿå‹ä¸è£å‰ª if teamId := r.MapRole.GetTeamId(); teamId &gt; 0 &amp;&amp; teamId == node.MapRole.GetTeamId() &#123; continue &#125; mayDelIds = append(mayDelIds, id) &#125; // å‡åŒ€åˆ é™¤ï¼Œé¿å…é›†ä¸­ if l := len(mayDelIds) - delNum; l &gt;= 0 &#123; // éšæœºä¿ç•™ for i := 0; i &lt; l; i++ &#123; if len(mayDelIds) == 0 &#123; break &#125; randIdx := helpers.Random(len(mayDelIds)) mayDelIds = append(mayDelIds[:randIdx], mayDelIds[randIdx+1:]...) &#125; &#125; for _, id := range mayDelIds &#123; if delKeep &#123; delete(r.keepNodes, id) r.leaveNodes = append(r.leaveNodes, id) &#125; else &#123; delete(r.enterNodes, id) &#125; &#125;&#125;","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"}]},{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - ä»»åŠ¡è®¾è®¡","date":"2023-11-05T16:00:00.000Z","path":"2023/11/06/game-task/","text":"ä¸€ä¸ªç²—ç•¥çš„ä»»åŠ¡ç³»ç»Ÿ å‰è¨€ä¸ºäº†è®©æ¸¸æˆçš„å†…å®¹ä¸°å¯Œèµ·æ¥ï¼ŒåŒæ—¶ä¹Ÿèƒ½è¾…åŠ©æ„å»ºæ¸¸æˆä¸–ç•Œæ‰€å¤„çš„ç¯å¢ƒå’Œä¸–ç•Œè§‚ç­‰ç­‰ï¼Œæ‰€ä»¥å‡†å¤‡ç®€å•çš„å¼€å‘ä¸€ä¸ªä»»åŠ¡ç³»ç»Ÿã€‚ e.g.æ”¯çº¿ä»»åŠ¡ - ç äººä¹°ç“œã€Œå‰å»é•¿å®‰åŸè´­ä¹°ç”˜ç”œå¯å£çš„è¥¿ç“œã€å¥–åŠ±ï¼šè½½å…·*1ã€æ­¦å™¨*1 æˆ‘ï¼šâ€œå“¥ä»¬å„¿ï¼Œè¿™ç“œå¤šå°‘é’±ä¸€æ–¤å‘â€ç“œæ‘Šè€æ¿ï¼šâ€œä¸¤å—é’±ä¸€æ–¤â€æˆ‘ï¼šâ€œç»™æˆ‘æŒ‘ä¸€ä¸ªâ€ç“œæ‘Šè€æ¿ï¼šâ€œè¡Œï¼Œè¿™ä¸ªæ€ä¹ˆæ ·ï¼Ÿâ€ é€‰é¡¹ 1[è¿™ç“œä¿ç†Ÿå—ï¼Ÿ] é€‰é¡¹ 2[ä¸ä¹°äº†] ä»»åŠ¡è®¾è®¡å‚è€ƒäº†ä¸€äº›æˆç†Ÿçš„æ¸¸æˆï¼Œä»»åŠ¡æš‚ä¸”åˆ† 4 ç±»ï¼š ä¸»çº¿ä»»åŠ¡ å‰§æƒ…ä»»åŠ¡ï¼Œé¡ºåºé¢†å– æ—¥å¸¸ä»»åŠ¡ æ¯æ—¥é¢†å–æ¬¡æ•°å‡æœ‰é™åˆ¶ï¼Œéš”å¤©é‡ç½®ã€‚ä¹Ÿå¯ç»†åˆ†ï¼šå¸ˆé—¨ä»»åŠ¡ã€å¸®æ´¾ä»»åŠ¡ã€ç»„é˜Ÿä»»åŠ¡ç­‰ å‘¨å¸¸ä»»åŠ¡ æ¯å‘¨é¢†å–æ¬¡æ•°å‡æœ‰é™åˆ¶ï¼Œéš”å‘¨é‡ç½®ã€‚æ¯”å¦‚ï¼šå‰¯æœ¬ä»»åŠ¡ æ”¯çº¿ä»»åŠ¡ å›ºå®š NPC é¢†å–æˆ–åŒºåŸŸè§¦å‘ æ¯ä¸ªä»»åŠ¡ç”±æœ€å°‘ 1 ä¸ªäº‹ä»¶ï¼ˆstepï¼‰æ„æˆï¼Œäº‹ä»¶çš„è§¦å‘æ–¹å¼ï¼ˆç±»å‹ï¼‰åˆ†ä¸ºï¼š NPC è§¦å‘ ç‚¹å‡» NPC é¢†å–ä»»åŠ¡ï¼Œæ¯”å¦‚ä¸Šé¢çš„ã€Œä¹°ç“œã€ä»»åŠ¡ å‡»æ€è§¦å‘ å‡»æ€æŒ‡å®š NPC é¢†å–ä»»åŠ¡ é“å…·è§¦å‘ ä½¿ç”¨ç‰¹å®šé“å…·é¢†å–ä»»åŠ¡ åŒºåŸŸè§¦å‘ è¿›å…¥æŸä¸ªåæ ‡èŒƒå›´é¢†å–ä»»åŠ¡ æ—¶é—´è§¦å‘ ä»»åŠ¡è¶…æ—¶å¤±è´¥ã€‚æ¯”å¦‚ï¼šé™åˆ¶ 3 åˆ†é’Ÿå†…å®Œæˆã€Œä¹°ç“œã€ä»»åŠ¡ æš‚æ—¶æƒ³åˆ°è¿™ä¹ˆå¤šï¼Œæ–°çš„æƒ³æ³•åé¢å†è¡¥å…… ä»»åŠ¡é…ç½®ç»“æ„å®šä¹‰ã€Œåƒç“œã€è¿™ä¸ªä»»åŠ¡çš„æ•°æ®ç»“æ„ 1234567891011121314151617181920212223// ä»»åŠ¡ç±»åˆ«const ( TASK_KIND_UNKNOWN = iota TASK_KIND_STORY // ä¸»çº¿ TASK_KIND_DAILY // æ—¥å¸¸ TASK_KIND_WEEKLY // å‘¨å¸¸ TASK_KIND_BRANCH_LINE // æ”¯çº¿)// äº‹ä»¶ç±»å‹const ( TASK_EVENT_TYPE_UNKNOWN = iota TASK_EVENT_TYPE_TALK // å¯¹è¯ TASK_EVENT_TYPE_KILL // å‡»æ€)// ä»»åŠ¡å¤±è´¥ç±»å‹const ( TASK_FAIL_EVENT_TYPE_UNKNOWN = iota TASK_FAIL_EVENT_TYPE_DEAD // æ­»äº¡ TASK_FAIL_EVENT_TYPE_TIME // è¶…æ—¶) 1234567891011121314151617181920212223242526272829303132333435363738394041&#123; &quot;id&quot;: 4001, // ä»»åŠ¡ç¼–å· &quot;name&quot;: &quot;æ”¯çº¿ ä¹°ç“œ&quot;, &quot;kind&quot;: 4, // ä»»åŠ¡ç±»åˆ« &quot;limits&quot;: &#123; &quot;name&quot;: &quot;åˆ˜åå¼º&quot; // é™åˆ¶åªèƒ½å«åˆ˜åå¼ºçš„ç©å®¶é¢†å– &#125;, &quot;events&quot;: [ &#123; &quot;type&quot;: 1, // äº‹ä»¶ç±»å‹ &quot;title&quot;: &quot;å‰å»é•¿å®‰åŸè´­ä¹°ç”˜ç”œå¯å£çš„è¥¿ç“œ&quot;, // äº‹ä»¶æ ‡é¢˜ &quot;npc&quot;: 250, // NPCç¼–å· &quot;dialog&quot;: [ // å¯¹è¯å†…å®¹ 0:ç©å®¶ !0:NPC &quot;0:å“¥ä»¬å„¿ï¼Œè¿™ç“œå¤šå°‘é’±ä¸€æ–¤å‘&quot;, &quot;250:ä¸¤å—é’±ä¸€æ–¤&quot;, &quot;0:ç»™æˆ‘æŒ‘ä¸€ä¸ª&quot;, &quot;250:è¡Œï¼Œè¿™ä¸ªæ€ä¹ˆæ ·ï¼Ÿ&quot;, &quot;0:è¿™ç“œä¿ç†Ÿå—ï¼Ÿ&quot;, &quot;250:æˆ‘å¼€æ°´æœæ‘Šçš„ï¼Œèƒ½å–ç»™ä½ ç”Ÿç“œè›‹å­ï¼Ÿ&quot; ], &quot;rewards&quot;: &#123;&#125; // äº‹ä»¶å¥–åŠ± &#125;, &#123; &quot;type&quot;: 2, &quot;title&quot;: &quot;ä¸ç“œæ‘Šè€æ¿ç†æ€§è®¨è®º&quot;, &quot;npc&quot;: 250, &quot;dialog&quot;: [&quot;250:ä½ ä»–ğŸ´åŠˆæˆ‘ç“œæ˜¯å§ï¼Ÿ&quot;], &quot;rewards&quot;: &#123; &quot;car&quot;: 1, &quot;weapon&quot;: 1 &#125; &#125; ], &quot;failEvents&quot;: [ &#123; &quot;type&quot;: 2, // ä»»åŠ¡å¤±è´¥ç±»å‹ &quot;value&quot;: 30 // å…·ä½“æ•°å€¼ &#125; ]&#125; é€»è¾‘å®ç°å¯¹è¯ 1234567891011121314151617func (r *TaskMgr) OnTalkNpc(id uint32, step int) bool &#123; task, ok := r.list[id] if !ok &#123; return false &#125; event := task.getEvent(step) if event == nil &#123; return false &#125; if event.Type != enums.TASK_EVENT_TYPE_TALK_NPC &#123; return false &#125; if event.State != enums.TASK_EVENT_STATE_ING &#123; return false &#125; return r.eventUpdate(task, event)&#125; å‡»æ€ 1234567891011121314151617181920212223func (r *TaskMgr) OnKillNpc(npc interfaces.INpc) bool &#123; for _, task := range r.list &#123; for _, event := range task.Events &#123; if event.Type != enums.TASK_EVENT_TYPE_KILL_NPC &#123; continue &#125; if event.State != enums.TASK_EVENT_STATE_ING &#123; continue &#125; for _, eventNpc := range event.EventNpcs &#123; if npc.GetId() != eventNpc.Id &#123; continue &#125; event.EventNpcs = event.EventNpcs[1:] &#125; if len(event.EventNpcs) &gt; 0 &#123; continue &#125; return r.eventUpdate(task, event) &#125; &#125; return false&#125; 12345678910111213141516171819// æ›´æ–°ä»»åŠ¡äº‹ä»¶func (r *TaskMgr) eventUpdate(task *Task, event *event) bool &#123; if _, ok := r.list[task.Id]; !ok &#123; return false &#125; // å‘é€å¥–åŠ± for key, reward := range event.config.KvRewards &#123; switch key &#123; case &quot;car&quot;: // å‘é€è½½å…· case &quot;weapon&quot;: // å‘é€æ­¦å™¨ &#125; &#125; // äº‹ä»¶å®Œæˆ event.State = enums.TASK_EVENT_STATE_DONE return true&#125;","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"}]},{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - Behavior Tree(è¡Œä¸ºæ ‘)","date":"2023-07-20T16:00:00.000Z","path":"2023/07/21/game-behavior-tree/","text":"è¡Œä¸ºæ ‘ä¸€èˆ¬åº”ç”¨äºæ¸¸æˆå†…ç‰©ä½“çš„ AI å†³ç­–ï¼Œä»¥æ ‘çš„å½¢å¼æ§åˆ¶ç‰©ä½“æ¥ä¸‹æ¥çš„åŠ¨ä½œã€‚æ¯”å¦‚: è¡€é‡å¤ªå°‘ -&gt; åƒè¯ã€æ”»å‡»è·ç¦»ä¸å¤Ÿ -&gt; ç§»åŠ¨ç­‰ç­‰ã€‚ å‰è¨€æœ€è¿‘åœ¨æ‘¸ç´¢å°æ¸¸æˆå¼€å‘ï¼Œæœ‰ä¸€äº›è”æœºå‹çš„åŠŸèƒ½éœ€è¦æœºå™¨äººå‚ä¸ï¼Œæ‰€ä»¥éœ€è¦å®ç°ä¸€ä¸‹æ¸¸æˆ AIã€‚ç»¼åˆä¸€ä¸‹å®ç°æ–¹æ¡ˆåŸºæœ¬æ˜¯ä»¥ä¸‹ä¸¤ç§ï¼š æœ‰é™çŠ¶æ€æœºï¼ˆFinite State Machineï¼‰ FSM ä¹Ÿæ˜¯æœ€å¼€å§‹é‡‡ç”¨çš„æ–¹æ¡ˆï¼Œå®ç°èµ·æ¥ç®€å•ç²—æš´ã€‚ç¼ºç‚¹æ˜¯æ•´ä¸ªé€»è¾‘éå¸¸è‡ƒè‚¿å¾ˆéš¾æ¨¡å—åŒ–ï¼Œåé¢å†å¯¹ AI è¿›è¡Œæ›´æ–°å’Œç»´æŠ¤æ¯”è¾ƒæ¶å¿ƒï¼Œå¾ˆå®¹æ˜“å› ä¸ºæ¼æ”¹ã€é”™æ”¹å¯¼è‡´ä¸å¯ç”¨ã€‚ è¡Œä¸ºæ ‘ï¼ˆBehavior Treeï¼‰ è¡Œä¸ºæ ‘æ˜¯ç”±ä¸€ç³»åˆ—èŠ‚ç‚¹æ„æˆçš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªåŠ¨ä½œï¼Œè‡ªä¸Šè€Œä¸‹æ‰§è¡Œä¸”æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¿”å›æ‰§è¡ŒçŠ¶æ€ã€‚ è¡Œä¸ºæ ‘è¡Œä¸ºæ ‘ä¸€èˆ¬ç”±ï¼šæ ¹èŠ‚ç‚¹ï¼ˆRootï¼‰ã€åºåˆ—èŠ‚ç‚¹ï¼ˆSequenceï¼‰ã€é€‰æ‹©èŠ‚ç‚¹ï¼ˆSelectorï¼‰ã€å¹¶è¡ŒèŠ‚ç‚¹ï¼ˆParallelï¼‰ç­‰ç­‰èŠ‚ç‚¹ç»„æˆï¼Œå¯èƒ½è¿˜ä¼šæœ‰æ¡ä»¶èŠ‚ç‚¹ï¼ˆConditionï¼‰ã€‚è¿™äº›èŠ‚ç‚¹ä¹Ÿå¯ä»¥è¢«æŠ½è±¡çš„å½’ä¸º 4 ç±»: æ§åˆ¶èŠ‚ç‚¹ åºåˆ—èŠ‚ç‚¹ï¼ˆSequenceï¼‰ é€‰æ‹©èŠ‚ç‚¹ï¼ˆSelectorï¼‰ å¹¶è¡ŒèŠ‚ç‚¹ï¼ˆParallelï¼‰ æ¡ä»¶èŠ‚ç‚¹ æ¡ä»¶èŠ‚ç‚¹ï¼ˆConditionï¼‰ è¡Œä¸ºèŠ‚ç‚¹ è‡ªå®šä¹‰èŠ‚ç‚¹ã€‚æ¯”å¦‚ï¼šæ”»å‡»ã€é˜²å¾¡ã€åƒè¯ç­‰ï¼Œæ˜¯çœŸæ­£æ‰§è¡Œæ¸¸æˆé€»è¾‘çš„èŠ‚ç‚¹ã€‚ è£…é¥°èŠ‚ç‚¹ é€†å˜èŠ‚ç‚¹ï¼ˆInverterï¼‰ é‡å¤æ‰§è¡ŒèŠ‚ç‚¹ï¼ˆRepeaterï¼‰ è£…é¥°èŠ‚ç‚¹ä¹Ÿç®—æ˜¯è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Œä¸»è¦ä½œç”¨æ˜¯è¾…åŠ©å­èŠ‚ç‚¹æ‰§è¡Œã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ— è®ºæ˜¯ä»€ä¹ˆèŠ‚ç‚¹éƒ½å¿…é¡»å®ç°Exec()æ‰§è¡Œæ–¹æ³•ã€‚ å®šä¹‰èŠ‚ç‚¹æ¥å£ï¼š 12345678910type Status int8const ( Success Status = iota Failure)type INode interface &#123; Exec() Status&#125; åºåˆ—èŠ‚ç‚¹æœ‰åºçš„æ‰§è¡Œå­èŠ‚ç‚¹ï¼Œä»»æ„å­èŠ‚ç‚¹å¤±è´¥ç»ˆæ­¢æ‰§è¡Œè¿”å›å¤±è´¥ï¼Œå…¨éƒ¨æ‰§è¡Œå®Œæ¯•è¿”å›æˆåŠŸã€‚ 12345678910111213141516171819// åºåˆ—type Sequence struct &#123; children []INode&#125;func NewSequence(children ...INode) *Sequence &#123; return &amp;Sequence&#123; children: children, &#125;&#125;func (r *Sequence) Exec() Status &#123; for _, child := range r.children &#123; if result := child.Exec(); result == Failure &#123; return Failure &#125; &#125; return Success&#125; é€‰æ‹©èŠ‚ç‚¹åŒæ ·æœ‰åºçš„æ‰§è¡Œå­èŠ‚ç‚¹ã€å’Œåºåˆ—èŠ‚ç‚¹ä¸åŒçš„æ˜¯ä»»æ„å­èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸè¿”å›æˆåŠŸã€‚ 123456789101112131415161718type Selector struct &#123; children []INode&#125;func NewSelector(children ...INode) *Selector &#123; return &amp;Selector&#123; children: children, &#125;&#125;func (r *Selector) Exec() Status &#123; for _, child := range r.children &#123; if result := child.Exec(); result == Success &#123; return Success &#125; &#125; return Failure&#125; å¹¶è¡ŒèŠ‚ç‚¹åŒæ—¶æ‰§è¡Œæ‰€æœ‰å­èŠ‚ç‚¹ 12345678910111213141516171819202122type Parallel struct &#123; children []INode&#125;func NewParallel(children ...INode) *Parallel &#123; return &amp;Parallel&#123; children: children, &#125;&#125;func (r *Parallel) Exec() Status &#123; wg := sync.WaitGroup&#123;&#125; for _, child := range r.children &#123; wg.Add(1) go func(node INode) &#123; defer wg.Done() node.Exec() &#125;(child) &#125; wg.Wait() return Success&#125; æ¡ä»¶èŠ‚ç‚¹ &#x2F; è¡Œä¸ºèŠ‚ç‚¹é¡¾åæ€ä¹‰ï¼Œæ‰§è¡Œå­èŠ‚ç‚¹å‰éœ€è¦æ£€æŸ¥æ˜¯ä¸æ˜¯ç¬¦åˆæ¡ä»¶ã€‚ 1234567891011121314151617type Condition struct &#123; f func(IBlackboard) bool&#125;func NewCondition(f func(IBlackboard) bool) *Condition &#123; return &amp;Condition&#123; f: f, &#125;&#125;func (r *Condition) Exec(db IBlackboard) Status &#123; if v := r.f(db); !v &#123; return Failure &#125; return Success&#125; åœ¨è¿™å¼•å…¥ä¸€ä¸ªæ¦‚å¿µ: é»‘æ¿ï¼ˆBlackboardï¼‰ï¼Œä¸€èˆ¬ä¸€ä¸ªè¡Œä¸ºæ ‘æœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼Œç”¨äºå„èŠ‚ç‚¹é—´å…±äº«æ•°æ®ã€‚å°±åƒä¸€ç¾¤äººåœ¨é»‘æ¿å‰è®¨è®ºé—®é¢˜ï¼Œå„è‡ªçš„æ€è·¯ã€æ–¹æ¡ˆéƒ½è¢«ä¹¦å†™åœ¨é»‘æ¿ä¸Šä¾›æ‰€æœ‰äººé˜…è¯»ã€‚è°ƒç”¨å®ç°: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354// ç»æ‹›type JueZhao struct &#123;&#125;func NewJueZhao() *JueZhao &#123; return &amp;JueZhao&#123;&#125;&#125;func (r *JueZhao) Exec(db IBlackboard) Status &#123; fmt.Println(&quot;[ç»æ‹›]done&quot;) db.Set(&quot;can_use_skill&quot;, false) return Success&#125;// è“„åŠ›type XuLi struct &#123;&#125;func NewXuLi() *XuLi &#123; return &amp;XuLi&#123;&#125;&#125;func (r *XuLi) Exec(db IBlackboard) Status &#123; db.Set(&quot;can_use_skill&quot;, true) fmt.Println(&quot;[è“„åŠ›]done&quot;) return Success&#125;func main() &#123; // å®šä¹‰æ ¹èŠ‚ç‚¹ bt := NewSequence( NewXuLi(), NewCondition(func(db IBlackboard) bool &#123; result := db.Get(&quot;can_use_skill&quot;) if result == nil || !result.(bool) &#123; return false &#125; return true &#125;), NewJueZhao(), ) db := &amp;Blackboard&#123; data: make(map[string]interface&#123;&#125;, 0), &#125; result := bt.Exec(db) fmt.Print(&quot;ç»“æœ: &quot;) switch result &#123; case Success: fmt.Println(&quot;æˆåŠŸ&quot;) case Failure: fmt.Println(&quot;å¤±è´¥&quot;) &#125;&#125;// [è“„åŠ›]done// [ç»æ‹›]done// ç»“æœ: æˆåŠŸ è£…é¥°èŠ‚ç‚¹æ¯”å¦‚è®© AI è¿ç»­æ‰§è¡Œ 3 æ¬¡ç»æ‹›ã€‚ 12345678910111213141516171819type Repeater struct &#123; child INode count int8&#125;func NewRepeater(child INode, count int8) *Repeater &#123; return &amp;Repeater&#123; child: child, count: count, &#125;&#125;func (r *Repeater) Exec(db IBlackboard) Status &#123; for r.count &gt; 0 &#123; r.child.Exec(db) r.count -= 1 &#125; return Success&#125; æœ€åé€šè¿‡ä»¥ä¸Šå‡ ä¸ªç®€å•å®ç°ï¼Œå¤§æ¦‚çŸ¥é“è¡Œä¸ºæ ‘å…¶å®å°±æ˜¯æŠŠæƒ³è¦è®© AI æ‰§è¡Œçš„åŠ¨ä½œæŠ½è±¡æˆä¸€ä¸ªä¸€ä¸ªè¡Œä¸ºèŠ‚ç‚¹ï¼Œä½¿ç”¨ç»„åˆèŠ‚ç‚¹åŠ ä»¥æ§åˆ¶ç»„æˆä¸€ä¸ªå¤æ‚çš„ AI æ ‘ã€‚ ä¼˜ç‚¹æ˜¾è€Œæ˜“è§ï¼Œå¯è¯»æ€§å¥½ã€æ–¹ä¾¿æ‰©å±•ã€å¯ä»¥è„šæœ¬åŒ–ç¼–å†™ã€‚éƒ¨åˆ†æ¸¸æˆå¼•æ“ä¹Ÿæä¾›å¯è§†åŒ–ç¼–å†™ï¼Œæ¯”å¦‚ï¼šUnrealã€Unity çš„ Behavior Designer æ’ä»¶ç­‰ ç¼ºç‚¹æ˜¯æ¯æ¬¡éƒ½ä»æ ¹èŠ‚ç‚¹è¿è¡Œï¼Œè¡Œä¸ºæ ‘æ¯”è¾ƒå¤æ‚çš„æƒ…å†µè¿è¡Œæ•ˆç‡ä¸ä¼šé«˜ã€‚å½“ç„¶é’ˆå¯¹è¿™ä¸ªé—®é¢˜å¯ä»¥è¿›è¡Œä¼˜åŒ–ï¼Œå°±æ˜¯å¯¹èŠ‚ç‚¹åš Running è®°å½•ï¼Œä¸‹æ¬¡ä» Running èŠ‚ç‚¹ç»§ç»­æ‰§è¡Œã€‚ é™„ä¸Šç¤ºä¾‹ï¼šbt","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"}]},{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - é€šä¿¡åè®®","date":"2023-02-26T16:00:00.000Z","path":"2023/02/27/game-protocol/","text":"åœ¨ç½‘ç»œæ¸¸æˆä¸­ï¼Œé€šä¿¡åè®®æ˜¯å…¶ä¸­å¿…ä¸å¯å°‘çš„ç»„æˆéƒ¨åˆ†ã€‚ä¸€ä¸ªé€šä¿¡åè®®çš„å¤§å°ã€ç»“æ„å°†ä¸æœåŠ¡å™¨è´Ÿè½½åŠå®¢æˆ·ç«¯å»¶è¿Ÿæ¯æ¯ç›¸å…³ã€‚ å‰è¨€æ¸¸æˆçš„é€šä¿¡åè®®ï¼Œä¸€èˆ¬éœ€è¦è€ƒè™‘2ä¸ªéƒ¨åˆ†ï¼š ç½‘ç»œä¼ è¾“åè®® æ•°æ®äº¤æ¢æ ¼å¼ ç½‘ç»œä¼ è¾“åè®®æ ¹æ®æ¸¸æˆç±»å‹çš„ä¸åŒï¼Œç½‘ç»œä¼ è¾“åè®®é€‰æ‹©ä¹Ÿæœ‰äº›è®¸ä¸åŒã€‚æ¯”å¦‚ï¼š å¼±è”ç½‘ç±»å‹ å•å·¥&#x2F;åŠåŒå·¥é€šä¿¡åè®®ï¼šHTTP1.0ã€HTTP1.1 å¼ºè”ç½‘ã€å¼ºäº¤äº’ç±»å‹ å…¨åŒå·¥é€šä¿¡åè®®ï¼šWebSocketã€TCP å¼ºè”ç½‘ã€å®æ—¶äº¤äº’ç±»å‹ UDP å•å·¥ã€åŠåŒå·¥åŠå…¨åŒå·¥é€šä¿¡åè®®çš„åŒºåˆ«ç”¨3å¼ å›¾æ¥è¡¨ç¤ºä¸€ä¸‹ï¼Œå…·ä½“å†…å®¹ç•™åˆ°ä¸‹ç¯‡å­¦ä¹ ç¬”è®°å†æ°´â€¦ å•å·¥ åŠåŒå·¥ å…¨åŒå·¥ æ•°æ®äº¤æ¢æ ¼å¼å¯¹äºæ•°æ®äº¤æ¢æ ¼å¼æ¥è¯´ï¼Œéœ€è¦è§£å†³çš„æœ€ä¸»è¦çš„é—®é¢˜å°±æ˜¯å†…å®¹è¯­ä¹‰æ¸…æ™°ï¼Œç»“æ„ç¨³å®šï¼Œé€šä¿—åœ°è¯´ä¸åŒçš„ç¨‹åºéƒ½å¯ä»¥ç¨³å®šçš„è§£æå¹¶ä¸”çŸ¥é“æ€æ ·å»å¤„ç†å®ƒä»¬ã€‚ å¯¹äºæ•°æ®ç»“æ„ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ä¸ªé€‰æ‹©ï¼š XML å¯è¯»æ€§é«˜ï¼Œè§£æéš¾åº¦é«˜ JSON å¯è¯»æ€§é«˜ã€æ˜“è§£æã€ä½“ç§¯å° Protocol Buffers å¯è¯»æ€§å·®ã€æ˜“è§£æã€ä½“ç§¯ç‰¹åˆ«å° åœ¨ç¡®å®šæ•°æ®äº¤æ¢åè®®åï¼Œè¿˜éœ€è¦åˆ¶å®šæ•°æ®äº¤æ¢çš„æ ¼å¼ï¼Œä¿è¯æ•°æ®ä¸ä¼šå‡ºç°æ­§ä¹‰ã€‚æ¯”å¦‚ä¸‹å›¾è¿™æ ·çš„æ ¼å¼ï¼ˆæœªè€ƒè™‘åŠ å¯†ï¼‰ã€‚ ä»å·¦å‘å³ç»“æ„ï¼šå¤´å­—èŠ‚è¡¨ç¤ºåè®®åç§°çš„é•¿åº¦ã€ä¸­é—´éƒ¨åˆ†æ˜¯åè®®åç§°ã€æœ€åæ˜¯åè®®çš„å…·ä½“æ•°æ®ï¼ˆå¯ä»¥æ˜¯XMLã€JSONã€PBç­‰ï¼‰ã€‚ å®ç°é€»è¾‘ä½¿ç”¨WebSocket + PBæ¥å®ç°ä¸€å¥—é€šä¿¡åè®®ï¼Œå®ç°ä¸€ä¸ªç®€æ˜“ç™»å½•åè®®ã€‚ åè®®æ–‡ä»¶ 12345678syntax = &quot;proto3&quot;;option go_package = &quot;./protocol&quot;;message login &#123; string username = 1; string password = 2;&#125; æœåŠ¡ç«¯æ ¸å¿ƒä»£ç  12345678910111213141516171819202122232425262728293031323334353637383940414243type Packet struct &#123; Protocol string Bytes []byte&#125;func (r *Packet) Encode() []byte &#123; buffer := &amp;bytes.Buffer&#123;&#125; // 2å­—èŠ‚ï¼Œåè®®åç§°é•¿åº¦ buffer.Write(r.shortBytes(uint16(len(r.Protocol)))) // åè®®åç§° buffer.WriteString(r.Protocol) // åè®®å†…å®¹ buffer.Write(r.Bytes) return buffer.Bytes()&#125;func (r *Packet) Decode() []byte &#123; buffer := bytes.NewBuffer(r.Bytes) byteLen := buffer.Len() // 2å­—èŠ‚ï¼Œåè®®åç§°é•¿åº¦ headLen := make([]byte, 2) buffer.Read(headLen) // åè®®åç§° protocolLen := r.readShort(headLen) protocol := make([]byte, protocolLen) buffer.Read(protocol) r.Protocol = string(protocol) // åè®®å†…å®¹ bytes := make([]byte, byteLen-2-int(protocolLen)) buffer.Read(bytes) r.Bytes = bytes return bytes&#125;func (r *Packet) readShort(b []byte) uint16 &#123; return binary.BigEndian.Uint16(b)&#125;func (r *Packet) shortBytes(i uint16) []byte &#123; bytes := make([]byte, 2) binary.BigEndian.PutUint16(bytes, i) return bytes&#125; é™„ä¸Šå®Œæ•´å®ç°ï¼šws-network","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"}]},{"title":"æ¸¸æˆå¼€å‘ç¬”è®° - åœ°å›¾ç¼–è¾‘å™¨","date":"2023-01-29T16:00:00.000Z","path":"2023/01/30/game-map-editor/","text":"ä¹‹å‰åœ¨å­¦ä¹ æ•°æ®ç»“æ„ä¸ç®—æ³• - AStar(A*)ç­‰å¯»è·¯ç®—æ³•çš„è¿‡ç¨‹ä¸­æåˆ°è¿‡ç½‘æ ¼åœ°å›¾æ—¶ç”±ç±»ä¼¼0æ˜¯å¯ç§»åŠ¨èŠ‚ç‚¹ã€1æ˜¯éšœç¢èŠ‚ç‚¹çš„ç½‘æ ¼ç»„æˆçš„ä¸€å¼ åœ°å›¾ï¼Œè¿™äº›åœ°å›¾ä¿¡æ¯æ˜¯æ€æ ·ç”Ÿæˆå‡ºæ¥çš„å‘¢ï¼Ÿ å¼•è¨€åœ°å›¾ç¼–è¾‘å™¨æ˜¯ä¸€ç§æ‰€è§å³æ‰€å¾—çš„æ¸¸æˆåœ°å›¾åˆ¶ä½œå·¥å…·ï¼Œå®ƒè¾…åŠ©è®¾è®¡å’Œè¾“å‡ºåœ°å›¾æ•°æ®ï¼ŒåŒ…æ‹¬åˆ›å»ºã€ç¼–è¾‘ã€å­˜å‚¨å’Œç®¡ç†æ¸¸æˆåœ°å›¾æ•°æ®ã€‚ å¦‚ä½•ç”Ÿæˆåœ°å›¾æ•°æ®åªè€ƒè™‘ 2D åœ°å›¾ï¼Œä¸€èˆ¬æ¥è¯´æœ‰ä¸¤ç§æ–¹å¼ï¼š PhotoShopæ‰“å¼€åŸå§‹åœ°å›¾æ–‡ä»¶ï¼ŒæŒ‰ç…§ç½‘æ ¼å¤§å°è¿›è¡Œæ ‡æ³¨ç±»å‹ åœ°å›¾ç¼–è¾‘å™¨2D æ¸¸æˆæœ‰å¾ˆå¤šæˆç†Ÿçš„ç¼–è¾‘å™¨ï¼Œæ¯”å¦‚ï¼štiled editorï¼Œä½†æœ¬ç€â€œé€ è½®å­â€çš„åŸåˆ™å°±æ˜¯å¼€å‘ä¸€å¥—å•¦ï¼ åœ°å›¾ç¼–è¾‘å™¨ä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯æ¥å¼€å‘ï¼Œé€‰æ‹©ä¹Ÿå¾ˆå¤šæ ·æ€§ã€‚ è€ƒè™‘å­¦ä¹ æˆæœ¬é—®é¢˜ï¼Œè¿™é‡Œä½¿ç”¨ Cocos Creator + Typescript æ¥å¼€å‘ä¸€å¥—ç®€æ˜“çš„åœ°å›¾ç¼–è¾‘å™¨ã€‚ å®ç°æ­¥éª¤ åŠ è½½è´´å›¾æ–‡ä»¶ æ ¹æ®æŒ‡å®šç½‘æ ¼å¤§å°è¿›è¡Œåˆ’åˆ†ç½‘æ ¼ å¯ä»¥å¯¹ç½‘æ ¼å¡«å……ä¸åŒçš„é¢œè‰²ï¼ˆå¯è¡Œèµ°ã€ä¸å¯è¡Œèµ°ï¼‰ å¯¼å‡ºç»“æœ åœ°å›¾ç¼–è¾‘å™¨æ˜¯æ¸¸æˆå¼€å‘ä¸­æœ€å…¥é—¨çš„éƒ¨åˆ†ï¼Œç®€å•ç²—æš´ï¼ åŠ è½½è´´å›¾æ–‡ä»¶åˆ›å»ºä¸€ä¸ªç”¨äºæ˜¾ç¤ºåœ°å›¾çš„SpriteèŠ‚ç‚¹ã€‚ 123456789101112131415161718192021const &#123; ccclass, property &#125; = cc._decorator;@ccclassexport default class main extends cc.Component &#123; // åœ°å›¾è´´å›¾èŠ‚ç‚¹ @property(cc.Node) mapNode: cc.Node = null; start() &#123;&#125; onLoad() &#123; // init logic cc.resources.load(&quot;textures/4006&quot;, cc.SpriteFrame, (err, frame: cc.SpriteFrame) =&gt; &#123; if (err) &#123; console.error(err.message || err); return; &#125; this.mapNode.getComponent(cc.Sprite).spriteFrame = frame; &#125;); &#125;&#125; åˆ’åˆ†ç½‘æ ¼åœ¨ Sprite èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªç»˜å›¾å­èŠ‚ç‚¹Graphicsã€‚ 1234567891011// ç»˜å›¾èŠ‚ç‚¹@property(cc.Graphics)mapGraphics: cc.Graphics = null;// åœ°å›¾åŸå§‹å°ºå¯¸originWidth: number = 2862;originHeight: number = 2304;// ç½‘æ ¼å¤§å°gridWidth: number = 20;gridHeight: number = 20; ä¹‹ååœ¨GraphicsèŠ‚ç‚¹è¿›è¡Œç»˜åˆ¶ã€‚ 1234567891011121314151617181920this.mapGraphics.clear(); // æ¸…é™¤æ‰€æœ‰ç»˜åˆ¶this.mapGraphics.strokeColor = cc.Color.RED; // çº¢è‰²this.mapGraphics.lineWidth = 1; // çº¿å®½åº¦// ç”»ç«–çº¿let xMax: number = Math.floor(this.mapNode.width / this.gridWidth);// console.log(&quot;xMax = width / gridWidth&quot;, xMax, this.mapNode.width, this.gridWidth)for (let i: number = 0; i &lt; xMax; i++) &#123; let x = i * this.gridWidth; this.mapGraphics.moveTo(x, 0); this.mapGraphics.lineTo(x, this.mapNode.height);&#125;// ç”»æ¨ªçº¿let yMax: number = Math.floor(this.mapNode.height / this.gridHeight);// console.log(&quot;yMax = height / gridHeight&quot;, yMax, this.mapNode.height, this.gridHeight)for (let i: number = 0; i &lt; yMax; i++) &#123; let y = i * this.gridHeight; this.mapGraphics.moveTo(0, y); this.mapGraphics.lineTo(this.mapNode.width, y);&#125;this.mapGraphics.stroke(); å¡«å……é¢œè‰²ç›‘å¬è§¦å±äº‹ä»¶TOUCH_STARTã€TOUCH_MOVEã€‚ 123// mouse eventthis.mapNode.on(cc.Node.EventType.TOUCH_START, this.updateGrid, this);this.mapNode.on(cc.Node.EventType.TOUCH_MOVE, this.updateGrid, this); äº‹ä»¶è§¦å‘ï¼Œç»™é¼ æ ‡æ‰€åœ¨åæ ‡çš„ç½‘æ ¼å¡«å……é¢œè‰²ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„å°çŸ¥è¯†ç‚¹åæ ‡ç³»çš„è½¬æ¢ï¼Œå¯åˆ†ä¸ºï¼šä¸–ç•Œåæ ‡ã€æœ¬åœ°åæ ‡ã€åƒç´ åæ ‡ã€‚ 1234567const eventPos: cc.Vec2 = event.getLocation();let pos = this.mapNode.convertToNodeSpaceAR(eventPos); // è½¬æ¢è‡³èŠ‚ç‚¹åæ ‡let x: number = Math.floor(pos.x / this.gridWidth);let y: number = Math.floor(pos.y / this.gridHeight);this.mapGraphics.rect(x * this.gridWidth, y * this.gridHeight, this.gridWidth, this.gridHeight);this.mapGraphics.fillColor = cc.Color.BLUE;this.mapGraphics.fill(); å¯¼å‡ºç»“æœå¯¼å‡ºç»“æœé€»è¾‘å¾ˆç®€å•ï¼Œéœ€è¦åœ¨å¡«å……é¢œè‰²æ—¶è®°å½•å¯¹åº”ç½‘æ ¼çš„ç±»å‹ï¼Œæœ€åè¾“å‡ºåˆ°æ–‡ä»¶ã€‚ ç”Ÿæˆ x*y ä¸ªç½‘ã€‚ 12// ç½‘æ ¼ä¿¡æ¯grids: Array&lt;Array&lt;number&gt;&gt;; è®°å½•ç½‘æ ¼ä¿¡æ¯ã€‚ 12345678// è®°å½•æ ¼å­ä¿¡æ¯this.grids = new Array(xMax);for (let i: number = 0; i &lt; xMax; i++) &#123; this.grids[i] = new Array(yMax); for (let j: number = 0; j &lt; yMax; j++) &#123; this.grids[i][j] = 1; // é»˜è®¤ä¸å¯è¡Œèµ° &#125;&#125; è¾“å‡ºåˆ°æ–‡ä»¶ 12345678910111213141516171819202122232425const v: object = &#123; map: &#123; originWidth: this.originWidth, originHeight: this.originHeight, width: this.mapNode.width, height: this.mapNode.height, &#125;, grid: &#123; width: this.gridWidth, height: this.gridHeight, &#125;, data: this.grids,&#125;;if (cc.sys.isBrowser) &#123; let json = JSON.stringify(v); let blob = new Blob([json], &#123; type: &quot;application/json&quot; &#125;); let aLink = document.createElement(&quot;a&quot;); aLink.download = &quot;map.json&quot;; if (window.webkitURL != null) &#123; aLink.href = window.webkitURL.createObjectURL(blob); &#125; aLink.click();&#125; else &#123; console.error(&quot;å¯¼å‡ºä»…æ”¯æŒæµè§ˆå™¨&quot;);&#125; æœ€åé™„ä¸Šå®Œæ•´ä»£ç ï¼šmap-editor","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"game","slug":"game","permalink":"http://xupin.im/tags/game/"}]},{"title":"æ•°æ®ç»“æ„ä¸ç®—æ³• - AST","date":"2022-12-12T16:00:00.000Z","path":"2022/12/13/data-structures-algo-ast/","text":"ASTï¼ˆAbstract syntax treeï¼‰æŠ½è±¡è¯­æ³•æ ‘ï¼Œç”¨äºè¡¨ç¤ºç¼–ç¨‹è¯­è¨€æºä»£ç çš„ä¸€ç§æŠ½è±¡è¯­æ³•çš„ç»“æ„ï¼Œæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯¹åº”æºä»£ç ä¸­çš„ä¸€ä¸ªç»“æ„ã€‚ å‰è¨€è®¡ç®—æœºå¦‚ä½•ç”Ÿæˆ AST ç»“æ„ï¼Ÿä¸€èˆ¬æ¥è¯´é¡ºåºå¦‚ä¸‹ï¼š è¯æ³•åˆ†æ æ‰«ææºä»£ç ï¼Œç”Ÿæˆæ ‡è®°ï¼ˆtokenï¼‰ è¯­æ³•åˆ†æ è§£æ tokensï¼Œæ„é€  AST ç»“æ„ åˆ†æè¿‡ç¨‹ï¼š AST ç»“æ„ï¼š åº”ç”¨åœºæ™¯AST åº”ç”¨åœºæ™¯æ¯”è¾ƒå¹¿æ³›ï¼Œæ¯”å¦‚ï¼š Typescript ç¼–è¯‘ Javascript æ–‡ä»¶ æ ¼å¼åŒ–æ’ä»¶ ä»£ç æ··æ·†&#x2F;å‹ç¼© ç±»å‹æ£€æŸ¥&#x2F;æ¨å¯¼ ç­‰ç­‰â€¦è¯¸å¤šåº”ç”¨åœºæ™¯ã€‚ è¯æ³•åˆ†æå¦‚ä½•è¯»å…¥æºä»£ç ï¼Œæ‰«æã€è§£æä»¥åŠç”Ÿæˆ ASTï¼Ÿä¸‹é¢å°è¯•ç”¨ä¸€ä¸ªå¯ä»¥è®¡ç®—+ã€-ã€*ã€/å…¬å¼çš„å°ç¨‹åºæ¥å­¦ä¹ å’Œå®éªŒã€‚ å‡è®¾ï¼Œç»™å®šçš„æºç æ˜¯1+2+3ï¼Œåº”è¯¥æ€æ ·å»æ‰«æï¼Ÿæ‰«æåŸç†å¾ˆç®€å•ï¼Œé€šä¿—çš„è¯´å°±æ˜¯æŒ‰å­—ç¬¦è¯»å–è®°å½•ä¸º Tokenã€‚ 123456789101112131415// é¦–å…ˆå®šä¹‰å­˜å‚¨æ ‡è®°çš„ç»“æ„type Token struct &#123; Str string&#125;// æ‰«ææºç s := &quot;1+2+3&quot;tokens := []Token&#123;&#125;for _, c := range s &#123; tokens = append(tokens, Token&#123; Str: string(c), &#125;)&#125;fmt.Printf(&quot;%+v\\n&quot;, tokens)// [&#123;Str:1&#125; &#123;Str:+&#125; &#123;Str:2&#125; &#123;Str:+&#125; &#123;Str:3&#125;] ä»¥ä¸Šï¼Œæ‰«æå·¥ä½œå°±å®Œæˆäº†ï¼ ä½†è¯æ³•åˆ†æä¸€èˆ¬æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œæ¯”å¦‚æ•°å­—1å’Œæ“ä½œç¬¦+ä¹Ÿä¸åº”è¯¥æ˜¯åŒä¸€ç§ç±»å‹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¹é€ è¯æ³•åˆ†æå™¨ï¼åœ¨ç”Ÿæˆ Token çš„åŒæ—¶è®°å½•ç±»å‹ï¼Œæ–¹ä¾¿è¿›ä¸€æ­¥å¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çŠ¶æ€æœºçš„è®¾è®¡æ€è·¯ï¼š è¯»å…¥ä¸€ä¸ªå­—ç¬¦ åˆ¤æ–­å­—ç¬¦ç±»å‹ï¼Œæ•°å­— or æ“ä½œç¬¦&nbsp;&nbsp;&nbsp;&nbsp;1. æ˜¯æ•°å­—ï¼Œè®°å½•å½“å‰å­—ç¬¦ä½ç½®ï¼Œç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼Œç›´è‡³éæ•°å­—æˆ–è€…å­—ç¬¦è¾¹ç•Œï¼Œè®°å½•å®Œæ•´çš„æ•°å€¼ã€‚&nbsp;&nbsp;&nbsp;&nbsp;2. ä¸æ˜¯æ•°å­—ï¼Œç›´æ¥è®°å½•æ“ä½œç¬¦ã€‚ è¿”å› token è¯¦ç»†æ‰«æé€»è¾‘ï¼Œå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103type Lexer struct &#123; Expression string Char byte Pos int&#125;type Token struct &#123; Str string Type int Start int End int&#125;func (r *Lexer) Lex() ([]*Token, error) &#123; tokens := make([]*Token, 0) r.Char = r.Expression[0] for r.Pos &lt; len(r.Expression) &#123; token := r.Scan() if token.Type == enums.ILLEGAL &#123; return []*Token&#123;&#125;, fmt.Errorf(&quot;&#x27;%s&#x27; is not supported&quot;, token.Str) &#125; tokens = append(tokens, token) &#125; return tokens, nil&#125;func (r *Lexer) Scan() *Token &#123; var token *Token pos := r.Pos switch r.Char &#123; case &#x27;0&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;: for r.IsDigit() &#123; if !r.NextChar() &#123; break &#125; &#125; token = &amp;Token&#123; Str: string(r.Expression[pos:r.Pos]), Type: enums.NUMBER, Start: pos, End: r.Pos, &#125; case &#x27;+&#x27;: token = &amp;Token&#123; Str: string(r.Char), Type: enums.ADD, Start: pos, End: pos, &#125; r.NextChar() case &#x27;-&#x27;: token = &amp;Token&#123; Str: string(r.Char), Type: enums.SUB, Start: pos, End: pos, &#125; r.NextChar() case &#x27;*&#x27;: token = &amp;Token&#123; Str: string(r.Char), Type: enums.MUL, Start: pos, End: pos, &#125; r.NextChar() if r.Char == &#x27;*&#x27; &#123; token = &amp;Token&#123; Str: &quot;**&quot;, Type: enums.XOR, Start: pos, End: pos, &#125; r.NextChar() &#125; case &#x27;/&#x27;: token = &amp;Token&#123; Str: string(r.Char), Type: enums.QUO, Start: pos, End: pos, &#125; r.NextChar() default: token = &amp;Token&#123; Str: string(r.Char), Type: enums.ILLEGAL, Start: pos, End: r.Pos, &#125; &#125; return token&#125; ç°åœ¨ï¼Œæˆ‘ä»¬è°ƒç”¨è¯æ³•åˆ†æå™¨è§£æ1+2+3 12345678910111213141516lexer := lexer.Lexer&#123; Expression: &quot;1+2+3&quot;,&#125;tokens, err := lexer.Lex()if err != nil &#123; fmt.Println(err) return&#125;for _, token := range tokens &#123; fmt.Printf(&quot;%+v \\n&quot;, token)&#125;// &amp;&#123;Str:1 Type:9 Start:0 End:0&#125;// &amp;&#123;Str:+ Type:10 Start:1 End:1&#125;// &amp;&#123;Str:2 Type:9 Start:2 End:2&#125;// &amp;&#123;Str:+ Type:10 Start:3 End:3&#125;// &amp;&#123;Str:3 Type:9 Start:4 End:4&#125; è¯­æ³•åˆ†æç”Ÿæˆ tokens æ˜¯ç¬¬ä¸€æ­¥ï¼Œè¿™ä¸€ä¸² token åˆè¦æ€æ ·å»è§£æå‘¢ï¼Ÿ å·²çŸ¥+-*&#x2F;å‡å±äºäºŒå…ƒè¿ç®—ï¼ŒäºŒå…ƒè¿ç®—ä¸‰å…ƒç´ ï¼šè¿ç®—ç¬¦ã€å·¦å˜é‡ã€å³å˜é‡ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦çš„ç»“æ„å¤§æ¦‚æ˜¯è¿™æ ·ï¼šNumber{1} Op{+} Number{2} Op{+} Number{3}ï¼Œç”¨äºŒå‰æ ‘æ¥è¡¨ç¤ºï¼š 12345678910111213141516171819// é¦–å…ˆå®šä¹‰ä¸€ä¸ªè¯­æ³•åˆ†æå™¨type Parser struct &#123; Tokens []*lexer.Token // tokens CurToken *lexer.Token // å½“å‰token Index int // ä¸‹æ ‡ Err error // error&#125;// æ•°å€¼ç»“æ„type Number struct &#123; Val int&#125;// äºŒå…ƒè¿ç®—ç»“æ„type Stmt struct &#123; Type int Left Node Right Node&#125; å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š é¡ºåºå–å‡ºä¸€ä¸ª tokenã€‚ ParseExpr()åˆ¤å®š token ç±»å‹ï¼Œè¿”å›å¯¹åº”ç»“æ„ï¼Œä¸‹æ ‡+1ï¼ˆå¤„ç†ä¸‹ä¸€ä¸ª tokenï¼Œåº”å½“æ˜¯è¿ç®—ç¬¦ tokenï¼‰ã€‚&nbsp;&nbsp;&nbsp;&nbsp;1. å¦‚æœæ˜¯æ•°å€¼ç±»å‹ï¼Œåˆ™ç›´æ¥è¿”å› Number{}ç»“æ„ã€‚&nbsp;&nbsp;&nbsp;&nbsp;2. å¦‚æœæ˜¯è¿ç®—ç¬¦ç±»å‹ï¼Œåˆ™é€’å½’å¤„ç†è¿”å› Stmt{}ç»“æ„ã€‚ ParseRight()å¤„ç†å³ä¾§å˜é‡ï¼ŒæŠŠå·¦ä¾§å˜é‡ä¼ å…¥å‡½æ•°ã€‚ æ ¹æ®è¿ç®—ç¬¦åˆ¤æ–­å˜é‡ä¼˜å…ˆçº§é—®é¢˜ï¼Œå¦‚æœå½“å‰è¿ç®—ç¬¦å°äºä¼ å…¥å˜é‡ä¼˜å…ˆçº§ï¼Œåˆ™ç›´æ¥è¿”å›ä¼ å…¥å˜é‡ï¼Œå¤„ç†ç»“æŸã€‚ è®°å½•å½“å‰è¿ç®—ç¬¦ï¼ˆç±»å‹ï¼‰ï¼Œä¸‹æ ‡+1ï¼Œå¤„ç†å½“å‰æ“ä½œç¬¦å³ä¾§å˜é‡ï¼ˆæ­¥éª¤ 2ï¼‰ã€‚ å†æ¬¡åˆ¤æ–­ä¼ å…¥å˜é‡ä¼˜å…ˆçº§æ˜¯å¦ä½äºå½“å‰è¿ç®—ç¬¦ã€‚&nbsp;&nbsp;&nbsp;&nbsp;1. æ˜¯ï¼Œåˆ™æŠŠå³ä¾§å˜é‡ï¼ˆæ­¥éª¤ 4ï¼‰å½“æˆå·¦ä¾§å˜é‡ä¼ å…¥é€’å½’å¤„ç†ã€‚&nbsp;&nbsp;&nbsp;&nbsp;2. ä¸æ˜¯ï¼Œåˆ™æ„é€ äºŒå…ƒè¿ç®—è¡¨è¾¾å¼ Stmt{Type: è¿ç®—ç¬¦ç±»å‹, Left: å·¦ä¾§å˜é‡, Right: å³ä¾§å˜é‡}ã€‚ å½“å‰å¾ªç¯ç»“æŸï¼Œå›åˆ°æ­¥éª¤ 4ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990func (r *Parser) Parse() (Node, error) &#123; if len(r.Tokens) == 0 &#123; return nil, errors.New(&quot;the token list is empty&quot;) &#125; if r.CurToken == nil &#123; r.CurToken = r.Tokens[0] &#125; return r.Compile(), r.Err&#125;func (r *Parser) Compile() Node &#123; left := r.ParseExpr() right := r.ParseRight(1, left) return right&#125;func (r *Parser) ParseExpr() Node &#123; switch r.CurToken.Type &#123; case enums.NUMBER: return r.ParseNumber() case enums.ADD: return r.ParseNumber() case enums.SUB: if t := r.NextToken(); t.Type == enums.EOF &#123; r.Err = errors.New(&quot;expects to be number, eof given&quot;) return nil &#125; return &amp;Stmt&#123; Type: enums.SUB, Left: &amp;Number&#123;&#125;, Right: r.ParseExpr(), &#125; case enums.MUL: return r.ParseNumber() case enums.QUO: return r.ParseNumber() default: r.Err = fmt.Errorf(&quot;expects to be number, &#x27;%s&#x27; given&quot;, r.CurToken.Str) return nil &#125;&#125;func (r *Parser) ParseRight(precedence int, left Node) Node &#123; for &#123; curPrec := r.Precedence() if curPrec &lt; precedence &#123; return left &#125; tokenType := r.CurToken.Type r.NextToken() right := r.ParseExpr() if right == nil &#123; return nil &#125; if curPrec &lt; r.Precedence() &#123; right = r.ParseRight(curPrec, right) if right == nil &#123; return nil &#125; &#125; left = &amp;Stmt&#123; Type: tokenType, Left: left, Right: right, &#125; &#125;&#125;func (r *Parser) ParseNumber() *Number &#123; f, err := strconv.ParseFloat(r.CurToken.Str, 64) if err != nil &#123; return &amp;Number&#123;&#125; &#125; node := &amp;Number&#123; Val: f, &#125; r.NextToken() return node&#125;func (r *Parser) Precedence() int &#123; switch r.CurToken.Type &#123; case enums.ADD, enums.SUB: return 1 case enums.MUL, enums.QUO: return 2 default: return 0 &#125;&#125; çœ‹çœ‹æ•ˆæœï¼š 123456789101112131415161718lexer := lexer.Lexer&#123; Expression: &quot;1+2-3*4&quot;,&#125;tokens, err := lexer.Lex()if err != nil &#123; fmt.Println(err) return&#125;p := &amp;parser.Parser&#123; Tokens: tokens,&#125;ast, err := p.Parse()if err != nil &#123; fmt.Println(err) return&#125;fmt.Printf(&quot;%+v \\n&quot;, ast)// &#123;Type: 10, Left: &#123;Type: 10, Left: &#123;Type: 9, Val: 1&#125;, Right: &#123;Type: 9, Val: 2&#125;&#125;, Right: &#123;Type: 9, Val: 3&#125;&#125; æœ€åæœ‰äº† AST ç»“æ„ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è¿›è¡Œè®¡ç®—å•¦ï½è¿™æ ·ä¸€ä¸ªæ”¯æŒ+-*&#x2F;çš„å°ç¨‹åºå°±å®Œæˆäº†ï¼è®¡ç®—é€»è¾‘ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œç›´æ¥è´´ä»£ç : 1234567891011121314151617181920212223242526// æ•°å€¼ç±»å‹func (r *Number) Evaluate() float64 &#123; return r.Val&#125;// äºŒå…ƒè¿ç®—ç±»å‹func (r *Stmt) Evaluate() float64 &#123; left := r.Left.Evaluate() right := r.Right.Evaluate() switch r.Type &#123; case enums.ADD: return left + right case enums.SUB: return left - right case enums.MUL: return left * right case enums.QUO: if right == 0 &#123; fmt.Printf(&quot;expr[%g/%g]exception, division by zero \\n&quot;, left, right) return 0 &#125; return left / right default: return 0 &#125;&#125; é™„ä¸Šå®Œæ•´ä»£ç ï¼šmath-evaluate","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"data structures","slug":"data-structures","permalink":"http://xupin.im/tags/data-structures/"},{"name":"algorithms","slug":"algorithms","permalink":"http://xupin.im/tags/algorithms/"}]},{"title":"æ•°æ®ç»“æ„ä¸ç®—æ³• - Tire Tree","date":"2022-12-10T16:00:00.000Z","path":"2022/12/11/data-structures-algo-tire/","text":"Tire æ ‘åˆç§°å•è¯æŸ¥æ‰¾æ ‘ã€å‰ç¼€æ ‘ï¼Œæ˜¯ä¸€ç§å“ˆå¸Œæ ‘å˜ç§çš„æ ‘å½¢ç»“æ„ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ç©ºé—´æ¢æ—¶é—´ï¼Œåˆ©ç”¨å­—ç¬¦ä¸²çš„å…¬å…±å‰ç¼€æ¥æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œå¸¸å¸¸è¢«åº”ç”¨å­—ç¬¦ç»Ÿè®¡ã€æ£€ç´¢ç­‰åœºæ™¯ï¼Œæ¯”å¦‚æœç´¢å¼•æ“çš„è¯é¢‘ç»Ÿè®¡å’Œæç¤ºç­‰ åŸç†å‰ç¼€æ ‘çš„å­˜å‚¨åŸç†å¾ˆç®€å•ï¼Œå³åˆå¹¶å­—ç¬¦ä¸²ç›¸åŒçš„å­—ç¬¦å‰ç¼€è¿›è¡Œå­˜å‚¨ã€‚ æ¯”å¦‚ï¼Œå­˜å‚¨dogã€catã€doingä¸‰ä¸ªå­—ç¬¦ä¸²çš„æ ‘ç»“æ„ï¼š éœ€è¦æ³¨æ„ï¼šå‰ç¼€æ ‘ä¸æ˜¯äºŒå‰æ ‘ï¼Œè€Œæ˜¯å¤šå‰æ ‘ã€‚ å‰ç¼€æ ‘çš„ç‰¹å¾ï¼š æ ¹ç»“ç‚¹ä¸å­˜å‚¨ä»»ä½•å†…å®¹ã€‚ æ¯ä¸ªèŠ‚ç‚¹åªå­˜å‚¨ 1 ä¸ªå­—ç¬¦ã€‚ æ ¹èŠ‚ç‚¹åˆ°ä»»æ„å­èŠ‚ç‚¹æ˜¯ä¸ºå­˜å‚¨çš„å­—ç¬¦ä¸²ã€‚ å†™å…¥å’ŒæŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å‡ä¸º O(N)ã€‚ å¦‚ä½•å®ç°ä¸€èˆ¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼æ¥å®ç°ï¼Œ å•å‘é“¾è¡¨ï¼ˆæœ¬æ–‡é‡‡ç”¨æ–¹å¼ï¼‰ äºŒç»´æ•°ç»„ å­˜å‚¨ 12345678910111213// å®šä¹‰æ ¹ç»“ç‚¹type Tire struct &#123; Root *Node Size int // æ€»å…±å­˜å‚¨å¤šå°‘ä¸ªå­—ç¬¦&#125;// å®šä¹‰å­˜å‚¨å­—ç¬¦çš„èŠ‚ç‚¹type Node struct &#123; Char string // å½“å‰èŠ‚ç‚¹å­˜å‚¨çš„å­—ç¬¦ Count int // å‡ºç°è¿‡å¤šå°‘æ¬¡ IsWord bool // æ˜¯å¦æ˜¯å®Œæ•´çš„å•è¯ï¼ˆå­—ç¬¦ä¸²ç»“å°¾ï¼‰ Next map[rune]*Node // å­˜å‚¨ä¸‹ä¸€ä¸ªå­—ç¬¦çš„èŠ‚ç‚¹&#125; ä»ç»“æ„å¯ä»¥çœ‹å‡ºï¼Œå…¶å®å‰ç¼€æ ‘å°±æ˜¯æŠŠå­—ç¬¦ä¸²æŒ‰å­—ç¬¦é¡ºåºå­˜å‚¨ã€‚ 1234567891011121314151617181920212223func (r *Tire) Append(s string) &#123; if r.Find(s, true) &#123; return &#125; node := r.Root for _, c := range s &#123; v, ok := node.Next[c] // æ˜¯å¦å­˜åœ¨è¯¥å­—ç¬¦ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿›è¡Œå­˜å‚¨ï¼Œåä¹‹å–ä¸‹ä¸€ä¸ªå­—ç¬¦ if !ok &#123; v = &amp;Node&#123; Char: string(c), IsWord: false, Count: 1, Next: make(map[rune]*Node, 0), &#125; node.Next[c] = v r.Size += 1 &#125; else &#123; v.Count += 1 &#125; node = v &#125; node.IsWord = true // æœ€åä¸€ä¸ªå­—ç¬¦æŠŠIsWordæ ‡è®°ä¸ºtrue&#125; æŸ¥æ‰¾ 1234567891011func (r *Tire) Find(s string, isFullMatch bool) bool &#123; node := r.Root for _, c := range s &#123; v, ok := node.Next[c] // æ˜¯å¦å­˜åœ¨è¯¥å­—ç¬¦ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥è¿”å›falseï¼Œåä¹‹ç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå­—ç¬¦ if !ok &#123; return false &#125; node = v &#125; return (!isFullMatch &amp;&amp; !node.IsWord) || node.IsWord&#125; åˆ é™¤ åˆ é™¤æ˜¯å‰ç¼€æ ‘ä¸­ç¨å¤æ‚ä¸€ç‚¹çš„æ“ä½œï¼Œå¦‚æœå­—ç¬¦è¢«å…¶ä»–å­—ç¬¦ä¸²ä½¿ç”¨ï¼Œä¸èƒ½ç›´æ¥åˆ é™¤ã€‚ 12345678910111213141516171819202122func (r *Tire) Remove(s string) bool &#123; if !r.Find(s, true) &#123; return false &#125; node := r.Root prev := r.Root for i, c := range s &#123; node = node.Next[c] node.Count -= 1 if node.Count == 0 &#123; r.Size -= (len(s) - i) break &#125; prev = node &#125; if node.Count == 0 &#123; delete(prev.Next, rune(node.Char[0])) &#125; else &#123; node.IsWord = false &#125; return true&#125; æœ€åé™„ä¸Šå®Œæ•´ä»£ç ï¼štire","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"data structures","slug":"data-structures","permalink":"http://xupin.im/tags/data-structures/"},{"name":"algorithms","slug":"algorithms","permalink":"http://xupin.im/tags/algorithms/"}]},{"title":"æ•°æ®ç»“æ„ä¸ç®—æ³• - AOI","date":"2022-10-07T16:00:00.000Z","path":"2022/10/08/data-structures-algo-aoi/","text":"AOIï¼ˆArea Of Interestï¼‰ç¿»è¯‘è¿‡æ¥ç§°ä¸ºâ€œæ„Ÿå…´è¶£çš„åŒºåŸŸâ€ï¼Œç”¨äºè®¡ç®—ç©å®¶ä¸ç©å®¶ï¼ˆæˆ–å…¶ä»– Entityï¼‰ä¹‹é—´å½¼æ­¤è¿›å…¥ã€ç¦»å¼€ã€ç§»åŠ¨è§†é‡çš„ç®—æ³•ã€‚é€šä¿—çš„è§£é‡Šæ¯”å¦‚ï¼Œç©å®¶ç¦»å¼€æŸä¸ªåœ°å›¾æ—¶ï¼Œè®¡ç®—å‡ºéœ€è¦é€šçŸ¥çš„å…¶ä»–ç©å®¶ã€‚ AOI æ¨¡å—æ˜¯å¤šäººè”æœºæ¸¸æˆæœåŠ¡å™¨ä¸­å¾ˆé‡è¦çš„åŠŸèƒ½æ¨¡å—ä¹‹ä¸€ï¼ŒAOI æ¨¡å—çš„â€œå¥½â€ä¸â€œåâ€ä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå½±å“æœåŠ¡å™¨çš„æ€§èƒ½ã€‚ æ€è·¯å½“ä¸€ä¸ªç©å®¶è¿›å…¥åœºæ™¯åï¼Œé¦–å…ˆè¦è®¡ç®—å‡ºåœºæ™¯ä¸­çš„å…¶ä»–æ‰€æœ‰ç©å®¶å¹¶æ”¾è¿›å¯¹è±¡é›†åˆï¼ˆåˆç§°è§‚å¯Ÿè€…é›†åˆï¼‰ï¼Œä¹‹åè¯¥ç©å®¶çš„è¿›å…¥ã€ç§»åŠ¨ã€ç¦»å¼€æˆ–å…¶ä»–è¡Œä¸ºéƒ½å°†ä¼šä¸€ä¸€é€šçŸ¥è¯¥é›†åˆå†…çš„ç©å®¶ï¼Œå¹¶ä¸”æ¯ä¸ªç©å®¶éƒ½éœ€è¦ç»´æŠ¤è¿™æ ·ä¸€ä¸ªå¯¹è±¡é›†åˆã€‚ Watchers è§‚å¯Ÿè€…é›†åˆï¼Œå³èƒ½å¤Ÿçœ‹åˆ°æˆ‘çš„å…¶ä»–ç©å®¶æˆ–å®ä½“ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥å¯¹è±¡é›†åˆå†…çš„ç©å®¶åˆ—è¡¨ä¼šéšç€ç©å®¶çš„è¡Œä¸ºå‘ç”Ÿå˜åŒ–ï¼Œåœ¨ç©å®¶ç¦»å¼€åœºæ™¯åæ¸…ç©ºå¯¹è±¡é›†åˆã€‚ å…¨åœºæ™¯åŒæ­¥å³æ¯ä¸ªç©å®¶éƒ½èƒ½çœ‹åˆ°è¿›å…¥è¯¥åœºæ™¯çš„æ‰€æœ‰ç©å®¶ï¼Œé‚£ä¹ˆæ‰€æœ‰è¿›å…¥è¯¥åœºæ™¯çš„ç©å®¶å‘ç”Ÿè¡Œä¸ºï¼ŒAOI åœºæ™¯ç®¡ç†å™¨éƒ½ä¼šé€šçŸ¥å…¶ä»–ç©å®¶ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»åœ°å›¾ 0,0 ç§»åŠ¨è‡³åœ°å›¾ 10,10 è¿™æ ·çš„è¡Œä¸ºã€‚ è¿›å…¥ 123456ç©å®¶[pp]è¿›å…¥åœ°å›¾ 0,0ç©å®¶[wl]è¿›å…¥åœ°å›¾ 2,20 é€šçŸ¥ç©å®¶[pp]è¿›å…¥è§†é‡ç©å®¶[sd]è¿›å…¥åœ°å›¾ 0,4 é€šçŸ¥ç©å®¶[pp]è¿›å…¥è§†é‡ é€šçŸ¥ç©å®¶[wl]è¿›å…¥è§†é‡ ç§»åŠ¨ 123ç©å®¶[sd]è¿›è¡Œç§»åŠ¨ 0,4 -&gt; 0,5 é€šçŸ¥ç©å®¶[pp]è¿›è¡Œç§»åŠ¨ é€šçŸ¥ç©å®¶[wl]è¿›è¡Œç§»åŠ¨ ç¦»å¼€ 123ç©å®¶[sd]ç¦»å¼€åœ°å›¾ é€šçŸ¥ç©å®¶[pp]ç¦»å¼€åœ°å›¾ é€šçŸ¥ç©å®¶[wl]ç¦»å¼€åœ°å›¾ ä½†å¦‚æœåœ°å›¾åœºæ™¯å¤§ã€ç©å®¶æ•°é‡å¤šçš„åœºæ™¯ä¸‹é—®é¢˜å°±å‡¸æ˜¾å‡ºæ¥ï¼ŒæœåŠ¡å™¨é€šä¿¡é‡å°†ä¼šååˆ†å·¨å¤§ï¼ˆç©å®¶ä¸ç©å®¶ä¹‹é—´ï¼‰ã€‚æ¯”å¦‚ï¼Œåœ¨ä¸€æ¬¾å«ã€Šç»åœ°æ±‚ç”Ÿã€‹çš„æ¸¸æˆä¸­æœ€å¤§çš„åœ°å›¾æ˜¯ 8km*8kmï¼Œå‡å¦‚ä¸¤ä¸ªç©å®¶ç›¸è· 6kmï¼Œè¿™ä¸¤ä¸ªç©å®¶å½¼æ­¤ä¹‹é—´è¿˜éœ€è¦é€šä¿¡å—ï¼Ÿ é™åˆ¶ç©å®¶è§†é‡ä¸ºäº†æé«˜æœåŠ¡å™¨è¿è¡Œæ•ˆç‡ï¼Œæ‰€ä»¥éœ€è¦å¯¹ç©å®¶çš„å¯è§†èŒƒå›´ï¼ˆè§†é‡ï¼‰è¿›è¡Œä¸€å®šé™åˆ¶ï¼Œä»è€Œå‡å°‘é€šä¿¡é‡ã€‚å³æ¯ä¸ªç©å®¶éƒ½åªèƒ½çœ‹åˆ°è§†é‡å†…çš„å…¶ä»–ç©å®¶ï¼Œå½“å‘ç”Ÿè¡Œä¸ºæ—¶ä¹Ÿåªä¼šåŒæ­¥ä¿¡æ¯ç»™è¿™äº›ç©å®¶ã€‚ æ¯”å¦‚ï¼Œå½“æ¯ä¸ªç©å®¶éƒ½åªæœ‰ 5 è§†é‡å•ä½æ—¶ï¼š è¿›å…¥ 1234ç©å®¶[pp]è¿›å…¥åœ°å›¾ 0,0ç©å®¶[wl]è¿›å…¥åœ°å›¾ 2,20ç©å®¶[sd]è¿›å…¥åœ°å›¾ 0,4 é€šçŸ¥ç©å®¶[pp]è¿›å…¥è§†é‡ ç§»åŠ¨ 123ç©å®¶[sd]è¿›è¡Œç§»åŠ¨ 0,4 -&gt; 1,20 é€šçŸ¥ç©å®¶[pp]ç¦»å¼€è§†é‡ é€šçŸ¥ç©å®¶[wl]è¿›å…¥è§†é‡ ç¦»å¼€ 12ç©å®¶[sd]ç¦»å¼€åœ°å›¾ é€šçŸ¥ç©å®¶[wl]ç¦»å¼€åœ°å›¾ å¯¹ç©å®¶è¿›è¡Œäº†è§†é‡é™åˆ¶åï¼Œæ¶ˆæ¯é‡ä¼šå¤§å¹…ä¸‹é™ã€‚ä½†å› ä¸ºä¼šå¯¹åœºæ™¯å†…æ‰€æœ‰ç©å®¶è¿›è¡Œæš´åŠ›æŸ¥æ‰¾ï¼Œæ‰€ä»¥æ£€ç´¢æ•ˆç‡å¹¶ä¸é«˜ã€‚ ä¹å®«æ ¼æŠŠåœ°å›¾ç½‘æ ¼åŒ–åï¼Œé™åˆ¶ç©å®¶çš„è§†é‡èŒƒå›´ä¸º 9 ä¸ªæ ¼å­ã€‚å¦‚å›¾ï¼š ä¸€èˆ¬è®¾è®¡æ˜¯ç©å®¶çš„æ‰‹æœºå±å¹•æ˜¾ç¤ºä¸º 4&#x2F;9 æ ¼å­ï¼Œä½†çœŸå®è§†é‡ä¸º 1 ï½ 9 ç½‘æ ¼ï¼Œæ‰€ä»¥æœåŠ¡å™¨åªéœ€è¦åŒæ­¥æ¶ˆæ¯ç»™ç©å®¶å¯è§†èŒƒå›´å†…çš„ 9 ä¸ªç½‘æ ¼å…¶ä»–ç©å®¶ã€‚ è¿›å…¥ æ ¹æ®ç©å®¶åæ ‡è®¡ç®—æ ¼å­ï¼ŒæŠŠç©å®¶åŠ å…¥åˆ°æ ¼å­ã€‚é€šçŸ¥ä¹å®«æ ¼å†…çš„ç©å®¶ï¼Œæœ‰ç©å®¶è¿›å…¥åœºæ™¯ã€‚ ç§»åŠ¨ æ ¼å­æ— å˜åŒ–ï¼Œä»…é€šçŸ¥ç§»åŠ¨è¡Œä¸ºç»™ä¹å®«æ ¼å†…çš„ç©å®¶ã€‚æ ¼å­æœ‰å˜åŒ–ï¼Œå¯¹æ ¼å­è¿›è¡Œäº¤é›†ã€å¹¶é›†è¿ç®—ã€‚å¹¶é›†ï¼Œç¦»å¼€æ ¼å­å¹¶é€šçŸ¥æ ¼å­å†…ç©å®¶ç¦»å¼€è¡Œä¸ºï¼ŒåŠ å…¥æ–°æ ¼å­å¹¶é€šçŸ¥æ ¼å­å†…ç©å®¶è¿›å…¥è¡Œä¸ºã€‚äº¤é›†ï¼Œä»…é€šçŸ¥ç§»åŠ¨è¡Œä¸ºã€‚ ç¦»å¼€ æ ¹æ®ç©å®¶åæ ‡è®¡ç®—æ ¼å­ï¼ŒæŠŠç©å®¶ä»æ ¼å­ç§»é™¤ã€‚é€šçŸ¥ä¹å®«æ ¼å†…çš„ç©å®¶ï¼Œæœ‰ç©å®¶ç¦»å¼€åœºæ™¯ã€‚ ç¯å¡”ç¯å¡”æ˜¯åœ¨ä¹å®«æ ¼çš„åŸºç¡€ä¸Šè¿›è¡Œä¼˜åŒ–ï¼Œåœ¨æŠŠåœ°å›¾ç½‘æ ¼åŒ–çš„åŸºç¡€ä¸Šåˆ’åˆ†åŒºåŸŸï¼ˆæ¯”å¦‚ 4 ä¸ªç½‘æ ¼ç»„æˆä¸€ä¸ªåŒºåŸŸï¼‰ï¼Œæ¯ä¸ªåŒºåŸŸæœ‰ä¸€ä¸ªç®¡ç†è€…ï¼šç¯å¡”ï¼Œè¿™ä¸ªç®¡ç†è€…çŸ¥æ™“å½“å‰åŒºåŸŸçš„å…¨éƒ¨ç©å®¶ã€‚å¦‚å›¾ï¼š æ¯ä¸ªç¯å¡”ç»´æŠ¤ä¸¤ä¸ªå¯¹è±¡é›†åˆï¼šWatchersï¼ˆè§‚å¯Ÿè€…é›†åˆï¼‰ã€Markersï¼ˆè¢«è§‚å¯Ÿè€…é›†åˆï¼‰ã€‚ è¿›å…¥ æ ¹æ®ç©å®¶åæ ‡è®¡ç®—å‡ºç¯å¡”ï¼ŒæŠŠç©å®¶åŠ å…¥åˆ°ç¯å¡”çš„ Markersã€‚é€šçŸ¥è¯¥ç¯å¡”æ‰€æœ‰ Watchersï¼Œæœ‰ç©å®¶è¿›å…¥åœºæ™¯ã€‚æ‰¾å‡ºè¯¥ç©å®¶è§†é‡å†…æ‰€æœ‰ç¯å¡”ï¼ŒæŠŠç©å®¶åŠ å…¥åˆ°ç¯å¡”çš„ Watchersï¼ŒåŒæ—¶æŠŠè¿™äº› Watchers å’Œç©å®¶äº’ç›¸åŠ è¿›å¯¹æ–¹çš„è§†é‡åˆ—è¡¨ã€‚ ç§»åŠ¨ ç¯å¡”æ— å˜åŒ–ï¼Œä»…é€šçŸ¥ç§»åŠ¨è¡Œä¸ºç»™ç©å®¶è§†é‡åˆ—è¡¨å†…çš„ç©å®¶ã€‚ç¯å¡”æœ‰å˜åŒ–ï¼Œå¯¹ç¯å¡”åˆ—è¡¨è¿›è¡Œäº¤é›†ã€å¹¶é›†è¿ç®—ã€‚å¹¶é›†ï¼Œä»ç¦»å¼€ç¯å¡”çš„ Watchersã€Markers ç§»é™¤è¯¥ç©å®¶ï¼Œæ–°è¿›å…¥ç¯å¡”çš„ Watchersã€Markers æ·»åŠ è¯¥ç©å®¶ã€‚ äº¤é›†ï¼Œä»…é€šçŸ¥ç§»åŠ¨è¡Œä¸ºã€‚å¯¹ç§»åŠ¨å‰åç¯å¡”çš„ Watchers è¿›è¡Œå¹¶é›†è¿ç®—ã€‚ä»ç¦»å¼€çš„ Watchers äº’ç›¸ä»å¯¹æ–¹çš„è§†é‡åˆ—è¡¨å†…ç§»é™¤ï¼Œæ–°è¿›å…¥çš„ Watchers äº’ç›¸åŠ è¿›å¯¹æ–¹çš„è§†é‡åˆ—è¡¨ã€‚ ç¦»å¼€ æ ¹æ®ç©å®¶åæ ‡è®¡ç®—å‡ºç¯å¡”ï¼ŒæŠŠç©å®¶ä»è¯¥ç¯å¡”çš„ Markers ä¸­ç§»é™¤ã€‚é€šçŸ¥è¯¥ç¯å¡”æ‰€æœ‰ Watchersï¼Œæœ‰ç©å®¶ç¦»å¼€åœºæ™¯ã€‚æ‰¾å‡ºè¯¥ç©å®¶è§†é‡å†…æ‰€æœ‰ç¯å¡”ï¼ŒæŠŠç©å®¶ä»è¿™äº›ç¯å¡”çš„ Watchers ä¸­ç§»é™¤ï¼ŒåŒæ—¶æŠŠè¯¥ç©å®¶å’Œè§†é‡åˆ—è¡¨å†…çš„æ‰€æœ‰ç©å®¶äº’ç›¸æŠŠå¯¹æ–¹ä»è§†é‡åˆ—è¡¨å†…ç§»é™¤ã€‚ ä¸€èˆ¬è®¾è®¡ä¸Šç¯å¡”åæ ‡æ˜¯éœ€è¦è½¬æ¢çš„ï¼Œç±»ä¼¼äº Redis Cluster çš„ slot æœºåˆ¶ï¼Œé€šè¿‡è½¬æ¢ç©å®¶åæ ‡æ¥åˆ¤æ–­ç¯å¡”å½’å±ã€‚ 123456789101112131415func (r *Aoi) transPos(x, y uint) (uint, uint) &#123; x = uint(math.Floor(float64(x) / float64(r.TowerWidth))) y = uint(math.Floor(float64(y) / float64(r.TowerHeight))) return x, y&#125;func (r *Aoi) getTower(x, y uint) *Tower &#123; x, y = r.transPos(x, y) tower, ok := r.Towers[x][y] if !ok &#123; fmt.Printf(&quot;ç¯å¡”[å¼‚å¸¸]ä¸å­˜åœ¨çš„ç¯å¡”: %d,%d \\n&quot;, x, y) return nil &#125; return tower&#125; åå­—é“¾è¡¨æŠŠ Xã€Y è½´åˆ†åˆ«ä»¥é“¾è¡¨çš„å½¢å¼å­˜å‚¨ï¼Œå°†ç©å®¶çš„åæ ‡åˆ†åˆ«å†™å…¥ Xã€Y é“¾è¡¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸¤ä¸ªé“¾è¡¨çš„æ’åºæ–¹å¼å¿…é¡»ä¸€è‡´ï¼Œæ¯”å¦‚éƒ½æŒ‰ç…§Xã€Yä»å°åˆ°å¤§ã€‚å½“ç©å®¶è¿›å…¥åœºæ™¯åæ ¹æ®å½“å‰åæ ‡åˆ†åˆ«å–å‡º Xã€Y é“¾è¡¨è§†è·å†…çš„ç©å®¶åˆ—è¡¨å–äº¤é›†ï¼Œè¿™å°±æ˜¯å½“å‰ç©å®¶è§†é‡èŒƒå›´å†…çš„å…¶ä»–ç©å®¶ä»¬ã€‚è‡³äºæ˜¯è¿›å…¥ã€ç§»åŠ¨è¿˜æ˜¯ç¦»å¼€è¿™äº›é€»è¾‘éƒ½å’Œä¹å®«æ ¼ã€ç¯å¡”å…¶å®æ˜¯ä¸€æ ·çš„ã€‚ å®šä¹‰ 2 ä¸ªé“¾è¡¨ 12345678910111213141516type Aoi struct &#123; list map[uint32]*node xList *node yList *node VisibleRange uint&#125;type node struct &#123; Id uint32 xPrev *node xNext *node yPrev *node yNext *node x, y uint player *entity.Player&#125; æŸ¥æ‰¾é‚»å±…èŠ‚ç‚¹ 12345678910111213141516171819202122232425262728293031323334func (r *Aoi) findNeighbors(targetNode *node, model string) map[uint32]*node &#123; // æ„Ÿå…´è¶£çš„é‚»å±… neighbors := make(map[uint32]*node, 0) // å‘åæ‰¾ for cur := targetNode.xNext; cur != nil; cur = cur.xNext &#123; // å½“å‰èŠ‚ç‚¹å·²ç»è¶…å‡ºèŒƒå›´ if cur.x-targetNode.x &gt; r.VisibleRange &#123; break &#125; // yè½´ä¸ç¬¦åˆ if abs(int(cur.y-targetNode.y)) &gt; int(r.VisibleRange) &#123; continue &#125; neighbors[cur.Id] = cur &#125; // å‘å‰æ‰¾ for cur := targetNode.xPrev; cur != nil; cur = cur.xPrev &#123; // å½“å‰èŠ‚ç‚¹å·²ç»è¶…å‡ºèŒƒå›´ if targetNode.x-cur.x &gt; r.VisibleRange &#123; fmt.Println(targetNode.x, cur.x) break &#125; // yè½´ä¸ç¬¦åˆ if abs(int(targetNode.y-cur.y)) &gt; int(r.VisibleRange) &#123; continue &#125; // å·²å­˜åœ¨ if _, ok := neighbors[cur.Id]; ok &#123; continue &#125; neighbors[cur.Id] = cur &#125; return neighbors&#125; è¿›å…¥ã€ç§»åŠ¨åŠç¦»å¼€åœ°å›¾ä¸å…¶ä»–æ–¹å¼ä¸€æ · 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455func (r *Aoi) addX(newNode *node) &#123; var ( prev *node cur *node ) for cur = r.xList; cur != nil; cur = cur.xNext &#123; // æ’å…¥curä¹‹å‰ if cur.x &gt; newNode.x &#123; // æ ¹èŠ‚ç‚¹ if cur.xPrev == nil &#123; r.xList = newNode &#125; else &#123; newNode.xPrev = cur.xPrev // å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ cur.xPrev.xNext = newNode // æ–°èŠ‚ç‚¹æˆä¸ºå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ &#125; cur.xPrev = newNode // æ–°èŠ‚ç‚¹ä½œä¸ºå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ newNode.xNext = cur // å½“å‰èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ break &#125; prev = cur &#125; // æ’å…¥å°¾éƒ¨ if prev != nil &amp;&amp; cur == nil &#123; prev.xNext = newNode newNode.xPrev = prev &#125;&#125;func (r *Aoi) addY(newNode *node) &#123; var ( prev *node cur *node ) for cur = r.yList; cur != nil; cur = cur.yNext &#123; // æ’å…¥curä¹‹å‰ if cur.y &gt; newNode.y &#123; // æ ¹èŠ‚ç‚¹ if cur.yPrev == nil &#123; r.yList = newNode &#125; else &#123; newNode.yPrev = cur.yPrev // å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ cur.yPrev.yNext = newNode // æ–°èŠ‚ç‚¹æˆä¸ºå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ &#125; cur.yPrev = newNode // æ–°èŠ‚ç‚¹ä½œä¸ºå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ newNode.yNext = cur // å½“å‰èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ break &#125; prev = cur &#125; // æ’å…¥å°¾éƒ¨ if prev != nil &amp;&amp; cur == nil &#123; prev.yNext = newNode newNode.yPrev = prev &#125;&#125; æœ€åé™„ä¸Šç¤ºä¾‹ï¼š aoi","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"data structures","slug":"data-structures","permalink":"http://xupin.im/tags/data-structures/"},{"name":"algorithms","slug":"algorithms","permalink":"http://xupin.im/tags/algorithms/"}]},{"title":"æ•°æ®ç»“æ„ä¸ç®—æ³• - BitMap","date":"2022-08-23T16:00:00.000Z","path":"2022/08/24/data-structures-algo-bitmap/","text":"BitMapï¼ˆä½å›¾ï¼‰æ˜¯ä¸€ç§ä»¥ bit æ–¹å¼å­˜å‚¨æ•°æ®çš„æ•°æ®ç»“æ„ï¼Œä»¥æ­¤æ¥æé«˜ç©ºé—´åˆ©ç”¨ç‡ã€‚ å®šä¹‰BitMapï¼Œé€šè¿‡å­—é¢æ„æ€ç†è§£åˆ©ç”¨ bit æ˜ å°„æ•°æ®çš„å­˜å‚¨ç»“æ„ã€‚æ‰€ä»¥å®ƒåº”è¯¥æœ‰ Keyã€Valueï¼ŒKey æ˜¯ bitã€Value æ˜¯è¦å­˜å‚¨çš„å…·ä½“çš„å€¼ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡ bit æ¥è®°å½•æ•°æ®æ˜¯å¦å­˜å‚¨ï¼š0 ä¸å­˜åœ¨ã€1 å­˜åœ¨ã€‚ å®šä¹‰ä¸€ä¸ªé•¿åº¦ä¸º 8 çš„ bit æ•°ç»„ï¼Œä» 0 ï½ 7 åˆ†åˆ«æ˜ å°„å¯¹åº”çš„æ•´å‹æ•°å€¼ã€‚ å½“æ•´æ•° 4 å­˜å‚¨æ—¶ï¼Œåˆ™æ”¹å˜å¯¹åº” bit çš„çŠ¶æ€ï¼ˆå€¼ï¼‰ã€‚ è¿™æ ·åšå¸¦æ¥çš„å¥½å¤„ï¼ŒåŒæ ·ä¸€ä¸ªæ•´æ•°åœ¨æ•°ç»„ä¸­å­˜å‚¨éœ€è¦ 4byte*8bit&#x3D;32bit ç©ºé—´ï¼Œåœ¨ BitMap ä¸­åªéœ€è¦ 1bit ç©ºé—´ã€‚ å®ç°é€»è¾‘å®šä¹‰ä¸€ä¸ªå¯ä»¥å­˜å‚¨ 0 ï½ 32 çš„ BitMap 123bits := make([]byte, (32&gt;&gt;3)+1) // 32 &gt;&gt; 3 ç­‰ä»·äº floor(32 / 8)// fmt.Printf(&quot;%08b\\n&quot;, bits)// [00000000 00000000 00000000 00000000 00000000] æŠŠ 31 å­˜å‚¨è¿› BitMapï¼Œåˆ©ç”¨æŒ‰ä½æˆ–æ“ä½œæ”¹å˜ bit å€¼ 123bits[31&gt;&gt;3] |= 1 &lt;&lt; (31 % 8)// æ‹†è§£é€»è¾‘// bits[3] = 00000000 | 10000000 é‡è§æ•°æ®å»é‡ï¼Œåˆ¤æ–­ 31 æ˜¯ä¸æ˜¯å·²å­˜åœ¨ 123bits[31&gt;&gt;3]&amp;1&lt;&lt;(31%8) == 0// æ‹†è§£é€»è¾‘// 10000000 &amp; 10000000 ä» BitMap åˆ é™¤æŒ‡å®šæ•°æ® 1234bits[31&gt;&gt;3] &amp;^= 1 &lt;&lt; (31 % 8)// æ‹†è§£é€»è¾‘// 10000000 &amp; 10000000 = 10000000// 10000000 ^ 10000000 = 00000000 å®Œæ•´ä»£ç ï¼šbitmap ä½æ“ä½œBitMap é€šè¿‡ä½æ“ä½œå»å®ç°ï¼Œæ‰€ä»¥æ¸©ä¹ ä»¥ä¸‹æ“ä½œç¬¦ï¼š æŒ‰ä½ä¸ï¼š&amp; 123// å°†æ“ä½œç¬¦å·¦å³ä¸¤ä¾§æ•°å€¼çš„bitè¿›è¡Œå¯¹åº” &amp;&amp; è¿ç®—4 &amp; 5 = 400000100 &amp; 00000101 = 00000100 æŒ‰ä½æˆ–ï¼š| 123// å°†æ“ä½œç¬¦å·¦å³ä¸¤ä¾§æ•°å€¼çš„bitè¿›è¡Œå¯¹åº” || è¿ç®—4 | 5 = 500000100 | 00000101 = 00000101 æŒ‰ä½å¼‚æˆ–ï¼š^ 123// å°†æ“ä½œç¬¦å·¦å³ä¸¤ä¾§æ•°å€¼çš„bitè¿›è¡Œé€»è¾‘é¢„ç®—ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š1 ^ 1 = 0ã€1 ^ 0 = 1ã€0 ^ 1 = 1ã€0 ^ 0 = 04 ^ 5 = 100000100 ^ 00000101 = 00000001 æŒ‰ä½å–åï¼š^ å…¶ä»–è¯­è¨€ä¸€èˆ¬æ˜¯ ~ï¼ŒGoè¯­è¨€æ˜¯ ^ 123// å°†æ“ä½œç¬¦å³ä¾§æ•°å€¼çš„bitè¿›è¡Œå–åï¼Œ0 -&gt; 1ã€1 -&gt; 0^4 = -5-(00000100 + 00000001) = -0000101 = 10000101 å·¦ç§»ï¼š&lt;&lt; 123// å°†æ“ä½œç¬¦å·¦ä¾§æ•°å€¼çš„bitæŒ‰ç…§å³ä¾§æ•°å€¼è¿›è¡Œå·¦ç§»ï¼ˆæº¢å‡ºä½åˆ™èˆå¼ƒï¼‰4 &lt;&lt; 5 = 128[00000]100 &lt;&lt; 5 = 100[00000] // å·¦ä¾§èˆå¼ƒçš„ä½åœ¨å³ä¾§è¿›è¡Œè¡¥ä½ å³ç§»ï¼š&gt;&gt;å’Œå·¦ç§»åŒç†ï¼Œåªä¸è¿‡æ–¹å‘ç›¸å","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"data structures","slug":"data-structures","permalink":"http://xupin.im/tags/data-structures/"},{"name":"algorithms","slug":"algorithms","permalink":"http://xupin.im/tags/algorithms/"}]},{"title":"æ•°æ®ç»“æ„ä¸ç®—æ³• - JPS","date":"2022-08-11T16:00:00.000Z","path":"2022/08/12/data-structures-algo-jps/","text":"JPS å¯»è·¯ç®—æ³•æ˜¯åŸºäº A*è®¡ç®—è¿‡ç¨‹ä¸­æŸ¥æ‰¾èŠ‚ç‚¹å†—ä½™ã€æ•ˆç‡è¾ƒä½ç­‰é—®é¢˜ä¼˜åŒ–çš„ä¸€ç§ç®—æ³•ã€‚ èƒŒæ™¯A*æ˜¯æ¯”è¾ƒå¸¸è§çš„å¯»è·¯ç®—æ³•ï¼Œä½†å­˜åœ¨ä¸€ä¸ªè¾ƒä¸ºæ˜æ˜¾çš„é—®é¢˜ï¼Œå½“ç§»åŠ¨åˆ°æ–°çš„èŠ‚ç‚¹æ€»æ˜¯ä¼šæŠŠç›¸é‚»èŠ‚ç‚¹ï¼ˆ4ã€8ï¼‰åŠ å…¥åˆ°å¾…æŸ¥æ‰¾åˆ—è¡¨ã€‚è¿™æ ·å¸¦æ¥ä¸¤ä¸ªé—®é¢˜ åœ¨å¤šæ¡ç§»åŠ¨è·¯å¾„æˆæœ¬ç›¸åŒæ—¶ï¼Œå†—ä½™æŸ¥æ‰¾ã€‚ å¾…æŸ¥æ‰¾èŠ‚ç‚¹è¿‡å¤šï¼Œå†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ã€‚ JPSJPS å…¨ç§°â€œJump search pointâ€ï¼Œåˆç§°â€œè·³ç‚¹æœç´¢â€ã€â€œæ‹ç‚¹æœç´¢â€ï¼Œç”±ä¸¤ä½æ¾³å¤§åˆ©äºšæ•™æˆ 2011 å¹´æå‡ºï¼ˆè®ºæ–‡ï¼‰ã€‚ JPS å¯»è·¯ç®—æ³•ä¿ç•™ A*çš„ä¸»ä½“é€»è¾‘ï¼Œä¸ä¸€æ ·çš„æ˜¯ JPS åªä¼šæŠŠæ„Ÿå…´è¶£çš„èŠ‚ç‚¹åŠ å…¥åˆ°å¾…æŸ¥æ‰¾åˆ—è¡¨ï¼Œæ€æ ·è®¡ç®—å‡ºæ„Ÿå…´è¶£çš„èŠ‚ç‚¹å‘¢ï¼Ÿä»¥ä¸‹ 2 ä¸ªæ¦‚å¿µçœ¼ç†Ÿä¸€ä¸‹ å¼ºè¿«é‚»å±… è·³ç‚¹ï¼ˆæ‹ç‚¹ï¼‰ é€šè¿‡æœ‰æ²¡æœ‰å¼ºè¿«é‚»å±…åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦è·³ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ã€‚ å¼ºè¿«é‚»å±…å¼ºè¿«é‚»å±…çš„å®šä¹‰ï¼š èŠ‚ç‚¹ x çš„ 8 ä¸ªé‚»å±…ä¸­æœ‰éšœç¢ï¼Œä¸” x çš„çˆ¶èŠ‚ç‚¹ p ç»è¿‡ x åˆ°è¾¾ n çš„è·ç¦»ä»£ä»·æ¯”ä¸ç»è¿‡ x åˆ°è¾¾çš„ n çš„ä»»æ„è·¯å¾„çš„è·ç¦»ä»£ä»·å°ï¼Œåˆ™ç§° n æ˜¯ x çš„å¼ºè¿«é‚»å±…ã€‚ å…è®¸å¯¹è§’ç§»åŠ¨çš„æƒ…å†µä¸‹ï¼Œæ£€ç´¢æ–¹å‘å¼ºè¿«é‚»å±…èŠ‚ç‚¹çš„æ–¹å¼åˆ†ä¸º 3 ç§ï¼šå¯¹è§’ã€å‚ç›´ã€æ°´å¹³ã€‚ å¯¹è§’ç§»åŠ¨ å‚ç›´ç§»åŠ¨ æ°´å¹³ç§»åŠ¨ ç»¿è‰²æ˜¯çˆ¶èŠ‚ç‚¹ï¼Œçº¢è‰²æ˜¯éšœç¢ç‰©ï¼Œx æ˜¯å½“å‰èŠ‚ç‚¹ï¼Œn æ˜¯å¼ºè¿«é‚»å±…ã€‚ é€šä¿—çš„è§£é‡Šå°±æ˜¯ï¼Œåœ¨æŒ‡å®šç§»åŠ¨æ–¹å‘ä¸Šâ€œå¼ºè¿«â€å½“å‰èŠ‚ç‚¹æ”¹å˜ç§»åŠ¨æ–¹å‘çš„èŠ‚ç‚¹å°±æ˜¯å½“å‰èŠ‚ç‚¹çš„å¼ºè¿«é‚»å±…ï¼ŒåŒæ—¶å½“å‰èŠ‚ç‚¹ä¹Ÿæ˜¯è·³ç‚¹ï¼Œè·³ç‚¹å’Œå¼ºè¿«é‚»å±…éƒ½ç›¸é‚»éšœç¢èŠ‚ç‚¹ã€‚ è·³ç‚¹ï¼ˆæ‹ç‚¹ï¼‰çŸ¥é“å¦‚æœæœ‰å¼ºè¿«é‚»å±…æ”¹å˜å½“å‰èŠ‚ç‚¹ç§»åŠ¨æ–¹å‘ï¼Œé‚£ä¹ˆå½“å‰èŠ‚ç‚¹å°±è¢«è§†ä¸ºè·³ç‚¹ï¼Œè¿™æ˜¯åˆ¤æ–­è·³ç‚¹çš„æ¡ä»¶ä¹‹ä¸€ã€‚åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦è·³ç‚¹çš„ä»»ä¸€æ¡ä»¶ï¼š å½“å‰èŠ‚ç‚¹æ˜¯èµ·ç‚¹æˆ–ç»ˆç‚¹ã€‚ å½“å‰èŠ‚ç‚¹æ‹¥æœ‰å¼ºè¿«é‚»å±…ã€‚ å¦‚æœç§»åŠ¨æ–¹å‘æ˜¯å¯¹è§’ç§»åŠ¨ï¼Œå½“å‰èŠ‚ç‚¹çš„å‚ç›´ã€æ°´å¹³æ–¹å‘ä¸Šçš„èŠ‚ç‚¹æ»¡è¶³æ¡ä»¶ 1 æˆ–æ¡ä»¶ 2ï¼Œå½“å‰èŠ‚ç‚¹ä¸€æ ·è¢«è§†ä¸ºè·³ç‚¹ã€‚ æ¡ä»¶ 3 å¯èƒ½æœ‰äº›éš¾ç†è§£ï¼Œç¤ºæ„å›¾: é»„è‰²ç½‘æ ¼ 1ã€2ã€3 éƒ½æ˜¯è·³ç‚¹ï¼Œç½‘æ ¼ 1 å› ä¸ºæ»¡è¶³â€œå½“å‰èŠ‚ç‚¹çš„å‚ç›´ã€æ°´å¹³æ–¹å‘ä¸Šçš„èŠ‚ç‚¹æ»¡è¶³æ¡ä»¶ 1 æˆ–æ¡ä»¶ 2ï¼Œå½“å‰èŠ‚ç‚¹ä¸€æ ·è¢«è§†ä¸ºè·³ç‚¹â€æ¡ä»¶ï¼ˆç½‘æ ¼ 2 æ˜¯è·³ç‚¹ï¼‰ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯è·³ç‚¹ã€‚ å¯»è·¯æ€è·¯ æŠŠèµ·ç‚¹æ”¾è¿›å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨ã€‚ ä»å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨é‡Œé¢å–å‡ºä¸€ä¸ªï¼Œåˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦æ˜¯ç»ˆç‚¹ï¼Œå¦‚æœä¸æ˜¯åˆ™æŸ¥æ‰¾è¯¥èŠ‚ç‚¹çš„ç›¸é‚»èŠ‚ç‚¹ã€‚ éå†ç›¸é‚»èŠ‚ç‚¹ï¼Œåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²æŸ¥æ‰¾è¿‡ï¼Œå¦åˆ™å¯¹ç›¸é‚»èŠ‚ç‚¹è¿›è¡Œè·³ç‚¹æŸ¥æ‰¾å¹¶å¯¹è·³ç‚¹è¿›è¡Œä¼°ä»·ï¼ŒåŒæ—¶æŠŠå½“å‰èŠ‚ç‚¹è®¾ä¸ºè·³ç‚¹åˆ°çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœè·³ç‚¹æ˜¯ç»ˆç‚¹åˆ™è¿”å›ï¼Œå¦åˆ™æŠŠè·³ç‚¹åŠ å…¥åˆ°å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨ã€‚ å¯¹å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨æŒ‰ f å€¼è¿›è¡Œæ’åºï¼Œå–æœ€å°å€¼ã€‚é‡å¤ 2ã€3ã€4 æ­¥éª¤ï¼Œç›´è‡³æ‰¾åˆ°ç»ˆç‚¹åæ ‡ï¼ˆæœ€ç»ˆçš„è·³ç‚¹ï¼‰ã€‚ å®Œæ•´çš„å¯»è·¯è¿‡ç¨‹ï¼š ä»¥ä¸Šå¯»è·¯è¿‡ç¨‹ï¼ŒJPS å’Œ A*å¯»è·¯è¿‡ç¨‹çš„åŒºåˆ«åœ¨äºè·³ç‚¹æŸ¥æ‰¾ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455// è·³ç‚¹å‡½æ•°// åˆ¤æ–­å½“å‰ç‚¹æ˜¯å¦æ»¡è¶³è·³ç‚¹æ¡ä»¶func (r *Jps) jump(node, parent *Node) *Node &#123; // æ˜¯ç»ˆç‚¹ï¼Œç›´æ¥è¿”å› if r.isEnd(node) &#123; return node &#125; x, y := node.X, node.Y dx, dy := r.direction(node, parent) // å¯¹è§’ç§»åŠ¨ if dx != 0 &amp;&amp; dy != 0 &#123; // [å·¦|å³]ä¸èƒ½èµ° &amp;&amp; [å·¦ä¸Š|å·¦ä¸‹|å³ä¸Š|å³ä¸‹]èƒ½èµ° if !r.isWalkable(x-dx, y) &amp;&amp; r.isWalkable(x-dx, y+dy) &#123; return node &#125; // [ä¸Š|ä¸‹]ä¸èƒ½èµ° &amp;&amp; [å·¦ä¸Š|å³ä¸Š|å·¦ä¸‹|å³ä¸‹]èƒ½èµ° if !r.isWalkable(x, y-dy) &amp;&amp; r.isWalkable(x+dx, y-dy) &#123; return node &#125; // é€’å½’æŸ¥æ‰¾æ–¹å‘[ä¸Š|ä¸‹]ç»§ç»­æŸ¥æ‰¾ if r.isWalkable(x+dx, y) &amp;&amp; r.jump(r.nodes[x+dx][y], node) != nil &#123; return node &#125; // é€’å½’æŸ¥æ‰¾æ–¹å‘[å·¦|å³]ç»§ç»­æŸ¥æ‰¾ if r.isWalkable(x, y+dy) &amp;&amp; r.jump(r.nodes[x][y+dy], node) != nil &#123; return node &#125; &#125; else if dx == 0 &#123; // å‚ç›´ç§»åŠ¨ // å³ä¸èƒ½èµ° &amp;&amp; [å³ä¸‹|å³ä¸Š]èƒ½èµ° if !r.isWalkable(x+1, y) &amp;&amp; r.isWalkable(x+1, y+dy) &#123; return node &#125; // å·¦ä¸èƒ½èµ° &amp;&amp; [å·¦ä¸Š|å·¦ä¸‹]èƒ½èµ° if !r.isWalkable(x-1, y) &amp;&amp; r.isWalkable(x-1, y+dy) &#123; return node &#125; &#125; else &#123; // æ°´å¹³ç§»åŠ¨ // ä¸‹ä¸èƒ½èµ° &amp;&amp; [å·¦ä¸‹|å³ä¸‹]èƒ½èµ° if !r.isWalkable(x, y+1) &amp;&amp; r.isWalkable(x+dx, y+1) &#123; return node &#125; // ä¸Šä¸èƒ½èµ° &amp;&amp; [å·¦ä¸Š|å³ä¸Š]èƒ½èµ° if !r.isWalkable(x, y-1) &amp;&amp; r.isWalkable(x+dx, y-1) &#123; return node &#125; &#125; // é€’å½’æŸ¥æ‰¾æ–¹å‘[å·¦ä¸Š|å·¦ä¸‹|å³ä¸Š|å³ä¸‹]ç»§ç»­æŸ¥æ‰¾ if r.isWalkable(x+dx, y+dy) &#123; if next := r.jump(r.nodes[x+dx][y+dy], node); next != nil &#123; return next &#125; &#125; // æ— å¼ºè¿«é‚»å±…ï¼ˆå½“å‰èŠ‚ç‚¹ä¸æ˜¯è·³ç‚¹ï¼‰æˆ–åˆ°è¾¾è¾¹ç•Œ return nil&#125; åŒæ—¶ï¼Œä¸ºäº†å‡å°‘æŸ¥æ‰¾ä¸å¿…è¦çš„èŠ‚ç‚¹ï¼ŒæŸ¥æ‰¾ç›¸é‚»èŠ‚ç‚¹çš„å‡½æ•°ä¹Ÿæœ‰ä¼˜åŒ– 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061// æŸ¥æ‰¾ç›¸é‚»èŠ‚ç‚¹ä½ç½®func (r *Jps) findNeighbors(node *Node) []*Node &#123; neighbors := make([]*Node, 0) // ç¬¬ä¸€æ¬¡ç§»åŠ¨ if node.Parent == nil &#123; for _, v := range r.neighborPos &#123; x, y := node.X+v[0], node.Y+v[1] // æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦éæ³• if !r.isWalkable(x, y) &#123; continue &#125; neighbors = append(neighbors, r.nodes[x][y]) &#125; &#125; else &#123; // è®¡ç®—å½“å‰èŠ‚ç‚¹ä½äºçˆ¶èŠ‚ç‚¹çš„æ–¹å‘ï¼šæ°´å¹³ã€å‚ç›´å’Œå¯¹è§’æ–¹å‘ x, y := node.X, node.Y dx, dy := r.direction(node, node.Parent) // ç§»åŠ¨æ–¹å‘ä¸Šçš„ä¸‹ä¸€ä¸ª if r.isWalkable(x+dx, y+dy) &#123; neighbors = append(neighbors, r.nodes[x+dx][y+dy]) &#125; // å¯¹è§’ç§»åŠ¨ if dx != 0 &amp;&amp; dy != 0 &#123; // [å·¦|å³]èƒ½èµ° if r.isWalkable(x+dx, y) &#123; neighbors = append(neighbors, r.nodes[x+dx][y]) &#125; // [ä¸Š|ä¸‹]èƒ½èµ° if r.isWalkable(x, y+dy) &#123; neighbors = append(neighbors, r.nodes[x][y+dy]) &#125; // [å·¦|å³]ä¸èƒ½èµ° &amp;&amp; [å·¦ä¸Š|å·¦ä¸‹|å³ä¸Š|å³ä¸‹]èƒ½èµ° if !r.isWalkable(x-dx, y) &amp;&amp; r.isWalkable(x-dx, y+dy) &#123; neighbors = append(neighbors, r.nodes[x-dx][y+dy]) &#125; // [ä¸Š|ä¸‹]ä¸èƒ½èµ° &amp;&amp; [å·¦ä¸Š|å³ä¸Š|å·¦ä¸‹|å³ä¸‹]èƒ½èµ° if !r.isWalkable(x, y-dy) &amp;&amp; r.isWalkable(x+dx, y-dy) &#123; neighbors = append(neighbors, r.nodes[x+dx][y-dy]) &#125; &#125; else if dx == 0 &#123; // å‚ç›´ç§»åŠ¨ // å³ä¸èƒ½èµ° &amp;&amp; [å³ä¸‹|å³ä¸Š]èƒ½èµ° if !r.isWalkable(x+1, y) &amp;&amp; r.isWalkable(x+1, y+dy) &#123; neighbors = append(neighbors, r.nodes[x+1][y+dy]) &#125; // å·¦ä¸èƒ½èµ° &amp;&amp; [å·¦ä¸Š|å·¦ä¸‹]èƒ½èµ° if !r.isWalkable(x-1, y) &amp;&amp; r.isWalkable(x-1, y+dy) &#123; neighbors = append(neighbors, r.nodes[x-1][y+dy]) &#125; &#125; else &#123; // æ°´å¹³ç§»åŠ¨ // ä¸‹ä¸èƒ½èµ° &amp;&amp; [å·¦ä¸‹|å³ä¸‹]èƒ½èµ° if !r.isWalkable(x, y+1) &amp;&amp; r.isWalkable(x+dx, y+1) &#123; neighbors = append(neighbors, r.nodes[x+dx][y+1]) &#125; // ä¸Šä¸èƒ½èµ° &amp;&amp; [å·¦ä¸Š|å³ä¸Š]èƒ½èµ° if !r.isWalkable(x, y-1) &amp;&amp; r.isWalkable(x+dx, y-1) &#123; neighbors = append(neighbors, r.nodes[x+dx][y-1]) &#125; &#125; &#125; return neighbors&#125; å®Œæ•´ä»£ç ï¼šjps å…³äºå…¶ä»–ä¼˜åŒ–ç‚¹æœ‰å¾ˆå¤šå€¼å¾—ä¼˜åŒ–çš„ç»†èŠ‚ï¼Œ å› ä¸ºæ˜¯ç½‘æ ¼å¯»è·¯ï¼Œå®¢æˆ·ç«¯è§’è‰²èµ°è·¯ä¼šå‡ºç°æ‹ç›´è§’çš„è¡¨ç°ï¼ˆå¹³æ»‘è·¯å¾„ï¼Œæ¯”å¦‚ï¼šå¼—æ´›ä¼Šå¾·ç®—æ³•ï¼‰ã€‚ å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨å¯ä»¥ç”¨äºŒå‰å †å®ç°ï¼Œæ’å…¥å’Œå¼¹å‡ºæ•ˆç‡éƒ½å¾ˆé«˜ã€‚ åœ°å›¾èŠ‚ç‚¹ä½¿ç”¨æ•°ç»„å­˜å‚¨ï¼Œæ£€ç´¢æ•ˆç‡è¾ƒé«˜ã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"data structures","slug":"data-structures","permalink":"http://xupin.im/tags/data-structures/"},{"name":"algorithms","slug":"algorithms","permalink":"http://xupin.im/tags/algorithms/"}]},{"title":"æ•°æ®ç»“æ„ä¸ç®—æ³• - AStar(A*)","date":"2022-07-31T16:00:00.000Z","path":"2022/08/01/data-structures-algo-astar/","text":"å¯»è·¯ç®—æ³•æ˜¯æ¸¸æˆæ¯”è¾ƒé‡è¦çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ï¼Œå°¤å…¶åœ¨å›½å†…æ¸¸æˆå¾ˆå¸¸è§çš„è‡ªåŠ¨å¯»è·¯ç³»ç»Ÿï¼Œæ¯”å¦‚æ“çºµè§’è‰²ä» A ç‚¹åˆ° B ç‚¹çš„ç§»åŠ¨ã€‚è®¡ç®—æœ€çŸ­è·¯å¾„æœ‰å¾ˆå¤šä¸åŒçš„ç®—æ³•ï¼Œæ¯”å¦‚ï¼šDijkstraã€AStarï¼ˆA*ï¼‰ã€NavMeshï¼ˆå¤šè¾¹å½¢ç®—æ³•ï¼‰ã€RVO åŠ¨æ€é¿éšœç­‰ç­‰ A*å¯»è·¯ç®—æ³•å¯»è·¯ç®—æ³•çš„ç§»åŠ¨è·¯å¾„æ ¸å¿ƒæœ‰ 2 ç‚¹ï¼šæœ€çŸ­ã€å¯ç§»åŠ¨ã€‚ æ‰€ä»¥é¦–å…ˆéœ€è¦ç¡®å®šèµ·ç‚¹åæ ‡çš„ç›¸é‚»èŠ‚ç‚¹ï¼ˆ4 æ–¹å‘ã€8 æ–¹å‘ï¼‰ï¼Œç„¶åé€šè¿‡è®¡ç®—æœ€é è¿‘ç»ˆç‚¹åæ ‡çš„ç›¸é‚»åæ ‡ï¼ˆä¸è€ƒè™‘éšœç¢ç‰©ï¼‰ç¡®è®¤æ£€ç´¢æ–¹å‘ï¼Œå†å»è®¡ç®—â€œç›¸é‚»åæ ‡â€ç§»åŠ¨çš„ä¸‹ä¸€ä¸ªåæ ‡ï¼ˆè·ç¦»ç»ˆç‚¹åæ ‡æœ€è¿‘ &amp; å¯ç§»åŠ¨ï¼‰ï¼Œé‡å¤è®¡ç®—è¿™ä¸ªè¿‡ç¨‹ç›´è‡³æ‰¾åˆ°ç»ˆç‚¹åæ ‡ï¼Œè¿™å°±æ˜¯ A*ç®—æ³• A*ç®—æ³•æ˜¯ä¸€ç±»åŸºäºç½‘æ ¼çš„å¯»è·¯ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯æŠŠåœ°å›¾çœ‹ä½œä¸€ä¸ªç”±ç½‘æ ¼ç»„æˆçš„çŸ©é˜µï¼Œæ¯ä¸ªåæ ‡å°±æ˜¯ä¸€ä¸ªç½‘æ ¼ã€‚ ä¸€å¼  3x3 åœ°å›¾ å¯å‘å‡½æ•°ä»èµ·ç‚¹ç§»åŠ¨åˆ°ç»ˆç‚¹åæ ‡å¯èƒ½ä¼šäº§ç”Ÿå¤šæ¡ç§»åŠ¨è·¯å¾„ï¼Œæ‰€ä»¥è¿˜éœ€è¦è®¡ç®—å‡ºå“ªæ¡ç§»åŠ¨è·¯å¾„æœ€çŸ­ï¼Œä¸ç„¶è¶Šèµ°è¶Šè¿œå°±æ¼”å˜æˆã€Šè®ºè¿°å¦‚ä½•å¸®åŠ©ç©å®¶åˆ·å¾®ä¿¡æ­¥æ•°ã€‹çš„å°´å°¬æƒ…å†µã€‚ åœ¨ç½‘æ ¼åœ°å›¾ä¸­è‚¯å®šæ˜¯ç»è¿‡è¶Šå°‘çš„ç½‘æ ¼è·¯å¾„å°±è¶ŠçŸ­ï¼Œä½†æˆ‘ä»¬ä¸å¯èƒ½æŠŠæ¯æ¡å¯èƒ½çš„è·¯å¾„éƒ½èµ°ä¸€éå†é€‰å‡ºå“ªæ¡è·¯å¾„æœ€çŸ­ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œè¯„ä¼°æ¥ä¸‹æ¥èµ°å“ªä¸ªç½‘æ ¼æœ€è¿‘ã€‚ å‡è®¾æˆ‘ä»¬æŠŠç½‘æ ¼ç›´çº¿ï¼ˆæ°´å¹³ã€å‚ç›´ï¼‰ç§»åŠ¨æˆæœ¬è®¾ä¸º 1ã€å¯¹è§’ç§»åŠ¨æˆæœ¬è®¾ä¸ºï¼š1.4ã€‚ç„¶åæŠŠç§»åŠ¨è·¯å¾„ä¸Šçš„åæ ‡çš„æˆæœ¬è¿›è¡Œç›¸åŠ å–å‡ºæœ€å°å€¼å³å¯èƒ½æ˜¯å½“å‰æœ€ä½³ç§»åŠ¨è·¯å¾„ã€‚ è¿™ä¹Ÿå«å¯å‘å¼ç®—æ³•ï¼Œå³ä¼˜å…ˆæ£€ç´¢å¯èƒ½æ˜¯æˆæœ¬æœ€ä½çš„ç½‘æ ¼ã€‚ ä¼°ä»·å…¬å¼æˆ‘ä»¬ä¸å¯èƒ½æŠŠæ¯æ¡å¯èƒ½çš„è·¯å¾„éƒ½èµ°ä¸€éï¼Œæ‰€ä»¥é€šè¿‡ä¼°ä»·å…¬å¼ï¼šf = g + hï¼Œæ¥è¯„ä¼°æ¥ä¸‹æ¥èµ°å“ªä¸€ä¸ªç½‘æ ¼ã€‚ g ä»èµ·ç‚¹åæ ‡ç§»åŠ¨åˆ°å½“å‰åæ ‡çš„ç§»åŠ¨æˆæœ¬ï¼ˆç½‘æ ¼æ•°ï¼‰ h ä»å½“å‰åæ ‡ç§»åŠ¨åˆ°ç»ˆç‚¹åæ ‡çš„ç§»åŠ¨æˆæœ¬ f å½“å‰åæ ‡çš„ç§»åŠ¨æˆæœ¬ é€šè¿‡è¿™æ ·ä¸€ä¸ªç½‘æ ¼ç§»åŠ¨æˆæœ¬çš„è¯„ä¼°å…¬å¼ï¼Œå¯ä»¥å¤§æ¦‚è®¡ç®—å‡ºä»èµ·ç‚¹ç½‘æ ¼ç§»åŠ¨è‡³ç»ˆç‚¹ç½‘æ ¼çš„è·¯å¾„ä¸­ï¼Œä¸‹ä¸€æ­¥èµ°å“ªä¸€ä¸ªç½‘æ ¼å¯èƒ½è·¯å¾„æœ€çŸ­ã€‚ ç§»åŠ¨æˆæœ¬æ€ä¹ˆè®¡ç®—ç§»åŠ¨æˆæœ¬ï¼Ÿä½¿ç”¨è·ç¦»ç®—æ³•ä½œä¸ºä¼°ä»·å‡½æ•°å¯¹ç½‘æ ¼è¿›è¡Œä¼°ä»·ã€‚æ¯”å¦‚ä»¥ä¸‹çš„è·ç¦»ç®—æ³•ï¼ˆä¸ä»…é™äºï¼‰ï¼š æ¬§æ°è·ç¦» æ›¼å“ˆé¡¿è·ç¦» åˆ‡æ¯”é›ªå¤«è·ç¦» 45 åº¦è§’è®¡ç®—ï¼ˆOctileï¼‰ ä¸åŒçš„è·ç¦»ç®—æ³•åœ¨ä¸åŒçš„åœºæ™¯ä¸Šè¡¨ç°ä¸ä¸€ï¼Œæ¯”å¦‚è¯´åœ¨é™æ€ç½‘æ ¼åœ°å›¾åœºæ™¯ä¸­ æ¬§æ°è·ç¦» ä¼˜ç‚¹ï¼š è®¡ç®—ç›´çº¿è·ç¦»ï¼Œç§»åŠ¨è·¯å¾„æœ€çŸ­ã€‚ ç¼ºç‚¹ï¼š è®¡ç®—è¿‡ç¨‹ä¸­ä¼´éšç€å¹³æ–¹ä¸å¼€æ ¹å·è¿ç®—ï¼Œå¹¶ä¸”éœ€è¦ä½¿ç”¨æµ®ç‚¹æ•°ï¼Œæ€§èƒ½å·®ã€‚ å› ä¸ºæ˜¯ç½‘æ ¼æ‰€ä»¥åŸºæœ¬ä¸èƒ½æŒ‰ç…§ç›´çº¿è¿›è¡Œç§»åŠ¨ï¼Œç²¾ç¡®åº¦ä¸å¤Ÿã€‚ æ›¼å“ˆé¡¿è·ç¦» ä¼˜ç‚¹ï¼š è®¡ç®—è¿‡ç¨‹ä¸å­˜åœ¨æµ®ç‚¹æ•°ï¼Œæ€§èƒ½è¾ƒé«˜ã€‚ ç¼ºç‚¹ï¼š åªå¯ä»¥å‚ç›´æˆ–è€…æ°´å¹³ç§»åŠ¨ã€‚ æ‰€ä»¥åœ¨å¯¹ 4 æ–¹å‘ã€8 æ–¹å‘åˆæˆ–è€… 6 æ–¹å‘ä¸Šçš„ç®—æ³•é€‰æ‹©æ˜¯ä¸ä¸€æ ·çš„ã€‚æ¯”å¦‚ 4 æ–¹å‘ç§»åŠ¨ä¸Šä¸‹å·¦å³ä½¿ç”¨æ›¼å“ˆé¡¿è·ç¦»æ¥è¿›è¡Œä¼°ä»·å°±å®Œå…¨è¶³å¤Ÿï¼Œä½†å¦‚æœæ˜¯ 8 æ–¹å‘ç§»åŠ¨å°±ä¸å¯ä»¥ï¼ˆå¯ä»¥å¯¹è§’ç§»åŠ¨ï¼‰ã€‚ æ‰€ä»¥ï¼Œå¦‚æœæ˜¯ 8 æ–¹å‘ç§»åŠ¨çš„åœºæ™¯é€šå¸¸ä¼šé‡‡ç”¨æ›¼å“ˆé¡¿+å¯¹è§’è®¡ç®—çš„è·ç¦»ç®—æ³•ã€‚ å¯»è·¯æ€è·¯ç¤ºä¾‹ï¼š3x3 &amp; æ— éšœç¢çš„åœ°å›¾ ç»¿è‰²æ˜¯èµ·ç‚¹ï¼Œè“è‰²æ˜¯ç»ˆç‚¹ æŠŠèµ·ç‚¹æ”¾è¿›å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨ã€‚ ä»å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨é‡Œé¢å–å‡ºä¸€ä¸ªï¼Œåˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦æ˜¯ç»ˆç‚¹ï¼Œå¦‚æœä¸æ˜¯åˆ™æŸ¥æ‰¾è¯¥èŠ‚ç‚¹çš„ç›¸é‚»èŠ‚ç‚¹ï¼Œæ‰¾åˆ° 3 ä¸ªèŠ‚ç‚¹åˆ†åˆ«æ˜¯å³ã€å³ä¸‹ã€ä¸‹ã€‚ éå†ç›¸é‚»èŠ‚ç‚¹ï¼Œåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²æŸ¥æ‰¾è¿‡ï¼Œå¦åˆ™å¯¹ 3 ä¸ªç›¸é‚»èŠ‚ç‚¹çš„è¿›è¡Œä¼°ä»·ï¼ˆå› ä¸ºä½¿ç”¨æ›¼å“ˆé¡¿ç®—æ³•æ‰€ä»¥æŠŠæµ®ç‚¹æ•°æ”¾å¤§10å€ï¼‰ï¼Œå¹¶æŠŠç»¿è‰²èŠ‚ç‚¹è®¾ä¸º 3 ä¸ªç›¸é‚»èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœæŸä¸€ç›¸é‚»èŠ‚ç‚¹æ˜¯ç»ˆç‚¹åˆ™è¿”å›ï¼Œå¦åˆ™æŠŠç›¸é‚»èŠ‚ç‚¹åŠ å…¥åˆ°å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨ã€‚ 1234561. å³ èµ·ç‚¹è·ç¦»è¯¥èŠ‚ç‚¹æ°´å¹³ç§»åŠ¨ä¸€ä¸ªç½‘æ ¼ï¼Œæ‰€ä»¥g = 10ã€‚è¯¥èŠ‚ç‚¹åˆ°ç»ˆç‚¹å¯¹è§’ç§»åŠ¨ä¸€ä¸ªç½‘æ ¼ï¼Œæ‰€ä»¥h = 14ã€‚æœ€ç»ˆè¯¥èŠ‚ç‚¹çš„ç§»åŠ¨æˆæœ¬ï¼š14ï¼ˆf = g + h ï¼‰ã€‚2. å³ä¸‹ èµ·ç‚¹è·ç¦»è¯¥èŠ‚ç‚¹å¯¹è§’ç§»åŠ¨ä¸€ä¸ªç½‘æ ¼ï¼Œæ‰€ä»¥g = 14ã€‚è¯¥èŠ‚ç‚¹åˆ°ç»ˆç‚¹å‚ç›´ç§»åŠ¨ä¸€ä¸ªç½‘æ ¼ï¼Œæ‰€ä»¥h = 10ã€‚æœ€ç»ˆè¯¥èŠ‚ç‚¹çš„ç§»åŠ¨æˆæœ¬ï¼š14ï¼ˆf = g + h ï¼‰ã€‚3. ä¸‹ èµ·ç‚¹è·ç¦»è¯¥èŠ‚ç‚¹å‚ç›´ç§»åŠ¨ä¸€ä¸ªç½‘æ ¼ï¼Œæ‰€ä»¥g = 10ã€‚è¯¥èŠ‚ç‚¹åˆ°ç»ˆç‚¹æ°´å¹³ç§»åŠ¨ä¸¤ä¸ªç½‘æ ¼ï¼Œæ‰€ä»¥h = 20ã€‚æœ€ç»ˆè¯¥èŠ‚ç‚¹çš„ç§»åŠ¨æˆæœ¬ï¼š30ï¼ˆf = g + h ï¼‰ã€‚ å¯¹å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨æŒ‰ f å€¼è¿›è¡Œæ’åºï¼Œå–æœ€å°å€¼ã€‚é‡å¤ 2ã€3ã€4 æ­¥éª¤ï¼Œç›´è‡³æ‰¾åˆ°ç»ˆç‚¹åæ ‡ã€‚ ä»£ç å®ç°ï¼ˆé™„ä¸Šå®Œæ•´ä»£ç ï¼‰é¦–å…ˆæœ€åŸºç¡€çš„æ˜¯æŠŠåœ°å›¾è¿›è¡Œç½‘æ ¼åŒ–ã€‚ 123456789101112131415/*åœ°å›¾ä»å·¦ä¸Šè§’å¼€å§‹ï¼Œæ°´å¹³x å‚ç›´y yx 0,0 1,0 2,0 0,1 1,1 2,1 0,2 1,2 2,2*/// 0æ˜¯å¯ç§»åŠ¨èŠ‚ç‚¹ã€1æ˜¯éšœç¢èŠ‚ç‚¹mapData := [][]int&#123; &#123;0, 0, 1, 1, 0, 0, 0, 0&#125;, &#123;0, 0, 0, 0, 1, 0, 0, 0&#125;, &#123;0, 0, 0, 1, 1, 0, 0, 0&#125;, &#123;0, 0, 0, 0, 1, 0, 0, 0&#125;, &#123;0, 0, 0, 0, 0, 0, 0, 0&#125;,&#125; æ¯ä¸ªèŠ‚ç‚¹ï¼ˆç½‘æ ¼ï¼‰å¯¹åº”ä¸€ä¸ªåæ ‡ï¼Œå› ä¸ºä¼°ä»·éœ€è¦åŒæ—¶æ¯ä¸ªèŠ‚ç‚¹è¿˜å­˜å‚¨ç€ fã€gã€h å€¼ã€‚ 12345678910111213141516// èŠ‚ç‚¹type Node struct &#123; // åæ ‡ X int Y int // æˆæœ¬ F int G int H int // çˆ¶èŠ‚ç‚¹ Parent *Node // ç±»å‹ Type int // çŠ¶æ€ State int&#125; æœ‰äº†èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿˜éœ€è¦å®šä¹‰æ¯ä¸ªèŠ‚ç‚¹æœ‰å“ªäº›é‚»å±…ï¼ˆè¿™é‡Œæ˜¯ 8 æ–¹å‘ï¼‰ 1234567891011// å¦‚æœä¸å…è®¸å¯¹è§’ç§»åŠ¨ï¼Œå»é™¤å¯¹è§’åæ ‡neighborPos = [][]int&#123; &#123;0, -1&#125;, // ä¸Š &#123;1, -1&#125;, // å³ä¸Š &#123;1, 0&#125;, // å³ &#123;1, 1&#125;, // å³ä¸‹ &#123;0, 1&#125;, // ä¸‹ &#123;-1, 1&#125;, // å·¦ä¸‹ &#123;-1, 0&#125;, // å·¦ &#123;-1, -1&#125;, // å·¦ä¸Š&#125; å¹¶ä¸æ˜¯æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦æŸ¥æ‰¾ï¼Œæ‰€ä»¥è¿˜éœ€è¦å®šä¹‰å¾…æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨ã€å·²æŸ¥æ‰¾èŠ‚ç‚¹åˆ—è¡¨ï¼ˆå·²æŸ¥æ‰¾è¿‡çš„èŠ‚ç‚¹ä¼šè¢«å¿½ç•¥ï¼‰ã€‚ 1var openList, closeList []*Node æœ€åï¼ŒæŸ¥æ‰¾èŠ‚ç‚¹çš„é€»è¾‘ï¼ˆè¿™é‡Œå·æ‡’ï¼Œç›´æ¥è´´ä¸Šå°è£…è¿‡çš„é€»è¾‘ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071type AStar struct &#123; // å¯å‘ç®—æ³• Heuristic func(node, end *Node) int // åœ°å›¾å¤§å° Rows int // y Cols int // x // åœ°å›¾èŠ‚ç‚¹ nodes [][]*Node start *Node end *Node // å¼€æ”¾ã€å…³é—­åˆ—è¡¨ openList []*Node closeList []*Node // ç›¸é‚»èŠ‚ç‚¹åæ ‡ neighborPos [][]int&#125;func (r *AStar) FindPath(start, end *Node) *Node &#123; r.start = r.nodes[start.X][start.Y] r.end = r.nodes[end.X][end.Y] // å¦‚æœèµ·æ­¢ç‚¹æ˜¯éšœç¢ç‰© if !r.start.isWalkable() || !r.end.isWalkable() &#123; fmt.Println(&quot;éšœç¢ç‰©ä¸å¯ç§»åŠ¨&quot;) return nil &#125; // å…ˆæŠŠå¼€å§‹èŠ‚ç‚¹æ”¾è¿›å¼€æ”¾åˆ—è¡¨ r.openListAppend(start) for len(r.openList) &gt; 0 &#123; node := r.openListPop() // åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯ç»ˆç‚¹ if r.isEnd(node) &#123; return node &#125; // æ‰¾å¼€æ”¾åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ç›¸é‚»èŠ‚ç‚¹ neighbors := r.findNeighbors(node) for _, neighbor := range neighbors &#123; // æ˜¯å¦åœ¨å…³é—­åˆ—è¡¨ if neighbor.isClosed() &#123; continue &#125; // å¼€å§‹èŠ‚ç‚¹ç§»åŠ¨è‡³å½“å‰èŠ‚ç‚¹çš„æˆæœ¬ // ç›¸é‚»èŠ‚ç‚¹çš„åæ ‡x,y // å¼€å§‹èŠ‚ç‚¹ç§»åŠ¨è‡³ç›¸é‚»èŠ‚ç‚¹çš„æˆæœ¬ g, x, y := node.G, neighbor.X, neighbor.Y // åˆ¤æ–­ç§»åŠ¨æ–¹å¼æ˜¯æ°´å¹³ï¼ˆæˆ–å‚ç›´ï¼‰ã€å¯¹è§’ï¼Œè®¡ç®—æˆæœ¬ if x == node.X || y == node.Y &#123; g += COST_STRAIGHT &#125; else &#123; g += COST_DIAGONAL &#125; if !neighbor.isOpened() || g &lt; neighbor.G &#123; neighbor.G = g neighbor.H = r.Heuristic(neighbor, end) neighbor.F = neighbor.G + neighbor.H neighbor.Parent = node // ä¼˜åŒ–é€»è¾‘ï¼Œç›¸é‚»èŠ‚ç‚¹æ˜¯å¦æ˜¯ç»ˆç‚¹ // if r.isEnd(neighbor) &#123; // return neighbor // &#125; if !neighbor.isOpened() &#123; r.openListAppend(neighbor) &#125; &#125; &#125; // å½“å‰èŠ‚ç‚¹æ”¾è¿›å…³é—­åˆ—è¡¨ r.closeListAppend(node) // æ›´æ–°å¼€æ”¾åˆ—è¡¨é¡ºåº r.openListSort() &#125; return nil&#125; ä¸ºä»€ä¹ˆè¦ç»™èŠ‚ç‚¹å®šä¹‰çˆ¶èŠ‚ç‚¹ï¼Ÿ è¿™é‡Œä½¿ç”¨é“¾è¡¨è®°å½•ç§»åŠ¨è·¯å¾„ï¼Œå³é€šè¿‡ç»ˆç‚¹èŠ‚ç‚¹ä¸æ–­è¿­ä»£çˆ¶èŠ‚ç‚¹æ‰“å°å‡ºå®Œæ•´è·¯å¾„ã€‚ å®Œæ•´ä»£ç ï¼šastar","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"data structures","slug":"data-structures","permalink":"http://xupin.im/tags/data-structures/"},{"name":"algorithms","slug":"algorithms","permalink":"http://xupin.im/tags/algorithms/"}]},{"title":"æ•°æ®ç»“æ„ä¸ç®—æ³• - Linked list","date":"2022-07-18T16:00:00.000Z","path":"2022/07/19/data-structures-algo-linked-list/","text":"é“¾è¡¨æ˜¯ä¸€ç§ä¸éœ€è¦è¿ç»­ç©ºé—´å­˜å‚¨çš„çº¿æ€§æ•°æ®ç»“æ„ï¼Œé€šè¿‡æŒ‡é’ˆæŠŠæ•°æ®èŠ‚ç‚¹é“¾æ¥èµ·æ¥ã€‚æ•°æ®èŠ‚ç‚¹çš„é€»è¾‘é¡ºåºå–å†³äºé“¾è¡¨æŒ‡é’ˆé“¾æ¥çš„å…ˆåé¡ºåºï¼ŒåŒæ—¶ï¼Œé“¾è¡¨ä¹Ÿæœ‰ï¼šå•é“¾è¡¨ã€åŒé“¾è¡¨ã€å¾ªç¯é“¾è¡¨ç­‰å¤šç±»ã€‚ å®šä¹‰é“¾è¡¨æ˜¯ç”±ä¸€ç³»åˆ—èŠ‚ç‚¹ç»„æˆï¼Œé™¤æ­¤ä¹‹å¤–é“¾è¡¨è¿˜æœ‰å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼š æ•°æ®èŠ‚ç‚¹ ä¸€èˆ¬ç”±ä¸¤å—ç»„æˆï¼šæ•°æ®åŸŸã€æŒ‡é’ˆåŸŸã€‚ é¦–å…ƒèŠ‚ç‚¹ é“¾è¡¨çš„ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ã€‚ å¤´èŠ‚ç‚¹ éå¿…è¦èŠ‚ç‚¹ï¼Œæ”¾åœ¨ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹å‰ã€‚ä¸€èˆ¬ç”¨äºå­˜å‚¨é“¾è¡¨çš„ä¿¡æ¯ï¼ˆæ¯”å¦‚è¯´é“¾è¡¨é•¿åº¦ç­‰ï¼‰å’Œä¿è¯æ•°æ®èŠ‚ç‚¹æ“ä½œçš„ç»Ÿä¸€æ€§ã€‚ å¤´æŒ‡é’ˆ æŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå¦‚æœæœ‰å¤´èŠ‚ç‚¹åˆ™æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œå¦åˆ™æŒ‡å‘é¦–å…ƒèŠ‚ç‚¹ã€‚ å•é“¾è¡¨æœ€ç®€å•çš„ä¸€ç§é“¾è¡¨ï¼Œåªæ”¯æŒä¸€ä¸ªéå†æ–¹å‘ï¼šé“¾å¤´ -&gt; é“¾å°¾ã€‚ä¸¤éƒ¨åˆ†ç»„æˆï¼šå½“å‰èŠ‚ç‚¹çš„æ•°æ®ã€æŒ‡å‘åç½®èŠ‚ç‚¹çš„æŒ‡é’ˆï¼ˆå°¾èŠ‚ç‚¹æŒ‡é’ˆæŒ‡å‘nilï¼‰ã€‚ ä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031323334353637type Node struct &#123; V string Next *Node&#125;func main() &#123; // å¤´èŠ‚ç‚¹ head := &amp;Node&#123; V: &quot;head node&quot;, &#125; // èŠ‚ç‚¹1 node := &amp;Node&#123; V: &quot;node1&quot;, &#125; head.Next = node // èŠ‚ç‚¹2 node2 := &amp;Node&#123; V: &quot;node2&quot;, &#125; node.Next = node2 // èŠ‚ç‚¹3 node3 := &amp;Node&#123; V: &quot;node3&quot;, &#125; node2.Next = node3 // å¤´æŒ‡é’ˆ -&gt; å¤´èŠ‚ç‚¹ linkedList := head for linkedList.Next != nil &#123; // æ‰“å°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å€¼ï¼ˆè¿™å—å°±ä½“ç°å‡ºå¤´èŠ‚ç‚¹çš„å¥½å¤„ï¼Œé¦–å…ƒèŠ‚ç‚¹å’Œå…¶ä»–æ•°æ®èŠ‚ç‚¹çš„æ“ä½œä¸€è‡´ï¼‰ fmt.Println(linkedList.Next.V) linkedList = linkedList.Next &#125;&#125; ä»¥ä¸Šæ˜¯å•é“¾è¡¨çš„ç®€å•å®ç°ï¼Œå…¶ä¸­æ·»åŠ èŠ‚ç‚¹çš„æ“ä½œä¹Ÿè¢«ç§°ä¸ºï¼šå°¾æ’æ³•ï¼Œå°è£…ä¸€ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445type Node struct &#123; V string Next *Node&#125;type List struct &#123; Head *Node&#125;func main() &#123; list := &amp;List&#123;&#125; n1 := &amp;Node&#123;V: &quot;node1&quot;&#125; n2 := &amp;Node&#123;V: &quot;node2&quot;&#125; n3 := &amp;Node&#123;V: &quot;node3&quot;&#125; list.Append(n1) list.Append(n2) list.Append(n3) list.Traverse() // è¾“å‡ºç»“æœï¼šnode1-&gt;node2-&gt;node3-&gt;nil&#125;// å°¾æ’æ³•func (l *List) Append(node *Node) &#123; if l.Head == nil &#123; l.Head = node &#125; else &#123; now := l.Head for now.Next != nil &#123; now = now.Next &#125; now.Next = node &#125;&#125;// éå†func (l *List) Traverse() &#123; now := l.Head for now != nil &#123; if now.Next == nil &#123; print(now.V, &quot;-&gt;&quot;, &quot;nil&quot;) &#125; else &#123; print(now.V, &quot;-&gt;&quot;) &#125; now = now.Next &#125;&#125; å¦‚æœæœ‰æ•°æ®èŠ‚ç‚¹æƒ³è¦æ’é˜Ÿï¼Œæ€ä¹ˆåŠï¼Ÿå¤´æ’æ³•ï¼Œæ€è·¯å°±æ˜¯ï¼šæŠŠå¤´èŠ‚ç‚¹ä½œä¸ºæ–°å¢èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ï¼Œæ–°å¢èŠ‚ç‚¹ä½œä¸ºæ–°çš„å¤´èŠ‚ç‚¹ã€‚ 12345678func (l *List) Insert(node *Node) &#123; if l.Head == nil &#123; l.Head = node &#125; else &#123; node.Next = l.Head l.Head = node &#125;&#125; è¿˜æƒ³æŠŠé“¾è¡¨åè½¬ï¼Œæ•°æ®èŠ‚ç‚¹é€†åºå‘¢ï¼Ÿæœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œæ¯”å¦‚ï¼šåˆ©ç”¨åŒæŒ‡é’ˆè¿­ä»£ã€é€’å½’ç­‰ç­‰ è¿­ä»£ï¼Œæ€è·¯å’Œå¤´æ’æ³•ä¸€è‡´ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354func (l *List) Reverse() &#123; if l.Head == nil &#123; return &#125; // å£°æ˜ä¸€ä¸ªå¤´èŠ‚ç‚¹ var head *Node // å¼€å§‹éå†é“¾è¡¨ï¼Œ // ç¬¬ä¸€æ¬¡ï¼Œheadï¼šnode1 -&gt; nil // ç¬¬ä¸€æ¬¡ï¼Œnowï¼šnode2 -&gt; node3 -&gt; nil // ç¬¬äºŒæ¬¡ï¼Œheadï¼šnode2 -&gt; node1 -&gt; nil // ç¬¬äºŒæ¬¡ï¼Œnowï¼šnode3 -&gt; nil // ç¬¬ä¸‰æ¬¡ï¼Œheadï¼šnode3 -&gt; node2 -&gt; node1 -&gt; nil // ç¬¬ä¸‰æ¬¡ï¼Œnowï¼šnil now := l.Head for now != nil &#123; // è®°å½•å½“å‰èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ next := now.Next // å½“å‰èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹å˜ä¸ºå¤´èŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹å˜ä¸ºæ–°çš„å¤´èŠ‚ç‚¹ã€‚è¿™ä¸ªæ“ä½œå’Œæ’å…¥èŠ‚ç‚¹çš„é€»è¾‘ä¸€è‡´ï¼ŒæŠŠå¤´èŠ‚ç‚¹ä½œä¸ºå½“å‰èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹ä½œä¸ºæ–°çš„å¤´èŠ‚ç‚¹ã€‚ if head == nil &#123; now.Next = nil &#125; else &#123; now.Next = head &#125; head = now // æŒ‡é’ˆåç§» now = next // è¯­æ³•ç³–ç‰ˆæœ¬ // now, now.Next, head = now.Next, head, now // è¯­æ³•ç³–ç‰ˆæœ¬ï¼Œæ‹†è§£å¦‚ä¸‹ // now = now.Next // now.Next = head // head = now // printNode(head) // printNode(now) &#125; l.Head = head&#125;func printNode(node *Node) &#123; if node == nil &#123; print(&quot;nil&quot;) &#125; now := node for now != nil &#123; if now.Next == nil &#123; print(now.V, &quot;-&gt;&quot;, &quot;nil&quot;) &#125; else &#123; print(now.V, &quot;-&gt;&quot;) &#125; now = now.Next &#125; print(&quot;\\n&quot;)&#125; åˆ é™¤æ“ä½œ: 1234567891011121314151617func (l *List) Delete(node *Node) &#123; if l.Head == nil &#123; return &#125; // å¦‚æœæ˜¯å°¾èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦æ‰¾å‡ºåˆ é™¤èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ if node.Next == nil &#123; prev := l.Head for prev.Next != node &#123; prev = prev.Next &#125; prev.Next = nil &#125; else &#123; // å¦‚æœä¸æ˜¯å°¾èŠ‚ç‚¹ï¼ŒæŠŠåˆ é™¤èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹æ•°æ®ç›´æ¥è¦†ç›–åˆ é™¤èŠ‚ç‚¹ã€‚ *node = *node.Next &#125; return&#125; å•é“¾è¡¨çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥å¾ˆè½»æ¾çš„æŸ¥è¯¢åˆ°æŒ‡å®šèŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ï¼Œä½†å¦‚æœæƒ³è¦æŸ¥è¯¢å‰ç½®èŠ‚ç‚¹åˆ™éœ€è¦éå†ä¸€éæ‰å¯ä»¥ï¼Œæ‰€ä»¥è¿™å°±éœ€è¦åŒé“¾è¡¨äº† åŒé“¾è¡¨åŒé“¾è¡¨é€šä¿—çš„è®²ï¼Œå°±æ˜¯æ¯ä¸ªæ•°æ®èŠ‚ç‚¹æ—¢å¯ä»¥æ‰¾åˆ°å®ƒå‰ä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿæ‰¾çš„åˆ°å®ƒåä¸€ä¸ªèŠ‚ç‚¹ã€‚ä¸‰éƒ¨åˆ†ç»„æˆï¼šå‰å€¼èŠ‚ç‚¹çš„æŒ‡é’ˆï¼ŒèŠ‚ç‚¹æ•°æ®ï¼Œåç½®èŠ‚ç‚¹çš„æŒ‡é’ˆï¼ˆå°¾èŠ‚ç‚¹æŒ‡é’ˆæŒ‡å‘nilï¼‰ã€‚ ç›´æ¥ä¸Šä»£ç : 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061type Node struct &#123; V string Prev *Node Next *Node&#125;type List struct &#123; Head *Node Tail *Node&#125;func main() &#123; list := &amp;List&#123;&#125; n1 := &amp;Node&#123;V: &quot;node1&quot;&#125; n2 := &amp;Node&#123;V: &quot;node2&quot;&#125; n3 := &amp;Node&#123;V: &quot;node3&quot;&#125; list.Append(n1) list.Append(n2) list.Append(n3) list.Traverse() // è¾“å‡ºç»“æœï¼šnode1&lt;-&gt;node2&lt;-&gt;node3-&gt;nil&#125;func (l *List) Append(node *Node) &#123; if l.Head == nil &#123; l.Head = node l.Tail = node &#125; else &#123; // å°¾èŠ‚ç‚¹ prev := l.Tail // å°¾èŠ‚ç‚¹è®¾ä¸ºå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ node.Prev = prev // å½“å‰èŠ‚ç‚¹è®¾ä¸ºå°¾èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ prev.Next = node // å½“å‰èŠ‚ç‚¹å˜ä¸ºå°¾èŠ‚ç‚¹ l.Tail = node &#125;&#125;func (l *List) Delete(node *Node) &#123; if l.Head == nil &#123; return &#125; // åˆ é™¤èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ prev := node.Prev // åˆ é™¤èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹è®¾ä¸ºå‰ç½®èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ prev.Next = node.Next // åˆ é™¤èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹è®¾ä¸ºåç½®èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ node.Next.Prev = node.Prev&#125;func (l *List) Traverse() &#123; now := l.Head for now != nil &#123; if now.Next == nil &#123; print(now.V, &quot;-&gt;&quot;, &quot;nil&quot;) &#125; else &#123; print(now.V, &quot;&lt;-&gt;&quot;) &#125; now = now.Next &#125;&#125; åŒé“¾è¡¨è¾ƒå•é“¾è¡¨çš„ä¸åŒæ¯”è¾ƒæ˜æ˜¾ï¼ŒåŒé“¾è¡¨å¯ä»¥å¾ˆè½»æ¾çš„æŸ¥æ‰¾åˆ°æŒ‡å®šèŠ‚ç‚¹çš„å‰ç½®å’Œåç½®èŠ‚ç‚¹ï¼Œéå†æ–¹å‘ä¹Ÿå¯ä»¥æ˜¯ä»å¤´åˆ°å°¾æˆ–è€…ä»å°¾åˆ°å¤´ã€‚åŒæ—¶ï¼ŒåŒé“¾è¡¨èŠ‚ç‚¹æ“ä½œæ¯”è¾ƒå¤æ‚ï¼Œå ç”¨ç©ºé—´ä¹Ÿæ›´å¤§ã€‚ å¾ªç¯é“¾è¡¨é¡¾åæ€ä¹‰ï¼Œå¾ªç¯é“¾è¡¨æ˜¯ä¸€ä¸ªç¯çŠ¶çš„é“¾è¡¨ã€‚å¾ªç¯é“¾è¡¨åˆåˆ†ä¸ºï¼šå•å‘å¾ªç¯é“¾è¡¨ã€åŒå‘å¾ªç¯é“¾è¡¨ï¼Œå®ç°ä¸Šå°±æ˜¯æŠŠå°¾èŠ‚ç‚¹å’Œå¤´èŠ‚ç‚¹è¿›è¡Œé“¾æ¥ã€‚ å•å‘å¾ªç¯é“¾è¡¨ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546type Node struct &#123; V string Next *Node&#125;type List struct &#123; Head *Node&#125;func main() &#123; list := &amp;List&#123;&#125; n1 := &amp;Node&#123;V: &quot;node1&quot;&#125; n2 := &amp;Node&#123;V: &quot;node2&quot;&#125; n3 := &amp;Node&#123;V: &quot;node3&quot;&#125; list.Append(n1) list.Append(n2) list.Append(n3) list.Traverse() // è¾“å‡ºç»“æœï¼šnode1-&gt;node2-&gt;node3-&gt;node1&#125;func (l *List) Append(node *Node) &#123; if l.Head == nil &#123; l.Head = node node.Next = l.Head &#125; else &#123; now := l.Head for now.Next != l.Head &#123; now = now.Next &#125; now.Next = node node.Next = l.Head &#125;&#125;func (l *List) Traverse() &#123; now := l.Head for &#123; if now.Next == l.Head &#123; print(now.V, &quot;-&gt;&quot;, l.Head.V) break &#125; else &#123; print(now.V, &quot;-&gt;&quot;) &#125; now = now.Next &#125;&#125; ä½¿ç”¨åœºæ™¯é“¾è¡¨æ˜¯æœ€åŸºç¡€ä¸”å¾ˆå¸¸ç”¨çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥è§£å†³å¾ˆå¤šç®—æ³•é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ç”¨äºæ„å»ºå…¶ä»–çš„æ•°æ®ç»“æ„ã€‚æ¯”å¦‚è¯´è§£å†³çº¦ç‘Ÿå¤«ç¯é—®é¢˜å’Œå®ç°å †æ ˆã€é˜Ÿåˆ—ç­‰ã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"data structures","slug":"data-structures","permalink":"http://xupin.im/tags/data-structures/"},{"name":"algorithms","slug":"algorithms","permalink":"http://xupin.im/tags/algorithms/"}]},{"title":"Goå­¦ä¹ ç¬”è®° - æ³›å‹","date":"2022-07-13T16:00:00.000Z","path":"2022/07/14/go-generic/","text":"2009 å¹´ Go è¯­è¨€é¦–æ¬¡å‘å¸ƒåï¼Œæ”¯æŒæ³›å‹ä¸€ç›´ä»¥æ¥å‘¼å£°æœ€é«˜çš„åŠŸèƒ½ä¹‹ä¸€ã€‚åå¹´ç£¨ä¸€å‰‘ï¼Go å®˜æ–¹ç»ˆäºåœ¨ 2022 å¹´ 03 æœˆ 15 æ—¥å‘å¸ƒ go1.18 stable æ­£å¼æ”¯æŒæ³›å‹ ä»€ä¹ˆæ˜¯æ³›å‹æ³›å‹çš„æ ¸å¿ƒæ˜¯æŠŠç±»å‹å‚æ•°åŒ–ï¼Œé€šä¿—çš„æ¥è¯´å°±æ˜¯å…è®¸ä½¿ç”¨æ—¶æ‰æŒ‡å®šç±»å‹çš„ä¸€ç§è®¾è®¡ã€‚ å‡è®¾æœ‰ä¸ªä¸¤å˜é‡ç›¸åŠ çš„éœ€æ±‚ï¼Œä¸”è¿™ä¿©å˜é‡å¯èƒ½æ˜¯ int æˆ–è€… stringï¼Œç®€å•ç²—æš´å°±ç›´æ¥å®šä¹‰ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ”¯æŒ intã€string 123456789// ä¼ ç»Ÿå†™æ³•func AddInt(arg1, arg2 int) int &#123; return arg1 + arg2&#125;func AddString(arg1, arg2 string) string &#123; return arg1 + arg2&#125;AddInt(1, 2)AddString(&quot;a&quot;, &quot;b&quot;) é‚£å¦‚æœä½¿ç”¨æ³›å‹æ¥å®šä¹‰å‘¢ï¼Œå®ƒçš„å†™æ³•å¤§æ¦‚æ˜¯è¿™æ ·çš„ 1234567// æ³›å‹å†™æ³•func Add[type] (var1, var2) type &#123; return var1 + var2&#125;// ä½¿ç”¨æ—¶å†æŒ‡å®šæ•°æ®ç±»å‹Add[int](1, 2)Add[string](&quot;a&quot;,&quot;b&quot;) å¥½å¤„æ˜¾è€Œæ˜“è§ï¼Œè‡³å°‘å¯ä»¥å°‘æ‹·è´ä¸€ä¸ªå‡½æ•°ã€‚å½“ç„¶è¿™ä¸è¶³ä»¥ä½“ç°å‡ºæ³›å‹çš„ä¼˜ç‚¹ï¼Œæ¯•ç«Ÿè¿™ç§é€šç”¨å‡½æ•°é€šè¿‡interfaceä¸€æ ·å¯ä»¥å®ç°ã€‚ 123456789101112func Add(var1, var2 interface&#123;&#125;) interface&#123;&#125; &#123; r := reflect.TypeOf(var1) switch r.Kind() &#123; case reflect.Int: return var1.(int) + var2.(int) case reflect.String: return var1.(string) + var2.(string) &#125; return nil&#125;Add(1, 2)Add(&quot;a&quot;,&quot;b&quot;) æ—¢ç„¶é€šè¿‡interfaceä¹Ÿå¯ä»¥å®ç°ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆæ³›å‹è¿˜å¤‡å—æ¨å´‡å‘¢ï¼Ÿ ä¾¿åˆ©æ€§ &amp; æ•ˆç‡ ä½¿ç”¨ interface å®ç°åˆ™éœ€è¦ä½¿ç”¨æ–­è¨€æˆ–è€…åå°„æ¥å¤„ç†ç±»å‹é—®é¢˜ï¼ŒåŒæ—¶ Go è¯­è¨€ä¸­åå°„æ€§èƒ½ååˆ†ä½ä¸‹ï¼ˆè§ä¸‹å›¾ï¼‰ã€‚ å®‰å…¨æ€§ interface ææ˜“å¼•å‘ç±»å‹å¼‚å¸¸é—®é¢˜ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¸èƒ½å‘ç°ç±»å‹é—®é¢˜ã€‚ Go çš„æ³›å‹åœ¨ Go è¯­è¨€ä¸­å¦‚ä½•ä½¿ç”¨æ³›å‹ï¼Œå…ˆäº†è§£ä¸€ä¸‹æ³›å‹çš„ 3 ä¸ªæ¦‚å¿µï¼š æ³›å‹å‚æ•° æ³›å‹å‚æ•°ç±»å‹çº¦æŸ æ³›å‹å‚æ•°åˆ—è¡¨ Go æ³›å‹çš„ä»£ç é£æ ¼å’Œå…¶ä»–è¯­è¨€åŸºæœ¬ç±»ä¼¼ï¼Œæ¯”å¦‚å®šä¹‰ä¸€ä¸ªåªæ”¯æŒ int å’Œ string ä¸¤å€¼ç›¸åŠ çš„æ³›å‹å‡½æ•°ï¼š 123func Add[T int | string](var1, var2 T) T &#123; return var1 + var2&#125; ä»¥ä¸Šå‡½æ•°ï¼Œ T æ³›å‹å‚æ•°ï¼Œå¯ä»¥æ˜¯ä»»æ„å­—æ¯ä¸”ä¸åŒºåˆ†å¤§å°å†™ï¼ˆä½†é€šå¸¸ä½¿ç”¨å¤§å†™å­—æ¯ï¼‰ã€‚ int | string æ³›å‹å‚æ•°ç±»å‹çº¦æŸï¼Œç”¨äºå£°æ˜å’Œçº¦æŸæ³›å‹å‚æ•° T æ”¯æŒçš„æ•°æ®ç±»å‹ã€‚æ¯”å¦‚ 1234Add[T float64] // åªæ”¯æŒfloat64ç±»å‹Add[T any] // æ”¯æŒä»»ä½•ç±»å‹ï¼Œanyç­‰ä»·äºinterface&#123;&#125;Add[T comparable] // golangæ–°å¢çš„å†…ç½®æ¥å£ï¼Œä»»ä½•å¯è¿›è¡Œæ¯”è¾ƒçš„ç±»å‹ï¼ˆ!=ã€==ã€&amp;&amp;ã€||ï¼‰Add[T ~int] // ä»»ä½•åº•å±‚ç±»å‹ä¸ºintçš„ç±»å‹ï¼Œ~æ˜¯æ–°å¢çš„æ“ä½œç¬¦ã€‚ [] ä¸­æ‹¬å·å†…æ˜¯æ³›å‹å‚æ•°åˆ—è¡¨ï¼Œæ”¯æŒä»»æ„ä¸ªæ³›å‹å‚æ•°ï¼Œä½¿ç”¨é€—å·åˆ†éš”ã€‚ 1Add[T int64, T2 float64](var1, var2 T, var3 T2) å¦‚æœæ³›å‹ä»…ä»…èƒ½åœ¨å‡½æ•°ä¸Šä½¿ç”¨å¥½åƒæœ‰ç‚¹â€œé¸¡è‚‹â€ã€‚å®ƒè¿˜å¯ä»¥è¿™æ ·å»ä½¿ç”¨ï¼Œ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950// æ³›å‹ç»“æ„ä½“type Resp[T any] struct &#123; Code int Msg string Data T&#125;resp := &amp;Resp[string]&#123; Code: 200, Msg: &quot;OK&quot;, Data: &quot;&quot;,&#125;// æ³›å‹ç®¡é“type MyChan[T int | bool] chan Tch := make(MyChan[bool], 1)ch &lt;- true&lt;-ch// æ³›å‹Maptype MyMap[T int | string, T1 any] map[T]T1m := MyMap[string, string]&#123; &quot;key&quot;: &quot;val&quot;,&#125;// æ³›å‹æ¥å£type Personer[T any] interface &#123; Say(age T)&#125;type Male struct&#123;&#125;func (g *Male) Say(age int) &#123; fmt.Println(age)&#125;var m Personer[int] = &amp;Male&#123;&#125;m.Say(12)type Female struct&#123;&#125;func (f *Female) Say(age string) &#123; fmt.Println(age)&#125;var f Personer[string] = &amp;Female&#123;&#125;f.Say(&quot;secret&quot;)// æ³›å‹ç±»å‹type MyType interface &#123; int | string | float64&#125;func Add[T MyType](var1, var2 T) &#123; return var1 + var2&#125; ä»¥ä¸Šåªæ˜¯ç®€å•åˆ—ä¸¾ï¼Œè¿˜æ”¯æŒä¸€äº›åˆ—â€œå¥—å¨ƒâ€è¡Œä¸ºã€‚å€¼çš„æ³¨æ„çš„æ˜¯ï¼ŒGo æ–°å¢çš„æ“ä½œç¬¦~ã€‚ 123456789type MyType interface &#123; ~int | string | float64&#125;type MyInt intfunc Add[T MyType](var1, var2 T) T &#123; return var1 + var2&#125;var a, b MyInt = 1, 2Add(a, b) ä½¿ç”¨æ“ä½œç¬¦~ï¼Œæ„å‘³ä¸ä»…æ”¯æŒè¯¥æ“ä½œç¬¦åçš„åŸºæœ¬ç±»å‹ï¼ŒåŒæ—¶è¿˜æ”¯æŒä»»æ„åº•å±‚ç±»å‹æ˜¯è¯¥ç±»å‹çš„æ•°æ®ã€‚ ä»¥ä¸Šå†…å®¹å‚è€ƒæ¥æºï¼šhttps://tip.golang.org/doc/go1.18 ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ³›å‹å½“ä½ è¦ä¸ºä¸åŒæ•°æ®ç±»å‹åšç€åŒæ ·çš„å¤„ç†é€»è¾‘æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ³›å‹ã€‚æ³›å‹æ˜¯æŠŠåŒåˆƒå‰‘ï¼Œæ—¢å¯ä»¥æé«˜ç¼–ç æ•ˆç‡ã€æå‡ä»£ç ç¾å­¦ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥è®©ä»£ç å¯è¯»æ€§å˜çš„å¾ˆå·®ã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"golang","slug":"golang","permalink":"http://xupin.im/tags/golang/"}]},{"title":"Goå­¦ä¹ ç¬”è®° - initå‡½æ•°","date":"2022-03-07T16:00:00.000Z","path":"2022/03/08/go-init/","text":"å®šä¹‰Golangä¸­çš„ç‰¹æ®Šå‡½æ•°ï¼Œä¼šå…ˆäºmainå‡½æ•°æ‰§è¡Œä¸”ä¸èƒ½è¢«è°ƒç”¨ã€‚è¯¥å‡½æ•°æ— å…¥å‚ã€è¿”å›å€¼ï¼ŒåŒæ—¶æ”¯æŒé€‰æ‹©æ€§å®šä¹‰ã€‚ä¹Ÿå¯ä»¥é€‰æ‹©å®šä¹‰å¤šä¸ªinitå‡½æ•°ï¼Œä½†å»ºè®®åªå®šä¹‰ä¸€ä¸ªã€‚ 123456789101112131415161718package mainimport &quot;fmt&quot;func init() &#123; fmt.Println(&quot;init1&quot;)&#125;func init() &#123; fmt.Println(&quot;init2&quot;)&#125;func main() &#123; fmt.Println(&quot;main&quot;)&#125;// init1// init3// main sync.Onceinitå‡½æ•°å®ç°äº†sync.Onceé”ï¼Œåªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚ my&#x2F;my.go 1234567891011package myimport &quot;fmt&quot;func init() &#123; fmt.Println(&quot;a.init&quot;)&#125;func Test() &#123; fmt.Println(&quot;a.Test&quot;)&#125; main.go 12345678910111213package mainimport ( &quot;test/my&quot;)func main() &#123; my.Test() my.Test()&#125;// a.init// a.Test// a.Test åˆå§‹åŒ–é¡ºåºåœ¨packageå†…éƒ¨å˜é‡èµ‹å€¼ &gt; init() &gt; main()ã€‚ 123456789101112131415161718192021package mainimport &quot;fmt&quot;var f string = sayHello()func init() &#123; fmt.Println(&quot;init&quot;)&#125;func main() &#123; fmt.Println(&quot;main&quot;)&#125;func sayHello() string &#123; fmt.Println(&quot;sayHello&quot;) return &quot;hi&quot;&#125;// sayHello// init// main å¤šä¸ªpackageè°ƒç”¨æ—¶çš„åˆå§‹åŒ–é¡ºåºï¼Œåˆ™å–å†³äºä¾èµ–é¡ºåºã€‚ my.go 123456789101112131415package myimport ( &quot;fmt&quot; &quot;test/your&quot;)func init() &#123; fmt.Println(&quot;a.init&quot;)&#125;func Test() &#123; fmt.Println(&quot;a.Test&quot;) your.Test()&#125; your.go 1234567891011package yourimport &quot;fmt&quot;func init() &#123; fmt.Println(&quot;your.init&quot;)&#125;func Test() &#123; fmt.Println(&quot;your.Test&quot;)&#125; main.go 12345678910111213package mainimport ( &quot;test/my&quot;)func main() &#123; my.Test()&#125;// your.init// a.init// a.Test// your.Test ç–‘é—®å½“packageå†…å®šä¹‰å¤šä¸ªinitå‡½æ•°ï¼Œå®ƒçš„æ‰§è¡Œé¡ºåºï¼Ÿ","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"golang","slug":"golang","permalink":"http://xupin.im/tags/golang/"}]},{"title":"ClickHouseå­¦ä¹ ç¬”è®° - MergeTreeå­˜å‚¨ç»“æ„","date":"2022-01-25T16:00:00.000Z","path":"2022/01/26/clickhouse-mergetree/","text":"ClickHouse æ˜¯è¿™ä¸¤å¹´å¤‡å—ç©ç›®çš„å¼€æºåˆ—å¼æ•°æ®åº“ï¼Œä¸»è¦åº”ç”¨åœºæ™¯æ˜¯ OLAPï¼ˆåœ¨çº¿æ•°æ®åˆ†æå¤„ç†ï¼‰åœºæ™¯ã€‚ èƒŒæ™¯ä¹‹å‰å› ä¸ºé‡è§ä¸€äº›å°é—®é¢˜ï¼Œæ‰€ä»¥æƒ³é€šè¿‡å­˜å‚¨ç»“æ„å’Œç´¢å¼•æ–¹å¼ä¸¤ä¸ªæ–¹é¢ææ¸…æ¥šå®ƒä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆå¿«ã€‚ ClickHouse æ˜¯ OLAP å‹çš„åˆ—å¼æ•°æ®åº“ï¼Œå®˜æ–¹ç§°æ¯”è¾ƒè¡Œå¼æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡æå‡è‡³å°‘ 100 å€ï¼ŒDB Benchmarkæ˜¾ç¤º ClickHouse æ¯” Mysql å¿« 800 å€ï¼ ä»€ä¹ˆæ˜¯ OLAP å‹åˆ—å¼æ•°æ®åº“OLAP ä¸šåŠ¡åœºæ™¯ä¸€èˆ¬å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š å¤šæ•°æ˜¯æŸ¥è¯¢è¯·æ±‚ï¼Œä½†è¯·æ±‚ä¸å¯†é›†ã€‚ æ•°æ®å†™å…¥ä¸é¢‘ç¹ï¼Œæˆ–è€…å•æ¬¡å¤§æ‰¹é‡å†™å…¥æ•°æ®ã€‚ å°½é‡ä¸æ›´æ–°æˆ–å°‘æ›´æ–°å†å²æ•°æ®ã€‚ æ•°æ®è¡¨åˆ—æ¯”è¾ƒå¤šï¼ˆå®½è¡¨ï¼‰ï¼Œä½†æ¯åˆ—å­˜å‚¨æ•°æ®è¾ƒå°ã€‚ å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚è¾ƒä½ï¼Œä¸ä¾èµ–äº‹åŠ¡ã€‚ æŸ¥è¯¢è¯·æ±‚ç›®æ ‡æ•°æ®è¡¨æ¯”è¾ƒç‹¬ç«‹ï¼Œæˆ–è€…é™¤ç›®æ ‡è¡¨å¤–å…¶ä»–éœ€è¦å…³è”çš„è¡¨çš„æ•°æ®é‡ç›¸å¯¹å¾ˆå°‘ã€‚ æŸ¥è¯¢ç»“æœé›†æ•°æ®é‡è¿œè¿œå°äºæºæ•°æ®è¡¨ï¼Œè‡³å°‘æœåŠ¡å™¨å†…å­˜ä¸ä¼šæº¢å‡ºã€‚ ç®€å•çš„æŸ¥è¯¢ï¼Œæ¯«ç§’çº§åˆ«çš„å“åº”ã€‚ å•æ¬¡æŸ¥è¯¢é«˜ååé‡ã€‚ åˆ—å¼å’Œè¡Œå¼æ•°æ®åº“çš„åŒºåˆ«å­˜å‚¨æ–¹å¼ è¡Œå¼ Row WatchID JavaEnable Title GoodEvent EventTime #0 89354350662 1 Investor Relations 1 2016-05-18 05:19:20 #1 90329509958 0 Contact us 1 2016-05-18 08:10:20 #2 89953706054 1 Mission 1 2016-05-18 07:38:00 #N â€¦ â€¦ â€¦ â€¦ â€¦ åˆ—å¼ Row: #0 #1 #2 #N WatchID: 89354350662 90329509958 89953706054 â€¦ JavaEnable: 1 0 1 â€¦ Title: Investor Relations Contact us Mission â€¦ GoodEvent: 1 1 1 â€¦ EventTime: 2016-05-18 05:19:20 2016-05-18 08:10:20 2016-05-18 07:38:00 â€¦ æ£€ç´¢æ–¹å¼ï¼ˆé€šè¿‡ä¸¤å¼ å›¾æ„Ÿå—ä¸€ä¸‹ï¼‰ è¡Œå¼ï¼š åˆ—å¼ï¼š åˆ—å¼æ•°æ®åº“çš„ä¼˜åŠ¿ æŸ¥è¯¢è¯·æ±‚æ—¶åªè¯»å–éœ€è¦çš„åˆ—ï¼Œè€Œä¸æ˜¯åƒè¡Œå¼æ•°æ®åº“éœ€è¦è¯»å–ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰ blockï¼ˆå³ä½¿æ˜¯è¡Œå¼æ•°æ®åº“ä¹Ÿä¸æ˜¯æŒ‰è¡Œè¯»å–æ•°æ®è€Œæ˜¯å—ï¼Œæœ‰äº›æ•°æ®åº“ä¹Ÿç§°é¡µï¼‰ã€‚éœ€è¦è¯»å–æ•°æ®é‡çš„å‡å°‘ï¼Œæ„å‘³ç€ IO æ“ä½œä¼šæ›´å¿«ã€‚ åŒä¸€åˆ—çš„æ•°æ®ç±»å‹ä¸€è‡´ï¼Œå¯ä»¥ä½¿ç”¨æœ€é€‚ç”¨çš„å‹ç¼©ç®—æ³•ï¼ˆæ›´é«˜çš„å‹ç¼©æ¯”ï¼‰ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ã€‚ ClickHouse çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ æ”¯æŒ SQL è¯­æ³•ï¼Œä¸åƒ ES çš„ DSL é‚£æ ·æ™¦æ¶©éš¾æ‡‚ã€‚ å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼ˆæœ€ç»ˆï¼‰ã€‚ å‹æ¦¨æ€§èƒ½æé™ï¼Œå¤šæ ¸å¿ƒå¤„ç†ä½¿ç”¨æœºå™¨ä¸€åˆ‡å¯ç”¨èµ„æºã€‚ é«˜æ•ˆçš„ç£ç›˜ IOï¼Œæ•°æ®éƒ½æ˜¯æœ‰åºå­˜å‚¨ã€‚ æŸ¥è¯¢ä¸éœ€è¦éµå®ˆç´¢å¼•æœ€å·¦åŸåˆ™ã€‚ æ‰¹é‡å†™å…¥é€Ÿåº¦å¿«ã€‚ ç¼ºç‚¹ éƒ¨åˆ† SQL è¯­æ³•ä¸æ”¯æŒï¼Œä½†æ— ä¼¤å¤§é›…ã€‚ æ›´æ–°å’Œåˆ é™¤æ“ä½œæ”¯æŒä¸å¥½ã€‚ ä¸æ”¯æŒäº‹åŠ¡ã€‚ ä¸æ”¯æŒé«˜å¹¶å‘ï¼Œå®˜æ–¹é»˜è®¤ QPSï¼š100ï¼ˆå¯ä»¥é€šè¿‡é…ç½®ä¿®æ”¹ï¼‰ ç®€å•çš„åˆ—ä¸¾äº†ä¼˜ç¼ºç‚¹ï¼Œè¿™åªæ˜¯å†°å±±ä¸€è§’ã€‚å®é™…ä¸Š ClickHouse å€¼å¾—æ·±å…¥æ¢è®¨çš„å¤ªå¤šå¤ªå¤šã€‚ MergeTree çš„ç‰¹æ€§ClickHouse æ˜¯çœŸæ­£çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“ï¼Œä¸åŒäºå†…å­˜è®¡ç®—å¼•æ“ï¼ˆæ¯”å¦‚ SparkSQLã€Prestoï¼‰ï¼Œå®ƒæœ‰è‡ªå·±çš„æ•°æ®å­˜å‚¨æœºåˆ¶å’Œç´¢å¼•æ–¹å¼ã€‚ 1234567891011121314CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster]( name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1] [TTL expr1], name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2] [TTL expr2], ... INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1, INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2) ENGINE = MergeTree()ORDER BY expr[PARTITION BY expr][PRIMARY KEY expr][SAMPLE BY expr][TTL expr [DELETE|TO DISK &#x27;xxx&#x27;|TO VOLUME &#x27;xxx&#x27;], ...][SETTINGS name=value, ...] ORDER BY æ’åºå­—æ®µï¼Œæ•°æ®å­˜å‚¨æ—¶æŒ‰ç…§æ’åºå­—æ®µï¼ˆæ’åºå­—æ®µå¯ä»¥æ˜¯ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯å…ƒç»„ï¼‰è¿›è¡Œæœ‰åºå­˜å‚¨ã€‚ PARTITION BY ClickHouse æ”¯æŒæŒ‰åˆ—å€¼è¿›è¡Œæ•°æ®åˆ†åŒºï¼Œä¹Ÿæ”¯æŒä»¥è¡¨è¾¾å¼è¿›è¡Œåˆ†åŒºï¼ˆæ¯”å¦‚toYear(date)ï¼‰ï¼Œåˆ†åŒºå­—æ®µå€¼ä¸å¯ä»¥è¿‡å¤šï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼ˆæ¯”å¦‚æŒ‰ç…§ user_id åˆ†åŒºï¼‰ã€‚ä¸»è¦ä½œç”¨æ˜¯åˆ†åŒºè£å‰ªï¼Œè¿‡æ»¤éå¿…è¦çš„æŸ¥è¯¢æ•°æ®ã€‚ PRIMARY KEY ClickHouse çš„ MergeTree å¼•æ“å¯ä»¥å®šä¹‰ä¸»é”®ï¼Œä½†ä¸åŒäºè¡Œå¼æ•°æ®åº“ã€‚ä¸»é”®ä¸åšå”¯ä¸€çº¦æŸï¼Œå¯ä»¥æ˜¯å¤šä¸ªå­—æ®µã€‚é»˜è®¤ä¸å®šä¹‰ä¸»é”®ï¼Œä¼šå°†æ’åºé”®ä½œä¸ºä¸»é”®ã€‚å¦‚æœå®šä¹‰ä¸»é”®ï¼ˆæ’åºé”®è¿‡å¤§ï¼Œä¸ºäº†æ§åˆ¶ä¸»é”®æ–‡ä»¶å¤§å°ï¼‰ï¼Œåˆ™å°½é‡ä¿è¯æ˜¯æ’åºé”®çš„å‰éƒ¨åˆ†é”®ã€‚ SAMPLE BY ClickHouse æä¾›çš„æŠ½æ ·è¡¨è¾¾å¼æœºåˆ¶ï¼ŒæŸ¥è¯¢è¯·æ±‚æ—¶é€šè¿‡é‡‡æ ·å­å¥è¿›è¡Œæ•°æ®é‡‡æ ·åŠŸèƒ½ã€‚å»ºè¡¨æ—¶éœ€è¦å£°æ˜é‡‡æ ·è¡¨è¾¾å¼ï¼ˆé€šè¿‡å“ªä¸ªå­—æ®µé‡‡æ ·ï¼‰ï¼Œè¯¥å­—æ®µå¿…é¡»æ˜¯UIntç±»å‹ä¸”å¿…é¡»å‡ºç°åœ¨ä¸»é”®æˆ–æ’åºé”®ä¸­ï¼ˆå¦‚æœä¸æ˜¯ UInt ç±»å‹å¯ä»¥å£°æ˜ï¼Œä½†ä½¿ç”¨ä¼šæŠ¥é”™ï¼‰ã€‚ 1234567create table example( user_id UInt64, name String)ORDER BY intHash32(user_id)SAMPLE BY intHash32(user_id) æŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œé€šè¿‡sampleå…³é”®å­—è¿›è¡Œä¼ªéšæœºæ•°æ®é‡‡æ ·ã€‚ 123select * from example sample 1/10 # æ•°æ®çš„10%select * from example sample 10 # 10è¡Œæ•°æ®select * from example sample 1/10 offset 1/2 # ä»æ•°æ®è¡¨50%éƒ¨åˆ†ä¸­å–å‡º10%çš„æ•°æ® å¯ä»¥é€šè¿‡å­—æ®µ_sample_factoræŸ¥è¯¢é‡‡æ ·ç³»æ•°ï¼Œè¯¥å­—æ®µæ˜¯è™šæ‹Ÿçš„ã€‚ TTL ClickHouse åŸç”Ÿæ”¯æŒçš„æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æœºåˆ¶ï¼Œåœ¨ MergeTree ä¸­å¯ä»¥ä¸ºåˆ—ã€è¡¨ 2 ä¸ªçº§åˆ«è®¾ç½® TTLï¼Œå½“æ—¶é—´åˆ°æœŸåè§¦å‘ç›¸åº”çº§åˆ«çš„æ•°æ®åˆ é™¤æ“ä½œã€‚æ— è®ºæ˜¯å“ªç§çº§åˆ«çš„ TTLï¼Œå­—æ®µå¿…é¡»ä¸ºDatetimeæˆ–Dateç±»å‹ï¼Œå› ä¸ºä¾èµ– INTERVAL è®¾ç½®ç”Ÿå‘½å‘¨æœŸã€‚ 123456create table example( date Date, login_ip String TTL date + INTERVAL 1 DAY)TTL date + INTERVAL 1 MONTH # [DELETE,TO VOLUME,TO DISK] é»˜è®¤å€¼: DELETE å½“åˆ—çº§ TTL è§¦å‘æ—¶ï¼Œä¼šæŠŠå¯¹åº”å€¼ä¿®æ”¹ä¸ºåˆ—ç±»å‹çš„é»˜è®¤å€¼ï¼Œå¦‚æœè¯¥åˆ—æ•°æ®å…¨éƒ¨è¿‡æœŸåˆ™ä¼šåˆ é™¤è¯¥åˆ—ã€‚ å½“è¡¨çº§ TTL è§¦å‘æ—¶ï¼Œä¼šåˆ é™¤æ‰€æœ‰ç¬¦åˆè¿‡æœŸæ¡ä»¶çš„æ•°æ®è¡Œã€‚ å½“åŒæ—¶è®¾ç½®åˆ—çº§ã€è¡¨çº§ TTLï¼Œä»¥å…ˆåˆ°æœŸçš„ä¸ºå‡†ã€‚ SETTINGS æ§åˆ¶ MergeTree è¡Œä¸ºçš„é¢å¤–å‚æ•°ï¼Œå¯é€‰é¡¹ï¼š 1index_granularity # ç´¢å¼•ç²’åº¦ã€‚ç´¢å¼•ä¸­ç›¸é‚»çš„ã€æ ‡è®°ã€é—´çš„æ•°æ®è¡Œæ•°ã€‚é»˜è®¤å€¼8192 ã€‚ å…¶ä»–æ›´å¤šå‚æ•°ï¼Œå¯ä»¥æŸ¥é˜…å®˜æ–¹æ–‡æ¡£SETTINGSéƒ¨åˆ†ã€‚ å­˜å‚¨ç»“æ„ä½¿ç”¨ MergeTree å¼•æ“ï¼Œä¸€å¼ æ•°æ®è¡¨ä¼šåˆ†æˆ N ä¸ªæ•°æ®åˆ†åŒºï¼Œæ¯ä¸ªæ•°æ®åˆ†åŒºå¯¹åº”ä¸€ä¸ªæ–‡ä»¶ç›®å½•ã€‚å¯ä»¥é€šè¿‡ SQL æŸ¥è¯¢åˆ°åˆ†åŒºä¿¡æ¯ï¼š 1SELECT * FROM system.parts WHERE `table` = &#x27;&#123;table&#125;&#x27; -- pathå­—æ®µæ˜¯æ•°æ®åˆ†åŒºçš„å­˜å‚¨ä½ç½® æˆ–è€…åœ¨ ClickHouse æ•°æ®å­˜å‚¨ç›®å½•æŸ¥çœ‹ 1234567891011121314151617181920212223242526272829$ cd /data/clickhouse/data$ tree -d.â”œâ”€â”€ defaultâ”‚ â”œâ”€â”€ test_a -&gt; /data/clickhouse/store/adf/adf66eb8-4f34-4a9c-adf6-6eb84f346a9c/â”‚ â””â”€â”€ test_b -&gt; /data/clickhouse/store/ed9/ed96975a-4048-4846-ad96-975a40484846/â””â”€â”€ system â”œâ”€â”€ asynchronous_metric_log -&gt; /data/clickhouse/store/507/5075436a-cb6c-4fac-9075-436acb6ccfac/ â”œâ”€â”€ metric_log -&gt; /data/clickhouse/store/86c/86cd831c-1bd4-4df2-86cd-831c1bd43df2/ â”œâ”€â”€ query_log -&gt; /data/clickhouse/store/986/9860fbbb-e965-476f-9860-fbbbe965776f/ â”œâ”€â”€ query_thread_log -&gt; /data/clickhouse/store/c1b/c1b39615-68ee-4fb7-81b3-961568eeafb7/ â””â”€â”€ trace_log -&gt; /data/clickhouse/store/b6d/b6d34f2c-1580-411b-b6d3-4f2c1580911b/$ cd /data/clickhouse/store/adf/adf66eb8-4f34-4a9c-adf6-6eb84f346a9c/$ tree.â”œâ”€â”€ 20220101_1_3_0â”‚ â”œâ”€â”€ checksums.txtâ”‚ â”œâ”€â”€ columns.txtâ”‚ â”œâ”€â”€ &#123;column&#125;.binâ”‚ â”œâ”€â”€ &#123;column&#125;.mrkâ”‚ â”œâ”€â”€ count.txtâ”‚ â”œâ”€â”€ primary.idxâ”‚ â”œâ”€â”€ partition.datâ”‚ â”œâ”€â”€ minmax_&#123;column&#125;.idxâ”‚ â”œâ”€â”€ skp_idx_&#123;column&#125;.idxâ”‚ â””â”€â”€ skp_idx_&#123;column&#125;.mrkâ”œâ”€â”€ detachedâ”œâ”€â”€ format_version.txtâ””â”€â”€ mutation_&#123;key&#125;.txt 20220101_1_3_0 æ•°æ®åˆ†åŒºçš„åç§°ï¼Œç”± 4 éƒ¨åˆ†ç»„æˆã€‚ åç§°ï¼š20220101 æœ€å°æ•°æ®å—ç¼–å·ï¼š1 æœ€å¤§æ•°æ®å—ç¼–å·ï¼š3 æ•°æ®å—çº§åˆ«ï¼š0ï¼ˆå³åœ¨ç”±å—ç»„æˆçš„åˆå¹¶æ ‘ä¸­ï¼Œè¯¥å—åœ¨æ ‘ä¸­çš„æ·±åº¦ï¼‰ checksums.txt æ ¡éªŒæ–‡ä»¶ï¼Œä½¿ç”¨äºŒè¿›åˆ¶å­˜å‚¨æ•°æ®ç›®å½•çš„æ–‡ä»¶ä¿¡æ¯ï¼Œä¿è¯å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚ columns.txt æ˜æ–‡å­˜å‚¨åˆ—ä¿¡æ¯ï¼ˆåˆ—åï¼Œåˆ—ç±»å‹ï¼‰ {column}.bin æ ¸å¿ƒæ•°æ®æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶å­˜å‚¨ï¼‰ï¼Œåˆ†åŒºå­—æ®µpart_typeä¸ºWideæ—¶ä¼šä¸ºæ¯åˆ—åˆ›å»ºå¯¹åº”çš„æ•°æ®æ–‡ä»¶ï¼Œå¦‚æœæ˜¯Compactåˆ™æ‰€æœ‰åˆ—å­˜å‚¨åœ¨ä¸€ä¸ªæ•°æ®æ–‡ä»¶ã€‚è¯¥å€¼å—é…ç½®min_bytes_for_wide_partã€min_rows_for_wide_partå½±å“ã€‚è¯¥æ–‡ä»¶çš„å†…å®¹ä»¥æ•°æ® Block å­˜å‚¨ï¼ˆä¹Ÿç§°é¡µï¼‰ï¼Œæ•°æ®æ˜¯å¦å‹ç¼©å—é…ç½®max_compress_block_sizeã€min_compress_block_sizeå½±å“ã€‚é»˜è®¤å‹ç¼©æ ¼å¼ï¼šlz4ã€‚Block æ•°æ®å—åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå¤´ä¿¡æ¯å’Œæ•°æ®ã€‚å¤´ä¿¡æ¯å›ºå®šå  9 å­—èŠ‚ï¼šå‹ç¼©æ–¹å¼ 1 å­—èŠ‚ã€å‹ç¼©åå¤§å° 4 å­—èŠ‚ã€å‹ç¼©å‰å¤§å° 4 å­—èŠ‚ã€‚ {column}.mrk åˆ—å­—æ®µæ ‡è®°æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶å­˜å‚¨ï¼‰ï¼Œæ–‡ä»¶ä¸­è®°å½•{column}.bin æ–‡ä»¶ä¸­æ•°æ® Block çš„åç§»é‡ã€‚ count.txt è¯¥æ•°æ®åˆ†åŒºçš„æ•°æ®è¡Œæ•°ã€‚ primary.idx ä¸»é”®ç´¢å¼•æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶å­˜å‚¨ï¼‰ï¼Œæ¯index_granularityè¡Œå–ä¸»é”®å€¼ä½œä¸ºç¨€ç–ç´¢å¼•ã€‚ partition.dat å½“å‰æ•°æ®åˆ†åŒºçš„ç¼–å·ã€‚ minmax_{column}.idx åˆ—ç´¢å¼•æ–‡ä»¶ï¼Œå­˜å‚¨åˆ—çš„æœ€å¤§å€¼å’Œæœ€å°å€¼ã€‚ skpidx{column}.idx è·³æ•°ç´¢å¼•ï¼ˆåˆç§°äºŒçº§ç´¢å¼•ï¼‰æ–‡ä»¶ï¼Œå—allow_experimental_data_skipping_indiceså‚æ•°æ§åˆ¶ï¼Œé»˜è®¤ä¸å¼€å¯ã€‚ skpidx{column}.mrk è·³æ•°ç´¢å¼•æ ‡è®°æ–‡ä»¶ã€‚ detached æ‰§è¡ŒALTER TABLE table_name DETACH PARTITION|PART partition_exprå‘½ä»¤åï¼Œä¼šå°†å¯¹åº”çš„æ•°æ®åˆ†ç¦»è‡³è¯¥ç›®å½•å¹¶â€œé—å¿˜â€ã€‚ format_version.txt è®°å½•å­˜å‚¨çš„æ ¼å¼ã€‚ mutation_{key}.txt ä¸åŒäºè¡Œå¼æ•°æ®åº“ï¼ŒClickHouse å¯¹äº mutation æ“ä½œï¼ˆUpdateã€Deleteï¼‰æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼ŒåŒæ—¶ä¼šç”Ÿæˆmutation_&#123;key&#125;.txtæ–‡ä»¶è®°å½•æ“ä½œå’Œç”Ÿæˆæ–°çš„æ•°æ®ç›®å½•20220101_1_3_0_&#123;key&#125;ã€‚å¯ä»¥é€šè¿‡ SQL æŸ¥è¯¢: 1SELECT * FROM system.mutations WHERE `table` = &#x27;&#123;table&#125;&#x27; å› ä¸ºä½¿ç”¨ç±» LSM æ¶æ„ï¼Œè¯¥ç±»æ“ä½œå°½é‡å°‘æ‰§è¡Œï¼ˆåŸ‹ä¸ªå‘ï¼Œåé¢å†å»ç ”ç©¶ï¼‰","tags":[{"name":"clickhouse","slug":"clickhouse","permalink":"http://xupin.im/tags/clickhouse/"},{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"}]},{"title":"Goå­¦ä¹ ç¬”è®° - é—­åŒ…å‡½æ•°ã€åŒ¿åå‡½æ•°åŠlambdaâ€œå‡½æ•°â€æœ‰ä»€ä¹ˆå…³ç³»","date":"2022-01-18T16:00:00.000Z","path":"2022/01/19/func-closure-lambda-diff/","text":"ç»å¸¸åœ¨æŠ€æœ¯åšå®¢ä¸­çœ‹åˆ°åŒ¿åå‡½æ•°ã€é—­åŒ…å‡½æ•°å’Œ lambda è¡¨è¾¾å¼è¿™æ ·åè¯ï¼Œä½†ä¸€ç›´å‚»å‚»åˆ†ä¸æ¸…ä»–ä»¬ä¹‹é—´ç©¶ç«Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæ‰€ä»¥æƒ³ä¸€æ¢ç©¶ç«Ÿã€‚ å‡½æ•°å®šä¹‰ä¸€ä¸ªå‡½æ•°çš„å®šä¹‰ï¼Œä¸€èˆ¬ä¼šåŒ…å«ï¼šå‡½æ•°åã€å‡½æ•°çš„å‚æ•°ã€å‡½æ•°çš„ä¸»ä½“ï¼ˆä»£ç å—ï¼‰ã€å‡½æ•°çš„è¿”å›ç±»å‹&#x2F;å€¼ã€‚ 123func hello(name string) string &#123; return &quot;Hello, &quot; + name&#125; é—­åŒ…å‡½æ•°é€šè¿‡å­—é¢æ„æ€ç†è§£ï¼Œå³å®šä¹‰åœ¨å†…éƒ¨çš„å‡½æ•°ã€‚ 12345678910111213141516171819202122232425package mainimport &quot;fmt&quot;func main() &#123; t := test() t() t() t()&#125;func test() func() &#123; x := 0 fmt.Println(&quot;test()&quot;, x, &amp;x) return func() &#123; x += 1 fmt.Println(&quot;closure()&quot;, x, &amp;x) &#125;&#125;// æ‰§è¡Œç¨‹åºè¾“å‡ºä»¥ä¸‹å†…å®¹// test() 0 0xc000016098// closure() 1 0xc000016098// closure() 2 0xc000016098// closure() 3 0xc000016098 æ‰§è¡Œ test()å‡½æ•°è¿”å›é—­åŒ…å‡½æ•°ã€‚ æ‰§è¡Œé—­åŒ…å‡½æ•°å‘ç°å¯ä»¥ä½¿ç”¨ x å˜é‡ï¼Œä½†ä¸ç”¨å£°æ˜ x å˜é‡ã€‚ å†æ¬¡æ‰§è¡Œé—­åŒ…å‡½æ•°ä»æ—§å¯ä»¥ä½¿ç”¨ x å˜é‡ï¼Œè¯´æ˜é—­åŒ…å‡½æ•°è‡ªèº«åœ¨â€œç»´æŠ¤â€x å˜é‡ã€‚ é€šè¿‡å†…å­˜åœ°å€å¯ä»¥çœ‹å‡ºé—­åŒ…å‡½æ•°å’Œ test()å‡½æ•°çš„ x å˜é‡æ˜¯åŒä¸€ä¸ªå˜é‡ã€‚ æ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºï¼šå‡½æ•°åˆ›å»ºæ—¶è·å–æ‰€éœ€å¤–éƒ¨çŠ¶æ€ï¼Œå³ä½¿å¤–éƒ¨çŠ¶æ€å…³é—­ï¼Œå‡½æ•°ä¸­çš„çŠ¶æ€è¿˜ä¼šå­˜åœ¨ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯â€œé—­åŒ…â€ï¼Œæˆ–è®¸é—­åŒ…å‡½æ•°è§£å†³çš„æ˜¯å˜é‡ä½œç”¨åŸŸçš„é—®é¢˜ï¼Ÿ å¼•ç”¨ JavaScript MDN å¯¹é—­åŒ…å‡½æ•°çš„ä¸€å¥è§£é‡Šï¼š A closure is the combination of a function and the lexical environment within which that function was declared. åŒ¿åå‡½æ•°åŒ¿åå‡½æ•°ï¼Œå³â€œæ— åâ€å‡½æ•°ã€‚ 1234567891011package mainimport &quot;fmt&quot;func main() &#123; lam := func(x, y, z int) int &#123; return x + y + z &#125; x := lam(1, 2, 3) fmt.Println(x)&#125; åŒ¿åå‡½æ•°å¯ä»¥ç›´æ¥å®šä¹‰åœ¨ä»£ç å—ä¸­ã€‚åŒ¿åå‡½æ•°å¯ä»¥å‡å°‘å‡½æ•°æš´éœ²ï¼Œé˜²æ­¢è¢«å¤–éƒ¨ä»£ç è°ƒç”¨æ‰§è¡Œï¼ˆé¿å…æ•°æ®æ±¡æŸ“ï¼‰ã€‚ lambdaâ€œå‡½æ•°â€lambdaâ€œå‡½æ•°â€ï¼Œä¸¥æ ¼æ¥è¯´åº”è¯¥å« lambda è¡¨è¾¾å¼ã€‚å®ƒæ˜¯ä¸€ä¸ªå¯ä»¥æ¥å— N ä¸ªå‚æ•°ä½†åªè¿”å›å•ä¸ªè¡¨è¾¾å¼å€¼çš„â€œå‡½æ•°â€ï¼Œå¯ä»¥ç†è§£ä¸ºå®ƒæ˜¯åŒ¿åå‡½æ•°çš„ä¸€ç§ä»£ç é£æ ¼æˆ–è€…è¯­æ³•ç³–ã€‚ lambda ä¼šä½¿ä»£ç çœ‹èµ·æ¥æ¯”è¾ƒç®€æ´ï¼Œå¾ˆé€‚ç”¨äºè¿™ä¸ªå‡½æ•°â€œåªç”¨ä¸€æ¬¡â€çš„åœºæ™¯ã€‚æ¯”å¦‚ï¼š 123456789def square(x): return x * xprint(&quot;square()&quot;, list(map(square, [1, 2, 3, 4, 5])))print(&quot;lambda&quot;, list(map(lambda x: x * x, [1, 2, 3, 4, 5])))# è¾“å‡º# square() [1, 4, 9, 16, 25]# lambda [1, 4, 9, 16, 25] lambda è¡¨è¾¾å¼å¸¦æ¥ä»£ç ç®€æ´çš„åŒæ—¶ä¹Ÿæœ‰å‰¯ä½œç”¨ï¼Œlambda å¯è¯»æ€§è¾ƒå·®ï¼Œä¸é€‚ç”¨äºå¾ˆé•¿å¾ˆå¤æ‚çš„é€»è¾‘ï¼Œæ‰€ä»¥ä¸è¦ä¸ºäº†å†™ lambda è€Œå†™ lambdaã€‚ 123456789func = lambda x, y, z: x + y + zx = func(1, 2, 3)print(x)# ä»£ç è¢«è‡ªåŠ¨è½¬æ¢def func(x, y, z): return x + y + zx = func(1, 2, 3)print(x) åœ¨Visual Studio Codeä¸­ç¼–è¾‘ä¿å­˜è¿™æ®µä»£ç ä¼šè¢«è‡ªåŠ¨è½¬æ¢ï¼Œåœ¨PyCharmä¸­åˆ™ä¼šç›´æ¥ç»™å‡ºè­¦å‘ŠPEP 8: E731 do not assign a lambda expression, use a defautopep8 è‡³äºä¸ºä»€ä¹ˆè¿™ç§ä¹¦å†™æ–¹å¼ç§°ä¹‹ä¸º lambda è¡¨è¾¾å¼ï¼Œåˆ™æ˜¯æœ‰åŸå› çš„ï¼š Alonzo Church åœ¨ 30 å¹´ä»£å‘æ˜çš„Lambda Calculusï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­åšçš„ä¸€ä»¶äº‹å°±æ˜¯ Î» è¿ç®—ã€‚ æœ€åçŒœçŒœä»¥ä¸‹è¿™æ®µä»£ç æ‰§è¡Œåä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿ 123456789101112131415161718192021package mainimport ( &quot;fmt&quot; &quot;sync&quot;)func main() &#123; var wg sync.WaitGroup a := []int&#123;1, 2, 3, 4, 5, 6, 7, 8, 9&#125; for _, v := range a &#123; i := v fmt.Printf(&quot;for v:%d i:%d\\n&quot;, v, i) wg.Add(1) go func() &#123; defer wg.Done() fmt.Printf(&quot;func v:%d i:%d\\n&quot;, v, i) &#125;() &#125; wg.Wait()&#125;","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"lambda","slug":"lambda","permalink":"http://xupin.im/tags/lambda/"},{"name":"closure","slug":"closure","permalink":"http://xupin.im/tags/closure/"},{"name":"function","slug":"function","permalink":"http://xupin.im/tags/function/"}]},{"title":"ClickHouseå­¦ä¹ ç¬”è®° - æ•°æ®å¼•æ“","date":"2022-01-15T16:00:00.000Z","path":"2022/01/16/clickhouse-engines/","text":"ClickHouseæ˜¯ä¸ªç”±è€æ¯›å­å›½å†…å¸‚åœºä½¿ç”¨ç‡ç¬¬ä¸€çš„æœç´¢å¼•æ“Yandexå¼€æºçš„OLAPå‹åˆ—å¼æ•°æ®åº“ã€‚ èƒŒæ™¯ä¹‹å‰å› ä¸ºä¸šåŠ¡æ¥è§¦åˆ°ClickHouseï¼Œä½†å› ä¸ºæ²¡æœ‰ç³»ç»Ÿçš„äº†è§£è¿‡å¯¼è‡´é‡è§ä¸ªå¾ˆå°çš„é—®é¢˜ã€èŠ±äº†å¤§é‡çš„æ—¶é—´ã€ç”¨äº†å¾ˆæŒ«çš„æ–¹å¼æ¥è§£å†³é—®é¢˜ï¼Œç—›å®šæ€ç—›çš„æƒ…å†µä¸‹å†³å¿ƒç³»ç»Ÿçš„é€æ­¥å­¦ä¹ ä¸€ä¸‹ã€‚ClickHouseæ— è®ºæ˜¯å­˜å‚¨è¿˜æ˜¯ä½¿ç”¨æ–¹å¼éƒ½ä¸åŒç¨‹åº¦çš„å¼‚äºæˆ‘ä»¬å¸¸ç”¨çš„Mysqlï¼ŒPostgreSqlï¼ŒMssqlç­‰è¡Œå¼æ•°æ®åº“ï¼Œä½†å®ƒæ”¯æŒç»å¤§éƒ¨åˆ†çš„SQLè¯­æ³•ã€‚ æ•°æ®å¼•æ“ClickHouseï¼ˆåŸºäºv21.7ï¼‰çš„å¼•æ“åˆ†ä¸ºæ•°æ®åº“å¼•æ“å’Œè¡¨å¼•æ“ã€‚ æ•°æ®åº“å¼•æ“ MySQL é¡¾åæ€ä¹‰ï¼Œå’ŒMysqlæ•°æ®åº“æœ‰å…³ç³»ã€‚è¯¥å¼•æ“å…è®¸è¿æ¥è¿œç¨‹Mysqlæ•°æ®åº“å¹¶ä¸”æ‰§è¡ŒSqläº¤æ¢æ•°æ®ã€‚ä½†æ˜¯ä»…æ”¯æŒéƒ¨åˆ†æ“ä½œï¼ˆè¯»å†™ï¼‰ã€‚ MaterializeMySQL v20.8æ–°å¢çš„å¼•æ“ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤„åœ¨å®éªŒé˜¶æ®µçš„å¼•æ“ï¼Œé€šè¿‡åç§°å¯ä»¥çœ‹å‡ºæ¥ä¹Ÿæ˜¯å’ŒMysqlç›¸å…³çš„å¼•æ“ï¼Œè¯¥å¼•æ“é€šè¿‡binlogæ—¥å¿—è¿›è¡Œå…¨é‡ï¼ˆç¬¬ä¸€æ¬¡ï¼‰å’Œå¢é‡å®æ—¶ç‰©åŒ–ï¼ˆå¯ä»¥ç†è§£ä¸ºåŒæ­¥ï¼Ÿï¼‰Mysqlæ•°æ®ï¼ŒåŸæœ¬Mysqlçš„DDLå’ŒDMLæ“ä½œéƒ½å¯ä»¥é€šè¿‡ClickHouseæ‰§è¡Œã€‚ Lazy åœ¨æœ€åä¸€æ¬¡æ“ä½œè¯¥è¡¨ä¹‹åï¼Œä»…åœ¨å›ºå®šç§’æ•°å†…å°†è¡¨ä¿ç•™åœ¨è¿å­˜ä¸­ï¼Œè¯¥ç§’æ•°é€šè¿‡expiration_time_in_secondså‚æ•°æ§åˆ¶ã€‚ Atomic æ–°ç‰ˆæœ¬é»˜è®¤çš„æ•°æ®åº“å¼•æ“ï¼Œæ”¯æŒå¯¹è¡¨éé˜»å¡çš„dropã€renameæ“ä½œä»¥åŠåŸå­æ“ä½œäº¤æ¢ä¸¤å¼ è¡¨ã€‚ PostgreSQL è¯¥å¼•æ“çš„ç‰¹æ€§å’ŒMySQLå¼•æ“å¤§è‡´ç›¸åŒï¼Œåªä¸è¿‡æ˜¯å¯¹PostgreSqlçš„æ”¯æŒã€‚ MaterializedPostgreSQL ä¸MaterializeMySQLä¸€æ ·ï¼Œæ˜¯å®éªŒé˜¶æ®µçš„å¼•æ“ã€‚ä½œä¸ºPostgreSqlæ•°æ®è¡¨çš„å‰¯æœ¬è¿›è¡Œåå°åŒæ­¥ã€‚ Replicated åŸºäºAtomicå¼•æ“ï¼Œé€šè¿‡å°†DDLæ“ä½œæ—¥å¿—å†™å…¥ZKå¹¶åœ¨æ•°æ®åº“çš„æ‰€æœ‰å‰¯æœ¬ä¸Šæ‰§è¡Œçš„å…ƒæ•°æ®å¤åˆ¶ï¼ˆå¤åˆ¶æ•°æ®åº“ï¼‰ã€‚å¯ä»¥åŒæ—¶è¿è¡Œå’Œæ›´æ–°å¤šä¸ªå¤åˆ¶çš„æ•°æ®åº“ã€‚ä½†æ˜¯åŒä¸€ä¸ªå¤åˆ¶çš„æ•°æ®åº“ä¸èƒ½æœ‰å¤šä¸ªå‰¯æœ¬ã€‚ è¡¨å¼•æ“ï¼ˆè¡¨å¼•æ“æ¯”æ•°æ®åº“å¼•æ“ç¨å¾®å¤æ‚ä¸€äº›ï¼Œè¡¨å¼•æ“åˆåˆ†ä¸ºå››å¤§ç³»åˆ—ï¼‰ MergeTreeç³»åˆ— Logç³»åˆ— Integrationsç³»åˆ— Specialç±» MergeTreeç³»åˆ—MergeTreeç³»åˆ—çš„è¡¨å¼•æ“æ¯”è¾ƒå¸¸ç”¨ï¼Œå®ƒæ”¯æŒä¸»é”®ã€æ•°æ®åˆ†åŒºã€æ•°æ®å‰¯æœ¬å’Œæ•°æ®é‡‡æ ·ç­‰ç‰¹æ€§ï¼ŒåŒæ—¶æ”¯æŒé‡è¦çš„alteræ“ä½œè¯­å¥ã€‚ ReplacingMergeTree æ¸…æ´—æ•°æ®ï¼Œå»é™¤é‡å¤æ•°æ®ã€‚å½“æ•°æ®é‡å¤æ—¶æ•°æ®å»é‡ç­–ç•¥æœ‰ä¸¤ç§ï¼šé€šè¿‡ReplacingMergeTree(&#123;version&#125;)å»ºç«‹versionå­—æ®µåˆ™ä¿ç•™versionå­—æ®µæœ€å¤§å€¼ï¼Œå¦åˆ™åˆ™ä¿ç•™æœ€åä¸€è¡Œã€‚ SummingMergeTree æŒ‰ç…§é¢„å…ˆå®šä¹‰çš„èšåˆæ¡ä»¶æ±‡æ€»æ•°æ® AggregatingMergeTree SummingMergeTreeå¼•æ“çš„è¿›é˜¶ç‰ˆã€‚èƒ½å¤Ÿåœ¨åˆå¹¶åˆ†åŒºæ—¶ï¼ŒæŒ‰ç…§é¢„å…ˆå®šä¹‰çš„èšåˆæ¡ä»¶æ±‡æ€»æ•°æ®ã€‚ CollapsingMergeTree æ”¯æŒè¡Œçº§æ•°æ®çš„æ›´æ–°å’Œåˆ é™¤ï¼Œé€šè¿‡æŒ‡å®šå­—æ®µCollapsingMergeTree(&#123;sign&#125;)æ ‡è®°æ•°æ®è¡Œçš„çŠ¶æ€ï¼ˆçŠ¶æ€å€¼ï¼š1ï¼Œ-1ï¼‰ã€‚åˆ†åŒºåˆå¹¶æ—¶ï¼ŒåŒä¸€ä¸ªæ•°æ®åˆ†åŒºå†…signå€¼ä¸º1çš„æ•°æ®è¡Œä¼šå’Œä¸‹ä¸€è¡Œsignå€¼ä¸º-1çš„æŠµæ¶ˆåˆ é™¤ã€‚å¦‚æœå¹¶å‘å†™å…¥æ—¶åˆ™ä¼šå¯¼è‡´ä¹±åºé—®é¢˜ï¼Œå³signå€¼1å’Œ-1çš„æ•°æ®è¡Œå¹¶ä¸ç›¸ä¸´çš„é—®é¢˜ã€‚ VersionedCollapsingMergeTree CollapsingMergeTreeå¼•æ“çš„è¿›é˜¶ç‰ˆã€‚é€šè¿‡VersionedCollapsingMergeTree(&#123;sign&#125;,&#123;version&#125;)æ–°å¢versionå­—æ®µè§£å†³ä¹±åºé—®é¢˜ã€‚ GraphiteMergeTree å­˜å‚¨æ—¶åºæ•°æ®åº“Graphiteçš„æ•°æ®ã€‚ Logç³»åˆ—Logå¼•æ“é¢å‘çš„åº”ç”¨åœºæ™¯ä¸€èˆ¬æ˜¯ï¼šå°æ•°æ®é‡ã€å¤šå†™å°‘æŸ¥ã€å•æ¬¡æŸ¥è¯¢æ•°æ®è¾ƒå¤§ã€‚ StripLog æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è¯»å–æ–‡ä»¶ï¼ˆdata.binï¼‰ï¼Œæ•°æ®å†™å…¥æ—¶ä¼šå°†æ‰€æœ‰æ•°æ®åˆ—å­˜å‚¨åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ TinyLog æ•°æ®å†™å…¥æ—¶æ¯ä¸ªæ•°æ®åˆ—å­˜å‚¨åœ¨ä¸åŒçš„æ–‡ä»¶ï¼ˆ{column}.binï¼‰ï¼Œä½†ä¸æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è¯»å–æ–‡ä»¶ã€‚ Log æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è¯»å–æ–‡ä»¶ï¼Œå†™å…¥æ—¶æ¯ä¸ªæ•°æ®åˆ—å•ç‹¬å­˜å‚¨æ–‡ä»¶ã€‚ Integrationsç³»åˆ—è¯¥ç±»å¼•æ“æä¾›å¤šç§æ–¹å¼ä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆï¼ˆå¤–éƒ¨è¡¨ï¼‰ï¼Œæ”¯æŒåŒ…æ‹¬ä½†ä¸ä»…é™äºï¼š ODBC JDBC Mysql MongoDB HDFS S3 Kafka EmbeddedRocksDB RabbitMQ PostgreSQL SQLite Hive Specialç±»è¿™ä¸ªåˆ†ç±»ä¸‹çš„å¼•æ“é€‚ç”¨äºå®šåˆ¶åŒ–çš„ä¸šåŠ¡åœºæ™¯ã€‚ å†…å­˜ç±» Memory å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½†ä¸æä¾›æŒä¹…åŒ–æ“ä½œï¼Œé‡å¯æ•°æ®å°±è·‘ä¸¢äº†ã€‚ Set é€‚ç”¨äºé›†åˆç±»å‹çš„æŸ¥è¯¢æ“ä½œï¼Œæ¯”å¦‚ï¼šinã€‚ Join æœ›æ–‡ç”Ÿä¹‰ï¼Œä¸ºäº†è¿è¡¨æŸ¥è¯¢ã€‚ Buffer é€šä¿—çš„è¯´åƒæ˜¯æ•°æ®è„é¡µè®¾ç½®ä¸€ä¸ªåˆ·æ–°é˜ˆå€¼ï¼Œè¾¾åˆ°å³åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚ ä¸­é—´ä»¶ç±» Distributed è‡ªåŠ¨åˆ†ç‰‡ã€è‡ªåŠ¨å†™å…¥å’ŒæŸ¥è¯¢æ•°æ®ã€‚ Dictionary è‡ªåŠ¨ä¸ºæ•°æ®å­—å…¸åˆ›å»ºæ•°æ®è¡¨ã€‚ Merge åˆå¹¶å¤šä¸ªç›¸åŒè¡¨ç»“æ„çš„æŸ¥è¯¢ç»“æœã€‚ å…¶ä»– Null å†™å…¥çš„æ•°æ®ä¼šè¢«ä¸¢å¼ƒ â€¦ æš‚æ—¶ä¸æ‡‚ä»€ä¹ˆç”¨é€”ï¼Œå®˜æ–¹çš„æè¿°æ˜¯é€‚ç”¨äºè§†å›¾å±•ç¤ºã€‚ Url é…åˆRESTfulæ¥å£ï¼Œæ“ä½œä¼šè½¬åŒ–ä¸ºï¼šinsert &#x3D;&gt; postã€select &#x3D;&gt; getã€‚ Live View å®éªŒé˜¶æ®µçš„å¼•æ“ï¼Œå¯¹äº‹ä»¶ç›‘å¬è¿›è¡Œå®æ—¶æ•°æ®è®¡ç®—ã€‚é€‚ç”¨åœºæ™¯æ¯”å¦‚ï¼šè¯åˆ¸ç½‘ç«™ã€‚ æ€»ç»“ç®€å•çš„æµè§ˆäº†ClickHouseä¸åŒçš„æ•°æ®å¼•æ“ï¼Œæ¥ä¸‹æ¥ä¼šå­¦ä¹ å­˜å‚¨ç»“æ„å’Œç´¢å¼•æ–¹å¼ï¼ˆææ¸…æ¥šä¸ºä»€ä¹ˆæŸ¥è¯¢è¿™ä¹ˆå¿«ï¼‰ã€‚","tags":[{"name":"clickhouse","slug":"clickhouse","permalink":"http://xupin.im/tags/clickhouse/"},{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"}]},{"title":"ClickHouseå­¦ä¹ ç¬”è®° - æ•°ç»„æ‹†åˆ†å†åˆ†ç»„","date":"2022-01-13T16:00:00.000Z","path":"2022/01/14/clickhouse-array-split-group/","text":"ClickHouseæ˜¯ä¸ªç”±è€æ¯›å­å›½å†…å¸‚åœºä½¿ç”¨ç‡ç¬¬ä¸€çš„æœç´¢å¼•æ“Yandexå¼€æºçš„OLAPå‹åˆ—å¼æ•°æ®åº“ã€‚ èƒŒæ™¯æœ€è¿‘ï¼Œæ•°æ®åˆ†æé¡¹ç›®è¦åšä¸€ä¸ªå¹¿å‘Šç´ ææ¨å¹¿æˆæ•ˆåˆ†æåŠŸèƒ½ã€‚éœ€æ±‚è¯„å®¡ä¸‹æ¥å¤§æ¦‚æ˜¯é€šè¿‡ç»™å¹¿å‘Šç´ ææ‰“æ ‡ç­¾è¿›è¡Œåˆ†ç±»ï¼Œç„¶åæŒ‰æ ‡ç­¾çº¬åº¦è¿›è¡Œåˆ†ææ•°æ®ã€‚ æ•°æ®åº“é€‰å‹è¯¥é¡¹ç›®ä¹‹å‰çš„æ•°æ®æ˜¯å­˜æ”¾åœ¨Elasticsearchï¼Œä½†æ€»æ˜¯æ„Ÿè§‰ESçš„DSLè¯­å¥è¿‡äºç¹çä¸åˆ©äºé˜…è¯»ä¸”å­¦ä¹ æˆæœ¬è¾ƒé«˜ï¼Œå†…éƒ¨é’ˆå¯¹è¯¥é—®é¢˜è®¨è®ºä¹‹åé€‰ç”¨äº†åœ¨å¤§æ•°æ®å¤„ç†ä¸ŠåŒæ ·å‡ºè‰²çš„ClickHouseä½œä¸ºæ–°åŠŸèƒ½çš„æ•°æ®ä»“åº“ï¼ˆè¯•ç‚¹åŠŸèƒ½233ï¼‰ã€‚ æ•°æ®ç»“æ„å› ä¸ºæ˜¯åˆ—å¼æ•°æ®åº“ï¼Œæ‰€ä»¥ä¸éœ€è¦éµå®ˆæ•°æ®åº“ä¸‰å¤§èŒƒå¼ã€‚ ä¼ªè¡¨ç»“æ„ï¼š 1234567891011121314CREATE TABLE creative_daily_summary( `date` Date, `creative_id` String, `tags` Array(String), `revenue` Float64, `cost` Float64, `impressions` Int64, `clicks` Int64, `installs` Int64)ENGINE = MergeTreeORDER BY dateSETTINGS index_granularity = 8192 è¿™é‡Œå› ä¸ºè€ƒè™‘æ•°æ®å†—ä½™çš„é—®é¢˜ï¼Œæ ‡ç­¾å­˜å‚¨ä¸ºæ•°ç»„ç±»å‹ï¼ˆæ‰€ä»¥ä¹Ÿå°±å‡ºç°äº†è¿™ç¯‡ç¬”è®°ï¼‰ã€‚ å­˜å‚¨ä¸€äº›æ•°æ®ï¼š 12345INSERT INTO creative_daily_summary (`date`,creative_id,tags,revenue,cost,impressions,clicks,installs) VALUES (&#x27;2022-01-07&#x27;,&#x27;1721&#x27;,[&#x27;ä»£å…¥/ä»£å…¥è§’è‰²/å±å¹•å¤–è§’è‰²&#x27;,&#x27;ç©æ³•/è£…ä¿®/ä¿®ç†&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥/å»ºç­‘å‡çº§&#x27;,&#x27;ç©æ³•/å°æ¸¸æˆ/æƒ…æ™¯é€‰æ‹©(åºŸé™¤)&#x27;,&#x27;å…ƒç´ /å…¶ä»–/äººæ‰‹&#x27;,&#x27;å…ƒç´ /å…¶ä»–/è¡¨æƒ…åŒ…&#x27;,&#x27;å…ƒç´ /åœºæ™¯/å†œåœº&#x27;],0.0,2.41,2204,0,0);INSERT INTO creative_daily_summary (`date`,creative_id,tags,revenue,cost,impressions,clicks,installs) VALUES (&#x27;2022-01-07&#x27;,&#x27;1721&#x27;,[&#x27;ä»£å…¥/ä»£å…¥è§’è‰²/å±å¹•å¤–è§’è‰²&#x27;,&#x27;ç©æ³•/è£…ä¿®/ä¿®ç†&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥/å»ºç­‘å‡çº§&#x27;,&#x27;ç©æ³•/å°æ¸¸æˆ/æƒ…æ™¯é€‰æ‹©(åºŸé™¤)&#x27;,&#x27;å…ƒç´ /å…¶ä»–/äººæ‰‹&#x27;,&#x27;å…ƒç´ /å…¶ä»–/è¡¨æƒ…åŒ…&#x27;,&#x27;å…ƒç´ /åœºæ™¯/å†œåœº&#x27;],0.0,0.05,9,1,0);INSERT INTO creative_daily_summary (`date`,creative_id,tags,revenue,cost,impressions,clicks,installs) VALUES (&#x27;2022-01-08&#x27;,&#x27;1788&#x27;,[&#x27;ä»£å…¥/è§†è§’é•œå¤´/ç¬¬ä¸€äººç§°&#x27;,&#x27;å‰§æƒ…/æƒ…æ„Ÿå…±é¸£/è‚²å„¿&#x27;,&#x27;å‰§æƒ…/æ´åŠ©/è§£æ•‘&#x27;,&#x27;å‰§æƒ…/å›°å¢ƒ/è‡ªç„¶ç¾å®³&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥/æ‘˜æœ&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥/å¼•æ°´&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥/å»ºç­‘å‡çº§&#x27;,&#x27;ç©æ³•/æ”¹å˜åœ°å½¢/æŒ–æ²³é“&#x27;],0.0,130.64,31868,63,7);INSERT INTO creative_daily_summary (`date`,creative_id,tags,revenue,cost,impressions,clicks,installs) VALUES (&#x27;2022-01-09&#x27;,&#x27;1788&#x27;,[&#x27;ä»£å…¥/è§†è§’é•œå¤´/ç¬¬ä¸€äººç§°&#x27;,&#x27;å‰§æƒ…/æƒ…æ„Ÿå…±é¸£/è‚²å„¿&#x27;,&#x27;å‰§æƒ…/æ´åŠ©/è§£æ•‘&#x27;,&#x27;å‰§æƒ…/å›°å¢ƒ/è‡ªç„¶ç¾å®³&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥/æ‘˜æœ&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥/å¼•æ°´&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥/å»ºç­‘å‡çº§&#x27;,&#x27;ç©æ³•/æ”¹å˜åœ°å½¢/æŒ–æ²³é“&#x27;],0.0,0.04,76,0,0);INSERT INTO creative_daily_summary (`date`,creative_id,tags,revenue,cost,impressions,clicks,installs) VALUES (&#x27;2022-01-10&#x27;,&#x27;2124&#x27;,[&#x27;ä»£å…¥/ä»£å…¥è§’è‰²/å›ºå®šè§’è‰²-å¥³æ€§&#x27;,&#x27;å‰§æƒ…/æƒ…æ„Ÿå…±é¸£/è´­ç‰©ç„¦è™‘&#x27;,&#x27;ç›®çš„/ç›®çš„/æ‹‰æ–°&#x27;,&#x27;å½¢å¼/æŠ€æœ¯å½¢å¼/3D&#x27;,&#x27;å…ƒç´ /åœºæ™¯/åŸå¸‚è¡—é“&#x27;,&#x27;å…ƒç´ /åœºæ™¯/å®¤å†…å…¬å…±åœºæ‰€&#x27;],0.0,0.02,5,0,0); date creative_id tags revenue cost impressions clicks installs 2022-01-07 1721 [â€˜ä»£å…¥&#x2F;ä»£å…¥è§’è‰²&#x2F;å±å¹•å¤–è§’è‰²â€™,â€™ç©æ³•&#x2F;è£…ä¿®&#x2F;ä¿®ç†â€™,â€™ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥&#x2F;å»ºç­‘å‡çº§â€™,â€™ç©æ³•&#x2F;å°æ¸¸æˆ&#x2F;æƒ…æ™¯é€‰æ‹©(åºŸé™¤)â€™,â€™å…ƒç´ &#x2F;å…¶ä»–&#x2F;äººæ‰‹â€™,â€™å…ƒç´ &#x2F;å…¶ä»–&#x2F;è¡¨æƒ…åŒ…â€™,â€™å…ƒç´ &#x2F;åœºæ™¯&#x2F;å†œåœºâ€™] 0.0 2.41 2204 0 0 2022-01-07 1721 [â€˜ä»£å…¥&#x2F;ä»£å…¥è§’è‰²&#x2F;å±å¹•å¤–è§’è‰²â€™,â€™ç©æ³•&#x2F;è£…ä¿®&#x2F;ä¿®ç†â€™,â€™ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥&#x2F;å»ºç­‘å‡çº§â€™,â€™ç©æ³•&#x2F;å°æ¸¸æˆ&#x2F;æƒ…æ™¯é€‰æ‹©(åºŸé™¤)â€™,â€™å…ƒç´ &#x2F;å…¶ä»–&#x2F;äººæ‰‹â€™,â€™å…ƒç´ &#x2F;å…¶ä»–&#x2F;è¡¨æƒ…åŒ…â€™,â€™å…ƒç´ &#x2F;åœºæ™¯&#x2F;å†œåœºâ€™] 0.0 0.05 9 1 0 2022-01-08 1788 [â€˜ä»£å…¥&#x2F;è§†è§’é•œå¤´&#x2F;ç¬¬ä¸€äººç§°â€™,â€™å‰§æƒ…&#x2F;æƒ…æ„Ÿå…±é¸£&#x2F;è‚²å„¿â€™,â€™å‰§æƒ…&#x2F;æ´åŠ©&#x2F;è§£æ•‘â€™,â€™å‰§æƒ…&#x2F;å›°å¢ƒ&#x2F;è‡ªç„¶ç¾å®³â€™,â€™ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥&#x2F;æ‘˜æœâ€™,â€™ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥&#x2F;å¼•æ°´â€™,â€™ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥&#x2F;å»ºç­‘å‡çº§â€™,â€™ç©æ³•&#x2F;æ”¹å˜åœ°å½¢&#x2F;æŒ–æ²³é“â€™] 0.0 130.64 31868 63 7 2022-01-09 1788 [â€˜ä»£å…¥&#x2F;è§†è§’é•œå¤´&#x2F;ç¬¬ä¸€äººç§°â€™,â€™å‰§æƒ…&#x2F;æƒ…æ„Ÿå…±é¸£&#x2F;è‚²å„¿â€™,â€™å‰§æƒ…&#x2F;æ´åŠ©&#x2F;è§£æ•‘â€™,â€™å‰§æƒ…&#x2F;å›°å¢ƒ&#x2F;è‡ªç„¶ç¾å®³â€™,â€™ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥&#x2F;æ‘˜æœâ€™,â€™ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥&#x2F;å¼•æ°´â€™,â€™ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥&#x2F;å»ºç­‘å‡çº§â€™,â€™ç©æ³•&#x2F;æ”¹å˜åœ°å½¢&#x2F;æŒ–æ²³é“â€™] 0.0 0.04 76 0 0 2022-01-10 2124 [â€˜ä»£å…¥&#x2F;ä»£å…¥è§’è‰²&#x2F;å›ºå®šè§’è‰²-å¥³æ€§â€™,â€™å‰§æƒ…&#x2F;æƒ…æ„Ÿå…±é¸£&#x2F;è´­ç‰©ç„¦è™‘â€™,â€™ç›®çš„&#x2F;ç›®çš„&#x2F;æ‹‰æ–°â€™,â€™å½¢å¼&#x2F;æŠ€æœ¯å½¢å¼&#x2F;3Dâ€™,â€™å…ƒç´ &#x2F;åœºæ™¯&#x2F;åŸå¸‚è¡—é“â€™,â€™å…ƒç´ &#x2F;åœºæ™¯&#x2F;å®¤å†…å…¬å…±åœºæ‰€â€™] 0.0 0.02 5 0 0 æ£€ç´¢æ•ˆæœäº§å“æœŸæœ›å®ç°çš„éœ€æ±‚æ˜¯ç»Ÿè®¡â€œæ ‡ç­¾â€çš„æ•°æ®ï¼Œä½†è¿™ä¸ªâ€œæ ‡ç­¾â€å¹¶ä¸æ˜¯å®Œæ•´çš„æ ‡ç­¾ï¼ˆä»£å…¥&#x2F;ä»£å…¥è§’è‰²&#x2F;å±å¹•å¤–è§’è‰²ï¼‰ï¼Œè€Œæ˜¯æ ‡ç­¾çš„ä¸€éƒ¨åˆ†ï¼ˆæ¯”å¦‚ä»£å…¥ã€ä»£å…¥è§’è‰²ã€å±å¹•å¤–è§’è‰²ç­‰ï¼Œæ‹†åˆ†å¼€æ¥çš„ï¼‰ï¼ŒåŒæ—¶ä¸€ä¸ªå¹¿å‘Šç´ æå¦‚æœæ»¡è¶³å¤šä¸ªæ ‡ç­¾å³æ‹†åˆ†æˆå¤šæ¡æ•°æ®ã€‚ æ€è·¯1 åˆ©ç”¨å­æŸ¥è¯¢å†åˆ†ç»„ï¼Œè¿™æ ·ä¼šæœ‰æ•°æ®é‡å¤çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦å†å¥—ä¸€å±‚æŸ¥è¯¢å»é‡ã€‚ 12345678910111213141516171819202122232425262728293031323334select date, tag, sum(cost) as costfrom ( select date, tag, creative_id, sumDistinct(cost) as cost from ( select date, arrayJoin(tags) as t, concat(arrayElement(splitByChar(&#x27;/&#x27;,t),1),&#x27;/&#x27;,arrayElement(splitByChar(&#x27;/&#x27;,t),2)) as tag, creative_id, sum(cost) as cost from creative_daily_summary where tag in (&#x27;ä»£å…¥/ä»£å…¥è§’è‰²&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥&#x27;) group by t, creative_id, date) group by tag, creative_id, date)group by tag, date date tag cost 2022-01-08 ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥ 130.64 2022-01-07 ä»£å…¥&#x2F;ä»£å…¥è§’è‰² 2.46 2022-01-10 ä»£å…¥&#x2F;ä»£å…¥è§’è‰² 0.02 2022-01-09 ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥ 0.04 2022-01-07 ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥ 2.46 æ€è·¯2 å› ä¸ºæ·±æ„Ÿç¬¬ä¸€ç§æ–¹å¼å¤ªæŒ«ï¼Œæ•ˆç‡ä¸é«˜ä¸”æ¯«æ— ç¾æ„Ÿï¼ˆæœ€é‡è¦çš„æ˜¯æ€»æ„Ÿè§‰è§£å†³çš„æ–¹å‘ä¸å¯¹ï¼‰ã€‚ 1234567891011select date, arrayJoin(arrayDistinct(arrayMap(tag -&gt; concat(arrayElement(splitByChar(&#x27;/&#x27;,tag),1),&#x27;/&#x27;,arrayElement(splitByChar(&#x27;/&#x27;,tag),2)),tags))) as tag, sum(cost) as costfrom creative_daily_summarywhere tag in(&#x27;ä»£å…¥/ä»£å…¥è§’è‰²&#x27;,&#x27;ç©æ³•/æ¨¡æ‹Ÿç»è¥&#x27;)group by date, tag date tag cost 2022-01-10 ä»£å…¥&#x2F;ä»£å…¥è§’è‰² 0.02 2022-01-07 ä»£å…¥&#x2F;ä»£å…¥è§’è‰² 2.46 2022-01-08 ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥ 130.64 2022-01-07 ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥ 2.46 2022-01-09 ç©æ³•&#x2F;æ¨¡æ‹Ÿç»è¥ 0.04 æ€»ç»“æ¥è§¦æ–°çš„äº‹ç‰©è¿˜æ˜¯è¦æŠ±ç€è°¦é€Šçš„æ€åº¦å…ˆç³»ç»Ÿçš„äº†è§£ä¸€ä¸‹ä¼˜åŠ¿å’Œç¼ºç‚¹ï¼Œä¸ç„¶è§£å†³é—®é¢˜æ—¶æ€»ä¼šé™·å…¥å®šå¼æ€ç»´çš„æ€ªåœˆï¼ˆåœ¨é”™è¯¯çš„æ–¹å‘æµªè´¹æ—¶é—´å’Œç²¾åŠ›ï¼‰ã€‚","tags":[{"name":"clickhouse","slug":"clickhouse","permalink":"http://xupin.im/tags/clickhouse/"},{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"}]},{"title":"Goå­¦ä¹ ç¬”è®° - æ§åˆ¶åç¨‹æ•°é‡","date":"2021-12-02T16:00:00.000Z","path":"2021/12/03/go-coroutine-number/","text":"ä¹‹å‰å› ä¸ºéœ€è¦å¹¶å‘åŒæ­¥å•å¼ æ•°æ®è¡¨çš„è„šæœ¬ï¼Œå› ä¸ºè®¾ç½®åç¨‹æ•°é‡å¤ªå¤šè¿æ¥æ•°è¿‡é«˜å¯¼è‡´æœåŠ¡å®•æœº â€¦ å¾—ä¸å¿å¤±ï¼Œæ‰€ä»¥æƒ³æ€ä¹ˆæ§åˆ¶ä¸€ä¸‹åç¨‹æ•°é‡ Channelåˆ©ç”¨channelé˜»å¡ï¼Œä¸Šä»£ç ï¼š 123456789101112131415161718192021222324package mainimport ( &quot;fmt&quot; &quot;sync&quot; &quot;time&quot;)func main() &#123; // å…è®¸æœ€å¤§åç¨‹æ•° ch := make(chan int, 5) wg := &amp;sync.WaitGroup&#123;&#125; for i := 0; i &lt; 10; i++ &#123; wg.Add(1) ch &lt;- i // ché•¿åº¦ç­‰äº5æ—¶ï¼Œé˜»å¡ç­‰å¾… go func(i int) &#123; defer wg.Done() fmt.Println(&quot;è®°å½•æ‰§è¡Œ &quot;, i) time.Sleep(time.Second * 3) fmt.Println(&quot;æ‰§è¡Œå®Œæ¯• &quot;, &lt;-ch) &#125;(i) &#125; wg.Wait()&#125; åŸç†å°±æ˜¯åˆ©ç”¨channelé€šé“çš„ç‰¹æ€§ï¼Œå½“é€šé“æ»¡çš„æ—¶å€™ç»§ç»­å‘é€šé“ä¸¢æ•°æ®ä¼šé˜»å¡ä»£ç æ‰§è¡Œã€‚ å°è£…ä¸€ä¸‹: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package mainimport ( &quot;fmt&quot; &quot;sync&quot; &quot;time&quot;)type Worker struct &#123; ch chan interface&#123;&#125; wg *sync.WaitGroup&#125;func main() &#123; // å…è®¸æœ€å¤§åç¨‹æ•° worker := NewWorker(5) for i := 0; i &lt; 10; i++ &#123; worker.Run(i) go func(i int) &#123; fmt.Println(&quot;è®°å½•æ‰§è¡Œ &quot;, i) time.Sleep(time.Second * 3) key := worker.Done() fmt.Println(&quot;æ‰§è¡Œå®Œæ¯• &quot;, key) &#125;(i) &#125; worker.Wait()&#125;func NewWorker(size int) *Worker &#123; return &amp;Worker&#123; ch: make(chan interface&#123;&#125;, size), wg: &amp;sync.WaitGroup&#123;&#125;, &#125;&#125;func (w *Worker) Run(key interface&#123;&#125;) &#123; w.ch &lt;- key w.wg.Add(1)&#125;func (w *Worker) Done() interface&#123;&#125; &#123; key := &lt;-w.ch w.wg.Done() return key&#125;func (w *Worker) Wait() &#123; w.wg.Wait()&#125; Goroutine Poolæ„Ÿè§‰Duckä¸å¿… â€¦ æ—¥åå†è°ˆ","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"golang","slug":"golang","permalink":"http://xupin.im/tags/golang/"}]},{"title":"Goå­¦ä¹ ç¬”è®° - å¹¶å‘æŸ¥è¯¢å•è¡¨","date":"2021-12-01T16:00:00.000Z","path":"2021/12/02/go-coroutine-query/","text":"æœ€è¿‘æ¥è§¦ä¸€ä¸ªé¡¹ç›®ï¼Œéœ€è¦æ¯å¤©å®šæ—¶æŠŠPgSqlä¸€å¼ æ•°æ®é‡è¶…å¤§çš„æ•°æ®è¡¨åŒæ­¥åˆ°ClickHouse æ€è€ƒè¿™ç§åœºæ™¯ä¸‹æ€ä¹ˆæé«˜åŒæ­¥é€Ÿåº¦ã€‚ æŒ‰ä¸»é”®åˆ†é¡µæ€è·¯ æŒ‰ç…§ä¸»é”®æ’åºåˆ†åŒºé—´æŸ¥è¯¢ ä»£ç  123456789101112131415161718192021222324252627282930313233package mainimport ( &quot;fmt&quot; &quot;math&quot; &quot;strconv&quot; &quot;sync&quot;)func main() &#123; maxId := 203202 pageNum := 1500 num, _ := strconv.ParseFloat(fmt.Sprintf(&quot;%.2f&quot;, float64(maxId)/float64(pageNum)), 64) maxPage := int(math.Ceil(num)) wg := &amp;sync.WaitGroup&#123;&#125; for i := 0; i &lt; maxPage; i++ &#123; wg.Add(1) go func(i int) &#123; defer wg.Done() startId := (i * pageNum) endId := startId + pageNum if endId &gt; maxId &#123; endId = maxId &#125; sql := fmt.Sprintf(&quot;select * from logs where id &gt;= %d and id &lt;= %d&quot;, startId, endId) fmt.Printf(&quot;ç¬¬ %d é¡µ SQL: %s\\n&quot;, i+1, sql) &#125;(i) &#125; wg.Wait()&#125; ä¼˜ç‚¹ å‘½ä¸­ç´¢å¼•æŸ¥è¯¢ ç¼ºç‚¹ PgSqlè®¾ç½®ä¸»é”®ä¼šå½±å“æ’å…¥å’ŒæŸ¥è¯¢é€Ÿåº¦ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆPgSqlæ•°æ®è¡¨ä¸€èˆ¬ä¸è®¾ç½®ä¸»é”®çš„åŸå›  æ¸¸æ ‡æ€è·¯ å¤šä¸ªåç¨‹è·å–åŒä¸€ä¸ªæ¸¸æ ‡çš„æ•°æ® ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263package mainimport ( &quot;fmt&quot; &quot;project/postgresql&quot; &quot;math&quot; &quot;strconv&quot; &quot;sync&quot;)func main() &#123; // pgSql client cli := postgresql.GetClient() // trx tx, err := cli.Begin() if err != nil &#123; panic(err) &#125; // è®¡ç®—å¤šå°‘ä¸ªcoroutine cnt := 0 cli.QueryRow(&quot;select count(*) from logs&quot;).Scan(&amp;cnt) pageNum := 1500 num, _ := strconv.ParseFloat(fmt.Sprintf(&quot;%.2f&quot;, float64(cnt)/float64(pageNum)), 64) maxPage := int(math.Ceil(num)) // cursor cursorName := &quot;cursor_name&quot; cursorQuery := &quot;select * from logs&quot; tx.Query(&quot;DECLARE &quot; + cursorName + &quot; CURSOR FOR &quot; + cursorQuery) wg := &amp;sync.WaitGroup&#123;&#125; lock := &amp;sync.Mutex&#123;&#125; for i := 1; i &lt;= maxPage; i++ &#123; wg.Add(1) go func(i int) &#123; defer wg.Done() // äº’æ–¥é” lock.Lock() // æ¯æ¬¡å–&#123;pageNum&#125;æ¡ rows, err := tx.Query(&quot;FETCH FORWARD &quot; + strconv.Itoa(pageNum) + &quot; FROM &quot; + cursorName) if err != nil &#123; panic(err) &#125; defer rows.Close() // å¤„ç†è¿­ä»£é€»è¾‘ // for rows.Next() &#123; // &#125; fmt.Printf(&quot;ç¬¬ %d é¡µ ç»“æœ: %v\\n&quot;, i, rows) // è§£é” // TODO ä¸€å®šè¦è¿­ä»£å®Œæˆåå†è§£é” lock.Unlock() &#125;(i) &#125; wg.Wait() tx.Commit()&#125; ä¼˜ç‚¹ èƒ½ä¿è¯æ•°æ®çš„å®Œæ•´ï¼Œå¯é æ€§è¾ƒé«˜ ç¼ºç‚¹ å¿…é¡»ç­‰å¾…ç»“æœé›†è¿­ä»£å®Œæˆåæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ª ä¸ºå•¥ä¸ç”¨ offset, limitå› ä¸ºoffset, limitä¼šæ‰«å…¨è¡¨ 233","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"golang","slug":"golang","permalink":"http://xupin.im/tags/golang/"}]},{"title":"Pythonå­¦ä¹ ç¬”è®° - yield","date":"2021-11-21T16:00:00.000Z","path":"2021/11/22/python-yield/","text":"åœ¨ç¨‹åºä¸­é™¤äº†è¿­ä»£å™¨è¿˜æœ‰ç”Ÿæˆå™¨å‡æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œè¿­ä»£å™¨æ˜¯é€šè¿‡ç§»åŠ¨æ¸¸æ ‡æ¥éå†æ•°æ®ï¼Œé‚£ç”Ÿæˆå™¨å‘¢ ç”Ÿæˆå™¨ç”Ÿæˆå™¨åˆ›å»ºæ–¹å¼ï¼ˆpythonï¼‰ (è¡¨è¾¾å¼)123456generator = (i for i in [1, 2, 3]) // è¿™é‡Œæœ‰åŒºåˆ«äº [i for i in [1, 2, 3]]print(generator) # &lt;generator object &lt;genexpr&gt; at 0x10c312870&gt;print(next(generator)) # 1print(next(generator)) # 2print(next(generator)) # 3print(next(generator)) # raise StopIteration yield1234567891011def getGenerator(): for i in [1, 2, 3]: yield i print(&quot;done&quot;)generator = getGenerator()print(generator) # &lt;generator object getGenerator at 0x10c3128c0&gt;print(next(generator)) # 1print(next(generator)) # 2print(next(generator)) # 3print(next(generator)) # done &amp; raise StopIteration åŸç†å½“yieldå‡ºç°åœ¨å‡½æ•°ä¸­ï¼ˆyieldåªèƒ½å®šä¹‰åœ¨å‡½æ•°ä¸­ï¼‰ï¼Œé‚£ä¹ˆè°ƒç”¨æ—¶ä¸ä¼šç›´æ¥è¿è¡Œå‡½æ•°è€Œæ˜¯è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡ï¼Œç”Ÿæˆå™¨ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è¿­ä»£å™¨ï¼ˆå®ç°äº†è¿­ä»£å™¨åè®®çš„å¯¹è±¡ï¼‰ã€‚ ç¬¬ä¸€æ¬¡è°ƒç”¨next()å‡½æ•°ï¼Œé‡è§yieldåœä¸‹è¿”å›yieldåé¢çš„å†…å®¹ å†æ¬¡è°ƒç”¨next()å‡½æ•°ï¼Œä»ä¸Šæ¬¡yieldè¯­å¥å¤„æ¢å¤ï¼Œå¦‚æœè¿˜å­˜åœ¨yieldåˆ™æ­£å¸¸æ‰§è¡Œï¼Œå¦åˆ™å‡½æ•°ä½“æ‰§è¡Œå®Œæ¯•æŠ›å‡ºStopIterationå¼‚å¸¸ é€šä¿—çš„æ¥è¯´ï¼šyieldç›¸å½“äºreturnï¼Œä½†yieldä¼šè®°ä½è¿™ä¸ªè¿”å›ä½ç½®ï¼Œå†æ¬¡æ‰§è¡Œä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹ã€‚ ç”Ÿæˆå™¨ä¸­send()æ˜¯å’Œnext()ä¸€æ ·èƒ½è®©ç”Ÿæˆå™¨æ¢å¤æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸åŒçš„æ˜¯send(arg)å‡½æ•°å¯ä»¥ä¼ é€’å‚æ•° 12345678910111213def getGenerator(): for i in [1, 2, 3]: print(&quot;before: &quot;, i) t = yield i print(&quot;after: &quot;, i, t)generator = getGenerator()print(generator) # &lt;generator object getGenerator at 0x10c3128c0&gt;generator.send(None) # before: 1next(generator) # after: 1 None &amp; before: 2generator.send(22) # after: 2 22 &amp; before: 3generator.send(33) # after: 3 33 &amp; raise StopIteration æ³¨æ„ç¬¬ä¸€æ¬¡è°ƒç”¨ç”Ÿæˆå™¨ä¸å¯ä»¥ç›´æ¥ä¼ é€’éNoneå‚æ•°ï¼Œå› ä¸ºyieldè¿˜æœªå‡†å¤‡å¥½ï¼ˆæ— è¿”å›å€¼ï¼‰ï¼Œå¯ä»¥generator.send(None)æˆ–next(generator)ã€‚å…·ä½“å¯ä»¥å‚è€ƒpythonæºç : 12const char *msg = &quot;can&#x27;t send non-None value to a &quot; &quot;just-started generator&quot;; https://github.com/python/cpython/blob/3.9/Objects/genobject.c#L181 è¿­ä»£åè®®ä»€ä¹ˆæ˜¯å¯è¿­ä»£åè®®ï¼Ÿ å½“å¤„ç†è¿­ä»£æ—¶é¦–å…ˆè°ƒç”¨å¯è¿­ä»£å¯¹è±¡.__iter__()ï¼Œè¿”å›è¿­ä»£å™¨ã€‚ç„¶åé€šè¿‡è¿­ä»£å™¨.__next__()è·å–è¿­ä»£å™¨çš„å…ƒç´ ï¼Œç›´è‡³æŠ›å‡ºStopIterationã€‚ 123456789101112131415161718192021222324252627class CustomGenerator: def __init__(self, data): self.data = data self.index = 0 def __iter__(self): print(&quot;look at me&quot;) return self def __next__(self): if self.index &lt; len(self.data): val = self.data[self.index] self.index += 1 return val else: raise StopIterationgenerator = CustomGenerator([1, 2, 3])print(generator) # &lt;__main__.CustomGenerator object at 0x1047161f0&gt;for x in generator: print(x)# look at me# 1# 2# 3print(next(generator)) # raise StopIteration","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"python","slug":"python","permalink":"http://xupin.im/tags/python/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - cursor","date":"2021-11-17T16:00:00.000Z","path":"2021/11/18/mysql-cursor/","text":"æ¸¸æ ‡ï¼ˆcursorï¼‰æ˜¯å¯ä»¥ä»æ•°æ®åº“æ£€ç´¢ç»“æœé›†ä¸­æ¯æ¬¡æå–ä¸€è¡Œè®°å½•çš„æœºåˆ¶ï¼Œæ¸¸æ ‡çš„ä½œç”¨å°±æ˜¯å¯¹ç»“æœé›†è¿›è¡Œéå†ï¼Œæ–¹ä¾¿å¯¹è®°å½•è¿›è¡Œæ“ä½œã€‚ ç‰¹æ€§ä¸‰ç§ç‰¹æ€§ï¼š åªè¯» ä¸èƒ½æ›´æ–°å®ƒ éæ»šåŠ¨ æ ¹æ®SQLè¯­å¥ç¡®å®šé¡ºåºï¼Œä¸èƒ½å‘åè·å–è®°å½•å’Œè·³è¿‡è®°å½• æ•æ„Ÿ&#x2F;ä¸æ•æ„Ÿ æ•æ„Ÿæ¸¸æ ‡æŒ‡å‘çš„æ˜¯æ•°æ®è¡¨ï¼Œä¸æ•æ„Ÿæ¸¸æ ‡æŒ‡å‘çš„åˆ™æ˜¯ä¸´æ—¶æ•°æ®è¡¨ã€‚ï¼ˆMysqlä½¿ç”¨çš„æ˜¯æ•æ„Ÿæ¸¸æ ‡ï¼‰ å£°æ˜æ¸¸æ ‡æ¸¸æ ‡ä½¿ç”¨çš„å˜é‡å¿…é¡»åœ¨å£°æ˜æ¸¸æ ‡ä¹‹å‰å£°æ˜ 1234567891011121314151617// Mysql// ä¸åŒäºå…¶ä»–æ•°æ®åº“ï¼ŒMysqlçš„æ¸¸æ ‡å¿…é¡»å£°æ˜åœ¨å­˜å‚¨è¿‡ç¨‹/å‡½æ•°ä¸­ã€‚create procedure cur_func()begin declare &#123;...VARs&#125; // e.g. declare email varchar(50) declare &#123;CUR_NAME&#125; cursor for &#123;STATEMENT&#125;; open &#123;CUR_NAME&#125;; fetch &#123;CUR_NAME&#125; into &#123;...VARs&#125; // e.g. fetch cur1 into email,name // å–å‡º1è¡Œè®°å½• &amp; æŠŠå€¼èµ‹ç»™å˜é‡emailã€name close &#123;CUR_NAME&#125;;end;// PgSqlbegin declare &#123;CUR_NAME&#125; cursor for &#123;STATEMENT&#125;; fetch &#123;STATEMENT&#125; from &#123;CUR_NAME&#125; // e.g. fetch forward 10 from cur1 å–å‡º10è¡Œè®°å½• close &#123;CUR_NAME&#125;;end; åŸç†æ¸¸æ ‡æœ‰ç€ç±»ä¼¼æŒ‡é’ˆçš„ä½œç”¨ï¼Œå®ƒæ˜¯éå†å®¹å™¨çš„ä¸€å¥—æ¥å£ï¼ˆè¿­ä»£å™¨ï¼‰ï¼Œç®€å•å®ç°ï¼ˆgolangï¼‰: 123456789101112131415161718192021222324252627282930313233343536373839404142package mainimport &quot;fmt&quot;type CustomArray []interface&#123;&#125;type Iterator struct &#123; data CustomArray index int&#125;func main() &#123; cusArr := CustomArray&#123;&quot;1_1&quot;, 22, 3.3&#125; for iter := cusArr.iterator(); iter.hasNext(); &#123; fmt.Println(iter.key(), iter.next()) &#125;&#125;// è¿­ä»£å™¨func (arr CustomArray) iterator() *Iterator &#123; return &amp;Iterator&#123; data: arr, index: 0, &#125;&#125;// æ¸¸æ ‡func (iter *Iterator) key() int &#123; return iter.index&#125;// ä¸‹ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨func (iter *Iterator) hasNext() bool &#123; return iter.index &lt; len(iter.data)&#125;// å–å‡ºæ•°æ®&amp;ç§»åŠ¨æ¸¸æ ‡func (iter *Iterator) next() interface&#123;&#125; &#123; val := iter.data[iter.index] iter.index += 1 return val&#125; ç®€å•çš„è¯´ï¼šæ¸¸æ ‡è¿”å›ä¸€ä¸ªæ•°æ®é›†åˆè¿­ä»£å™¨ï¼Œå½“ä½ å–ä¸€è¡Œè®°å½•åŒæ—¶æ¸¸æ ‡æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚ ä¸¾ä¾‹ä½¿ç”¨æ¸¸æ ‡çš„DBåº“ï¼Œä»¥ä¸‹ï¼šhttps://github.com/PyMySQL/PyMySQL/blob/46d17402af/pymysql/cursors.py#L278https://github.com/golang/go/blob/master/src/database/sql/sql.go#L2983","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - InnoDBå¹¶å‘æ­»é”é—®é¢˜","date":"2021-11-14T16:00:00.000Z","path":"2021/11/15/mysql-deadlock/","text":"é¡¹ç›®ä¸­æŸä¸ªå®šæ—¶ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°æ­»é”é—®é¢˜ï¼Œå…·ä½“é”™è¯¯å¦‚ä¸‹: 1Error 1213: Deadlock found when trying to get lock; try restarting transaction åˆ†ææ£€æŸ¥ä¸€ä¸‹è¡¨å¼•æ“ &amp; äº‹åŠ¡éš”ç¦»çº§åˆ« 123456789101112131415161718192021mysql&gt; show variables like &#x27;%storage_engine%&#x27;;+---------------------------------+-----------+| Variable_name | Value |+---------------------------------+-----------+| default_storage_engine | InnoDB || default_tmp_storage_engine | InnoDB || disabled_storage_engines | || internal_tmp_mem_storage_engine | TempTable |+---------------------------------+-----------+4 rows in set (0.00 sec)mysql&gt; select @@global.tx_isolation;ERROR 1193 (HY000): Unknown system variable &#x27;tx_isolation&#x27; // Mysql8.0ä»¥åå–æ¶ˆäº†è¯¥å˜é‡mysql&gt; select @@transaction_isolation;+-------------------------+| @@transaction_isolation |+-------------------------+| REPEATABLE-READ |+-------------------------+1 row in set (0.00 sec) é»˜è®¤ä½¿ç”¨çš„å¼•æ“æ˜¯InnoDBï¼ŒInsertã€Updateã€Deleteæ“ä½œä¼šè§¦å‘æ’å®ƒé”ï¼ˆXé”ï¼‰å³è¡Œé”ï¼Œæ‰€ä»¥æ€€ç–‘æ˜¯ä¸æ˜¯è§¦å‘äº†å…±äº«é”ï¼ˆSé”ï¼‰ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120mysql&gt; show engine innodb status;=====================================2021-11-15 02:42:28 0x2b1f5b160700 INNODB MONITOR OUTPUT=====================================Per second averages calculated from the last 59 seconds...------------------------LATEST DETECTED DEADLOCK------------------------2021-11-12 14:21:02 0x2b204ca06700*** (1) TRANSACTION:TRANSACTION 3805455, ACTIVE 0 sec insertingmysql tables in use 1, locked 1LOCK WAIT 4 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 1MySQL thread id 875327, OS thread handle 47411963238144, query id 20765167 10.85.62.212 dsc updateINSERT INTO `user_tag_distributes` (`created_at`,`updated_at`,`deleted_at`,`app_id`,`tag_name`,`tag_value`,`account_num`) VALUES (&#x27;2021-11-12 14:21:02.386&#x27;,&#x27;2021-11-12 14:21:02.386&#x27;,NULL,&#x27;im&#x27;,&#x27;churn_model_v2&#x27;,&#x27;0.70709264&#x27;,1)*** (1) HOLDS THE LOCK(S):RECORD LOCKS space id 334 page no 341 n bits 160 index PRIMARY of table `api`.`user_tag_distributes` trx id 3805455 lock_mode X locks rec but not gapRecord lock, heap no 89 PHYSICAL RECORD: n_fields 11; compact format; info bits 0 0: len 8; hex 000000000002515d; asc Q];; 1: len 6; hex 0000003a110f; asc : ;; 2: len 7; hex 81000001960110; asc ;; 3: len 7; hex 99ab18e5420f14; asc B ;; 4: len 7; hex 99ab18e5420f14; asc B ;; 5: SQL NULL; 6: SQL NULL; 7: len 2; hex 696d; asc im;; 8: len 14; hex 636875726e5f6d6f64656c5f7632; asc churn_model_v2;; 9: len 10; hex 302e3730373039323634; asc 0.70709264;; 10: len 3; hex 800001; asc ;;*** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 334 page no 203 n bits 392 index tag of table `api`.`user_tag_distributes` trx id 3805455 lock mode S waitingRecord lock, heap no 88 PHYSICAL RECORD: n_fields 3; compact format; info bits 32 0: len 14; hex 636875726e5f6d6f64656c5f7632; asc churn_model_v2;; 1: len 9; hex 302e37303730393735; asc 0.7070975;; 2: len 8; hex 0000000000022d5f; asc -_;;*** (2) TRANSACTION:TRANSACTION 3805441, ACTIVE 0 sec fetching rowsmysql tables in use 1, locked 1LOCK WAIT 89 lock struct(s), heap size 24784, 17767 row lock(s), undo log entries 10247MySQL thread id 875354, OS thread handle 47415383693056, query id 20765093 10.85.62.212 dsc updatingDELETE FROM `user_tag_distributes` WHERE app_id = &#x27;im&#x27; and tag_name = &#x27;churn_model_v2&#x27;*** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 334 page no 203 n bits 392 index tag of table `api`.`user_tag_distributes` trx id 3805441 lock_mode X locks rec but not gapRecord lock, heap no 88 PHYSICAL RECORD: n_fields 3; compact format; info bits 32 0: len 14; hex 636875726e5f6d6f64656c5f7632; asc churn_model_v2;; 1: len 9; hex 302e37303730393735; asc 0.7070975;; 2: len 8; hex 0000000000022d5f; asc -_;;*** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 334 page no 341 n bits 160 index PRIMARY of table `api`.`user_tag_distributes` trx id 3805441 lock_mode X waitingRecord lock, heap no 89 PHYSICAL RECORD: n_fields 11; compact format; info bits 0 0: len 8; hex 000000000002515d; asc Q];; 1: len 6; hex 0000003a110f; asc : ;; 2: len 7; hex 81000001960110; asc ;; 3: len 7; hex 99ab18e5420f14; asc B ;; 4: len 7; hex 99ab18e5420f14; asc B ;; 5: SQL NULL; 6: SQL NULL; 7: len 2; hex 696d; asc im;; 8: len 14; hex 636875726e5f6d6f64656c5f7632; asc churn_model_v2;; 9: len 10; hex 302e3730373039323634; asc 0.70709264;; 10: len 3; hex 800001; asc ;;*** WE ROLL BACK TRANSACTION (1)------------TRANSACTIONS------------Trx id counter 3945122Purge done for trx&#x27;s n:o &lt; 3945122 undo n:o &lt; 0 state: running but idleHistory list length 3LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 328886640459544, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640456152, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640455304, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640457000, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640448520, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640447672, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640452760, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640458696, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640446824, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640453608, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640457848, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640451912, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640451064, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640454456, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640450216, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640449368, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640445976, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 328886640445128, not started0 lock struct(s), heap size 1136, 0 row lock(s)...----------------------------END OF INNODB MONITOR OUTPUT============================ é€šè¿‡ä»¥ä¸Šä¿¡æ¯ç¡®è®¤æ˜¯å› ä¸º[äº‹åŠ¡1]Insert &amp; [äº‹åŠ¡2]Deleteäº’ç›¸ç­‰å¾…å¯¹æ–¹äº‹åŠ¡é‡Šæ”¾é”çš„é—®é¢˜é€ æˆæ­»é”ï¼Œæœ€å[äº‹åŠ¡1]è¿›è¡Œå›æ»šã€‚ åŸå› reviewä»£ç æ¢³ç†ä¸€ä¸‹ä¸šåŠ¡é€»è¾‘ï¼Œåœºæ™¯åº”è¯¥å¦‚ä¸‹ï¼š | trx1 | trx2 || â€”â€” | â€”â€” | â€”â€” || | BEGIN || BEGIN | DELETE FROM user_tag_distributes WHERE app_id &#x3D; â€˜imâ€™ and tag_name &#x3D; â€˜churn_model_v2â€™ || DELETE FROM user_tag_distributes WHERE app_id &#x3D; â€˜imâ€™ and tag_name &#x3D; â€˜churn_model_v2â€™ | || INSERT INTO user_tag_distributes (created_at,updated_at,deleted_at,app_id,tag_name,tag_value,account_num) VALUES (â€˜2021-11-12 14:21:02.386â€™,â€™2021-11-12 14:21:02.386â€™,NULL,â€™imâ€™,â€™churn_model_v2â€™,â€™0.70709264â€™,1) | || ERROR 1213 (40001): Deadlock found when trying to get lock | || ROLLBACK | â€¦ || | COMMIT | å¯ä»¥çœ‹å‡º[äº‹åŠ¡1]è¿›è¡ŒInsertæ“ä½œæ—¶å‘ç°[äº‹åŠ¡2]è¿›è¡ŒDeleteæ“ä½œä¸”å·²ç”³è¯·Xé”ï¼Œ[äº‹åŠ¡1]æƒ³è¦è·å–Sé”åˆ™éœ€è¦[äº‹åŠ¡2]æäº¤ï¼Œæ‰€ä»¥[äº‹åŠ¡1]ã€[äº‹åŠ¡2]åœ¨ç›¸äº’ç­‰å¾…å¯¹æ–¹æäº¤äº‹åŠ¡ï¼ˆé‡Šæ”¾é”ï¼‰ã€‚ è§£å†³æ–¹æ¡ˆç›®å‰æƒ³åˆ°çš„å‡ ç§æªæ–½ï¼š å°½é‡é¿å…åœ¨å¹¶å‘ç¨‹åºä¸­Delete &amp; Insertæ“ä½œæ— ç¼æ‰§è¡Œ å¹¶å‘ç¨‹åºé‡‡ç”¨åˆ†å¸ƒå¼é”æ§åˆ¶ ç¨‹åºä¸å…è®¸å¹¶å‘æ‰§è¡Œ https://dev.mysql.com/doc/refman/8.0/en/mysql-nutshell.htmlhttps://dev.mysql.com/doc/refman/8.0/en/innodb-standard-monitor.html","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - æ•°æ®è¿ç§»","date":"2021-11-11T16:00:00.000Z","path":"2021/11/12/mysql-migrate/","text":"ä¹‹å‰é¡¹ç›®æ•°æ®è¡¨æœ‰åˆ†è¡¨è®¾è®¡ï¼Œç°åœ¨å› ä¸ºä¸šåŠ¡é‡å¢é•¿æ•°æ®è¡¨æ•°æ®é‡è†¨èƒ€æ•°å€å¯¼è‡´å•è¡¨æ€§èƒ½ä¸ç†æƒ³ â€¦ æ‰€ä»¥å¸Œæœ›åœ¨ä¸å½±å“ç”¨æˆ·ä½¿ç”¨çš„æƒ…å†µä¸‹æ‰©å±•æ•°æ®è¡¨ï¼ˆè¿ç§»ï¼‰ æ•°æ®è¿ç§»æ–¹æ¡ˆåŸºæœ¬åˆ†ä¸ºçƒ­è¿ç§»å’Œå†·è¿ç§»ä¸¤ç§æ–¹å¼ å†·è¿ç§» é€šä¿—çš„æ¥è¯´å°±æ˜¯åœæœºè¿ç§»ï¼Œæ¯”å¦‚æŸäº›æ¸¸æˆåˆæœç»´æŠ¤ç­‰ ä¼˜ç‚¹: æ“ä½œå¯é æ€§é«˜ã€æ•°æ®ä¸€è‡´æ€§æœ‰ä¿è¯ã€æ•°æ®å›æ»šæ–¹ä¾¿ ç¼ºç‚¹: ç”¨æˆ·ä½“éªŒå·® çƒ­è¿ç§» åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹æŠŠæ•°æ®è¡¨è¿ç§»ï¼Œæ–°æ—§è¡¨åŒå†™ ä¼˜ç‚¹: ç”¨æˆ·æ— æ„ŸçŸ¥ ç¼ºç‚¹: å®¹æ˜“ä¸¢å¤±æ•°æ®ã€æ•°æ®ä¸€è‡´æ€§ä¸å¥½ä¿è¯ è¿™ç§çƒ­è¿ç§»æ–¹å¼æ˜¯ä¸ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œçº¯é DBå®Œæˆè¿ç§»ï¼Œæç«¯åœºæ™¯ä¸‹å¯é æ€§ä¸ç¡®å®šã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Gitå°çŸ¥è¯† - depth","date":"2021-10-31T16:00:00.000Z","path":"2021/11/01/git-depth/","text":"æœ‰æ—¶å€™gité¡¹ç›®æ¯”è¾ƒå¤§ï¼Œgit cloneä¼šå› ä¸ºå„ç§åŸå› ä¸­æ–­ï¼Œä½†æ˜¯Gitå¹¶ä¸ä¼šæ–­ç‚¹ç»­â€œä¼ â€å†æ¬¡cloneåˆæ˜¯é‡æ–°æ¥è¿‡,ç±»ä¼¼è¿™ç§é—®é¢˜â€¦è®©äººå¾ˆæ˜¯è‹¦æ¼ 123$ error: RPC failed; HTTP 504 curl 22 The requested URL returned error: 504 Gateway Time-out$ ...$ error: RPC failed; curl 18 transfer closed with outstanding read data remaining è§£å†³æ–¹å¼ gité…ç½®æµ 1234$ git config --global http.lowSpeedLimit 0 // æœ€å°é€Ÿåº¦$ git config --global http.lowSpeedTime 999999 // æœ€å¤§é€Ÿåº¦$ git config --global http.postBuffer 524288000 // æ–‡ä»¶å¤§å°$ git config --global compression 0 // å…³é—­å‹ç¼© åˆ†å—æ‹‰å– 1$ git clone --depth=1 &#123;repo&#125; // æ‹‰å–æœ€æ–°çš„ä»£ç ï¼ˆæœ€åä¸€æ¬¡commitï¼‰ ä½†è¿™æ ·ä¼šå¸¦æ¥å…¶ä»–çš„å°é—®é¢˜ï¼Œå°±æ˜¯æ‹‰ä¸‹æ¥çš„ä»£ç é»˜è®¤åˆ†æ”¯æ—¢ä¸æ˜¯masterä¹Ÿä¸æ˜¯å…¶ä»–åˆ†æ”¯ â€¦ éœ€è¦æ‹‰å–å®Œæ•´çš„é¡¹ç›® 123$ git fetch --unshallow // æ‹‰å–æ·±å±‚ä»£ç $ git config remote.origin.fetch &quot;+refs/heads/*:refs/remotes/origin/*&quot; // ä¿®æ­£remoteå…³ç³»ï¼ˆä¿®æ”¹ä¹‹å‰: &quot;fetch = +refs/heads/master:refs/remotes/origin/master&quot;ï¼‰$ git fetch -pv // æ‹‰å–æ‰€æœ‰åˆ†æ”¯","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"biscuits","slug":"biscuits","permalink":"http://xupin.im/tags/biscuits/"},{"name":"git","slug":"git","permalink":"http://xupin.im/tags/git/"}]},{"title":"è®¾è®¡æ¨¡å¼ - æ§åˆ¶åè½¬/ä¾èµ–æ³¨å…¥","date":"2020-10-17T16:00:00.000Z","path":"2020/10/18/design-ioc-di/","text":"Laravelæ¡†æ¶ä¸­æ§åˆ¶åè½¬å’Œä¾èµ–æ³¨å…¥åŠŸèƒ½æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿå…¶å®æ§åˆ¶åè½¬å’Œä¾èµ–æ³¨å…¥æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ï¼Œå®ƒæœ€æ—©æºäºJava Springæ¡†æ¶è®¾è®¡ä¸­çš„æœºåˆ¶ï¼Œæ‰€ä»¥èº«è¾¹å¦‚æœæœ‰åšJavaå¼€å‘çš„å°ä¼™ä¼´~ç®€å•èŠèŠå°±èƒ½æ˜ç™½è®¸å¤šã€‚ 1.ä¾èµ–æ³¨å…¥ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰ï¼Œé€šä¿—çš„è§£é‡Šæ˜¯å½“æˆ‘ä»¬æ„å»ºå¯¹è±¡æ—¶éœ€è¦çš„å‚æ•°ï¼Œåªè¦ä¸æ˜¯æ‰‹åŠ¨åˆ›å»ºè€Œæ˜¯ä»¥å®ä¾‹å¯¹è±¡çš„å½¢å¼æ³¨å…¥éƒ½å¯ä»¥ç§°ä¸ºä¾èµ–æ³¨å…¥ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªå°æ¸¸æˆä¸­ç©å®¶å¯ä»¥åˆ›å»ºä¸åŒçš„èŒä¸šã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041// èŒä¸šæ¥å£interface Role &#123; // è·å–èŒä¸šå public function getName();&#125;class Dh implements Role &#123; // èŒä¸šå protected $name = &#x27;çŒé­”äºº&#x27;; // æ”»å‡»æˆé•¿ protected $attack; // é€Ÿåº¦æˆé•¿ protected $speed; // æ°”è¡€æˆé•¿ protected $hp; public function __construct($attack,$speed,$hp) &#123; $this-&gt;attack = $attack; $this-&gt;speed = $speed; $this-&gt;hp = $hp; &#125; public function getName() &#123; return $this-&gt;name; &#125;&#125;// ç©å®¶ç±»class Player &#123; // èŒä¸š protected $role; public function __construct($role) &#123; $this-&gt;role = $role; &#125;&#125;// çŒé­”äºº$dh = new Dh(100, 100, 60);// ç©å®¶1-&gt;çŒé­”äºº$player1 = new Player($dh); ä»¥ä¸Šæ˜¯åˆ›å»ºç©å®¶è§’è‰²çš„é€»è¾‘ï¼Œåˆ›å»ºè§’è‰²â€œplayer1â€æ—¶é€‰æ‹©è§’è‰²â€œdhâ€ï¼Œé‚£ä¹ˆè¿™ç§æ–¹å¼å…¶å®å°±æ˜¯ä¾èµ–æ³¨å…¥ã€‚ 2.æ§åˆ¶åè½¬ï¼ˆIocï¼‰æ§åˆ¶åè½¬ï¼ˆInversion of Controlï¼‰ï¼Œä»å­—é¢æ„æ€æ¥ç†è§£å°±æ˜¯æŠŠæ§åˆ¶æƒåè½¬ï¼Œé‚£ä¹ˆç©¶ç«Ÿæ€ä¹ˆåè½¬å‘¢ï¼Ÿ ä¹‹å‰åˆ›å»ºç©å®¶è§’è‰²çš„é€»è¾‘ï¼Œé€šè¿‡ç¨‹åºå¯ä»¥çœ‹å‡ºæ‰€æœ‰ä¾èµ–å¯¹è±¡éƒ½æ˜¯ç¨‹åºä¸»åŠ¨å»åˆ›å»ºï¼ˆèŒä¸šå¯¹è±¡ï¼Œç©å®¶å¯¹è±¡ï¼‰ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³æŠŠæ‰€æœ‰éœ€è¦çš„å‚æ•°éƒ½æå‰å‡†å¤‡å¥½ï¼Œæ€ä¹ˆä¼˜åŒ–ï¼Ÿ 123456789101112131415161718192021222324252627282930313233343536373839class Container&#123; protected $binds; protected $instances; public function bind($abstract, $concrete) &#123; if ($concrete instanceof Closure) &#123; $this-&gt;binds[$abstract] = $concrete; &#125; else &#123; $this-&gt;instances[$abstract] = $concrete; &#125; &#125; public function make($abstract, $parameters = []) &#123; if (isset($this-&gt;instances[$abstract])) &#123; return $this-&gt;instances[$abstract]; &#125; array_unshift($parameters, $this); return call_user_func_array($this-&gt;binds[$abstract], $parameters); &#125;&#125;$container = new Container();$container-&gt;bind(&#x27;player&#x27;, function($container, $role) &#123; return new Player($container-&gt;make($role));&#125;);$container-&gt;bind(&#x27;dh&#x27;, function($container) &#123; return new Dh(100, 100, 60);&#125;);// ç©å®¶1-&gt;çŒé­”äºº$player1 = $container-&gt;make(&#x27;player&#x27;, [&#x27;dh&#x27;]); åŠ å…¥äº†ä¸€ä¸ªåå«â€œContainerâ€çš„ç±»ï¼Œé‡Œé¢å­˜æ”¾æå‰è®¾è®¡å¥½çš„å¯¹è±¡ï¼Œå½“ç¨‹åºéœ€è¦æŸäº›ä¾èµ–å¯¹è±¡æ—¶â€œContainerâ€è‡ªåŠ¨å¸®ä½ å»å¯»æ‰¾æ‰§è¡Œã€‚è¿™å…¶å®å°±æ˜¯Iocè®¾è®¡æ€æƒ³ä¸­éµå¾ªâ€œDonâ€™t call us, weâ€™ll call youâ€çš„åŸåˆ™ï¼Œä¸éœ€è¦ç¨‹åºå»åˆ›å»ºä¾èµ–ï¼Œè€Œæ˜¯ä¸»åŠ¨å»å¸®ç¨‹åºå¯»æ‰¾ç›¸åº”ä¾èµ–ã€‚è¿™ä¹Ÿå°±æ˜¯æ‰€è¯´çš„æ§åˆ¶åè½¬ï¼Œä»ç‹­ä¹‰ä¸Šè®²ä¾èµ–æ³¨å…¥å…¶å®ç®—æ˜¯æ§åˆ¶åè½¬çš„ä¸€ç§å®ç°ã€‚ æœ€åå¯èƒ½å¾ˆå¤šå°ä¼™ä¼´ä¼šè§‰å¾—æ§åˆ¶åè½¬çš„æ€æƒ³å’Œå·¥å‚æ¨¡å¼å¾ˆç›¸åƒï¼Œå®ƒä»¬æ˜¯ä¸æ˜¯å°±æ˜¯åŒä¸€ä¸ªä¸œè¥¿å‘¢ï¼Ÿæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å»çœ‹çœ‹Dependency Injection vs Factory Patternã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"design","slug":"design","permalink":"http://xupin.im/tags/design/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - èšç°‡ç´¢å¼•å’Œå›è¡¨æŸ¥è¯¢çš„å…³ç³»","date":"2020-08-11T16:00:00.000Z","path":"2020/08/12/mysql-clustered-index/","text":"ä¹‹å‰ç®€å•äº†è§£è¿‡Mysqlçš„ç´¢å¼•ï¼Œä»Šå¤©æ¥å­¦ä¹ ä¸€ä¸‹Mysqlï¼ˆInnoDBï¼‰çš„èšç°‡ç´¢å¼•ä»¥åŠSQLä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå›è¡¨æŸ¥è¯¢ï¼Ÿ 1. ä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢ï¼Ÿéƒ½çŸ¥é“Mysqlå­˜å‚¨çš„æ•°æ®ç»“æ„æ˜¯B+Treeï¼Œæ‰€ä»¥å½“æŸ¥è¯¢æ•°æ®çš„æ—¶å€™èƒ½æœ€å¿«æ‰¾åˆ°å¶å­èŠ‚ç‚¹çš„æ£€ç´¢æ–¹å¼æ—¶æ˜¯æœ€å¿«çš„ã€‚æ¯”å¦‚ï¼šä¸»é”®ç›´æ¥å®šä½è¡Œè®°å½•ï¼Œè€Œæœ‰äº›æŸ¥è¯¢éœ€è¦å…ˆæ£€ç´¢ç´¢å¼•æ ‘æ‰¾åˆ°å¶å­èŠ‚ç‚¹çš„ä¸»é”®å€¼ï¼Œå†é€šè¿‡ä¸»é”®å€¼å®šä½è¡Œè®°å½•è¿™ç§æ‰«æ2æ¬¡ç´¢å¼•æ ‘çš„æ–¹å¼å°±å«åšå›è¡¨æŸ¥è¯¢ã€‚ å¦‚ä½•ç¡®å®šSQLè¯­å¥ä¼šä¸ä¼šé€ æˆå›è¡¨æŸ¥è¯¢ï¼Ÿå¦‚ä¸‹è¡¨ï¼š 12345678910CREATE TABLE `users` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user` varchar(125) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL, `name` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL, `status` tinyint(4) NOT NULL, `created_at` datetime NOT NULL, PRIMARY KEY (`id`) USING BTREE, UNIQUE INDEX `user`(`user`) USING BTREE, INDEX `name`(`name`) USING BTREE) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Compact; 2ç§æŸ¥è¯¢æ–¹å¼ï¼š 123456789101112131415# æœªå›è¡¨æŸ¥è¯¢EXPLAIN SELECT id,name FROM users WHERE name = &#x27;test1&#x27;;+------+-------------+-------+------+---------------+------+---------+-------+------+--------------------------+| id | select_type | table | type | possible_keys | key | key_len | ref | rows | Extra |+------+-------------+-------+------+---------------+------+---------+-------+------+--------------------------+| 1 | SIMPLE | users | ref | name | name | 202 | const | 1 | Using where; Using index |+------+-------------+-------+------+---------------+------+---------+-------+------+--------------------------+# å›è¡¨æŸ¥è¯¢EXPLAIN SELECT id,user,name FROM users WHERE name = &#x27;test1&#x27;;+------+-------------+-------+------+---------------+------+---------+-------+------+-----------------------+| id | select_type | table | type | possible_keys | key | key_len | ref | rows | Extra |+------+-------------+-------+------+---------------+------+---------+-------+------+-----------------------+| 1 | SIMPLE | users | ref | name | name | 202 | const | 1 | Using index condition |+------+-------------+-------+------+---------------+------+---------+-------+------+-----------------------+ æ³¨æ„çœ‹Extraå­—æ®µï¼Œå½“å€¼ä¸ºUsing index conditionæ—¶è¡¨ç¤ºè¯¥SQLéœ€è¦å›è¡¨æŸ¥è¯¢ï¼Œé‚£ä»¥ä¸Šä¸¤æ¡SQLåˆ°åº•æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ SQL1å‘½ä¸­nameç´¢å¼•å¹¶ä¸”åœ¨ç´¢å¼•æ ‘çš„å¶å­èŠ‚ç‚¹æ‰¾åˆ°ä¸»é”®idï¼Œæ»¡è¶³äº†æŸ¥è¯¢éœ€æ±‚æ‰€ä»¥ä¸éœ€è¦å›è¡¨æŸ¥è¯¢å…¶ä»–å­—æ®µã€‚ SQL2åŒæ ·æ˜¯å‘½ä¸­nameç´¢å¼•å¹¶ä¸”åœ¨ç´¢å¼•æ ‘å¶å­èŠ‚ç‚¹æ‰¾åˆ°ä¸»é”®idï¼Œä½†è¿˜æœ‰ä¸€ä¸ªuserå­—æ®µæ²¡æœ‰å¾—åˆ°ï¼Œæ‰€ä»¥éœ€è¦æ‹¿ç€ä¸»é”®idå»ç´¢å¼•æ ‘æŸ¥è¯¢userå­—æ®µã€‚ ä»¥ä¸Šå°±æ˜¯æ˜¯å¦å›è¡¨æŸ¥è¯¢çš„åŒºåˆ«ï¼Œå›è¡¨æŸ¥è¯¢ä¼šé¢å¤–äº§ç”Ÿä¸€æ¬¡æŸ¥è¯¢çš„å¼€é”€ï¼Œæ•…æ­¤æ•ˆç‡è¾ƒä½ã€‚ä¸è¿‡å›è¡¨æŸ¥è¯¢å’Œèšç°‡ç´¢å¼•åˆæœ‰ä»€ä¹ˆå…³è”å‘¢ï¼Ÿä¸ºä»€ä¹ˆå›è¡¨æŸ¥è¯¢éœ€è¦éå†2æ¬¡ç´¢å¼•æ ‘å‘¢ï¼Ÿ 2. èšç°‡ç´¢å¼•InnoDBçš„ç´¢å¼•ç±»å‹ä¹‹å‰æœ‰è¯´è¿‡ï¼Œå¤šæ•°ä½¿ç”¨B+Treeåšç´¢å¼•ä½†åœ¨å®ç°ä¸ŠåˆåŒºåˆ†ä¸ºï¼šèšç°‡ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•ã€‚ èšç°‡ç´¢å¼•ï¼ˆClustered Indexï¼‰ èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨è¡Œè®°å½•ï¼ŒInnoDBæœ‰ä¸”åªæœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚èšç°‡ç´¢å¼•çš„æ¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘ç›¸é‚»å¶å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œæ‰€ä»¥é¢å¯¹RangeæŸ¥è¯¢èšç°‡ç´¢å¼•æ•ˆç‡å¾ˆé«˜ã€‚ 1InnoDBé»˜è®¤ä¸»é”®æ˜¯èšç°‡ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰ä¸»é”®åˆ™ç¬¬ä¸€ä¸ªNot Null &amp; Uniqueç´¢å¼•åˆ—ä¸ºèšç°‡ç´¢å¼•ã€‚å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™ä¼šç”Ÿæˆä¸€ä¸ª6å­—èŠ‚çš„éšå¼è‡ªå¢é•¿ä¸»é”®`row-id`ã€‚ ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆInnoDBå¼•æ“ä¸‹è¦æ±‚æ•°æ®è¡¨å°½å¯èƒ½éƒ½è¦åˆ›å»ºä¸»é”®çš„åŸå› ã€‚ï¼‰ è¾…åŠ©ç´¢å¼•ï¼ˆSecondary Indexï¼‰ è¾…åŠ©ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼ˆèšç°‡ç´¢å¼•ï¼‰ã€‚ äº†è§£äº†ç´¢å¼•æ ‘çš„ç»“æ„ï¼Œå…¶å®ä¹Ÿå°±æ˜ç™½äº†ä¸ºä»€ä¹ˆæ˜æ˜å‘½ä¸­äº†ç´¢å¼•å´è¿˜ä¼šäº§ç”Ÿå›è¡¨æŸ¥è¯¢éœ€è¦æ‰«æ2æ¬¡ç´¢å¼•æ ‘ï¼Œå³ï¼šå…ˆæ‰«æè¾…åŠ©ç´¢å¼•æ ‘æ‹¿åˆ°ä¸»é”®å€¼ï¼Œå†æ‰«æèšç°‡ç´¢å¼•æ ‘è·å–è¡Œè®°å½•ã€‚ 3. å¦‚ä½•é¿å…å›è¡¨æŸ¥è¯¢ï¼Ÿé¿å…å›è¡¨æŸ¥è¯¢è¿™é‡Œæœ‰ä¸ªæ¦‚å¿µï¼šè¦†ç›–ç´¢å¼•ï¼ˆCovering indexï¼‰ï¼ŒMysqlå®˜æ–¹è™½ç„¶æ²¡æœ‰æ˜ç¡®å®šä¹‰è¦†ç›–ç´¢å¼•ä½†æ˜¯æœ‰åŒæ ·çš„æ¦‚å¿µå‡ºç°ã€‚ æŸ¥è¯¢çš„å­—æ®µå°½å¯èƒ½åœ¨ä¸€æ£µç´¢å¼•æ ‘éƒ½èƒ½è·å–åˆ°ï¼Œé¿å…å›è¡¨ã€‚ ï¼ˆæ¦‚å¿µå‡ºå¤„ï¼šUsing indexï¼‰ å…·ä½“æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿç›´æ¥ä¸ŠSQLã€‚ 12ALTER TABLE `users` DROP INDEX `name`;ALTER TABLE `users` ADD INDEX `user_name` ( `user`, `name` ); åˆ›å»ºuserã€nameå¤åˆç´¢å¼•ï¼Œè¿™æ ·å°±èƒ½å¤Ÿè¦†ç›–ç´¢å¼•ä¸éœ€è¦å›è¡¨ã€‚ æœ€ååŸ‹ä¸ªå‘ï¼Œåé¢æœ‰æ—¶é—´ä¼šç»§ç»­å­¦ä¹ ç›¸æ¯”è¾…åŠ©ç´¢å¼•èšç°‡ç´¢å¼•å¹³å‡ä¼šå‡å°‘å¤šå°‘æ¬¡IOæ“ä½œã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Rediså­¦ä¹ ç¬”è®° - Keyäº‹ä»¶é€šçŸ¥","date":"2020-08-09T16:00:00.000Z","path":"2020/08/10/redis-keyspace-notify/","text":"ç½‘ä¸Šè´­ç‰©çœ‹åˆ°è‡ªå·±å–œæ¬¢çš„ä¸œè¥¿åŠ å…¥è´­ç‰©è½¦ç„¶åä»˜æ¬¾ï¼Œä½†æ˜¯åœ¨ä»˜æ¬¾çš„çªç„¶ä¸æƒ³è¦äº† â€¦ å¾€å¾€è¿™ä¸ªè®¢å•ä¼šç»™ä¸€ä¸ª30åˆ†é’Ÿçš„æ”¯ä»˜æ—¶é—´ï¼Œæ—¶é—´ä¸€åˆ°å°±è‡ªåŠ¨å…³é—­äº† æ‰€ä»¥è¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ 1.å®ç°æ–¹å¼ è½®è¯¢ 1è„šæœ¬æ¯éš”ä¸€å®šæ—¶é—´å°±å»æ•°æ®è¡¨æ£€æŸ¥ä¸€ä¸‹çŠ¶æ€ï¼Œæ˜¯å¦è¿‡æœŸéœ€è¦å…³é—­ã€‚ å®šæ—¶å™¨ 1åˆ›å»ºè®¢å•æ—¶å¼€å§‹è®¡æ—¶ï¼Œè®¡æ—¶ç»“æŸåç›´æ¥å¤„ç†å…³é—­è®¢å•ã€‚ æ•°æ®åº“äº‹ä»¶+å­˜å‚¨è¿‡ç¨‹ 1æ•°æ®åº“å»ºç«‹æ£€æŸ¥äº‹ä»¶ï¼Œæ¯éš”ä¸€å®šæ—¶é—´å»æ‰§è¡Œä¸€æ¬¡å­˜å‚¨è¿‡ç¨‹ã€‚ Keyäº‹ä»¶é€šçŸ¥ 1å¯¹äºæ›´æ”¹ä»»ä½•Redis Keyçš„æ¯ä¸ªæ“ä½œï¼Œéƒ½å¯ä»¥é…ç½®Rediså°†æ¶ˆæ¯å‘å¸ƒåˆ°Pub/Subï¼Œç„¶åè®¢é˜…è¿™äº›é€šçŸ¥ã€‚ 2.æ•°æ®åº“äº‹ä»¶+å­˜å‚¨è¿‡ç¨‹ä¸å¤šè¯´ï¼Œç›´æ¥ä¸ŠSQL è®¢å•è¡¨ 1234567CREATE TABLE `orders` ( `id` int(11) NOT NULL AUTO_INCREMENT, `good_id` int(11) NOT NULL, `status` tinyint(1) NOT NULL COMMENT &#x27;0:å¾…ä»˜æ¬¾ï¼Œ1:å·²ä»˜æ¬¾ï¼Œ-1:è®¢å•å…³é—­&#x27;, `created_at` datetime NOT NULL, PRIMARY KEY (`id`) USING BTREE) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Compact; åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ï¼Œå¤„ç†å…³é—­è®¢å•ã€‚ 1234CREATE PROCEDURE job_proce()BEGIN update orders set status = -1 where time_to_sec(timediff(now(), created_at)) &gt; 1800 and status = 0;END åˆ›å»ºäº‹ä»¶ï¼Œè°ƒç”¨å­˜å‚¨è¿‡ç¨‹ã€‚ 123456SET GLOBAL event_scheduler = 1; CREATE EVENT IF NOT EXISTS job_eventON SCHEDULE EVERY 1 SECOND # 1ç§’æ£€æŸ¥ä¸€æ¬¡ON COMPLETION PRESERVE DO CALL job_proce(); å¼€å¯äº‹ä»¶ã€‚ 1ALTER EVENT job_event ON COMPLETION PRESERVE ENABLE; è¿™æ ·job_eventäº‹ä»¶å°±ä¼šä»¥1ç§’&#x2F;æ¬¡çš„é¢‘ç‡å»æ‰§è¡Œjob_proceå­˜å‚¨è¿‡ç¨‹æ‰§è¡Œæ•°æ®æ£€æŸ¥ã€‚ 3. Keyäº‹ä»¶é€šçŸ¥Keyäº‹ä»¶é€šçŸ¥ï¼ˆRedis Keyspace Notificationsï¼‰æœºåˆ¶è‡ª2.8ç‰ˆæœ¬ä»¥åå‡ºç°ï¼Œè¯¥æœºåˆ¶é»˜è®¤æ˜¯å…³é—­çš„ã€‚å¯é€šè¿‡é…ç½®redis.confè¿›è¡Œå¼€å¯ 1234567891011121314notify-keyspace-events Ex # Eè¡¨ç¤ºKeyäº‹ä»¶é€šçŸ¥ï¼Œxä»£è¡¨Keyè¿‡æœŸè¡Œä¸ºã€‚# notify-keyspace-eventså¯é…ç½®å‚æ•°# K é”®ç©ºé—´äº‹ä»¶ï¼Œä»¥__keyspace@&lt;db&gt;__å‰ç¼€å‘å¸ƒã€‚# E é”®äº‹ä»¶äº‹ä»¶ï¼Œä»¥__keyevent@&lt;db&gt;__å‰ç¼€å‘å¸ƒã€‚# g é€šç”¨å‘½ä»¤ï¼ˆéç±»å‹ç‰¹å®šï¼‰ï¼Œå¦‚DELï¼ŒEXPIREï¼ŒRENAMEç­‰ç­‰# $ å­—ç¬¦ä¸²å‘½ä»¤# l åˆ—è¡¨å‘½ä»¤# s é›†åˆå‘½ä»¤# h å“ˆå¸Œå‘½ä»¤# z æœ‰åºé›†åˆå‘½ä»¤# x è¿‡æœŸäº‹ä»¶ï¼ˆæ¯æ¬¡é”®åˆ°æœŸæ—¶ç”Ÿæˆçš„äº‹ä»¶ï¼‰# e è¢«é©±é€çš„äº‹ä»¶ï¼ˆå½“ä¸€ä¸ªé”®ç”±äºè¾¾åˆ°æœ€å¤§å†…å­˜è€Œè¢«é©±é€æ—¶äº§ç”Ÿçš„äº‹ä»¶ï¼‰# A g$lshzxeçš„åˆ«åï¼Œå› æ­¤å­—ç¬¦ä¸²AKEè¡¨ç¤ºæ‰€æœ‰çš„äº‹ä»¶ã€‚ ä¿®æ”¹é…ç½®å¼€å¯Keyäº‹ä»¶é€šçŸ¥ä»¥åï¼Œå½“Redisåœ¨åˆ é™¤è¿‡æœŸKeyçš„æ—¶å€™ä¼šå‘æŒ‡å®šchannelï¼ˆè¿‡æœŸè¡Œä¸ºçš„channelï¼š__keyevent@0__:expiredï¼‰ publishæ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯å¯ä»¥ä½¿ç”¨subscribe&#x2F;psubscribeè¿›è¡Œè®¢é˜…ã€‚ 12345127.0.0.1:6379&gt; PSUBSCRIBE __keyevent@0__:expiredReading messages... (press Ctrl-C to quit)1) &quot;psubscribe&quot;2) &quot;__keyevent@0__:expired&quot;3) (integer) 1 æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å†™ä¸ªç¨‹åºæ‰§è¡Œredis-&gt;psubscribe()è¿›è¡Œç›‘å¬å³å¯ã€‚ æœ€åemmmmâ€¦","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"redis","slug":"redis","permalink":"http://xupin.im/tags/redis/"}]},{"title":"Gitå°çŸ¥è¯† - Cloneé¡¹ç›®é€Ÿåº¦æ…¢çš„å°æŠ€å·§","date":"2020-07-04T16:00:00.000Z","path":"2020/07/05/git-cloning-slow/","text":"ç¢°ä¸Šgithubç½‘ç»œæŠ½é£çš„æ—¶å€™ï¼Œæ°å·§ä½ åˆéœ€è¦æ‹‰å–githubä¸Šæ‰˜ç®¡çš„é¡¹ç›®ï¼Œè¿™ä¸ªæ—¶å€™çœ‹ç€2kb&#x2F;sçš„ä¸‹è½½é€Ÿåº¦æ˜¯ä¸æ˜¯å¾ˆæŠ“ç‹‚ï¼Ÿ ç²—æš´çš„è§£å†³æ–¹å¼æ‰“å¼€ipaddressæŸ¥è¯¢ä»¥ä¸‹ä¸‰ä¸ªåŸŸåçš„ipï¼Œå†™åˆ°hostsæ–‡ä»¶ä¸­ã€‚ github.com github.global.ssl.fastly.net codeload.github.com è¿›é˜¶çš„æ–¹å¼ æŒ‚ä»£ç†ï¼Œå“¦è±export ALL_PROXY&#x3D;socks5:&#x2F;&#x2F;127.0.0.1:4000 ç©¶ææ–¹å¼ å¤åˆ¶ä½ è¦æ‹‰å–çš„é¡¹ç›®githubåœ°å€ï¼Œæ¯”å¦‚ï¼šhttps://github.com/v2ray/v2ray-core æ‰“å¼€ç äº‘ï¼Œåˆ›å»ºä»“åº“-&gt;ä» GitHub &#x2F; GitLab å¯¼å…¥ä»“åº“ æå®šï¼git clone https://gitee.com/xupinbest/v2ray-core","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"github","slug":"github","permalink":"http://xupin.im/tags/github/"},{"name":"biscuits","slug":"biscuits","permalink":"http://xupin.im/tags/biscuits/"}]},{"title":"Goå­¦ä¹ ç¬”è®° - goroutine","date":"2020-06-11T16:00:00.000Z","path":"2020/06/12/go-goroutine/","text":"åœ¨ç°åœ¨å¤§æ•°æ®ã€é«˜å¹¶å‘ï¼Œåˆ°å¤„éƒ½å……æ–¥ç€æµé‡çš„äº’è”ç½‘æ—¶ä»£ï¼Œèƒ½ä¸èƒ½åº”å¯¹é«˜å¹¶å‘ä¿¨ç„¶å·²ç»å‘å±•æˆä¸€ä¸ªè¡¡é‡æœåŠ¡ç«¯æ¶æ„æ˜¯å¦åˆæ ¼çš„æ ‡å‡†ï¼Œä½œä¸ºç¨‹åºåª›æˆ‘ä»¬æ€è€ƒå¦‚ä½•åˆ©ç”¨è¯­è¨€åœ¨ä»£ç å±‚é¢æœ€ä¼˜è®¾è®¡èƒ½åº”å¯¹å¹¶å‘çš„ç¨‹åºå»å¹¶è¡Œå¤„ç†ä»»åŠ¡ã€‚åœ¨ç¨‹åºä¸­å¯¹äºä»»åŠ¡å¹¶è¡Œå¤„ç†ä¸€èˆ¬è¶‹äºä½¿ç”¨ï¼šè¿›ç¨‹ã€çº¿ç¨‹ï¼Œä»¥åŠå¦å¤–ä¸€ç§ï¼šåç¨‹ã€‚æ”¯æŒåç¨‹çš„è¯­è¨€æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šC&#x2F;C++ã€Rubyã€ Pythonï¼ˆ2.5+ï¼‰ã€Golangç­‰ç­‰ï¼Œå®ƒä»¬æœ‰äº›æ˜¯æœ¬èº«è¯­è¨€æ”¯æŒåç¨‹ï¼Œæœ‰äº›åˆ™æ˜¯éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹åŒ…æ¥ä½¿ç”¨ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬ä¸»è¦æ¥å­¦ä¹ ä¸€ä¸‹Golangè¿™é—¨è¯­è¨€ï¼ˆç®€ç§°Goï¼‰ï¼Œå®ƒæ˜¯å¦‚ä½•ç†è§£ä»¥åŠå®ç°åç¨‹çš„ã€‚ ä¸€ã€è¿›ç¨‹ã€çº¿ç¨‹å’Œåç¨‹çš„å‰ä¸–ä»Šç”Ÿéƒ½çŸ¥é“ä¸€å°è®¡ç®—æœºçš„æ ¸å¿ƒæ˜¯CPUï¼Œå®ƒæ‰¿æ‹…ç€æ‰€æœ‰çš„è¿ç®—ã€‚è€Œè®¡ç®—æœºæ‰¿è½½çš„æ“ä½œç³»ç»Ÿï¼ˆå†…æ ¸ï¼‰åˆ™æ˜¯è´Ÿè´£æ‰€æœ‰ä»»åŠ¡çš„å¤„ç†å’Œè°ƒåº¦CPUä»¥åŠèµ„æºçš„åˆ†é…ã€‚å¦‚æœç”¨äººç±»æ¥æ¯”å–»ï¼Œå¤§è„‘æ˜¯CPUï¼Œæ€ç»´åˆ™æ˜¯æ“ä½œç³»ç»Ÿï¼ˆå†…æ ¸ï¼‰ã€‚ è¿›ç¨‹æœ€æ—©çš„è®¡ç®—æœºæ¯æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œå¦‚æœè¿˜æœ‰å…¶ä»–ç¨‹åºéœ€è¦æ‰§è¡Œåˆ™è¦æ’é˜Ÿç­‰å¾…ã€‚åæ¥CPUè¿ç®—èƒ½åŠ›æé«˜äº†ï¼Œè¿™ç§æ–¹å¼è¿‡äºåŸå§‹æœ‰äº›æµªè´¹æ€§èƒ½ï¼Œäºæ˜¯å°è¯•è®©å¤šä¸ªç¨‹åºå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œä½†æ˜¯è¿™æ ·é¢ä¸´ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼šè·‘åœ¨åŒä¸€ä¸ªCPUä¸­çš„ç¨‹åºéƒ½ä¼šä½¿ç”¨è®¡ç®—æœºèµ„æºï¼Œé‚£ç¨‹åºçš„è¿è¡ŒçŠ¶æ€å’Œæ•°æ®æ€ä¹ˆä¿éšœï¼Ÿè¿›ç¨‹ã€‚ 1è¿›ç¨‹æ˜¯å†…æ ¸èµ„æºç®¡ç†åˆ†é…çš„æœ€å°å•ä½ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚å†…æ ¸ä¸­çš„æ¯ä¸ªç¨‹åºéƒ½è¿è¡Œåœ¨ç‹¬ç«‹è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸Šä¸‹æ–‡æ˜¯ç”±ç¨‹åºæ­£å¸¸è¿è¡Œéœ€è¦çš„ä¸€ç³»åˆ—å‚æ•°ç»„æˆï¼Œå‚æ•°åŒ…æ‹¬å­˜å‚¨å™¨ä¸­çš„ä»£ç å’Œæ•°æ®ï¼Œå¯„å­˜å™¨ä¸­çš„å†…å®¹ä»¥åŠè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ–‡ä»¶å¥æŸ„ï¼‰ç­‰ã€‚å¯ä»¥æŠŠä¸Šä¸‹æ–‡é€šä¿—ç†è§£ä¸ºï¼š`ç¯å¢ƒ`ã€‚ å¦‚æœç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦è¿›è¡ŒIOæ“ä½œï¼ŒIOæ“ä½œé˜»å¡äº†ç¨‹åºåé¢çš„è®¡ç®—ï¼Œè¿™æ—¶å€™CPUå±äºç©ºé—²çŠ¶æ€ï¼Œé‚£å†…æ ¸ä¼šæŠŠCPUåˆ‡æ¢åˆ°å…¶ä»–è¿›ç¨‹å»å¤„ç†ã€‚ä¸è¿‡å½“è¿›ç¨‹æ•°é‡å˜é«˜ä»¥åï¼Œè®¡ç®—æœºçš„å¤§éƒ¨åˆ†èµ„æºéƒ½è¢«è¿›ç¨‹åˆ‡æ¢è¿™ä¸ªæ“ä½œæ¶ˆè€—æ‰äº†ã€‚ä¸ºä»€ä¹ˆè¯´è¿›ç¨‹åˆ‡æ¢æ“ä½œæ¶ˆè€—èµ„æºä»£ä»·æ¯”è¾ƒé«˜ï¼Ÿ 1æ‰€è°“è¿›ç¨‹åˆ‡æ¢å…¶å®å°±æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œéœ€è¦åˆ‡æ¢æ–°çš„é¡µè¡¨å¹¶åŠ è½½æ–°çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€åˆ‡æ¢å†…æ ¸æ ˆä»¥åŠç¡¬ä»¶ä¸Šä¸‹æ–‡ç­‰ã€‚åªè¦å‘ç”Ÿè¿›ç¨‹åˆ‡æ¢æ“ä½œå°±å¾—åå¤è¿›å…¥å†…æ ¸ï¼ŒåŠ è½½åˆ‡æ¢ä¸€ç³»åˆ—çŠ¶æ€ã€‚ çº¿ç¨‹ä¸ºäº†å‡å°‘è¿™ç§å¼€é”€ï¼Œçº¿ç¨‹åº”è¿è€Œç”Ÿã€‚ 1çº¿ç¨‹æ˜¯å†…æ ¸è°ƒåº¦CPUæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯è¿è¡Œåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡çš„é€»è¾‘æµï¼Œçº¿ç¨‹æ˜¯å…·ä½“æ‰§è¡Œç¨‹åºçš„å•ä½ã€‚ä¸€ä¸ªè¿›ç¨‹è‡³å°‘åŒ…å«ä¸€ä¸ªä¸»çº¿ç¨‹ï¼ˆå¯ä»¥æ‹¥æœ‰å¤šä¸ªå­çº¿ç¨‹ï¼‰ï¼Œä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹åªèƒ½å­˜åœ¨äºä¸€ä¸ªè¿›ç¨‹ä¸­ã€‚ çº¿ç¨‹åˆ‡æ¢ç›¸æ¯”è¿›ç¨‹åˆ‡æ¢å¼€é”€å°±å°äº†å¾ˆå¤šï¼Œçº¿ç¨‹åˆ‡æ¢åªéœ€è¦æŠŠå¯„å­˜å™¨åˆ·æ–°å³å¯ã€‚ åç¨‹åé¢ç¨‹åºåª›ä»¬å‘ç°çº¿ç¨‹è¿™æ ·è¿˜æ˜¯æœ‰æ€§èƒ½ç“¶é¢ˆï¼ˆIOé˜»å¡ï¼‰ï¼Œæ— è®ºæ˜¯è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹å› ä¸ºæ¶‰åŠåˆ°å¤§é‡çš„è®¡ç®—æœºèµ„æºï¼Œæ‰€ä»¥éƒ½æ˜¯ç”±å†…æ ¸è°ƒåº¦ç®¡ç†ã€‚èƒ½ä¸èƒ½å¼€å‘ä¸€ç§ç”±ä»£ç æ§åˆ¶çš„çº¿ç¨‹å‘¢ï¼Ÿè¿™å°±æ˜¯åç¨‹ã€‚ 1åç¨‹æ˜¯ç”±ç”¨æˆ·æ§åˆ¶çš„çº¿ç¨‹ï¼ˆç”¨æˆ·æ€çº¿ç¨‹ï¼‰ï¼Œåç¨‹åœ¨ç¨‹åºä¸­å®ç°è‡ªæˆ‘è°ƒåº¦ï¼Œä¸éœ€è¦åƒè¿›ç¨‹åˆ‡æ¢ä¸€æ ·è¿›å…¥å†…æ ¸åŠ è½½åˆ‡æ¢çŠ¶æ€ï¼Œæé«˜äº†çº¿ç¨‹åœ¨IOä¸Šçš„æ€§èƒ½é—®é¢˜ï¼ˆIOå¤šè·¯å¤ç”¨ï¼‰ã€‚ ä½†æ˜¯åç¨‹ä¹Ÿæœ‰ä¸ªè‡´å‘½çš„é—®é¢˜ï¼Œå‡å¦‚è¿›ç¨‹ä¸­çš„æŸä¸€ç¨‹åºå‡ºç°äº†é˜»å¡æ“ä½œåŒæ—¶è¢«CPUä¸­æ–­å¤„ç†ï¼ˆæŠ¢å å¼è°ƒåº¦ï¼‰ï¼Œé‚£ä¹ˆè¯¥è¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ã€‚ åé¢ä¼šä¸“é—¨å†™ä¸€ç¯‡å…³äºè¿›ç¨‹å’Œçº¿ç¨‹ä»¥åŠåç¨‹çš„ç‰¹æ€§ä»¥åŠåŒºåˆ«ã€‚ï¼ˆä¸å¤Ÿè¯¦ç»†ï¼ŒåŸ‹å‘Orz~ï¼‰ äºŒã€ä»€ä¹ˆæ˜¯goroutineï¼Ÿä¸Šé¢ç®€å•å­¦ä¹ äº†è¿›ç¨‹å’Œçº¿ç¨‹ä»¥åŠåç¨‹çš„æ¸Šæºï¼Œè™½ç„¶ä¸å¤Ÿè¯¦ç»†ä½†æ˜¯æˆ‘ä»¬å¤§æ¦‚çŸ¥é“å…¶å®åœ¨è¿›ç¨‹æˆ–è€…çº¿ç¨‹ç”šè‡³äºåç¨‹å­˜åœ¨çš„æ€§èƒ½ç“¶é¢ˆå¤§éƒ¨åˆ†æ˜¯CPUè°ƒåº¦é—®é¢˜ã€‚ 1go func() // Goè¯­è¨€å¯åŠ¨åç¨‹ï¼Œåªéœ€è¦ä½¿ç”¨goå…³é”®å­—å³å¯å¯åŠ¨åç¨‹è¿è¡Œå‡½æ•°ã€‚ä½¿ç”¨goå…³é”®å­—åˆ›å»ºçš„è¿™ä¸ªåç¨‹å°±å«åš`goroutine` ä¹‹å‰è¯´äº†goroutineæ˜¯Goè¯­è¨€çš„åç¨‹ï¼Œå…¶å®è¿™ä¹ˆç†è§£æ˜¯å¯ä»¥çš„ä½†goroutineæ¯”åç¨‹æ›´å¼ºå¤§ã€‚å®ƒä»¬ä½¿ç”¨çš„çº¿ç¨‹æ¨¡å‹æœ‰ç€æœ¬è´¨çš„åŒºåˆ«ï¼Œå¦‚ä¸‹ï¼š goroutineé€šè¿‡é€šé“æ¥é€šä¿¡ï¼Œè€Œåç¨‹é€šè¿‡è®©å‡ºæ‰§è¡Œå’Œæ¢å¤æ“ä½œæ¥é€šä¿¡ã€‚ goroutineé€šè¿‡Goè¯­è¨€çš„è°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ï¼Œè€Œåç¨‹é€šè¿‡ç¨‹åºæœ¬èº«è°ƒåº¦ã€‚ å¤§éƒ¨åˆ†è¯­è¨€æˆ–è€…ç¬¬ä¸‰æ–¹åº“æä¾›çš„åç¨‹å°±æ˜¯ä½¿ç”¨çš„ç”¨æˆ·æ€çº¿ç¨‹æ¨¡å‹ï¼Œä½†goroutineä½¿ç”¨çš„ä¸æ˜¯ä¼ ç»Ÿçš„ç”¨æˆ·æ€çº¿ç¨‹æ¨¡å‹ã€‚ä»¥ä¸‹ä¸»æµçš„çº¿ç¨‹æ¨¡å‹ï¼š å†…æ ¸çº§çº¿ç¨‹æ¨¡å‹ å†…æ ¸çº§åˆ«çš„çº¿ç¨‹çš„çŠ¶æ€åˆ‡æ¢éœ€è¦å†…æ ¸ç›´æ¥å¤„ç†ï¼Œæ‰€ä»¥å†…æ ¸æ¸…æ¥šçš„çŸ¥é“æ¯ä¸€ä¸ªKSEï¼ˆKernel Scheduling Entityï¼‰çš„å­˜åœ¨ï¼ˆå³å†…æ ¸çº¿ç¨‹å’ŒKSEæ˜¯ä¸€å¯¹ä¸€å…³ç³»ï¼‰ï¼Œå®ƒä»¬å¯ä»¥å…¨ç³»ç»Ÿå†…è¿›è¡Œèµ„æºçš„ç«äº‰ã€‚ ç”¨æˆ·çº§çº¿ç¨‹æ¨¡å‹ï¼ˆç”¨æˆ·æ€çº¿ç¨‹ï¼Œåç¨‹ï¼‰ ç”¨æˆ·æ€çº§åˆ«çš„çº¿ç¨‹å—ç”¨æˆ·æ§åˆ¶ï¼Œå†…æ ¸å¹¶ä¸ç›´æ¥çŸ¥é“ç”¨æˆ·æ€çº¿ç¨‹çš„å­˜åœ¨ï¼ˆä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Ÿå› ä¸ºç”¨æˆ·æ€çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹å­˜åœ¨ç€å¤šå¯¹ä¸€çš„å…³ç³»ï¼Œå³å¤šä¸ªç”¨æˆ·æ€çº¿ç¨‹å¯¹åº”ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼‰ï¼Œä¸€èˆ¬ç”¨æˆ·æ€å¤šçº¿ç¨‹å±äºåŒä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥å®ƒä»¬åªèƒ½åœ¨è¿›ç¨‹å†…è¿›è¡Œèµ„æºç«äº‰ã€‚ ä¸¤çº§çº¿ç¨‹æ¨¡å‹ï¼ˆæ··åˆå‹çº¿ç¨‹æ¨¡å‹ï¼‰ ä¸¤çº§çº¿ç¨‹æ¨¡å‹å¸å–äº†å†…æ ¸çº§å’Œç”¨æˆ·çº§çº¿ç¨‹çš„ç»éªŒï¼Œä¸¤çº§çº¿ç¨‹æ¨¡å‹ä¸‹çš„çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹å¤„äºå¤šå¯¹å¤šçš„å…³ç³»ã€‚ä¸€ä¸ªè¿›ç¨‹å†…çš„å¤šä¸ªçº¿ç¨‹å¯ä»¥åˆ†åˆ«ç»‘å®šå†…æ ¸çº¿ç¨‹ï¼Œæ—¢å¯ä»¥å¤šä¸ªçº¿ç¨‹ç»‘å®šå¤šä¸ªå†…æ ¸çº¿ç¨‹ä¹Ÿå¯ä»¥å¤šä¸ªçº¿ç¨‹ç»‘å®šä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œå½“æŸä¸ªçº¿ç¨‹å†…çš„ç¨‹åºäº§ç”Ÿé˜»å¡å…¶ç»‘å®šçš„å†…æ ¸çº¿ç¨‹è¢«CPUä¸­æ–­å¤„ç†ï¼Œè¿›ç¨‹å†…çš„å…¶ä»–çº¿ç¨‹å¯ä»¥é‡æ–°ä¸å…¶ä»–å†…æ ¸çº¿ç¨‹ç»‘å®šã€‚ goroutineä½¿ç”¨çš„æ­£æ˜¯ä¸¤çº§çº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯è¿™ç§å¤šä¸ªçº¿ç¨‹è·‘åœ¨å¤šä¸ªå†…æ ¸ä¸­ï¼Œæ—¢ä¸æ˜¯ç”¨æˆ·çº§çº¿ç¨‹æ¨¡å‹å®Œå…¨é è‡ªèº«è°ƒåº¦ä¹Ÿä¸æ˜¯å†…æ ¸çº§çº¿ç¨‹æ¨¡å‹å®Œå…¨ä¾èµ–å†…æ ¸è°ƒåº¦ï¼Œè€Œæ˜¯ç”¨æˆ·å’Œå†…æ ¸ååŒè°ƒåº¦ã€‚å› ä¸ºè¿™ç§æ¨¡å‹å¤æ‚æ€§è¾ƒé«˜ï¼Œæ‰€ä»¥Goè¯­è¨€å¼€å‘äº†è‡ªå·±çš„runtimeè°ƒåº¦å™¨ã€‚ ä¸‰ã€Go runtimeè°ƒåº¦å™¨Go runtimeè°ƒåº¦å™¨çš„ç»“æ„ç”±ä¸‰éƒ¨åˆ†ç»„æˆ: G Goroutineï¼Œæ¯ä¸ªgoroutineæœ‰å¯¹åº”çš„Gç»“æ„ä½“ï¼ŒGç»“æ„ä½“å‚¨å­˜goroutineçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚Gå¹¶ä¸èƒ½ç›´æ¥è¢«è°ƒåº¦ï¼Œéœ€è¦ç»‘å®šå¯¹åº”çš„Pæ‰èƒ½è¢«è°ƒåº¦æ‰§è¡Œã€‚ P Processorï¼Œä¸ºGå’ŒMè¿›è¡Œè°ƒåº¦çš„é€»è¾‘å¤„ç†å™¨ï¼Œå¯¹äºGæ¥è¯´Påƒæ˜¯å†…æ ¸ï¼Œè€Œåœ¨Mçœ‹æ¥Pç›¸å½“äºä¸Šä¸‹æ–‡ã€‚Pçš„æ•°é‡å¯ä»¥åœ¨ç¨‹åºä¸­ä»£ç æ§åˆ¶ï¼Œå¦‚ä¸‹:1runtime.GOMAXPROCS(runtime.NumCPU()) // è¯¥å€¼æœ€å¤§ä¸º256ã€‚ M Machineï¼Œè´Ÿè´£è°ƒåº¦ä»»åŠ¡ï¼ˆå¯ä»¥ç†è§£ä¸ºå†…æ ¸çº¿ç¨‹çš„æŠ½è±¡ï¼‰ï¼Œä»£è¡¨ç€æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œæ˜¯çœŸæ­£å¤„ç†ä»»åŠ¡çš„æœåŠ¡ã€‚Mçš„æ•°é‡ä¸æ˜¯å›ºå®šçš„ï¼Œå—Go runtimeè°ƒåº¦å™¨æ§åˆ¶ã€‚ï¼ˆä¸è¿‡è¯¥å€¼æœ€å¤§ä¸º10000ï¼Œå¯ä»¥å‚è€ƒï¼šsrc&#x2F;runtime&#x2F;proc.goï¼‰ å€¼å¾—ä¸€æçš„æ˜¯Goè¯­è¨€åœ¨æœ€åˆçš„ç‰ˆæœ¬ä¸­Go runtimeè°ƒåº¦å™¨çš„ç»“æ„æ˜¯GMæ¨¡å‹ï¼ˆå¹¶éGMPæ¨¡å‹ï¼‰ï¼ŒPæœåŠ¡æ˜¯å› ä¸ºGMæ¨¡å‹åœ¨å¹¶å‘ä¸Šå‡ºç°å¾ˆå¤§çš„æ€§èƒ½æŸè€—ã€‚æœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹ä¸€ä¸‹Go runtimeçš„æ ¸å¿ƒå¼€å‘è€…Dmitry Vyukovå‘ç°çš„é—®é¢˜Scalable Go Scheduler Design Docã€‚ ç®€å•è¯´äº†ä¸€ä¸‹Go runtimeè°ƒåº¦å™¨ä¸­çš„GPMæ¨¡å‹çš„æ¦‚å¿µï¼Œé‚£ä¹ˆGPMç©¶ç«Ÿæ˜¯æ€ä¹ˆè°ƒåº¦çš„å‘¢ï¼Ÿé¦–å…ˆå½“é€šè¿‡go func()åˆ›å»ºä¸€ä¸ªGå¯¹è±¡çš„æ—¶å€™ï¼ŒGä¼šè¢«ä¼˜å…ˆæ”¾å…¥Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚ä¸ºäº†æ‰§è¡ŒG Méœ€è¦ç»‘å®šä¸€ä¸ªPï¼Œç„¶åMå¯åŠ¨å†…æ ¸çº¿ç¨‹å¹¶å¾ªç¯ä»Pçš„æœ¬åœ°é˜Ÿåˆ—å–å‡ºGå¹¶æ‰§è¡Œã€‚ å½“På‘ç°å½“å‰ç»‘å®šçš„Mè¢«é˜»å¡æ—¶ä¼šè½¬å…¥ç»‘å®šå…¶ä»–Mï¼ˆæ–°çš„Må¯èƒ½æ˜¯è¢«åˆ›å»ºæˆ–è€…ä»å†…æ ¸çº¿ç¨‹ç¼“å­˜ä¸­å–å‡ºï¼‰ã€‚ å¦‚æœMå¤„ç†å®Œäº†å½“å‰Pçš„æœ¬åœ°é˜Ÿåˆ—é‡Œçš„Gåï¼ŒPä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—é‡Œå–Gæ¥æ‰§è¡Œï¼ˆåŒæ ·Pä¹Ÿä¼šå‘¨æœŸæ€§çš„æ£€æŸ¥å…¨å±€é˜Ÿåˆ—æ˜¯å¦æœ‰Gå¯ä»¥æ‰§è¡Œï¼‰ã€‚å¦‚æœå…¨å±€é˜Ÿåˆ—æ²¡æœ‰å¯ä»¥æ‰§è¡Œçš„Gï¼ŒPä¼šéšæœºæŒ‘é€‰å¦å¤–ä¸€ä¸ªPå¹¶ä»å®ƒçš„æœ¬åœ°é˜Ÿåˆ—ä¸­å–å‡ºä¸€åŠGåˆ°è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚è¿™ä¸ªåŠ¨ä½œä½¿ç”¨è°ƒåº¦ç®—æ³•work-stealingï¼ˆå·¥ä½œçªƒå–ç®—æ³•ï¼‰å®ç°ã€‚ æœ€åä»¥ä¸Šå°±æ˜¯Go runtimeè°ƒåº¦å™¨çš„è¿è¡ŒåŸç†ï¼ˆå¤§æ¦‚ï¼‰ï¼Œåé¢æœ‰æ›´æ·±å…¥çš„ç†è§£ä¼šè¡¥å……è¿›æ¥ã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"goroutine","slug":"goroutine","permalink":"http://xupin.im/tags/goroutine/"}]},{"title":"Mysqlå°çŸ¥è¯† - æŸ¥æ‰¾è¿ç»­ç¼–å·ä¸­çš„ç¼ºå¤±ç¼–å·","date":"2020-04-12T16:00:00.000Z","path":"2020/04/13/mysql-trick/","text":"åœ¨å’Œå°ä¼™ä¼´è®¨è®ºé—®é¢˜çš„æ—¶å€™ï¼Œå°ä¼™ä¼´çªç„¶é—®äº†æˆ‘è¿™æ ·ä¸€ä¸ªå°é—®é¢˜ï¼Œæ•°æ®åº“ä¸­å¦‚ä½•æŸ¥æ‰¾è¿ç»­ç¼–å·ä¸­çš„ç¼ºå¤±ç¼–å·ï¼Ÿ 1.æè¿°åœºæ™¯å¤§æ¦‚æ˜¯è¿™æ ·ï¼Œæœ‰ä¸€ä»½è¿ç»­æ•°æ®IDï¼š1 â€¦ 27ï¼Œå…¶ä¸­IDï¼š6ï¼Œ7ï¼Œ14çš„æ•°æ®ä¸¢äº†ã€‚ç»“æ„å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132CREATE TABLE `letter` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL, PRIMARY KEY (`id`) USING BTREE) ENGINE = InnoDB AUTO_INCREMENT = 27 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Compact;INSERT INTO `letter` VALUES (1, &#x27;A&#x27;);INSERT INTO `letter` VALUES (2, &#x27;B&#x27;);INSERT INTO `letter` VALUES (3, &#x27;C&#x27;);INSERT INTO `letter` VALUES (4, &#x27;D&#x27;);INSERT INTO `letter` VALUES (5, &#x27;E&#x27;);# INSERT INTO `letter` VALUES (6, &#x27;F&#x27;);# INSERT INTO `letter` VALUES (7, &#x27;J&#x27;);INSERT INTO `letter` VALUES (8, &#x27;H&#x27;);INSERT INTO `letter` VALUES (9, &#x27;I&#x27;);INSERT INTO `letter` VALUES (10, &#x27;J&#x27;);INSERT INTO `letter` VALUES (11, &#x27;K&#x27;);INSERT INTO `letter` VALUES (12, &#x27;L&#x27;);INSERT INTO `letter` VALUES (13, &#x27;M&#x27;);# INSERT INTO `letter` VALUES (14, &#x27;N&#x27;);INSERT INTO `letter` VALUES (15, &#x27;O&#x27;);INSERT INTO `letter` VALUES (16, &#x27;P&#x27;);INSERT INTO `letter` VALUES (17, &#x27;Q&#x27;);INSERT INTO `letter` VALUES (18, &#x27;R&#x27;);INSERT INTO `letter` VALUES (19, &#x27;S&#x27;);INSERT INTO `letter` VALUES (20, &#x27;T&#x27;);INSERT INTO `letter` VALUES (21, &#x27;U&#x27;);INSERT INTO `letter` VALUES (22, &#x27;V&#x27;);INSERT INTO `letter` VALUES (23, &#x27;W&#x27;);INSERT INTO `letter` VALUES (24, &#x27;X&#x27;);INSERT INTO `letter` VALUES (25, &#x27;Y&#x27;);INSERT INTO `letter` VALUES (26, &#x27;Z&#x27;); æ€ä¹ˆæŠŠ6ï¼Œ7ï¼Œ14è¿™ä¸‰æ¡æ•°æ®æ‰¾å‡ºæ¥ï¼Ÿæ–¹æ³•æœ‰å¾ˆå¤šç§å“ˆï¼Œä»Šå¤©æˆ‘ä»¬è¯´ä¸€ä¸‹å¦‚ä½•åˆ©ç”¨SQLå¿«é€ŸæŸ¥è¯¢å‡ºæ¥ã€‚å¤§æ¦‚æ€è·¯æ˜¯æŠŠID+1ï¼Œç„¶åæŸ¥è¯¢ID+1è¿™ä¸ªå€¼æ˜¯å¦å­˜åœ¨IDåˆ—è¡¨ä¸­ï¼Œå¦‚æœä¸å­˜åœ¨é‚£è‚¯å®šå°±æ˜¯ç¼ºå¤±çš„ã€‚SQLå¦‚ä¸‹ï¼š 123456SELECT id + 1 AS id FROM `letter` WHERE id + 1 NOT IN ( SELECT id FROM `letter` ) ä½†æ˜¯è¿™æ ·ä¼šæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯MAX(id)+1ï¼ˆ27ï¼‰ä¹Ÿä¼šè¢«æŸ¥è¯¢å‡ºæ¥ï¼Œæ‰€ä»¥ï¼š 123456789101112SELECT id + 1 AS id FROM `letter` WHERE id + 1 NOT IN ( SELECT id FROM `letter` ) AND id &lt;( SELECT max( id ) FROM `letter` ) 2.ä¼˜åŒ–1234567891011121314151617181920SELECT start_id, ( SELECT MIN(id)- 1 FROM `letter` WHERE id &gt; start_id ) AS end_id FROM ( SELECT id + 1 AS start_id FROM `letter` WHERE id + 1 NOT IN ( SELECT id FROM `letter` ) AND id &lt;( SELECT max(id) FROM `letter` ) ) AS max_id ORDER BY start_id è¿™ç§æƒ…å†µé€‚ç”¨äºæŸ¥æ‰¾æ•´æ•°ç±»å‹çš„è¿ç»­ç¼–å·ï¼Œé‚£ä¹ˆå¦‚æœç¼–å·æ˜¯stringç±»å‹çš„å‘¢ï¼Ÿåé¢æœ‰æœºä¼šå†è¡¥å……è¿›æ¥&#x3D;,&#x3D;ã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"biscuits","slug":"biscuits","permalink":"http://xupin.im/tags/biscuits/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Rediså­¦ä¹ ç¬”è®° - é›†ç¾¤","date":"2020-03-26T16:00:00.000Z","path":"2020/03/27/redis-cluster/","text":"ä¹‹å‰ç²—æµ…çš„å­¦ä¹ äº†Redisä¸‰ç§é›†ç¾¤ç­–ç•¥çš„ä¸»ä»å¤åˆ¶å’Œå“¨å…µç­–ç•¥ï¼Œç°åœ¨æœ€åè¿™ç¯‡æ¥å­¦ä¹ ä¸€ä¸‹Redis Clusterä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªé›†ç¾¤ç­–ç•¥ã€‚ 1.ä»€ä¹ˆæ˜¯é›†ç¾¤ï¼Ÿé›†ç¾¤ï¼ˆClusterï¼‰ï¼ŒRedis2.6ç‰ˆæœ¬ï¼ˆæ­£å¼ç‰ˆæœ¬æ˜¯3.0ï¼‰æ¨å‡ºçš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆï¼Œæœ‰æ•ˆè§£å†³äº†å•MasterèŠ‚ç‚¹å†™æ“ä½œçš„å‹åŠ›å¹¶ä¸”åˆ†å¸ƒå¼å­˜å‚¨æ•°æ®ï¼Œå¤§å¤§æé«˜äº†è´Ÿè½½èƒ½åŠ›ã€‚ åœ¨Rediså‘å¸ƒ3.0æ­£å¼ç‰ˆæœ¬å‰ï¼Œä¸€èˆ¬ä½¿ç”¨ä»£ç†ä¸­é—´ä»¶æ¥å®ç°åˆ†å¸ƒå¼é›†ç¾¤ç­–ç•¥ã€‚è¿™é‡Œä¸å±•å¼€å­¦ä¹ äº†ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´è‡ªè¡Œç ”ç©¶ã€‚ ç‰¹ç‚¹ Clusterç­–ç•¥æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼ŒèŠ‚ç‚¹é—´ç›¸äº’åè°ƒå·¥ä½œã€‚ å› ä¸ºå¯¹ä¸»ä»å¤åˆ¶å’Œå“¨å…µç­–ç•¥éƒ½ç§°ä¸ºé›†ç¾¤ç­–ç•¥ï¼Œæ‰€ä»¥ä¸ºäº†é˜²æ­¢è¯¯è§£åœ¨ä¸‹æ–‡ä¸­æåŠçš„é›†ç¾¤ï¼ˆClusterï¼‰ç­–ç•¥ï¼Œç›´æ¥ç”¨Clusterç§°å‘¼ã€‚ Clusterè‡³å°‘è¦3ä¸ªMasterèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ˜¯æ— ä¸­å¿ƒåŒ–è®¾è®¡ã€‚ å®¢æˆ·ç«¯ä½¿ç”¨Clusterï¼Œä¸éœ€è¦è¿æ¥æ‰€æœ‰èŠ‚ç‚¹ï¼Œåªéœ€è¦è¿æ¥Clusterä¸­ä»»æ„ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹å³å¯ã€‚ æ•°æ®çš„åˆ†å¸ƒå¼å­˜å‚¨ä¸éœ€è¦æŒ‡å®šï¼ŒClusterä¼šè‡ªåŠ¨å®Œæˆã€‚ ä¼˜ç‚¹ Clusterç­–ç•¥æ‹¥æœ‰ä¸»ä»å¤åˆ¶å’Œå“¨å…µç­–ç•¥çš„ä¼˜ç‚¹ã€‚ è§£å†³äº†å•MasterèŠ‚ç‚¹å†™æ“ä½œçš„å‹åŠ›ã€‚ åˆ†å¸ƒå¼å­˜å‚¨æ•°æ®ï¼Œæé«˜äº†è´Ÿè½½èƒ½åŠ›ã€‚ æ”¯æŒçº¿æ€§æ‰©å®¹ã€‚ ç¼ºç‚¹ éƒ¨åˆ†æ“ä½œå‘½ä»¤å—é™ï¼Œæ¯”å¦‚msetï¼Œç›®å‰åªèƒ½æ”¯æŒåŒä¸€ä¸ªæ’æ§½ï¼ˆslotï¼‰çš„keyè¿›è¡Œæ“ä½œã€‚ äº‹åŠ¡æœºåˆ¶ä¸æ”¯æŒå¤šèŠ‚ç‚¹æ“ä½œã€‚ ä¸æ”¯æŒå¤šæ•°æ®åº“ï¼Œå³åªæœ‰db0ã€‚ 2.å¦‚ä½•é…ç½®ï¼ˆæ–°æ—§æ–¹å¼ï¼‰ æ—§æ–¹å¼ï¼Œ.&#x2F;redis-trib.rb create â€“replicas {SLAVE_NUM} {IP}:{PORT} â€¦ {IP}:{PORT} æ–°æ–¹å¼ï¼Œ.&#x2F;redis-cli â€“cluster create â€“cluster-replicas {SLAVE_NUM} {IP}:{PORT} â€¦ {IP}:{PORT} redis.confç¤ºä¾‹ 12345678910111213# æ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œdaemonize yes/no# æ˜¯å¦å¯ç”¨Clustercluster-enabled yes/no# èŠ‚ç‚¹ä¿¡æ¯é…ç½®æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆã€‚# FILE_NAMEï¼šé…ç½®æ–‡ä»¶åcluster-cluster-config-file &#123;FILE_NAME&#125;# èŠ‚ç‚¹è¿æ¥è¶…æ—¶æ—¶é—´# MSï¼šè¶…æ—¶æ—¶é—´ï¼ˆå•ä½ï¼šMillisecondï¼‰cluster-node-timeout &#123;MS&#125; 3.å·¥ä½œæœºåˆ¶ RedisèŠ‚ç‚¹å¯åŠ¨ï¼ŒèŠ‚ç‚¹æ ¹æ®é…ç½®cluster-enabledåˆ¤æ–­æ˜¯å¦åŠ å…¥Clusterã€‚ æ–°èŠ‚ç‚¹é€šè¿‡cluster meet &#123;IP&#125; &#123;PORT&#125;å‘½ä»¤å’Œå…¶ä»–èŠ‚ç‚¹æ„ŸçŸ¥å¹¶å»ºç«‹è¿æ¥ï¼ŒèŠ‚ç‚¹é—´ä¼šé€šè¿‡Gossipåè®®PING&#x2F;PONGå‘½ä»¤æ¥æ£€æµ‹çŠ¶æ€å’Œäº¤æ¢ä¿¡æ¯ã€‚ Clusterè®¡ç®—å¹¶ä¸”åˆ†é…ä¸»èŠ‚ç‚¹æ’æ§½æ•°é‡ã€‚è¿™ä¸ªåœ°æ–¹æ³¨æ„ï¼Œä¸æ˜¯æ’æ§½æ•°é‡ï¼Œæ˜¯æ¯ä¸ªèŠ‚ç‚¹çš„æ’æ§½æ•°é‡ã€‚æ’æ§½æ•°é‡æ˜¯å›ºå®šçš„ï¼š16384ã€‚ æ’æ§½åˆ†é…æˆåŠŸä¹‹åï¼ŒClusterå¼€å§‹æœåŠ¡ã€‚ 4.å¦‚ä½•æ„ŸçŸ¥æ–°èŠ‚ç‚¹ï¼Ÿå½“ç»™æŸä¸€èŠ‚ç‚¹å‘é€å‘½ä»¤cluster meet &#123;IP&#125; &#123;PORT&#125;ï¼ˆæ–°èŠ‚ç‚¹ï¼‰ï¼Œè¯¥èŠ‚ç‚¹å°±ä¼šå°è¯•ä¸æ–°èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œå…·ä½“æµç¨‹ï¼š è¯¥èŠ‚ç‚¹å‘æ–°èŠ‚ç‚¹å‘é€MEETå‘½ä»¤ã€‚ æ–°èŠ‚ç‚¹æ¥æ”¶åˆ°MEETå‘½ä»¤åï¼Œå›å¤PONGå‘½ä»¤ã€‚ è¯¥èŠ‚ç‚¹æ¥æ”¶åˆ°æ–°èŠ‚ç‚¹è¿”å›çš„PONGå‘½ä»¤ï¼ŒçŸ¥é“æ–°èŠ‚ç‚¹æˆåŠŸæ¥æ”¶äº†è‡ªå·±çš„MEETå‘½ä»¤ã€‚ è¯¥èŠ‚ç‚¹å‘æ–°èŠ‚ç‚¹å‘é€PINGå‘½ä»¤ã€‚ æ–°èŠ‚ç‚¹æ¥æ”¶åˆ°è¯¥èŠ‚ç‚¹å‘é€çš„PINGå‘½ä»¤ï¼ŒçŸ¥é“è¯¥èŠ‚ç‚¹å·²ç»æˆåŠŸæ¥æ”¶åˆ°è‡ªå·±è¿”å›çš„PONGå‘½ä»¤ã€‚ è¯¥èŠ‚ç‚¹å’Œæ–°èŠ‚ç‚¹æ¡æ‰‹å®Œæˆï¼Œå»ºç«‹è¿æ¥ã€‚ æœ€åï¼Œè¯¥èŠ‚ç‚¹ä¼šå°†æ–°èŠ‚ç‚¹çš„ä¿¡æ¯é€šè¿‡Gossipåè®®åŒæ­¥ç»™Clusterä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œè®©å…¶ä»–èŠ‚ç‚¹ä¹Ÿä¸æ–°èŠ‚ç‚¹è¿›è¡Œæ¡æ‰‹ï¼Œå»ºç«‹è¿æ¥ã€‚ å¯ä»¥é€šè¿‡cluster nodeså‘½ä»¤æŸ¥çœ‹é›†ç¾¤ä¸­å“ªäº›èŠ‚ç‚¹å·²ç»å»ºç«‹è¿æ¥ã€‚ 5.æ•°æ®æ’æ§½è¯´åˆ°æ’æ§½ï¼ˆslotï¼‰ä¸å¾—ä¸æä¸€ä¸‹ï¼Œä¸ºäº†èƒ½å¤Ÿè®©æ•°æ®å¹³å‡åˆ†é…åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šè€Œé‡‡ç”¨çš„æ•°æ®åˆ†åŒºç®—æ³•ã€‚å¸¸è§çš„æ•°æ®åˆ†åŒºç®—æ³•ï¼šèŒƒå›´ï¼ˆRangeï¼‰ã€å“ˆå¸Œï¼ˆHashï¼‰ã€ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å’Œè™šæ‹Ÿå“ˆå¸Œæ§½ç­‰ã€‚ Clusteré‡‡ç”¨çš„è™šæ‹Ÿå“ˆå¸Œæ§½æ•°æ®åˆ†åŒºç®—æ³•ï¼Œæ‰€æœ‰çš„keyæ ¹æ®å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°0 ~ 16383æ’æ§½å†…ï¼ˆå…¬å¼ï¼šslot &#x3D; crc16(key) &amp; 16383ï¼‰ï¼Œä¹‹å‰ä¹Ÿæåˆ°è¿‡æ’æ§½ä¹Ÿæ˜¯å¹³å‡åˆ†é…åˆ°æ¯ä¸ªMasterèŠ‚ç‚¹çš„ã€‚ è™šæ‹Ÿå“ˆå¸Œæ§½çš„ç‰¹ç‚¹ é™ä½äº†èŠ‚ç‚¹å’Œæ•°æ®ä¹‹é—´çš„è€¦åˆæ€§ï¼Œæ–¹ä¾¿çº¿æ€§æ‰©å®¹&amp;åŠ¨æ€ç®¡ç†èŠ‚ç‚¹ã€‚ èŠ‚ç‚¹è‡ªå·±ç®¡ç†å’Œæ’æ§½çš„å¯¹åº”å…³ç³»ã€‚ æ”¯æŒæŸ¥è¯¢èŠ‚ç‚¹ã€æ’æ§½å’Œkeyçš„å¯¹åº”å…³ç³»ã€‚ å¯ä»¥é€šä¿—ç†è§£ä¸ºï¼Œæ’æ§½æ˜¯Clusterç®¡ç†æ•°æ®çš„åŸºæœ¬å•ä½ã€‚ 6.åŠ¨æ€ç®¡ç†èŠ‚ç‚¹å‡å¦‚æˆ‘ä»¬åŸæœ‰4ä¸ªMasterèŠ‚ç‚¹ï¼ˆM1 â€¦ M4ï¼‰ï¼Œä½†æ˜¯ç°åœ¨å› ä¸ºæ•°æ®å¢é‡é—®é¢˜ä¸´æ—¶åŠ ä¸€ä¸ªMasterèŠ‚ç‚¹ï¼ˆM5ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿ å¯åŠ¨M5èŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯å‘é€MEETå‘½ä»¤è®©M5èŠ‚ç‚¹åŠ å…¥åˆ°Clusterä¸­ï¼Œç°åœ¨M5èŠ‚ç‚¹æ²¡æœ‰ä»»ä½•æ’æ§½æ‰€ä»¥ä¸ä¼šæ¥å—ä»»ä½•è¯»å†™æ“ä½œã€‚ åœ¨M5èŠ‚ç‚¹æ‰§è¡Œcluster setslot &#123;SLOT&#125; importing &#123;SOURCE_NODE_ID&#125;å‘½ä»¤ï¼Œè®©M5èŠ‚ç‚¹å‡†å¤‡å¯¼å…¥{SLOT}æ’æ§½ã€‚ åœ¨æ‹¥æœ‰è¿™ä¸ª{SLOT}æ’æ§½çš„æºèŠ‚ç‚¹ä¸Šé¢æ‰§è¡Œcluster setslot &#123;SLOT&#125; migrating &#123;M5_NODE_ID&#125;ï¼Œè®©æºèŠ‚ç‚¹å‡†å¤‡å¥½è¿å‡ºæ’æ§½ã€‚ è¿™æ—¶å€™å¦‚æœå®¢æˆ·ç«¯æ“ä½œçš„keyå­˜åœ¨äº{SLOT}æ’æ§½ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œç”±æºèŠ‚ç‚¹å¤„ç†ã€‚å¦‚æœkeyä¸å­˜åœ¨äº{SLOT}æ’æ§½ä¸­ï¼Œè¿™ä¸ªæ“ä½œå°†ç”±M5èŠ‚ç‚¹æ“ä½œã€‚ ç°åœ¨æºèŠ‚ç‚¹çš„{SLOT}æ’æ§½ä¸ä¼šåˆ›å»ºä»»ä½•æ–°çš„keyï¼Œéœ€è¦æŠŠæºèŠ‚ç‚¹{SLOT}æ’æ§½ä¸­çš„keyè¿ç§»åˆ°M5èŠ‚ç‚¹ã€‚æ‰§è¡Œcluster getkeysinslot &#123;SLOT&#125; &#123;COUNT&#125;å‘½ä»¤è·å–{SLOT}æ’æ§½ä¸­æŒ‡å®š{COUNT}æ•°é‡çš„keyåˆ—è¡¨ã€‚ åœ¨æºèŠ‚ç‚¹å¯¹æ¯ä¸ªkeyæ‰§è¡Œmigrateå‘½ä»¤ï¼ŒæŠŠkeyè¿ç§»åˆ°M5èŠ‚ç‚¹ã€‚ åœ¨æºèŠ‚ç‚¹å’ŒM5èŠ‚ç‚¹æ‰§è¡Œcluster setslot &#123;SLOT&#125; NODE &#123;M5_NODE_ID&#125;ï¼Œå®Œæˆè¿ç§»ã€‚ è¿™å°±æ˜¯åŠ¨æ€å¢åŠ èŠ‚ç‚¹çš„æµç¨‹äº†ï¼Œå¯èƒ½åœ¨æ–°çš„Redisç‰ˆæœ¬ä¸­å¢åŠ äº†èŠ‚ç‚¹è¿ç§»å·¥å…·ï¼Œä½†æ˜¯æ ¸å¿ƒæµç¨‹åº”è¯¥è¿˜æ˜¯è¿™æ ·ã€‚ 7.Hash Tagå­¦ä¹ äº†æ•°æ®æ’æ§½ï¼Œæˆ‘ä»¬çŸ¥é“Redisåœ¨keyåˆ†é…åˆ°æ’æ§½çš„è¿™ä¸€æ“ä½œå®Œå…¨æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œä¸è¿‡å½“æˆ‘ä»¬æœ‰éœ€æ±‚å¯¹ä¸åŒçš„keyéœ€è¦æ”¾åˆ°åŒä¸€æ’æ§½ä¸­çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™è¦æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦åœ¨keyä¸­åŠ å…¥{}ç¬¦å·å³å¯ï¼Œæ¯”å¦‚ï¼š {UID_1001}:following {UID_1001}:followers è¿™ä¸¤ä¸ªkeyä¼šè¢«åˆ†é…åˆ°åŒä¸€æ’æ§½ï¼ŒåŸç†å°±æ˜¯å½“keyä¸­å­˜åœ¨{}ç¬¦å·ï¼Œå“ˆå¸Œç®—æ³•åªä¼šé’ˆå¯¹{}ç¬¦å·å†…çš„å­—ç¬¦ä¸²ã€‚ 8.æ’æ§½ä¸ºä»€ä¹ˆæ˜¯16384ï¼Ÿè¿™ä¸ªå€¼èƒ½ä¿®æ”¹å—ï¼Ÿé¦–å…ˆcrc16ç®—æ³•ç®—å‡ºçš„å€¼æœ‰16bitï¼Œ2^16å³65536ã€‚ä¹Ÿå°±æ˜¯è¯´è¯¥ç®—æ³•çš„å€¼åœ¨0 ~ 65535ä¹‹é—´ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä½œè€…è¿˜æ˜¯é€‰æ‹©äº†16384å³0 ~ 16383ã€‚ å¾ˆå¼€å¿ƒï¼Œå¯¹äºè¿™ä¸ªç–‘é—®Redisä½œè€…ç»™äº†æ˜ç¡®çš„å›ç­”ã€‚å‰é¢æˆ‘ä»¬çŸ¥é“æ¯ä¸ªèŠ‚ç‚¹ä¹‹é—´ä¼šä»¥æ¯ç§’1æ¬¡çš„é¢‘ç‡äº’ç›¸å‘é€å¿ƒè·³åŒ…ï¼ˆPINGï¼‰&amp;äº¤æ¢ä¿¡æ¯ï¼ˆä¿¡æ¯åˆ†ä¸ºæ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ï¼‰ï¼Œä¹‹å‰ä¹Ÿæäº†äº¤æ¢çš„ä¿¡æ¯ä½“é‡Œé¢ä¸»è¦åŒ…å«èŠ‚ç‚¹çš„ä¿¡æ¯ç­‰ï¼Œé‚£ä¹ˆæ¶ˆæ¯å¤´çš„å†…å®¹å‘¢ï¼Ÿå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324typedef struct &#123; char sig[4]; /* Siganture &quot;RCmb&quot; (Redis Cluster message bus). */ uint32_t totlen; /* Total length of this message */ uint16_t ver; /* Protocol version, currently set to 1. */ uint16_t port; /* TCP base port number. */ uint16_t type; /* Message type */ uint16_t count; /* Only used for some kind of messages. */ uint64_t currentEpoch; /* The epoch accordingly to the sending node. */ uint64_t configEpoch; /* The config epoch if it&#x27;s a master, or the last epoch advertised by its master if it is a slave. */ uint64_t offset; /* Master replication offset if node is a master or processed replication offset if node is a slave. */ char sender[CLUSTER_NAMELEN]; /* Name of the sender node */ unsigned char myslots[CLUSTER_SLOTS/8]; char slaveof[CLUSTER_NAMELEN]; char myip[NET_IP_STR_LEN]; /* Sender IP, if not all zeroed. */ char notused1[34]; /* 34 bytes reserved for future usage. */ uint16_t cport; /* Sender TCP cluster bus port */ uint16_t flags; /* Sender node flags */ unsigned char state; /* Cluster state from the POV of the sender */ unsigned char mflags[3]; /* Message flags: CLUSTERMSG_FLAG[012]_... */ union clusterMsgData data; /* message body*/&#125; clusterMsg; å…¶ä¸­æœ‰ä¸ªmyslotså­—æ®µè¦æ³¨æ„ï¼Œè¯¥å­—æ®µä½¿ç”¨ä½å›¾ï¼Œå³1bitä»£è¡¨1slotï¼Œå¦‚æœè¯¥bitä¸º1å³è¯´æ˜è¯¥æ’æ§½å±äºè¿™ä¸ªèŠ‚ç‚¹ã€‚é‚£ä¹ˆè¯¥å­—æ®µçš„å¤§å°ä¸ºï¼š16384 &#x2F; 8bit &#x2F; 1024b &#x3D; 2kbã€‚ä¹Ÿå°±æ˜¯æ¶ˆæ¯å¤´ä¸è€ƒè™‘å…¶ä»–ä¿¡æ¯çš„æƒ…å†µï¼Œå•æ˜¯myslotså°±å·²ç»æœ‰2kbå¤§å°ã€‚ é‚£ä¹ˆæ¶ˆæ¯ä½“å‘¢ï¼Ÿä¹‹å‰å·²ç»æåˆ°äº†æ¶ˆæ¯ä½“ä¸­ä¼šåŒ…å«èŠ‚ç‚¹ä¿¡æ¯ã€‚å…·ä½“æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿæ¶ˆæ¯ä½“æ¯æ¬¡æºå¸¦æœ€å°‘3ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæ•°é‡çº¦ä¸ºæ€»èŠ‚ç‚¹æ•°çš„1&#x2F;10ã€‚å¦‚æœèŠ‚ç‚¹æ•°é‡è¶Šå¤šï¼Œæ¶ˆæ¯ä½“è¶Šå¤§ã€‚ å¦‚æœæ’æ§½æ•°é‡æ˜¯65535ï¼Œé‚£ä¹ˆè¯¥å­—æ®µçš„å¤§å°æ”¾å¤§ä¸ºï¼š65535 &#x2F; 8bit &#x2F; 1024b &#x3D; 8kbã€‚è¿™å¯¹äºæ¯ç§’1æ¬¡é¢‘ç‡çš„å¿ƒè·³åŒ…æ¥è®²ï¼Œå¸¦å®½å¼€é”€æ˜¯æå¤§çš„ã€‚ ä¸Šé¢è¯´äº†èŠ‚ç‚¹è¶Šå¤šï¼Œæ¶ˆæ¯ä½“ä¹Ÿå°±è¶Šå¤§ï¼Œå¦‚æœèŠ‚ç‚¹è¶…è¿‡1000ä¸ªä¹Ÿä¼šå¯¼è‡´ç½‘ç»œæ‹¥å µï¼Œå› ä¸ºRedisä½œè€…ä¸å»ºè®®ClusterèŠ‚ç‚¹çš„æ•°é‡è¶…è¿‡1000ï¼Œé‚£ä¹ˆå¯¹äº1000ä¸ªä»¥ä¸‹çš„èŠ‚ç‚¹æ¥è¯´16384ä¸ªæ’æ§½ä¹Ÿå°±å¤Ÿç”¨äº†ã€‚ ç¬¬ä¸‰ä¸ªè€ƒè™‘æ˜¯å…³äºä½å›¾çš„å‹ç¼©é—®é¢˜ï¼Œæˆ‘è¿˜æ²¡æœ‰ææ˜ç™½~~æ‰€ä»¥è¿™é‡Œä¸å±•å¼€è¯´äº†ï¼Œå…ˆåŸ‹ä¸ªå‘ã€‚ è¿™ä¸ªå€¼èƒ½ä¿®æ”¹å—ï¼Ÿ16384æ’æ§½æ•°é‡æ˜¯å†™æ­»åœ¨Redisæºä»£ç ä¸­çš„ï¼Œæ‰€ä»¥æ˜¯ä¸å¯ä»¥æ›´æ”¹çš„ã€‚ é™„ä¸Šå…³äºä½œè€…çš„å›ç­” https://github.com/antirez/redis/issues/2576 æœ€åClusteråœ¨æ•…éšœæ¢å¤ä¸»ä»åˆ‡æ¢çš„æœºåˆ¶ï¼ˆåŒ…æ‹¬ï¼šä¸»è§‚å®•æœºã€å®¢è§‚å®•æœºã€æŠ•ç¥¨é€‰ä¸¾ã€ä¸»ä»åˆ‡æ¢ï¼‰å’Œå“¨å…µç­–ç•¥åŸºæœ¬ä¸€è‡´ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå°±ä¸å­¦ä¹ Clusterå…³äºæ•…éšœæ¢å¤ä¸»ä»åˆ‡æ¢çš„ç›¸å…³çŸ¥è¯†äº†ã€‚ å‰é¢æåˆ°è¿‡Gossipåè®®ï¼Œå®ƒä¸»è¦èŒè´£å°±æ˜¯å„èŠ‚ç‚¹é—´çš„ä¿¡æ¯äº¤æ¢ï¼Œå¸¸ç”¨çš„Gossipæ¶ˆæ¯å¯åˆ†ä¸ºï¼š ping pong meet fail åé¢ä¼šä¸“é—¨æ¥å­¦ä¹ Gossipåè®®çš„çŸ¥è¯†ï¼ˆ-,-å†æ¬¡åŸ‹ä¸ªå‘ï¼‰ã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"redis","slug":"redis","permalink":"http://xupin.im/tags/redis/"}]},{"title":"Rediså­¦ä¹ ç¬”è®° - å“¨å…µ","date":"2020-03-25T16:00:00.000Z","path":"2020/03/26/redis-sentinel/","text":"ç°åœ¨è¿™ç¯‡æ¥å­¦ä¹ ä¸€ä¸‹Redis Sentinelå³å“¨å…µç­–ç•¥çš„ç›¸å…³çŸ¥è¯†ã€‚ 1.ä»€ä¹ˆæ˜¯å“¨å…µï¼Ÿå“¨å…µï¼ˆSentinelï¼‰ï¼ŒRedis2.6ç‰ˆæœ¬ï¼ˆæ­£å¼ç‰ˆæœ¬æ˜¯2.8ï¼Œç°2.6ç‰ˆæœ¬å·²è¢«åºŸå¼ƒï¼‰å¼€å§‹æä¾›çš„ä¸€ç§é›†ç¾¤ç­–ç•¥ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯è§£å†³äº†ä¸»ä»å¤åˆ¶ï¼ˆReplicationï¼‰åœ¨MasterèŠ‚ç‚¹æ•…éšœï¼Œæ— æ³•è‡ªåŠ¨åˆ‡æ¢SlaveèŠ‚ç‚¹ä¸ºæ–°MasterèŠ‚ç‚¹çš„é—®é¢˜ã€‚ ç‰¹ç‚¹ å“¨å…µç­–ç•¥æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼ŒèŠ‚ç‚¹é—´ç›¸äº’åè°ƒå·¥ä½œã€‚ å“¨å…µé›†ç¾¤è‡³å°‘è¦3ä¸ªèŠ‚ç‚¹ã€‚ å¯ä»¥æŠŠå“¨å…µçœ‹ä½œæ˜¯ä¸€ç§ç‰¹æ®Šçš„RedisæœåŠ¡ã€‚ ä¼˜ç‚¹ å“¨å…µç­–ç•¥æ‹¥æœ‰ä¸»ä»å¤åˆ¶çš„ä¼˜ç‚¹ã€‚ å“¨å…µç­–ç•¥è§£å†³äº†MasterèŠ‚ç‚¹æ•…éšœï¼Œæ— æ³•è‡ªåŠ¨åˆ‡æ¢SlaveèŠ‚ç‚¹ä¸ºæ–°MasterèŠ‚ç‚¹çš„é—®é¢˜ã€‚ ç¼ºç‚¹ MasterèŠ‚ç‚¹å†™æ“ä½œçš„å‹åŠ›æ²¡æœ‰å¾—åˆ°è§£å†³ã€‚ æ•°æ®å­˜å‚¨èƒ½åŠ›è¿˜æ˜¯å—åˆ°å•èŠ‚ç‚¹é™åˆ¶ã€‚ 2.å¦‚ä½•é…ç½®ï¼ˆå¤šç§æ–¹å¼ï¼‰ å¯åŠ¨Rediså“¨å…µï¼Œ.&#x2F;redis-sentinel redis-sentinel.conf å¯åŠ¨RedisæœåŠ¡æ—¶å¹¶ä¸”å¯åŠ¨å“¨å…µï¼Œ.&#x2F;redis-server redis-sentinel.conf â€“sentinel redis-sentinel.confç¤ºä¾‹ 1234567891011121314151617181920212223242526# å“¨å…µç›‘æ§çš„èŠ‚ç‚¹ã€‚# MASTER_NAMEï¼šè‡ªå®šä¹‰çš„MasterèŠ‚ç‚¹åç§°ã€‚# IPï¼šMasterèŠ‚ç‚¹çš„åœ°å€ã€‚# PORTï¼šMasterèŠ‚ç‚¹çš„ç«¯å£ã€‚# QUORUMï¼šå½“MasterèŠ‚ç‚¹æ•…éšœï¼Œç¡®è®¤MasterèŠ‚ç‚¹odownæœ€å°‘çš„å“¨å…µæ•°é‡ã€‚sentinel monitor &#123;MASTER_NAME&#125; &#123;IP&#125; &#123;PORT&#125; &#123;QUORUM&#125;# å“¨å…µéªŒè¯# PASSï¼šMasterèŠ‚ç‚¹çš„authï¼Œéœ€è¦æ³¨æ„çš„æ—¶å“¨å…µä¸èƒ½åŒæ—¶ä¸ºMasterèŠ‚ç‚¹å’ŒSlaveèŠ‚ç‚¹è®¾ç½®å¯†ç ï¼Œæ‰€ä»¥authéœ€è¦ä¿æŒä¸€è‡´ã€‚sentinel auth-pass &#123;MASTER_NAME&#125; &#123;PASS&#125;# å“¨å…µå¿ƒè·³Pingæœ€å¤§æ—¶é—´ï¼Œå¦‚æœå“¨å…µå‘MasterèŠ‚ç‚¹å‘é€Pingè¶…è¿‡è¿™ä¸ªæ—¶é—´æˆ–è€…å›å¤errï¼Œé‚£ä¹ˆå“¨å…µä¼šä¸»è§‚ï¼ˆsdownï¼‰è®¤ä¸ºè¯¥MasterèŠ‚ç‚¹å·²ç»å¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚# MSï¼šå¿ƒè·³Pingç­‰å¾…å“åº”çš„æœ€å¤§æ—¶é—´ï¼ˆå•ä½ï¼šMillisecondï¼‰ã€‚sentinel down-after-milliseconds &#123;MASTER_NAME&#125; &#123;MS&#125;# åŒæ—¶åŒæ­¥æ•°æ®çš„SlaveèŠ‚ç‚¹æ•°é‡# SLAVE_NUMï¼šå½“MasterèŠ‚ç‚¹æ•…éšœï¼ŒSlaveèŠ‚ç‚¹é€šè¿‡ç«é€‰å½“é€‰æ–°MasterèŠ‚ç‚¹ï¼Œæœ€å¤šå…è®¸å‡ ä¸ªSlaveèŠ‚ç‚¹å¼€å§‹åŒæ­¥æ–°Masterçš„æ•°æ®ã€‚sentinel parallel-syncs &#123;MASTER_NAME&#125; &#123;SLAVE_NUM&#125;# ä¸»ä»èŠ‚ç‚¹åˆ‡æ¢æ‰€éœ€è¦çš„æœ€å¤§æ—¶é—´ã€‚# MSï¼šä¸»ä»èŠ‚ç‚¹åˆ‡æ¢æ‰€éœ€è¦çš„æœ€å¤§æ—¶é—´ï¼ˆå•ä½ï¼šMillisecondï¼‰ã€‚sentinel failover-timeout &#123;MASTER_NAME&#125; &#123;MS&#125;# MasterèŠ‚ç‚¹æ•…éšœè°ƒç”¨çš„è„šæœ¬# SCRIPT_PATHï¼šè„šæœ¬è·¯å¾„sentinel notification-script &#123;MASTER_NAME&#125; &#123;SCRIPT_PATH&#125; 3.å·¥ä½œæœºåˆ¶ å“¨å…µå‘å·²çŸ¥èŠ‚ç‚¹å’Œå“¨å…µå‘é€å¿ƒè·³åŒ…æ£€æµ‹çŠ¶æ€ã€‚ MasterèŠ‚ç‚¹æ— æ•ˆå›å¤ï¼Œå“¨å…µåˆ¤æ–­MasterèŠ‚ç‚¹çŠ¶æ€ï¼šä¸»è§‚å®•æœºï¼Œå®¢è§‚å®•æœºã€‚ MasterèŠ‚ç‚¹è¢«ç¡®å®šå®¢è§‚å®•æœºï¼Œè¿›è¡Œé¢†å¤´ï¼ˆLeaderï¼‰å“¨å…µé€‰ä¸¾ã€‚ å‡†å¤‡è¿›è¡Œä¸»ä»åˆ‡æ¢çš„é¢†å¤´å“¨å…µè·å–å…¶ä»–å“¨å…µçš„æˆæƒã€‚ æˆæƒæˆåŠŸï¼Œä»SlaveèŠ‚ç‚¹ä¸­é€‰ä¸¾æ–°MasterèŠ‚ç‚¹ã€‚ é¢†å¤´å“¨å…µæŠŠæ–°MasterèŠ‚ç‚¹ä¿¡æ¯åŒæ­¥ç»™å…¶ä»–å“¨å…µï¼Œå…¶ä»–å“¨å…µæŠŠæ–°MasterèŠ‚ç‚¹ä¿¡æ¯åŒæ­¥å¯¹åº”SlaveèŠ‚ç‚¹ã€‚ 4.å¿ƒè·³åŒ…æ¯ä¸ªå“¨å…µä»¥æ¯ç§’é’Ÿ1æ¬¡çš„é¢‘ç‡å‘å®ƒå·²çŸ¥çš„MasterèŠ‚ç‚¹ã€SlaveèŠ‚ç‚¹å’Œå…¶ä»–å“¨å…µå‘é€PINGå‘½ä»¤ï¼Œå¸Œæœ›å¾—åˆ°çš„æœ‰æ•ˆå›å¤å¦‚ä¸‹ï¼š 123PING replied with +PONG.PING replied with -LOADING error.PING replied with -MASTERDOWN error. å…¶å®ƒä»»ä½•å›å¤æˆ–è€…æ— å›å¤éƒ½æ˜¯æ— æ•ˆå›å¤ã€‚ 5.å“¨å…µå’ŒèŠ‚ç‚¹ä¹‹é—´çš„è‡ªåŠ¨å‘ç°æœºåˆ¶é€šè¿‡Redisçš„pub&#x2F;subç³»ç»Ÿå®ç°ï¼Œæ¯ä¸ªå“¨å…µéƒ½ä¼šå‘è‡ªå·±ç›‘æ§çš„èŠ‚ç‚¹å¯¹åº”çš„channelï¼šsentinel:helloå‘é€ä¸€æ¡æ¶ˆæ¯ï¼ˆæ¶ˆæ¯ä½“åŒ…å«è‡ªå·±çš„{IP}ã€{PORT}å’Œ{RUNID}ä»¥åŠMasterèŠ‚ç‚¹çš„å®Œæ•´é…ç½®ï¼‰ï¼Œæ¯ä¸ªè®¢é˜…è¯¥channelçš„å“¨å…µéƒ½å¯ä»¥æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯å¹¶ä¸”èƒ½å‘ç°åˆ°å…¶ä»–å“¨å…µçš„å­˜åœ¨ï¼Œå¦‚æœæŸä¸ªå“¨å…µå‘ç°è‡ªå·±ç»´æŠ¤çš„èŠ‚ç‚¹é…ç½®ä½äºæ–°æ¥æ”¶çš„èŠ‚ç‚¹é…ç½®ï¼Œåˆ™ä¼šç”¨æ–°çš„èŠ‚ç‚¹é…ç½®è¿›è¡Œè¦†ç›–ã€‚ 6.ä¸»è§‚&#x2F;å®¢è§‚å®•æœºå¦‚æœä¸€ä¸ªMasterèŠ‚ç‚¹åœ¨æ”¶åˆ°PINGå‘½ä»¤åæ²¡æœ‰åœ¨æœ‰æ•ˆæ—¶é—´å†…ï¼ˆdown-after-millisecondsï¼‰è¿›è¡Œæœ‰æ•ˆå›å¤ï¼Œåˆ™ä¼šè¢«æ ‡è®°ä¸ºä¸»è§‚å®•æœºï¼ˆsdownï¼ŒSubjectively Downï¼‰ã€‚ å“¨å…µä¼šè·å–å…¶ä»–å“¨å…µæ£€æµ‹è¯¥èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå‘½ä»¤ï¼š 12345# IPï¼šä¸»è§‚å®•æœºçš„MasterèŠ‚ç‚¹åœ°å€# PORTï¼šä¸»è§‚å®•æœºçš„MasterèŠ‚ç‚¹ç«¯å£# CURRENT_EPOCHï¼šå“¨å…µçš„é…ç½®çºªå…ƒï¼Œç”¨äºé¢†å¤´å“¨å…µé€‰ä¸¾ã€‚# RUNIDï¼šå¯ä»¥æ˜¯*å’Œå“¨å…µçš„RunIDï¼Œå½“å€¼æ˜¯ * ä»£è¡¨æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦ä¸»è§‚å®•æœºï¼Œå¦‚æœæ˜¯RunIDåˆ™ç”¨äºé¢†å¤´å“¨å…µé€‰ä¸¾ã€‚SENTINEL is-master-down-byaddr &#123;IP&#125; &#123;PORT&#125; &#123;CURRENT_EPOCH&#125; &#123;RUNID&#125; å½“æœ‰è¶³å¤Ÿæ•°é‡ï¼ˆ{QUORUM}ï¼‰çš„å“¨å…µéƒ½è®¤ä¸ºè¯¥MasterèŠ‚ç‚¹å¤„äºä¸»è§‚å®•æœºçŠ¶æ€ã€‚åˆ™è¯¥MasterèŠ‚ç‚¹ä¼šè¢«æ ‡è®°ä¸ºå®¢è§‚å®•æœºï¼ˆodownï¼ŒObjectively Downï¼‰ï¼Œè‹¥æ²¡æœ‰è¶³å¤Ÿæ•°é‡çš„å“¨å…µéƒ½è®¤ä¸ºè¯¥MasterèŠ‚ç‚¹å¤„äºä¸»è§‚å®•æœºçŠ¶æ€ï¼Œåˆ™ä¸ä¼šè¢«æ ‡è®°ä¸ºå®¢è§‚å®•æœºï¼ŒåŒæ—¶å¦‚æœè¯¥MasterèŠ‚ç‚¹é‡æ–°è¿”å›å“¨å…µæœ‰æ•ˆå›å¤ï¼Œè¯¥MasterèŠ‚ç‚¹ä¸»è§‚å®•æœºçŠ¶æ€ä¼šè¢«ç§»é™¤ã€‚ 7.é¢†å¤´å“¨å…µé€‰ä¸¾å› ä¸ºåªéœ€è¦ä¸€ä¸ªå“¨å…µå®Œæˆä¸»ä»åˆ‡æ¢ï¼Œæ‰€ä»¥éœ€è¦é€‰ä¸¾ä¸€ä¸ªé¢†å¤´å“¨å…µã€‚ æ¯ä¸ªå“¨å…µéƒ½ä¼šå‘é€SENTINEL is-master-down-byaddrå‘½ä»¤å¸Œæœ›æˆä¸ºé¢†å¤´å“¨å…µã€‚æ”¶åˆ°è¯¥å‘½ä»¤çš„å“¨å…µå¦‚æœæ²¡æœ‰åŒæ„è¿‡å…¶ä»–å“¨å…µçš„åŒæ ·å‘½ä»¤ï¼Œé‚£ä¹ˆåŒæ„è¯¥è¯·æ±‚ï¼Œå¦åˆ™æ‹’ç»ã€‚ å¦‚æœæŸä¸€å“¨å…µå‘ç°åŒæ„è‡ªå·±è¯·æ±‚çš„å“¨å…µæ•°é‡å¹¶ä¸”æ•°é‡å¤§äºç­‰äº{QUORUM}ï¼Œé‚£ä¹ˆå®ƒå°†æˆä¸ºé¢†å¤´å“¨å…µã€‚ å¦‚æœé€‰ä¸¾è¿‡ç¨‹ä¸­æœ‰å¤šä¸ªå“¨å…µå½“é€‰é¢†å¤´å“¨å…µï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé€‰ä¸¾ä¼šé‡æ–°è¿›è¡Œã€‚ è¯¥æ–¹æ³•åŸºäºraftç®—æ³•é¢†å¤´é€‰ä¸¾æ–¹æ³•å®ç°ã€‚ 8.ä¸»ä»åˆ‡æ¢æˆæƒå½“é€‰ä¸¾å‡ºé¢†å¤´å“¨å…µä¹‹åå¹¶æœªé©¬ä¸Šè¿›è¡Œä¸»ä»åˆ‡æ¢ï¼Œé¢†å¤´å“¨å…µè¿˜éœ€è¦è·å–{MAJORITY}æ•°é‡çš„å“¨å…µæˆæƒã€‚ 1# MAJORITYï¼šè¯¥å€¼ä¸å¯é…ç½®ï¼ŒRedisè‡ªè¡Œè®¡ç®—ã€‚å…¬å¼ï¼šmajority = voters / 2 + 1 å¦‚æœ{QUORUM} &lt; {MAJORITY}ï¼Œé¢†å¤´å“¨å…µéœ€è¦{MAJORITY}æ•°é‡çš„å“¨å…µè¿›è¡Œæˆæƒã€‚ å¦‚æœ{QUORUM} &gt;&#x3D; {MAJORITY}ï¼Œé‚£ä¹ˆé¢†å¤´å“¨å…µéœ€è¦{QUORUM}æ•°é‡çš„å“¨å…µæˆæƒæ‰å¯ä»¥ã€‚ å½“é¢†å¤´å“¨å…µè·å¾—æˆæƒä¹‹åï¼Œæ­£å¼å¼€å§‹ä¸»ä»åˆ‡æ¢æµç¨‹ã€‚ 9.ä¸»ä»åˆ‡æ¢å¼€å§‹ä¸»ä»åˆ‡æ¢ï¼ˆfailoverï¼‰ï¼Œé¦–å…ˆé¢†å¤´å“¨å…µä¼šé€‰ä¸¾å‡ºä¸€ä¸ªSlaveèŠ‚ç‚¹å‡ºæ¥ä½œä¸ºæ–°MasterèŠ‚ç‚¹ï¼Œè¯¥SlaveèŠ‚ç‚¹é€‰ä¸¾å‚è€ƒå‚æ•°ï¼š è¯¥èŠ‚ç‚¹å’ŒMasterèŠ‚ç‚¹æ–­å¼€çš„æ—¶é•¿ï¼Œå¦‚æœä¸€ä¸ªSlaveèŠ‚ç‚¹ä¸MasterèŠ‚ç‚¹æ–­å¼€è¿æ¥æ—¶é—´å·²ç»è¶…è¿‡down-after-millisecondså‚æ•°çš„10å€ï¼Œå†åŠ ä¸ŠMasterå®•æœºçš„æ—¶é•¿ï¼Œè¯¥SlaveèŠ‚ç‚¹å°±ä¼šè¢«è®¤ä¸ºä¸é€‚åˆé€‰ä¸¾ä¸ºæ–°çš„MasterèŠ‚ç‚¹ã€‚ 1(down-after-milliseconds * 10) + milliseconds_since_master_is_in_SDOWN_state SlaveèŠ‚ç‚¹çš„ä¼˜å…ˆçº§ï¼ˆslave-priorityï¼‰ï¼Œslave-priorityè¶Šä½ä¼˜å…ˆçº§è¶Šé«˜ã€‚ å¤åˆ¶æ•°æ®åç§»é‡ï¼ˆå¤åˆ¶æ•°æ®æœ€å®Œæ•´ï¼‰ RunIDï¼ˆæœ€å°çš„ï¼‰ 10.é…ç½®åŒæ­¥åœ¨é¢†å¤´å“¨å…µå®Œæˆä¸»ä»åˆ‡æ¢ä¹‹åï¼Œä¼šåœ¨æœ¬åœ°ç”Ÿæˆæœ€æ–°çš„Masteré…ç½®ç„¶åé€šè¿‡pub&#x2F;subæ¶ˆæ¯æœºåˆ¶åŒæ­¥ç»™å…¶ä»–å“¨å…µï¼Œå…¶ä»–å“¨å…µåˆ™æ›´æ–°å¯¹åº”çš„MasterèŠ‚ç‚¹é…ç½®ã€‚ é‚£ä¹ˆå…¶ä»–å“¨å…µæ€ä¹ˆçŸ¥é“è¿™ä»½é…ç½®æ˜¯æœ€æ–°çš„å‘¢ï¼Ÿ é¢†å¤´å“¨å…µå‡†å¤‡æ‰§è¡Œä¸»ä»åˆ‡æ¢å‰ï¼Œä¼šä»è¦åˆ‡æ¢æˆæ–°MasterèŠ‚ç‚¹çš„SlaveèŠ‚ç‚¹å–å¾—ä¸€ä¸ªconfiguration epochï¼Œå¯ä»¥ç†è§£ä¸ºé…ç½®ç‰ˆæœ¬å·ã€‚å¦‚æœé¢†å¤´å“¨å…µä¸»ä»åˆ‡æ¢å¤±è´¥äº†ï¼Œé‚£ä¹ˆå…¶ä»–å“¨å…µä¼šç­‰å¾…failover-timeoutæ—¶é—´ç„¶åæ¥æ›¿ç»§ç»­æ‰§è¡Œåˆ‡æ¢ï¼Œæ¯æ¬¡æ¥æ›¿éƒ½ä¼šé‡æ–°è·å–ä¸€ä¸ªconfiguration epochï¼Œä½œä¸ºæ–°çš„é…ç½®ç‰ˆæœ¬å·ã€‚å¦‚æœé¢†å¤´å“¨å…µåˆ‡æ¢æˆåŠŸï¼Œé‚£ä¹ˆå…¶ä»–å“¨å…µä¼šæ ¹æ®è‡ªå·±çš„é…ç½®ç‰ˆæœ¬å·æ¥æ›´æ–°å¯¹åº”SlaveèŠ‚ç‚¹çš„MasterèŠ‚ç‚¹é…ç½®ã€‚ æœ€åä¸ºä»€ä¹ˆè¯´å“¨å…µæœ€å°‘è¦3ä¸ªèŠ‚ç‚¹ï¼Œä¸¾ä¸ªä¾‹å­ï¼š å¦‚æœæ˜¯2ä¸ªèŠ‚ç‚¹ï¼Œ{QUORUM}å€¼ä¸º1ï¼Œæ­¤æ—¶å…¶ä¸­ä¸€å°æœåŠ¡å™¨å‡ºç°å®¢è§‚å®•æœºã€‚é¢†å¤´å“¨å…µéœ€è¦è¿›è¡Œä¸»ä»åˆ‡æ¢ï¼Œåœ¨è¿›è¡Œä¸»ä»åˆ‡æ¢å‰éœ€è¦è·å–{MAJORITY}æ•°é‡çš„å“¨å…µåŒæ„ï¼Œè¯¥{MAJORITY}å‚æ•°æœ€å°çš„å€¼æ˜¯ï¼š2ï¼Œæ­¤æ—¶é¢†å¤´å“¨å…µæ— æ³•è¿›è¡Œä¸»ä»åˆ‡æ¢ã€‚ https://redis.io/topics/sentinel","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"redis","slug":"redis","permalink":"http://xupin.im/tags/redis/"}]},{"title":"Rediså­¦ä¹ ç¬”è®° - ä¸»ä»å¤åˆ¶","date":"2020-03-24T16:00:00.000Z","path":"2020/03/25/redis-replication/","text":"Rediså•ç‚¹é…ç½®çš„æƒ…å†µä¸‹å¦‚æœæœåŠ¡å‡ºç°æ•…éšœå®•æœºï¼Œé‚£ä¹ˆæœåŠ¡ä¹Ÿå°±å¤„äºä¸å¯ç”¨çŠ¶æ€ï¼Œå‡å¦‚æ˜¯ç”Ÿäº§ç¯å¢ƒé‚£ä¹ˆå¸¦æ¥çš„åæœä¼šæœ‰å¾ˆä¸¥é‡ï¼Œæ‰€ä»¥å‡ºç°äº†é«˜å¯ç”¨æ–¹æ¡ˆï¼šé›†ç¾¤ç­–ç•¥ã€‚ 1.ä¸‰ç§é›†ç¾¤ç­–ç•¥Redisæä¾›äº†ä¸‰ç§é›†ç¾¤ç­–ç•¥ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š ä¸»ä»å¤åˆ¶ï¼ˆReplicationï¼‰ å“¨å…µï¼ˆSentinelï¼‰ é›†ç¾¤ï¼ˆClusterï¼‰ è¿™ä¸‰ç§ç­–ç•¥ä¼šé€ä¸€å­¦ä¹ ï¼Œæœ¬ç¯‡ä¸»è¦å­¦ä¹ ç­–ç•¥ä¹‹ä¸€ä¸»ä»å¤åˆ¶ï¼ˆReplicationï¼‰ã€‚ 2.ä¸»ä»å¤åˆ¶çš„æ¦‚å¿µåœ¨ä¸»ä»å¤åˆ¶ï¼ˆReplicationï¼‰ç­–ç•¥ä¸­ï¼ŒæœåŠ¡åˆ†ä¸ºä¸¤ç±»ï¼šMasterèŠ‚ç‚¹ã€SlaveèŠ‚ç‚¹ã€‚ ç‰¹ç‚¹ MasterèŠ‚ç‚¹å¯ä»¥æ‹¥æœ‰å¤šä¸ªSlaveèŠ‚ç‚¹ï¼Œä½†SlaveèŠ‚ç‚¹åªèƒ½æœåŠ¡ä¸€ä¸ªMasterèŠ‚ç‚¹ã€‚ æ•°æ®å¤åˆ¶æ–¹å‘åªèƒ½æ˜¯MasterèŠ‚ç‚¹-&gt;SlaveèŠ‚ç‚¹ã€‚ ä¼˜ç‚¹ å®ç°äº†å¤šæœºçƒ­æ•°æ®å¤‡ä»½ï¼Œæé«˜äº†é¢å¯¹å®•æœºæ•°æ®æ¢å¤çš„ç¾å¤‡èƒ½åŠ›ã€‚ åœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šå®ç°è¯»å†™åˆ†ç¦»æé«˜æœåŠ¡ååé‡ï¼Œå³ï¼šMasterèŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼ŒSlaveèŠ‚ç‚¹æä¾›è¯»æœåŠ¡ã€‚ å¦‚æœMasterèŠ‚ç‚¹å®•æœºå¯ä»¥å¿«é€Ÿåˆ‡æ¢ä½¿ç”¨SlaveèŠ‚ç‚¹æä¾›æœåŠ¡ã€‚ ç¼ºç‚¹ MasterèŠ‚ç‚¹æ•…éšœï¼Œæ— æ³•è‡ªåŠ¨åˆ‡æ¢SlaveèŠ‚ç‚¹ä¸ºæ–°MasterèŠ‚ç‚¹çš„é—®é¢˜ã€‚ MasterèŠ‚ç‚¹å†™æ“ä½œçš„å‹åŠ›æ²¡æœ‰å¾—åˆ°è§£å†³ã€‚ æ•°æ®å­˜å‚¨èƒ½åŠ›è¿˜æ˜¯å—åˆ°å•èŠ‚ç‚¹é™åˆ¶ã€‚ 3.å¦‚ä½•é…ç½®ï¼ˆå¤šç§æ–¹å¼ï¼‰ åœ¨SlaveèŠ‚ç‚¹æœåŠ¡å™¨redis.confå¢åŠ é…ç½®è¡Œï¼Œslaveof {MASTER_IP} {MASTER_PORT}ã€‚ å¯åŠ¨redis-serveræ—¶ï¼Œ.&#x2F;redis-server slaveof {MASTER_IP} {MASTER_PORT}ã€‚ åœ¨redis-cliå‘½ä»¤è¡Œç•Œé¢è¾“å…¥ï¼Œslaveof {MASTER_IP} {MASTER_PORT}ã€‚ 4.å·¥ä½œæœºåˆ¶ SlaveèŠ‚ç‚¹æ‰§è¡Œslaveofå‘½ä»¤ï¼Œä¿å­˜MasterèŠ‚ç‚¹ä¿¡æ¯ã€‚ èŠ‚ç‚¹å†…éƒ¨çš„å®šæ—¶ä»»åŠ¡å‘ç°ä¸»èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¼€å§‹å°è¯•Socketè¿æ¥ä¸»èŠ‚ç‚¹ã€‚ è¿æ¥å»ºç«‹æˆåŠŸï¼ŒSlaveèŠ‚ç‚¹å‘é€pingå‘½ä»¤ï¼ŒæœŸæœ›å¾—åˆ°pongå‘½ä»¤å“åº”ï¼Œå¦åˆ™å‘èµ·é‡è¿ã€‚ å¦‚æœä¸»èŠ‚ç‚¹æœ‰è®¾ç½®authï¼Œé‚£ä¹ˆè¿›è¡ŒauthéªŒè¯ï¼ŒæˆåŠŸç»§ç»­ï¼Œå¤±è´¥ç»ˆæ­¢ã€‚ï¼ˆéå¿…é¡»ï¼Œæ ¹æ®MasterèŠ‚ç‚¹æ˜¯å¦é…ç½®authå†³å®šï¼‰ SlaveèŠ‚ç‚¹åŒæ­¥MasterèŠ‚ç‚¹å…¨é‡æ•°æ®é›†ã€‚ï¼ˆè¯¥æ“ä½œæ˜¯MasterèŠ‚ç‚¹å‘SlaveèŠ‚ç‚¹å‘é€æ•°æ®å“Ÿï¼‰ MasterèŠ‚ç‚¹æŒç»­æŠŠå†™å‘½ä»¤åŒæ­¥SlaveèŠ‚ç‚¹ã€‚ 5.åŒæ­¥å‘½ä»¤Redisä¸»ä»å¤åˆ¶æ•°æ®æœ‰ä¸¤ä¸ªå‘½ä»¤ï¼Œsyncå’Œpsyncï¼Œsyncæ˜¯Redis2.8ç‰ˆæœ¬ä¹‹å‰çš„åŒæ­¥æ–¹æ³•ï¼Œpsyncæ˜¯Redis2.8ç‰ˆæœ¬ä»¥åä¼˜åŒ–syncæ–°è®¾è®¡åŒæ­¥æ–¹æ³•ã€‚åœ¨è¿™ä¼šç€é‡å­¦ä¹ psyncï¼Œä¹Ÿä¼šæå¸¦è¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆsyncä¼šè¢«ä¼˜åŒ–ã€‚ é¦–å…ˆï¼Œpsyncéœ€è¦3ä¸ªå‚æ•°æ”¯æŒï¼š MasterèŠ‚ç‚¹å’ŒSlaveèŠ‚ç‚¹å¤åˆ¶æ•°æ®çš„åç§»é‡ã€‚ 1MasterèŠ‚ç‚¹å’ŒSlaveèŠ‚ç‚¹å¤åˆ¶æ•°æ®çš„åç§»é‡ï¼Œä¸»è¦ä½œç”¨æ˜¯é€šè¿‡å¯¹æ¯”å¤åˆ¶åç§»é‡ï¼Œæ¥åˆ¤æ–­MasterèŠ‚ç‚¹å’ŒSlaveèŠ‚ç‚¹æ•°æ®æ˜¯å¦ä¸€è‡´ã€‚ MasterèŠ‚ç‚¹å¤åˆ¶ç§¯å‹ç¼“å†²åŒºã€‚ 1psyncçš„ç‰¹æ€§ä¹‹ä¸€ï¼Œç”¨äºå¢é‡æ•°æ®å¤åˆ¶å’Œè¡¥æ•‘ä¸¢å¤±çš„å¤åˆ¶æ•°æ®ã€‚ MasterèŠ‚ç‚¹çš„RunIDï¼ˆReplication IDï¼‰ã€‚ 1RedisæœåŠ¡å¯åŠ¨çš„æ—¶ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ª40ä½çš„å”¯ä¸€RunIDã€‚ MasterèŠ‚ç‚¹å’ŒSlaveèŠ‚ç‚¹å¤åˆ¶æ•°æ®çš„åç§»é‡ï¼šæ¯ä¸ªå‚ä¸å¤åˆ¶æ•°æ®çš„èŠ‚ç‚¹éƒ½ä¼šç»´æŠ¤ä¸€ä»½å¤åˆ¶åç§»é‡ï¼ŒMasterèŠ‚ç‚¹åœ¨å¤„ç†å®Œå†™å‘½ä»¤åï¼Œä¼šæŠŠå‘½ä»¤çš„å­—èŠ‚é•¿åº¦è¿›è¡Œç´¯åŠ ï¼ŒSlaveèŠ‚ç‚¹æ¯ç§’é’Ÿä¼šå‘MasterèŠ‚ç‚¹ä¸ŠæŠ¥è‡ªå·±çš„å¤åˆ¶åç§»é‡ï¼Œå› æ­¤MasterèŠ‚ç‚¹ä¹Ÿä¼šè®°å½•SlaveèŠ‚ç‚¹çš„åç§»é‡ã€‚MasterèŠ‚ç‚¹æŒç»­æŠŠå†™å‘½ä»¤åŒæ­¥SlaveèŠ‚ç‚¹ï¼ŒSlaveèŠ‚ç‚¹æˆåŠŸæ¥æ”¶åˆ°ä¹‹åä¹Ÿä¼šç´¯åŠ è‡ªèº«çš„åç§»é‡ã€‚æŸ¥çœ‹åç§»é‡ï¼š 123&gt;info replicationmaster_repl_offset:&#123;NUM&#125; # MasterèŠ‚ç‚¹åç§»é‡slave_repl_offset:&#123;NUM&#125; # SlaveèŠ‚ç‚¹åç§»é‡ å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼šå¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ˜¯ä¸€ä¸ªä¿å­˜åœ¨MasterèŠ‚ç‚¹æ‹¥æœ‰å›ºå®šé•¿åº¦çš„é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—å…ˆè¿›å…ˆå‡ºï¼Œå¤§å°å—repl-backlog-sizeå‚æ•°æ§åˆ¶ï¼ˆé»˜è®¤ï¼š1MBï¼‰ï¼ŒæŸ¥çœ‹ç¼“å†²åŒºï¼š 12&gt;info replicationrepl_backlog_size:&#123;NUM&#125;ï¼ˆbyteï¼‰ MasterèŠ‚ç‚¹çš„RunIDï¼ˆReplication IDï¼‰ï¼šè¯¥IDä¸»è¦æ˜¯ç”¨æ¥è¯†åˆ«RedisæœåŠ¡èŠ‚ç‚¹ï¼Œå› ä¸ºå¦‚æœä½¿ç”¨IP+PORTæ–¹å¼ï¼Œå‡å¦‚MasterèŠ‚ç‚¹é‡å¯ä¹‹åä¿®æ”¹äº†RDB&#x2F;AOFå¤‡ä»½æ–‡ä»¶ï¼Œæ­¤æ—¶SlaveèŠ‚ç‚¹å†åŸºäºåŸæ¥çš„å¤åˆ¶åç§»é‡è¿›è¡Œå¤åˆ¶æ•°æ®æ˜¯ä¸å¯é çš„ã€‚æŸ¥çœ‹RunIDï¼š 12&gt;info serverrun_id:8d252f66c3ef89bd60a060cf8dc5cfe3d511c5e4 psyncå‘½ä»¤ä½¿ç”¨æ–¹å¼ 1psync &#123;RUNID&#125; &#123;OFFSET&#125; 6.å¢é‡&#x2F;å…¨é‡å¤åˆ¶çŸ¥é“äº†å‘½ä»¤å¦‚ä½•ä½¿ç”¨ï¼Œé‚£ä¹ˆå½“SlaveèŠ‚ç‚¹å‘é€psyncå‘½ä»¤ç»™MasterèŠ‚ç‚¹ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæµç¨‹åˆ†ä¸ºå…¨é‡å¤åˆ¶å’Œå¢é‡å¤åˆ¶ä¸¤ç§ã€‚ å…¨é‡å¤åˆ¶ï¼Œå¦‚æœSlaveèŠ‚ç‚¹å‘é€çš„å‘½ä»¤æ˜¯ï¼špsync ? -1 MasterèŠ‚ç‚¹çŸ¥é“SlaveèŠ‚ç‚¹è¦å…¨é‡å¤åˆ¶æ•°æ®ï¼Œè¿”å›å‘½ä»¤åˆ™æ˜¯ï¼š+fullresync {RUNID} {OFFSET}ï¼ŒåŒæ—¶MasterèŠ‚ç‚¹ä¼šæ‰§è¡ŒRDBå¤‡ä»½å¹¶ä¸”ä½¿ç”¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ¥è®°å½•æ­¤åæ‰€æœ‰çš„å†™å‘½ä»¤ã€‚MasterèŠ‚ç‚¹ RDBå¤‡ä»½å®Œæˆä¹‹åå‘SlaveèŠ‚ç‚¹å‘é€å¤‡ä»½æ–‡ä»¶ï¼ŒåŒæ—¶ç»§ç»­ç¼“å†²å†™å‘½ä»¤ï¼Œåœ¨å¤‡ä»½æ–‡ä»¶å‘é€å®Œæ¯•åMasterèŠ‚ç‚¹ä¼šå‘SlaveèŠ‚ç‚¹å‘é€ç¼“å†²åŒºçš„å†™å‘½ä»¤ã€‚SlaveèŠ‚ç‚¹åœ¨æ”¶åˆ°MasterèŠ‚ç‚¹å‘é€çš„å¤‡ä»½æ–‡ä»¶ä¹‹åï¼Œä¼šä¸¢å¼ƒæ‰€æœ‰çš„æ—§æ•°æ®ï¼Œå¼€å§‹è½½å…¥å¤‡ä»½æ–‡ä»¶å¹¶ä¸”å¼€å§‹æ‰§è¡ŒMasterèŠ‚ç‚¹å‘é€ç¼“å†²åŒºçš„å†™å‘½ä»¤ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨SlaveèŠ‚ç‚¹åŠ è½½å¤‡ä»½æ–‡ä»¶çš„æ—¶å€™æ•°æ®å¤„äºä¸å¯é é˜¶æ®µï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å‚æ•°slave-server-stale-dataï¼ˆyesã€noï¼‰é…ç½®æ˜¯å¦å“åº”è¯·æ±‚ï¼Œyeså“åº”ï¼Œnoåˆ™æŠ›å‡ºâ€œSYNC with master in progressâ€ã€‚ å¦‚æœå¤‡ä»½ä»åˆ›å»ºåˆ°ä¼ è¾“å®Œæ¯•æ¶ˆè€—æ—¶é—´å¤§äºrepl-timeoutå‚æ•°çš„å€¼ï¼ŒSlaveèŠ‚ç‚¹å°†ä¼šæ”¾å¼ƒæ¥æ”¶å¤‡ä»½æ–‡ä»¶å¹¶ä¸”æ¸…ç†å·²ç»ä¸‹è½½çš„ä¸´æ—¶æ–‡ä»¶ã€‚ å¢é‡å¤åˆ¶ï¼ŒMasterèŠ‚ç‚¹ä¼šæ ¹æ®{RUNID}å’Œ{OFFSET}å†³å®šè¿”å›ç»“æœã€‚ MasterèŠ‚ç‚¹é¦–å…ˆä¼šæ£€æŸ¥{RUNID}æ˜¯å¦ä¸è‡ªèº«ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°†ä¼šæ‰§è¡Œå…¨é‡æ•°æ®å¤åˆ¶ã€‚å¦‚æœä¸€è‡´ä¼šæ ¹æ®{OFFSET}å‚æ•°åœ¨ç¼“å†²åŒºæŸ¥æ‰¾ï¼Œå¦‚æœæ•°æ®åç§»é‡ä¹‹åçš„æ•°æ®å­˜åœ¨ç¼“å†²åŒºï¼Œè¿”å›å‘½ä»¤ï¼š+continueï¼Œè¡¨ç¤ºå¯ä»¥å¢é‡å¤åˆ¶æ•°æ®ã€‚å¦‚æœè¿”å›å‘½ä»¤+errï¼Œè¡¨ç¤ºMasterèŠ‚ç‚¹ç‰ˆæœ¬è¿‡ä½ä¸æ”¯æŒpsyncå‘½ä»¤ï¼Œå°†ä¼šä½¿ç”¨syncè¿›è¡Œå…¨é‡å¤åˆ¶æ•°æ®ã€‚ æœ€åæœ€åå­¦ä¹ ä¸€ä¸‹ä¸ºä»€ä¹ˆsyncä¼šè¢«ä¼˜åŒ–ï¼Ÿ ä½¿ç”¨syncå‘½ä»¤ï¼Œåœ¨ç½‘ç»œæˆ–è€…å…¶ä»–ä¸å¯æŠ—åŠ›å› ç´ å¯¼è‡´MasterèŠ‚ç‚¹å’ŒSlaveèŠ‚ç‚¹æ–­å¼€è¿æ¥ï¼Œéœ€è¦é‡æ–°è¿›è¡Œä¸€æ¬¡å…¨é‡æ•°æ®å¤åˆ¶ï¼ŒSlaveèŠ‚ç‚¹æ•°æ®æ¢å¤æˆæœ¬æé«˜ã€‚ https://redis.io/topics/replication http://try.redis.io","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"redis","slug":"redis","permalink":"http://xupin.im/tags/redis/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - åˆ†ç‰‡å’Œåˆ†åŒº","date":"2020-03-22T16:00:00.000Z","path":"2020/03/23/mysql-sharding-partition/","text":"ä¹‹å‰åœ¨å¤ä¹ Mysqlä¸»ä»çŸ¥è¯†çš„åŒæ—¶ï¼Œå°ä¼™ä¼´è€ƒäº†æˆ‘ä¸€ä¸ªé—®é¢˜ï¼Œåˆ†ç‰‡å’Œåˆ†åŒºæœ‰ä»€ä¹ˆå·®åˆ« â€¦ ä¹ä¸€å¬å¯èƒ½åªæ˜¯åè¯ä¸Šçš„ä¸åŒï¼Œä½†å…¶å®å®ƒä»¬ä¿©çš„ç¡®ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ã€‚ 1.ä»€ä¹ˆæ˜¯åˆ†ç‰‡ï¼ˆShardingï¼‰ï¼Ÿæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œä¸€å¼ æ–‡ç« è¡¨ã€‚ç»“æ„å¦‚ä¸‹ï¼š 123456789CREATE TABLE `mark`.`article` ( `id` int NOT NULL AUTO_INCREMENT, `type` varchar(20) NOT NULL COMMENT &#x27;ç±»å‹&#x27;, `title` varchar(255) NOT NULL COMMENT &#x27;æ ‡é¢˜&#x27;, `content` longtext NOT NULL COMMENT &#x27;å†…å®¹&#x27;, `author` varchar(20) NOT NULL COMMENT &#x27;ä½œè€…&#x27;, `date` datetime NOT NULL COMMENT &#x27;æ—¥æœŸ&#x27;, PRIMARY KEY (`id`)); éœ€æ±‚å¦‚ä¸‹ï¼š ç”¨æˆ·æ‰“å¼€appä¼šç›´æ¥å±•ç¤ºæ–‡ç« åˆ—è¡¨ï¼ˆç±»å‹ï¼Œæ ‡é¢˜ï¼Œä½œè€…ï¼Œæ—¥æœŸï¼‰ ç‚¹å‡»æ–‡ç« æŸ¥çœ‹è¯¦æƒ… é‚£ä¹ˆè¿™å¼ è¡¨åœ¨æ•°æ®é‡æ¯”è¾ƒå°çš„åˆæœŸåº”å¯¹è®¿é—®æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ã€‚ä½†æ˜¯éšç€æ•°æ®é‡æ—¥ç›Šè†¨èƒ€ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¼šè¶Šæ¥è¶Šä½ï¼Œå› ä¸ºé‡Œé¢contentå­—æ®µéå¸¸å·¨å¤§ã€‚ è¿™æ—¶å€™è¦æ€ä¹ˆä¼˜åŒ–å‘¢ï¼ŸæŠŠcontentå­—æ®µæ‹†å‡ºå»ï¼Œå› ä¸ºè®¿é—®æœ€å¤šçš„è¯·æ±‚å¹¶ä¸éœ€è¦contentï¼Œæ€ä¹ˆæ‹†å‘¢ï¼Ÿç»“æ„å¦‚ä¸‹ï¼š 1234567891011121314151617# æ–‡ç« è¡¨CREATE TABLE `mark`.`article` ( `id` int NOT NULL AUTO_INCREMENT, `type` varchar(20) NOT NULL COMMENT &#x27;ç±»å‹&#x27;, `title` varchar(255) NOT NULL COMMENT &#x27;æ ‡é¢˜&#x27;, `c_id` int NOT NULL COMMENT &#x27;æ–‡ç« ID&#x27;, `author` varchar(20) NOT NULL COMMENT &#x27;ä½œè€…&#x27;, `created_at` datetime NOT NULL COMMENT &#x27;æ—¥æœŸ&#x27;, PRIMARY KEY (`id`));# æ–‡ç« å†…å®¹è¡¨CREATE TABLE `mark`.`article_content` ( `id` int NOT NULL AUTO_INCREMENT, `content` longtext NOT NULL COMMENT &#x27;å†…å®¹&#x27;, `created_at` datetime NOT NULL COMMENT &#x27;æ—¥æœŸ&#x27;, PRIMARY KEY (`id`)); 2.å‚ç›´ï¼ˆçºµå‘ï¼‰åˆ‡åˆ†ä¸Šè¿°è¿™ç§æƒ…å†µå°±æ˜¯åˆ†ç‰‡çš„ä¸€ç§ï¼Œå‚ç›´åˆ‡åˆ†ä¹Ÿè¢«ç§°ä¸ºçºµå‘åˆ‡åˆ†ï¼Œè¿™ç§åˆ†ç‰‡çš„æ–¹å¼ä¸ä»…å¯ä»¥è·¨è¡¨ä¹Ÿå¯ä»¥è·¨åº“ã€‚ ä¼˜ç‚¹ æ‹†åˆ†è§„åˆ™ç®€å•ã€‚ æ•°æ®æ¨¡å—æ¸…æ™°ã€‚ å®¹æ˜“ç»´æŠ¤ï¼Œå®¹æ˜“å®šä½é—®é¢˜ã€‚ ç¼ºç‚¹ å¦‚æœåˆ†ç‰‡è¡¨è·¨åº“ï¼Œé‚£ä¹ˆåœ¨SQLå±‚æ— æ³•è¿›è¡Œè¿è¡¨æŸ¥è¯¢ï¼Œåªèƒ½åœ¨ç¨‹åºå±‚å¤„ç†ã€‚ äº‹åŠ¡å¤„ç†å¤æ‚åº¦å˜é«˜ã€‚ åæœŸè¡¨ç»“æ„çš„æ‰©å±•æ€§å—é™ã€‚ 3.æ°´å¹³ï¼ˆæ¨ªå‘ï¼‰åˆ‡åˆ†è¯´åˆ°äº†å‚ç›´åˆ‡åˆ†ï¼Œé‚£å°±ä¸å¾—ä¸æä¸€ä¸‹æ°´å¹³åˆ‡åˆ†ä¹Ÿè¢«ç§°ä¹‹ä¸ºæ¨ªå‘åˆ‡åˆ†ã€‚åŒæ ·ä¸¾ä¸ªä¾‹å­ï¼Œä¸€å¼ ç”¨æˆ·æ—¥å¿—è¡¨ã€‚ç»“æ„å¦‚ä¸‹ï¼š 12345CREATE TABLE `mark`.`user_log` ( `u_id` int NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;, `content` longtext NOT NULL COMMENT &#x27;æ—¥å¿—å†…å®¹&#x27;, `created_at` datetime NOT NULL COMMENT &#x27;åˆ›å»ºæ—¥æœŸ&#x27;); éœ€æ±‚å¦‚ä¸‹ï¼š æ ¹æ®ç”¨æˆ·IDå¿«é€Ÿæ£€ç´¢æ—¥å¿—ä¿¡æ¯ æƒ…å†µä¸€æ ·ï¼Œåœ¨æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™åŠŸèƒ½å“åº”é€Ÿåº¦åº”è¯¥è¿˜å¯ä»¥ï¼Œä½†æ˜¯éšç€æ•°æ®é‡å¢é•¿çš„æ¯”è¾ƒå‰å®³ã€‚æŸ¥è¯¢æ•ˆç‡ä¼šå‘ˆæ–­å´–å¼ä¸‹é™ã€‚ é‚£ä¹ˆè¿™æ—¶å€™è¦æ€ä¹ˆä¼˜åŒ–å‘¢ï¼Ÿæˆ‘ä»¬æŒ‰ç…§ç”¨æˆ·IDå»æ‹†åˆ†è¡¨ï¼Œå³æ¯ä¸ªç”¨æˆ·å­˜å‚¨çš„æ—¥å¿—å›ºå®šåœ¨ä¸€å¼ è¡¨ã€‚ç»“æ„å¦‚ä¸‹ï¼š 12345CREATE TABLE `mark`.`user_log_&#123;NUM&#125;` ( `u_id` int NOT NULL COMMENT &#x27;ç”¨æˆ·ID&#x27;, `content` longtext NOT NULL COMMENT &#x27;æ—¥å¿—å†…å®¹&#x27;, `created_at` datetime NOT NULL COMMENT &#x27;åˆ›å»ºæ—¥æœŸ&#x27;); ä¸ºäº†çœäº‹ï¼Œåé¢{NUM}æ˜¯ä¸ªæ•°å­—å“ˆï¼Œæ¯ä¸ªç”¨æˆ·è¿›æ¥æˆ‘ä»¬ä¼šåˆ©ç”¨æ‘˜è¦ç®—æ³•ï¼ˆæ¯”å¦‚ï¼šcrc32ï¼‰å–ä¸ªå›ºå®šæ•°å€¼ï¼Œç„¶åå›ºå®šæŠŠå¯¹åº”çš„æ•°æ®å­˜å‚¨åˆ°ç›¸åº”çš„è¡¨å†…ã€‚ ä¼˜ç‚¹ ä¸ä¼šå‡ºç°è·¨åº“æ— æ³•è¿è¡¨æŸ¥è¯¢çš„æƒ…å†µã€‚ äº‹åŠ¡å¤„ç†ç›¸å¯¹ç®€å•ã€‚ å¾ˆéš¾å‡ºç°æ‰©å±•æ€§å—é™çš„é—®é¢˜ã€‚ ç¼ºç‚¹ æ•°æ®åˆ†å¸ƒä¸å¹³å‡ï¼Œå¯èƒ½ä¸€å¼ è¡¨10Wè¡Œï¼Œå¦å¤–ä¸€å¼ 100Wè¡Œã€‚ éš¾ç»´æŠ¤ï¼Œå®šä½é—®é¢˜éœ€è¦å‰ç½®ç®—æ³•æŸ¥è¯¢ã€‚ åæœŸæ•°æ®è¿ç§»æ¯”è¾ƒéº»çƒ¦ã€‚ 4.ä»€ä¹ˆæ˜¯åˆ†åŒºï¼ˆPartitionï¼‰ï¼Ÿåˆ†ç‰‡ç®€å•è¯´äº†è¯´ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¦å­¦ä¹ ä¸€ä¸‹åˆ†åŒºã€‚åˆ†åŒºå’Œåˆ†ç‰‡æ¯”è¾ƒæ˜æ˜¾çš„ä¸€ç‚¹æ˜¯ï¼šåˆ†ç‰‡å¤šæ˜¯åˆ©ç”¨ç¨‹åºé…åˆæ¥å®ç°ï¼Œåˆ†åŒºåˆ™æ˜¯æ•°æ®åº“ï¼ˆä¸ä»…ä»…æ˜¯Mysqlï¼Œå…¶å®ƒæ•°æ®åº“ä¹Ÿæœ‰ï¼‰æä¾›çš„æœºåˆ¶ã€‚ é¦–å…ˆï¼Œåˆ†åŒºåˆ†ä¸º4ç§æ¨¡å¼ï¼š Range List Hash Key 5.RangeRangeï¼ˆèŒƒå›´ï¼‰å¤§æ¦‚çš„æ€æƒ³æ˜¯å°†æ•°æ®è¿›è¡Œåˆ†æ®µï¼Œæ¯”å¦‚æŒ‰ç…§æ—¥æœŸå°†å†…è´­è¡¨è¿›è¡Œæ‹†åˆ†ï¼Œåˆ†ä¸ºä¸åŒçš„å¹´ä»½ã€‚ 1234567891011CREATE TABLE purchase (id INT, app_id INT, name VARCHAR(50), money NUMERIC(20,4),currency VARCHAR(10),created_at DATE)PARTITION BY RANGE( YEAR(created_at) ) ( PARTITION p0 VALUES LESS THAN (1990), PARTITION p1 VALUES LESS THAN (1995), PARTITION p2 VALUES LESS THAN (2000), PARTITION p3 VALUES LESS THAN (2005), PARTITION p4 VALUES LESS THAN (2010), PARTITION p5 VALUES LESS THAN (2015));# ä¹Ÿå¯ä»¥æŒ‰ç…§é‡‘é¢æ¥è¿›è¡Œåˆ†åŒºã€‚# PARTITION BY RANGE( money ) (); å†™å…¥ä»¥ä¸‹æ•°æ® 1234567891011INSERT INTO purchase(app_id,name,money,currency,created_at) VALUES(600001,&#x27;desk organiser&#x27;,6.0000,&#x27;CNY&#x27;,&#x27;2003-10-15&#x27;),(600001,&#x27;alarm clock&#x27;,12.0000,&#x27;CNY&#x27;,&#x27;1997-11-05&#x27;),(600002,&#x27;chair&#x27;,30.0000,&#x27;CNY&#x27;,&#x27;2009-03-10&#x27;),(600002,&#x27;bookcase&#x27;,68.0000,&#x27;CNY&#x27;,&#x27;1989-01-10&#x27;),(600002,&#x27;exercise bike&#x27;,128.0000,&#x27;CNY&#x27;,&#x27;2014-05-09&#x27;),(600003,&#x27;sofa&#x27;,258.0000,&#x27;CNY&#x27;,&#x27;1987-06-05&#x27;),(600003,&#x27;espresso maker&#x27;,648.0000,&#x27;CNY&#x27;,&#x27;2011-11-22&#x27;),(600004,&#x27;aquarium&#x27;,99.0000,&#x27;USD&#x27;,&#x27;1992-08-04&#x27;),(600005,&#x27;study desk&#x27;,129.0000,&#x27;USD&#x27;,&#x27;2006-09-16&#x27;),(600006,&#x27;lava lamp&#x27;,299.0000,&#x27;USD&#x27;,&#x27;1998-12-25&#x27;); ç„¶åæˆ‘ä»¬è§‚å¯Ÿä¸€ä¸‹ï¼Œå¯èƒ½é€šè¿‡è‚‰çœ¼çœ‹æ²¡ä»€ä¹ˆå˜åŒ–ï¼Œæ‰§è¡Œè¿™æ¡æŸ¥çœ‹åˆ†åŒºçŠ¶æ€çš„SQL 1234567891011121314151617SELECT partition_name part, partition_expression expr, table_rows FROM information_schema.PARTITIONS WHERE table_schema = SCHEMA () AND table_name = &#x27;&#123;TABLE&#125;&#x27;;# ç»“æœå¦‚ä¸‹part | expr | descr | table_rowsp0 | YEAR(created_at) | 1990 | 2p1 | YEAR(created_at) | 1995 | 1p2 | YEAR(created_at) | 2000 | 2p3 | YEAR(created_at) | 2005 | 1p4 | YEAR(created_at) | 2010 | 2p5 | YEAR(created_at) | 2015 | 2 å¾ˆæ˜æ˜¾ï¼Œæ•°æ®åˆ†åˆ«æŒ‰ç…§è§„åˆ™å†™è¿›äº†åˆ†åŒºè¡¨p0 ~ p5ã€‚ 6.ListListï¼ˆåˆ—è¡¨ï¼‰æ¨¡å¼ï¼Œå¤šç”¨äºå¯¹äºæŒ‡å®šå­—æ®µçš„æ•°å€¼è¿›è¡Œæ˜ç¡®çš„æ•°æ®æ‹†åˆ†ã€‚ 123456789CREATE TABLE purchase (id INT, app_id INT, name VARCHAR(50), money NUMERIC(20,4),currency VARCHAR(10),created_at DATE)PARTITION BY LIST( app_id ) ( PARTITION p0 VALUES IN (600001), PARTITION p1 VALUES IN (600002), PARTITION p2 VALUES IN (600003), PARTITION p3 VALUES IN (600004), PARTITION p4 VALUES IN (600005), PARTITION p5 VALUES IN (600006)); å†™å…¥åŒæ ·çš„æ•°æ®ï¼Œä¹‹åæ‰§è¡ŒæŸ¥çœ‹åˆ†åŒºçŠ¶æ€çš„SQLã€‚ 1234567part | expr | descr | table_rowsp0 | app_id | 600001 | 2p1 | app_id | 600002 | 3p2 | app_id | 600003 | 2p3 | app_id | 600004 | 1p4 | app_id | 600005 | 1p5 | app_id | 600006 | 1 7.HashHashï¼ˆå“ˆå¸Œï¼‰æ¨¡å¼é€šè¿‡å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µè¿›è¡ŒHashè®¡ç®—ï¼Œé€šè¿‡è¿™ä¸ªHashå€¼æ¥è¿›è¡Œåˆ†åŒºï¼ˆæ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆåƒåˆ†ç‰‡ï¼Œå…¶å®åˆ†ç‰‡çš„æ€æƒ³å°±æ˜¯æ ¹æ®åˆ†åŒºè¡ç”Ÿè€Œæ¥ï¼‰ã€‚ 123CREATE TABLE purchase (id INT, app_id INT, name VARCHAR(50), money NUMERIC(20,4),currency VARCHAR(10),created_at DATE)PARTITION BY HASH( YEAR(created_at) )PARTITIONS 4; # ä¸ºäº†åŒºåˆ«ï¼Œè®¾4ä¸ªåˆ†åŒºã€‚ ç„¶åå†™å…¥åŒæ ·çš„æ•°æ®ï¼Œä¹‹åæ‰§è¡ŒæŸ¥çœ‹åˆ†åŒºçŠ¶æ€çš„SQLã€‚ 12345part| expr | descr | table_rowsp0 | YEAR(created_at) | NULL | 1p1 | YEAR(created_at) | NULL | 3p2 | YEAR(created_at) | NULL | 3p3 | YEAR(created_at) | NULL | 3 8.KeyKeyï¼ˆé”®ï¼‰æ¨¡å¼å’ŒHashæ¨¡å¼æå…¶ç›¸ä¼¼ï¼Œå¯èƒ½æœ‰ä¸€ç‚¹åŒºåˆ«å°±æ˜¯ï¼ŒHashæ¨¡å¼ä¸‹æ˜¯ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™è¿›è¡ŒHashè®¡ç®—ï¼Œè€ŒKeyæ¨¡å¼æ˜¯Mysqlä½¿ç”¨è‡ªå·±çš„å‡½æ•°è¿›è¡ŒHashè®¡ç®—ã€‚ 123CREATE TABLE purchase (id INT, app_id INT, name VARCHAR(50), money NUMERIC(20,4),currency VARCHAR(10),created_at DATE)PARTITION BY KEY( created_at )PARTITIONS 3; # ä¸ºäº†åŒºåˆ«ï¼Œè®¾3ä¸ªåˆ†åŒºã€‚ é‡å¤æ­¥éª¤ï¼Œå†™å…¥åŒæ ·çš„æ•°æ®ï¼Œä¹‹åæ‰§è¡ŒæŸ¥çœ‹åˆ†åŒºçŠ¶æ€çš„SQLã€‚ 1234part| expr | descr | table_rowsp0 | `created_at` | NULL | 2p1 | `created_at` | NULL | 3p2 | `created_at` | NULL | 5 Keyæ¨¡å¼å’ŒHashæ¨¡å¼åœ¨exprä¸Šé¢æœ‰äº†ç›´è§‚çš„ä¸åŒè¡¨ç°ï¼ŒHashæ¨¡å¼æ˜¯ï¼šYEAR(created_at)ï¼Œè€ŒKeyæ¨¡å¼æ˜¯ï¼šcreated_atã€‚è¿™å°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„Hashè®¡ç®—æ–¹å¼çš„åŒºåˆ«ã€‚ 9.æœ€åå…¶å®Mysqlåˆ†åŒºè¿˜æœ‰ç¬¬5ç§æ¨¡å¼ï¼Œå«åšCompositeï¼ˆå¤åˆï¼‰æ¨¡å¼ï¼Œæ¯”å¦‚ï¼šRange - Key 123456789101112CREATE TABLE purchase (id INT, app_id INT, name VARCHAR(50), money NUMERIC(20,4),currency VARCHAR(10),created_at DATE)PARTITION BY RANGE( YEAR( created_at ) ) SUBPARTITION BY KEY( created_at )SUBPARTITIONS 3( PARTITION p0 VALUES LESS THAN (1990), PARTITION p1 VALUES LESS THAN (1995), PARTITION p2 VALUES LESS THAN (2000), PARTITION p3 VALUES LESS THAN (2005), PARTITION p4 VALUES LESS THAN (2010), PARTITION p5 VALUES LESS THAN (2015)); è¿™é‡Œå°±ä¸å±•å¼€Compositeï¼ˆå¤åˆï¼‰æ¨¡å¼çš„å­¦ä¹ äº†ï¼Œæœ€åé€šè¿‡ä»¥ä¸Šçš„ä¾‹å­ï¼Œå¯ä»¥çœ‹å‡ºåˆ†åŒºä¹Ÿæ˜¯æœ‰å‚ç›´åˆ†åŒºå’Œæ°´å¹³åˆ†åŒºçš„è¯´æ³•çš„ã€‚ https://dev.mysql.com/doc/mysql-partitioning-excerpt/5.7/en/partitioning-management.html","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - åˆ·è„æœºåˆ¶","date":"2020-03-20T16:00:00.000Z","path":"2020/03/21/mysql-checkpoint/","text":"ä¹‹å‰å­¦ä¹ äº†LRUç®—æ³•å’ŒMysqlç¼“å†²æ± ä½¿ç”¨çš„LRUå˜ä½“ç®—æ³•ï¼Œå…¶ä¸­æœ‰ä¸ªå…±åŒç‚¹å°±æ˜¯å½“LRUé“¾è¡¨å†™æ»¡ä»¥åå¦‚æœå†æœ‰æ–°æ•°æ®è¿›æ¥ä¼šæ·˜æ±°å°¾éƒ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆMysqlæ·˜æ±°è¿™äº›å°¾éƒ¨æ•°æ®çš„æ—¶å€™æ˜¯å¦ä¼šè¿›è¡Œä»€ä¹ˆæ“ä½œå‘¢ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬åœ¨æœ€åæåˆ°äº†ä¸€ä¸ªå‚æ•°Modified db pagesï¼Œå³è„é¡µã€‚ 1.ä»€ä¹ˆæ˜¯è„é¡µï¼Ÿ è„é¡µï¼Œè¿™ä¸ªåè¯å¾ˆæŠ½è±¡ä»å­—é¢æ„æ€å»çœ‹å¯èƒ½å¾ˆä¸è§£ï¼Œè„é¡µæ˜¯å½“å†…å­˜ä¸­çš„æ•°æ®é¡µå’Œç£ç›˜ä¸­çš„æ•°æ®é¡µå†…å®¹ä¸ä¸€è‡´æ—¶ï¼Œè¿™ä¸ªæ•°æ®é¡µç§°ä¹‹ä¸ºè„é¡µã€‚å› ä¸ºä»æ“ä½œç³»ç»Ÿçš„è§’åº¦æ¥è®²ï¼Œè‡ªå·±è¯»å…¥çš„æ•°æ®è¢«å¤–éƒ¨æ‰€ä¿®æ”¹ç­‰äºè¢«æ±¡æŸ“ï¼Œæ‰€ä»¥å«è„é¡µã€‚ å½“å†…å­˜ä¸­çš„æ•°æ®é¡µå’Œç£ç›˜ä¸­çš„æ•°æ®é¡µæ•°æ®ä¸€è‡´ï¼Œå«å¹²å‡€é¡µã€‚ 2.è„é¡µä»€ä¹ˆæ—¶å€™ä¼šåˆ·æ–°ï¼Ÿ ç¼“å†²æ± ï¼ˆbuffer poolï¼‰ç©ºé—´ä¸è¶³ï¼Œä¹Ÿå°±æ˜¯LRUé“¾è¡¨å†™æ»¡æ—¶ï¼Œæ–°æ•°æ®è¿›æ¥æ—¶æ·˜æ±°æ‰çš„å°¾éƒ¨æ•°æ®è„é¡µã€‚ redo logä¸å¯ç”¨æ—¶ï¼Œéœ€è¦å¼ºåˆ¶å°†è„é¡µåˆ—è¡¨ä¸­çš„ä¸€äº›æ•°æ®é¡µåˆ·å…¥ç£ç›˜ã€‚ Mysqlåœ¨æœåŠ¡å™¨è´Ÿè½½è¾ƒå°æ—¶ï¼Œä¼šä¸»åŠ¨è¿›è¡Œåˆ·è„æ“ä½œã€‚ MysqlæœåŠ¡æ­£å¸¸å…³é—­ï¼Œä¼šåˆ·æ–°æ‰€æœ‰è„é¡µã€‚ 3.ä»€ä¹ˆæ˜¯redo logï¼ŸInnoDBä¸­ä¸¤å—éå¸¸é‡è¦çš„æ—¥å¿—ï¼Œä¸€ä¸ªæ˜¯undo logï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦å­¦ä¹ çš„redo logã€‚å‰è€…ç”¨æ¥ä¿è¯äº‹åŠ¡çš„åŸå­æ€§ä»¥åŠInnoDBçš„MVCCï¼ˆMutil-Version Concurrency Controlï¼‰ï¼Œåè€…ç”¨æ¥ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚ é‚£ä¹ˆä»€ä¹ˆæ—¶å€™å†™redo logå‘¢ï¼Ÿå½“æ•°æ®åº“å¯¹æ•°æ®åšä¿®æ”¹çš„æ—¶å€™ï¼Œéœ€è¦æŠŠæ•°æ®é¡µä»ç£ç›˜è¯»åˆ°ç¼“å†²æ± ä¸­ï¼Œç„¶ååœ¨ç¼“å†²æ± ä¸­è¿›è¡Œä¿®æ”¹ã€‚ä½†æ˜¯InnoDBé‡‡ç”¨çš„æ˜¯WALï¼ˆWrite Ahead Logï¼‰ç­–ç•¥æ¥é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡æäº¤æ—¶ï¼Œå…ˆå†™redo logæ‰ä¼šå†å»ä¿®æ”¹å†…å­˜æ•°æ®é¡µã€‚ redo logçš„æ–‡ä»¶åé»˜è®¤ä»¥ib_logfile{NUM}ï¼Œå­˜å‚¨åœ¨my.cnfä¸­datadirç›®å½•ä¸‹é¢ï¼Œå—ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°æ§åˆ¶ innodb_log_file_sizeï¼Œæ—¥å¿—å¤§å° innodb_log_files_in_groupï¼Œæ—¥å¿—ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯2ä¸ªã€‚ æ‰€ä»¥redo logçš„å¤§å°ç­‰äºinnodb_log_files_in_group*innodb_log_file_sizeã€‚ æ—¢ç„¶redo logä¼šäº§ç”Ÿï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šè¢«è¦†ç›–å‘¢ï¼Ÿredo logè¢«è®¾è®¡æˆå¯å¾ªç¯ä½¿ç”¨ï¼Œå½“æ—¥å¿—æ–‡ä»¶å†™æ»¡æ—¶é‚£äº›å·²ç»è¢«åˆ·å…¥ç£ç›˜ä¸­çš„æ•°æ®å°±å¯ä»¥è¢«è¦†ç›–å•¦ã€‚ WALï¼ˆWrite Ahead Logï¼‰ï¼Œæ˜¯å…³ç³»æ•°æ®åº“ç³»ç»Ÿä¸­ç”¨äºæä¾›åŸå­æ€§å’ŒæŒä¹…æ€§ï¼ˆACIDå±æ€§ä¸­çš„ä¸¤ä¸ªï¼‰çš„ä¸€ç³»åˆ—æŠ€æœ¯ï¼ŒARIESæ˜¯WALç³»åˆ—æŠ€æœ¯å¸¸ç”¨çš„ç®—æ³•ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­WALé€šå¸¸ç§°ä¸ºjournalingã€‚WALçš„ä¸»è¦æ€æƒ³æ˜¯å°†å…ƒæ•°æ®çš„å®æ—¶å˜æ›´æ“ä½œå†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨ç³»ç»Ÿè´Ÿè½½è¾ƒå°æ—¶å†æŠŠæ—¥å¿—åˆ·å…¥ç£ç›˜ã€‚ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘ç£ç›˜çš„IOæ“ä½œï¼Œæ­¤å¤„å°±ä¸å±•å¼€å­¦ä¹ äº†ã€‚å…ˆMarkä¸€ä¸‹ 4.CheckpointCheckpointï¼ˆæ£€æŸ¥ç‚¹ï¼‰ï¼Œåœ¨æ•°æ®åº“ä¸­ä¸€èˆ¬æ˜¯ç”¨æ¥æŠŠredo logè„é¡µåˆ·å…¥ç£ç›˜çš„ä¸€ä¸ªæ“ä½œï¼Œé€šè¿‡LSNä¿å­˜è®°å½•ï¼Œä½œç”¨æ˜¯å½“å‘ç”Ÿå®•æœºç­‰crashæƒ…å†µæ—¶ï¼Œå†æ¬¡å¯åŠ¨æ—¶ä¼šæŸ¥è¯¢Checkpointï¼Œåœ¨è¯¥Checkpointä¹‹åå‘ç”Ÿçš„äº‹åŠ¡ä¿®æ”¹æ¢å¤åˆ°ç£ç›˜ã€‚é€šä¿—æ¥è§£é‡Šï¼Œå°±åƒæˆ‘ä»¬ç©ä¸€äº›æ¸¸æˆæ¯è¿‡ä¸ä¹…å°±ä¼šå­˜ä¸€æ¬¡æ¡£ï¼Œç„¶åå¦‚æœæ¸¸æˆå®¢æˆ·ç«¯ä¸å¹¸crashé‡æ–°è¿›å…¥æœ€è¿‘çš„ä¸€æ¬¡å­˜æ¡£å³å¯ï¼ŒåŒç†ã€‚ Checkpointå­˜åœ¨çš„ç›®çš„ï¼š ç¼©çŸ­æ¢å¤æ•°æ®æ—¶é—´ã€‚ ç¼“å†²æ± å†™æ»¡æ—¶ï¼Œæ·˜æ±°è„é¡µåˆ·å…¥ç£ç›˜ã€‚ redo logå†™æ»¡æ—¶ï¼Œè¿›è¡Œåˆ·è„æ“ä½œã€‚ é‚£ä¹ˆæ€ä¹ˆæŸ¥çœ‹æˆ‘ä»¬çš„æ£€æŸ¥ç‚¹å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤show engine innodb statusæ¥æŸ¥çœ‹ï¼š 12345678910111213&gt;show engine innodb status\\G;---LOG---Log sequence number 1597945Log flushed up to 1597945Last Checkpoint at 1597945Max Checkpoint age 7782360Checkpoint age target 7539162Modified age 0Checkpoint age 00 pending log writes, 0 pending chkp writes8 log i/o&#x27;s done, 0.42 log i/o&#x27;s/second 12345Log sequence number | å½“å‰ç³»ç»ŸLSNæœ€å¤§å€¼ï¼Œæ–°çš„æ—¥å¿—LSNå°†åœ¨æ­¤åŸºç¡€ä¸Šç”Ÿæˆï¼ˆLSN+æ–°æ—¥å¿—çš„å¤§å°ï¼‰ã€‚Log flushed up to | å½“å‰å·²ç»å†™å…¥æ—¥å¿—æ–‡ä»¶çš„LSNã€‚Last Checkpoint at | å½“å‰å·²ç»å†™å…¥Checkpointçš„LSNã€‚Max Checkpoint age | Perconaçš„XtraDBå‚æ•°ï¼Œæ­¤å¤„ä¸è¿‡å¤šè§£é‡Šã€‚Checkpoint age target | åŒä¸Šã€‚ LSNï¼ˆLog Sequence Numberï¼‰ï¼ŒLSNæ˜¯æ—¥å¿—ç©ºé—´ä¸­æ¯æ¡æ—¥å¿—çš„ç»“æŸç‚¹ï¼Œç”¨å­—èŠ‚åç§»é‡æ¥è¡¨ç¤ºã€‚æ¯ä¸ªæ•°æ®é¡µæœ‰LSNï¼Œredo logä¹Ÿæœ‰LSNï¼ŒCheckpointäº¦æœ‰LSNã€‚è¯¥LSNè®°å½•å½“å‰æ•°æ®é¡µæœ€åä¸€æ¬¡ä¿®æ”¹çš„LSNå·ï¼Œç”¨äºåœ¨æ¢å¤æ•°æ®æ—¶å¯¹æ¯”é‡åšæ—¥å¿—LSNå·å†³å®šæ˜¯å¦å¯¹è¯¥æ•°æ®é¡µè¿›è¡Œæ¢å¤æ•°æ®ã€‚å¯ä»¥é€šä¿—ç†è§£ä¸ºï¼Œå­˜æ¡£ç¼–å·ã€‚ 5.Checkpointä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘ï¼ŸInnoDBå­˜å‚¨å¼•æ“æœ‰ä¸¤ç§Checkpointï¼Œåˆ†åˆ«æ˜¯ï¼š Sharp Checkpoint Fuzzy Checkpoint Sharp Checkpointå‘ç”Ÿåœ¨æ•°æ®åº“æœåŠ¡å…³é—­æ—¶ï¼Œå°†æ‰€æœ‰è„é¡µåˆ·å…¥ç£ç›˜ï¼Œæ­¤æ—¶innodb_fast_shutdownå‚æ•°çš„å€¼ä¸º1ï¼ˆinnodb_fast_shutdownå‚æ•°çš„å€¼ï¼š0ã€1ã€2ï¼‰ï¼Œè¿™æ˜¯é»˜è®¤æœºåˆ¶ã€‚ä½†æ˜¯è€ƒè™‘åˆ°å¦‚æœæ•°æ®åº“åœ¨ä½¿ç”¨æ—¶ä¹Ÿæ‰§è¡Œè¿™ç§æœºåˆ¶ï¼Œæ•°æ®åº“çš„æ€§èƒ½ä¼šå—åˆ°å½±å“ï¼Œæ‰€ä»¥Fuzzy Checkpointåˆ·æ–°éƒ¨åˆ†è„é¡µçš„è¿™ç§æœºåˆ¶äº§ç”Ÿäº†ã€‚ Fuzzy Checkpointåˆ·æ–°éƒ¨åˆ†è„é¡µï¼Œä¹Ÿåˆ†ä¸ºä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š Master Thread Checkpoint FLUSH_LRU_LIST Checkpoint Dirty Page too much Checkpoint Async&#x2F;Sync Flush Checkpoint Master Thread Checkpoint ä¸»çº¿ç¨‹ä»¥æ¯ç§’æˆ–è€…æ¯åç§’ä»ç¼“å†²æ± çš„è„é¡µåˆ—è¡¨ï¼ˆFlush Listï¼‰åˆ·æ–°ä¸€å®šæ¯”ä¾‹çš„æ•°æ®é¡µå›ç£ç›˜ï¼Œè¿™ä¸ªæ“ä½œè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ä¸ä¼šé˜»å¡çº¿ç¨‹ã€‚ FLUSH_LRU_LIST Checkpoint InnoDBéœ€è¦ä¿è¯LRUé“¾è¡¨ä¸­æœ‰è¶³å¤Ÿç©ºé—²é¡µå¯ä»¥ä½¿ç”¨ï¼Œåœ¨InnoDB1.1.xç‰ˆæœ¬å‰ï¼Œå¦‚æœLRUé“¾è¡¨å†™æ»¡æœ‰æ–°çš„æ•°æ®è¿›æ¥å¦‚æœæ·˜æ±°å°¾éƒ¨è„é¡µï¼Œä¼šè§¦å‘Checkpointæœºåˆ¶å¼ºåˆ¶è¿›è¡Œåˆ·è„æ“ä½œã€‚è¯¥æ“ä½œæ˜¯é˜»å¡çº¿ç¨‹çš„ï¼Œæ‰€ä»¥åœ¨InnoDB1.2.xç‰ˆæœ¬å¼€å§‹ï¼Œè¿™ä¸ªæ“ä½œæ”¾åˆ°Page Cleaner Threadæ¥å¤„ç†ï¼Œæ¯æ¬¡åˆ·æ–°LRUé“¾è¡¨è„é¡µçš„æ•°é‡å—innodb_lru_scan_depthå‚æ•°æ§åˆ¶ï¼ˆé»˜è®¤ï¼š1024ï¼‰ã€‚ Dirty Page too much Checkpoint å½“LRUé“¾è¡¨ä¸­è„é¡µæ•°é‡è¿‡å¤šæ—¶ï¼ˆæ¯”ä¾‹ï¼‰ï¼ŒInnoDBä¸ºäº†ä¿è¯ç¼“å†²æ± ä¸­æœ‰è¶³å¤Ÿå¤šçš„ç©ºé—²é¡µå¯ä»¥ä½¿ç”¨ï¼Œä¼šå¼ºåˆ¶è§¦å‘Checkpointæœºåˆ¶è¿›è¡Œåˆ·è„æ“ä½œã€‚æ­¤å€¼å—innodb_max_dirty_pages_pctå‚æ•°æ§åˆ¶ï¼ˆé»˜è®¤ï¼š75%ï¼‰ã€‚ Async&#x2F;Sync Flush Checkpoint ä¸ºäº†ä¿è¯redo logå¾ªç¯ä½¿ç”¨çš„å¯é‡ç”¨æ€§ï¼Œåœ¨redo logä¸å¯ç”¨æ—¶ä¼šå¼ºåˆ¶è§¦å‘Checkpointåˆ·è„æ“ä½œã€‚åœ¨InnoDB1.2.xç‰ˆæœ¬ä»¥å‰ï¼ŒAsync Flush Checkpointä¼šé˜»å¡å½“å‰æŸ¥è¯¢çº¿ç¨‹ï¼ŒSync Flush Checkpointä¼šé˜»å¡æ‰€æœ‰æŸ¥è¯¢çº¿ç¨‹ã€‚InnoDB1.2.Xä¹‹åæ”¾åˆ°å•ç‹¬çš„Page Cleaner Threadæ¥å¤„ç†ã€‚ 6.æœ€åå…³äºAsync&#x2F;Sync Flush Checkpointåˆ·è„æ–¹å¼çš„åŸç†æœ‰äº›å¤æ‚ï¼Œè¿™é‡Œå…ˆMarkä¸€ä¸‹ï¼Œæš‚æ—¶ä¸å±•å¼€å­¦ä¹ äº†ã€‚ å‰é¢è¯´åˆ°çš„Percona XtraDB https://www.percona.com/doc/percona-server/8.0/scalability/innodb_io.html","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - LRUç®—æ³•","date":"2020-03-17T16:00:00.000Z","path":"2020/03/18/mysql-lru/","text":"1.ä»€ä¹ˆæ˜¯LRUï¼ŸLRUï¼ˆLeast recently usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•æ ¹æ®æ•°æ®çš„å†å²è®¿é—®è®°å½•æ¥è¿›è¡Œæ·˜æ±°æ•°æ®ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯â€œæœ€è¿‘ä½¿ç”¨çš„é¡µé¢æ•°æ®ä¼šåœ¨æœªæ¥ä¸€æ®µæ—¶æœŸå†…ä»ç„¶è¢«ä½¿ç”¨,å·²ç»å¾ˆä¹…æ²¡æœ‰ä½¿ç”¨çš„é¡µé¢å¾ˆæœ‰å¯èƒ½åœ¨æœªæ¥è¾ƒé•¿çš„ä¸€æ®µæ—¶é—´å†…ä»ç„¶ä¸ä¼šè¢«ä½¿ç”¨â€ã€‚ 2.LRUçš„å®ç°LRUç®—æ³•æœ€å¸¸è§çš„å®ç°æ˜¯ä½¿ç”¨é“¾è¡¨æ¥ä¿å­˜æ•°æ®ï¼Œè¯¥é“¾è¡¨æ˜¯åŒå‘é“¾è¡¨ï¼Œç„¶ååˆ©ç”¨å…ˆè¿›å…ˆå‡ºçš„ç‰¹æ€§ï¼Œæœ€æ–°å†™å…¥çš„æ•°æ®ä¼šæœ€å¿«è¢«è·å–ã€‚ è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œç¼“å­˜æ•°æ®åˆ™ä¼šå†™å…¥é“¾è¡¨çš„å¤´éƒ¨ï¼Œé“¾è¡¨å†™æ»¡æ—¶ä¼šæ·˜æ±°æ‰å°¾éƒ¨çš„ç¼“å­˜æ•°æ®ã€‚ å½“ç¼“å­˜æ•°æ®è¢«è®¿é—®æ—¶ï¼Œåˆ™å°†è¯¥ç¼“å­˜æ•°æ®å‘é“¾è¡¨å¤´éƒ¨ç§»åŠ¨ã€‚ ä¼˜ç‚¹ï¼šé¢å¯¹é¢‘ç¹è®¿é—®çš„çƒ­ç‚¹æ•°æ®ï¼ŒæŸ¥è¯¢æ•ˆç‡é«˜ ç¼ºç‚¹ï¼šå¦‚æœä¸€æ¬¡æŸ¥è¯¢æ‰«æå…¨è¡¨ï¼Œé‚£ä¹ˆLRUåˆ—è¡¨ä¼šè¢«æ±¡æŸ“ 3.Mysql LRUç®—æ³•æœ‰ä½•ä¸åŒï¼ŸMysqlï¼ˆInnoDBï¼‰çš„ç¼“å†²æ± ï¼ˆbuffer poolï¼‰ä½¿ç”¨äº†LRUç®—æ³•çš„å˜ä½“ï¼Œå°†é“¾è¡¨åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šyoungã€midpointã€oldã€‚é“¾è¡¨æ¯”ä¾‹(5ã€3)åˆ†é…ç»™youngã€oldã€‚å…¶ä¸­youngå æ®5&#x2F;8ï¼Œoldå æ®3&#x2F;8ï¼Œæ­¤æ¯”ä¾‹å—å‚æ•°innodb_old_blocks_pctæ§åˆ¶ã€‚ youngæ˜¯é“¾è¡¨ä¸­æœ€è¿‘è®¿é—®è¿‡çš„æ–°å­è¡¨ã€‚ oldæ˜¯é“¾è¡¨ä¸­æœ€è¿‘è®¿é—®çš„æ—§å­è¡¨ã€‚ midpointæ˜¯ä»‹äºæ–°å­è¡¨ &amp; æ—§å­è¡¨çš„è¾¹ç•Œä¸­é—´ä½ç½®ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºæ—§å­è¡¨çš„å¤´éƒ¨ï¼‰ã€‚ æ•°æ®åº“åˆšå¯åŠ¨LRUé“¾è¡¨ä¸ºç©ºæ—¶ï¼Œæ­¤æ—¶ä¼šæ£€æŸ¥Free Listä¸­æ˜¯å¦æœ‰ç©ºé—²çš„æ•°æ®é¡µï¼Œå¦‚æœæœ‰åˆ™ä»Free Listä¸­åˆ é™¤å¹¶ä¸”åœ¨LRUé“¾è¡¨ä¸­å†™å…¥ç›¸åŒçš„æ•°æ®é¡µã€‚ è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®é¡µæ—¶ï¼Œæ•°æ®é¡µä¸ä¼šç›´æ¥å†™å…¥é“¾è¡¨çš„å¤´éƒ¨ï¼Œè€Œæ˜¯å†™å…¥ä¸­é—´ä½ç½®ï¼Œå¦‚æœé“¾è¡¨æ»¡äº†åˆ™ä¼šä»æ—§å­è¡¨å°¾éƒ¨æ·˜æ±°æ•°æ®é¡µã€‚ å½“æ•°æ®é¡µè¢«è®¿é—®æ—¶ï¼Œåˆ™åˆ¤æ–­è®¿é—®æ•°æ®é¡µçš„æ—¶é—´æ˜¯å¦å¤§äºè®¾å®šinnodb_old_blocks_timeï¼ˆé»˜è®¤ï¼š1000msï¼‰ï¼Œå¦‚æœå¤§äºåˆ™å‘é“¾è¡¨å¤´éƒ¨ç§»åŠ¨ï¼Œå¦‚æœå°äºå…¶ä½ç½®ä¸å˜ã€‚ æ”¹è¿›ä¼˜ç‚¹ï¼šèƒ½å¤Ÿé˜²æ­¢å•æ¬¡å¤§é‡çš„å…¨è¡¨æ‰«ææ±¡æŸ“æ•´ä¸ªLRUé“¾è¡¨ã€‚ 4.Mysql LRUç›¸å…³æŸ¥è¯¢å‘½ä»¤123456789101112131415161718192021222324252627282930&gt;show engine innodb status\\G;----------------------BUFFER POOL AND MEMORY----------------------Total memory allocated 137756672; in additional pool allocated 0Total memory allocated by read views 88Internal hash tables (constant factor + variable factor) Adaptive hash index 2217584 (2213368 + 4216) Page hash 139112 (buffer pool 0 only) Dictionary cache 593780 (554768 + 39012) File system 83536 (82672 + 864) Lock system 333248 (332872 + 376) Recovery system 0 (0 + 0)Dictionary memory allocated 39012Buffer pool size 8191Buffer pool size, bytes 134201344Free buffers 8048Database pages 143Old database pages 0Modified db pages 0Pending reads 0Pending writes: LRU 0, flush list 0, single page 0Pages made young 0, not young 00.00 youngs/s, 0.00 non-youngs/sPages read 143, created 0, written 00.00 reads/s, 0.00 creates/s, 0.00 writes/sNo buffer pool page gets since the last printoutPages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/sLRU len: 143, unzip_LRU len: 0I/O sum[0]:cur[0], unzip sum[0]:cur[0] 123456Buffer pool size | innodb_buffer_poolçš„å¤§å°Free buffers | å½“å‰Free Listä¸­æ•°æ®é¡µæ•°é‡Database pages | LRUé“¾è¡¨ä¸­æ•°æ®é¡µæ•°é‡Old database pages | LRUé“¾è¡¨ä¸­æ—§å­è¡¨æ•°æ®é¡µæ•°é‡Modified db pages | LRUé“¾è¡¨ä¸­è„é¡µæ•°é‡Pages made young 0, not young 0 | æ•°æ®é¡µä»oldç§»è‡³youngçš„è¡Œä¸ºï¼špage made young,æ•°æ®é¡µå› ä¸ºinnodb_old_blocks_timeå¯¼è‡´æ²¡æœ‰ä»oldç§»è‡³youngçš„è¡Œä¸ºï¼špage not youngã€‚åé¢çš„æ•°å€¼æ˜¯è¯¥è¡Œä¸ºå‘ç”Ÿçš„æ¬¡æ•°ã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - Inté•¿åº¦çš„é—®é¢˜","date":"2020-03-15T11:30:00.000Z","path":"2020/03/15/mysql-int-length/","text":"åˆ›å»ºæ•°æ®è¡¨çš„æ—¶å€™æˆ‘ä»¬æ€»æ˜¯è¦è€ƒè™‘å­˜å‚¨æ•°æ®çš„å­—æ®µè¯¥ç”¨å“ªç§ç±»å‹ã€å¤šå°‘é•¿åº¦æ¯”è¾ƒåˆé€‚ï¼Œä¸è¿‡åœ¨Mysqlä¸­å¦‚æœå­—æ®µç±»å‹æ˜¯Intï¼Œæ­¤æ—¶é•¿åº¦æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚ 1.Intç±»å‹çš„é•¿åº¦é—®é¢˜12345CREATE TABLE `test` ( `id` int(3) NOT NULL, `name` varchar(20) COLLATE utf8mb4_unicode_ci NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci æœ‰è¿™æ ·ä¸€å¼ è¡¨ï¼Œidæ˜¯Intç±»å‹é•¿åº¦3çš„å­—æ®µï¼Œé‚£ä¹ˆç†è®ºä¸Šæ˜¯ä¸èƒ½å­˜å‚¨é•¿åº¦è¶…è¿‡3çš„å€¼ï¼Œæ¯”å¦‚ï¼š 1INSERT INTO `test`(`id`, `name`) VALUES (1000000, &#x27;name&#x27;); ä¸è¿‡ç»“æœæ˜¯æ„å¤–çš„ï¼Œè¿™æ¡æ•°æ®å¯ä»¥æ­£å¸¸å†™å…¥ã€‚ 2.Intç±»å‹çš„é•¿åº¦ä¸ºä»€ä¹ˆä¸ç”Ÿæ•ˆç¿»äº†ä¸€ä¸‹Mysqlçš„æ•°æ®ç±»å‹æ–‡æ¡£ï¼Œå‘ç°è¿™ä¹ˆä¸€å¥è¯ï¼š å¯¹äºæ•´æ•°ç±»å‹ï¼ŒMè¡¨ç¤ºæœ€å¤§æ˜¾ç¤ºå®½åº¦ã€‚ å¯¹äºæµ®ç‚¹å’Œå®šç‚¹ç±»å‹ï¼ŒMæ˜¯å¯ä»¥å­˜å‚¨çš„æ€»ä½æ•°ï¼ˆç²¾åº¦ï¼‰ã€‚ å¯¹äºå­—ç¬¦ä¸²ç±»å‹ï¼ŒMæ˜¯æœ€å¤§é•¿åº¦ã€‚ Mçš„æœ€å¤§å…è®¸å€¼å–å†³äºæ•°æ®ç±»å‹ã€‚ æ‰€ä»¥è¿™ä¸ªIntç±»å‹çš„â€œé•¿åº¦â€å…¶å®å«å®½åº¦ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¾ç¤ºé•¿åº¦ã€‚ 3.å¦‚æœå­˜å‚¨çš„æ•°æ®é•¿åº¦ä½äºæ˜¾ç¤ºå®½åº¦ä¼šæ€æ ·ï¼Ÿ1INSERT INTO `test`(`id`, `name`) VALUES (1, &#x27;name&#x27;); å½“ç„¶æ˜¯å¯ä»¥å†™å…¥çš„ï¼Œä½†æ˜¯å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ä¸ä¸€æ ·ï¼Œä¸è¿‡æˆ‘ä»¬å†æ‰§è¡Œä¸€æ¡SQL 1ALTER TABLE `test` MODIFY COLUMN `id` int(3) UNSIGNED ZEROFILL; è¿™æ¬¡æ•°æ®äº§ç”Ÿå˜åŒ–äº†ï¼Œå˜æˆäº†è¿™æ · 123id | name001 | name1000000 | name 4.ä¸ºä»€ä¹ˆè¦è®¾è®¡æ˜¾ç¤ºå®½åº¦ï¼Ÿæˆ‘ä¹Ÿæ²¡æœ‰å¾—å‡ºæ˜ç¡®çš„ç­”æ¡ˆï¼Œå’Œå°ä¼™ä¼´è®¨è®ºè¿™ä¸ªé—®é¢˜~taè§‰å¾—æ˜¯ä¸ºäº†æ–¹ä¾¿æ’åºï¼Œä½ è§‰å¾—å‘¢ï¼Ÿ","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql int length","slug":"mysql-int-length","permalink":"http://xupin.im/tags/mysql-int-length/"}]},{"title":"Goå­¦ä¹ ç¬”è®° - å®šæ—¶ä»»åŠ¡è°ƒåº¦","date":"2020-01-18T16:00:00.000Z","path":"2020/01/19/go-console/","text":"æ¯ä¸€ä¸ªä»»åŠ¡éƒ½éœ€è¦ç¼–å†™ä¸€ä¸ªCrontabå‘½ä»¤ï¼Œè¿™æ˜¯ä»¶å¾ˆéº»çƒ¦ä¸”å¾ˆä¸å‹å¥½çš„äº‹æƒ…ã€‚ ä»»åŠ¡è°ƒåº¦å™¨å…è®¸ä½ ä»¥ä»£ç çš„å½¢å¼å®šä¹‰è°ƒåº¦å‘½ä»¤ï¼Œå¹¶ä¸”æœåŠ¡å™¨ä¸Šåªéœ€è¦ä¸€ä¸ªCrontabå‘½ä»¤å³å¯, ä»»åŠ¡è°ƒåº¦åˆæ˜¯æˆ‘ä»¬ä¿—ç§°çš„ â€œè®¡åˆ’ä»»åŠ¡â€ 1.å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨Githubä¸€ç•ªæœç´¢ï¼Œå‘ç°Golangæœ‰ä¸ªcronåŒ…ï¼ˆrobfig&#x2F;cronï¼‰å¤§æ¦‚æ»¡è¶³éœ€æ±‚ï¼Œäºæ˜¯å­¦ä¹ ä¸€ä¸‹ã€‚ 2.ä»‹ç»çœ‹äº†ä¸€éæ–‡æ¡£ï¼ŒcronåŒ…æ”¯æŒçš„å·²ç»å¾ˆå…¨é¢äº†~~~ä¸ç”¨è‡ªå·±é€ è½®å­äº†ã€‚ è¡¨è¾¾å¼ å…¼å®¹Linuxçš„crontabè¡¨è¾¾å¼ï¼ˆæ”¯æŒåˆ†é’Ÿçº§åˆ«ï¼‰ã€‚ æ—¥å¿— å¯ä»¥å¾ˆè¯¦ç»†çš„è®°å½•è°ƒåº¦çš„ä»»åŠ¡çŠ¶æ€ æ—¶åŒº æ”¯æŒä»»åŠ¡çº§åˆ«çš„æ—¶åŒºé…ç½® é¢„å®šä¹‰è®¡åˆ’ æ”¯æŒåœ¨æœªæ¥æŒ‡å®šçš„æ—¶é—´å»è¿è¡Œ çº¿ç¨‹å®‰å…¨é—®é¢˜ è¯¥cron libç®¡ç†ä»»åŠ¡é˜Ÿåˆ—çš„sliceæ²¡æœ‰åšå¹¶å‘å®‰å…¨è€ƒè™‘ï¼Œå¯èƒ½ä¼šå‡ºç°ä»»åŠ¡ç«ŸæŠ¢è¡Œä¸ºã€‚ 3.å®ä¾‹1234567891011121314151617181920212223242526package mainimport ( &quot;fmt&quot; &quot;time&quot; &quot;github.com/robfig/cron&quot;)func main() &#123; c := cron.New() c.AddFunc(&quot;* * * * * *&quot;, test) c.Start() timer := time.NewTimer(time.Second * 10) for &#123; select &#123; case &lt;-timer.C: timer.Reset(time.Second * 10) &#125; &#125;&#125;func test() &#123; fmt.Println(&quot;I&#x27;m a test script!&quot;)&#125; 12345$ go run .I&#x27;m a test script!!!I&#x27;m a test script!!!I&#x27;m a test script!!!... 4.ç®€å•å°è£… main.go123456789101112131415package mainimport &quot;cron-example/console&quot;func main() &#123; quitChan := make(chan bool, 1) // console go func() &#123; console.Default() &#125;() &lt;-quitChan&#125; console.go12345678910111213141516171819202122232425262728293031package consoleimport ( &quot;log&quot; &quot;time&quot; &quot;cron-example/console/commands&quot; &quot;github.com/robfig/cron&quot;)func schedule(c *cron.Cron) &#123; c.AddFunc(&quot;* * * * * *&quot;, commands.Test)&#125;func Default() &#123; log.Println(&quot;Starting...&quot;) c := cron.New() c.Start() schedule(c) timer := time.NewTimer(time.Second * 10) for &#123; select &#123; case &lt;-timer.C: timer.Reset(time.Second * 10) &#125; &#125;&#125;","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"golang","slug":"golang","permalink":"http://xupin.im/tags/golang/"}]},{"title":"PHPå­¦ä¹ ç¬”è®° - aliyundb SQLSetStatement is NOT supported","date":"2020-01-06T16:00:00.000Z","path":"2020/01/07/php-aliyundb/","text":"PHP é¡¹ç›®åœ¨æ•°æ®åº“è¿ç§»ä½¿ç”¨ ADBï¼ˆaliyundbï¼‰æ—¶å‘ç°è¿™ä¸ªé—®é¢˜ï¼Œå…·ä½“é”™è¯¯æè¿°æ˜¯ï¼š 1SQLSTATE[HY000]: General error: 1815 [15022, 2020010711034801025210201503151413416] statement type: class com.alibaba.fastsql.sql.ast.statement.SQLSetStatement is NOT supported! (SQL: select * from `users`) åœ¨æ’æŸ¥è¯¥é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå°è¯•äº†å„ç§æ–¹å¼ï¼Œé™ç‰ˆæœ¬ã€ä½¿ç”¨åŸç”Ÿè¯­å¥ç­‰ï¼Œç”šè‡³æŸ¥æ‰¾ ADB æ‰‹å†Œå’Œ Issue è¿˜æ˜¯æ— æ³•è§£å†³ã€‚ 1.åŸå› å› ä¸º ADB å…¼å®¹ Mysql ä½†æ˜¯æœ‰äº›æœºåˆ¶è¿˜æ˜¯ç•¥æœ‰ä¸åŒï¼Œé˜…è¯»æºç åå‘ç°æ¯”å¦‚ï¼šADB å°±ä¸èƒ½å¾ˆå¥½çš„æ”¯æŒæœ¬åœ°é¢„å¤„ç†è¯­å¥ï¼Œè¿™ä¹Ÿæ˜¯è¯¥å¼‚å¸¸çš„åŸå› ã€‚ 2.è§£å†³æ–¹æ¡ˆPHP PDO é“¾æ¥çš„å±æ€§å€¼PDO::ATTR_EMULATE_PREPARESéœ€è¦è®¾ç½®ä¸ºtrue 1PDO::ATTR_EMULATE_PREPARES =&gt; true","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"php","slug":"php","permalink":"http://xupin.im/tags/php/"}]},{"title":"Goå­¦ä¹ ç¬”è®° - WEBæ¡†æ¶Gin","date":"2019-12-30T16:00:00.000Z","path":"2019/12/31/go-gin/","text":"Gin æ˜¯ä¸€ä¸ªç”¨ Go (Golang) ç¼–å†™çš„ HTTP web æ¡†æ¶ã€‚ å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼äº martini ä½†æ‹¥æœ‰æ›´å¥½æ€§èƒ½çš„ API æ¡†æ¶, ç”±äº httprouterï¼Œé€Ÿåº¦æé«˜äº†è¿‘ 40 å€ã€‚ 1.æœ‰å“ªäº›ä¼˜ç‚¹ è¾ƒé«˜çš„æ€§èƒ½ï¼ˆGolang WEBæ¡†æ¶æ¯”å¯¹æ•°æ®ï¼‰ ç®€å•æ˜“ç”¨çš„ä¸­é—´ä»¶ ä½¿ç”¨äº†æ€§èƒ½é«˜å¯æ‰©å±•çš„HTTPè·¯ç”±httprouter ç¤¾åŒºé•¿æœŸæœ‰ç€å¾ˆé«˜çš„æ´»è·ƒåº¦ Githubæ˜Ÿæ˜Ÿå¤šï¼ˆOrzï¼‰ â€¦ç­‰ 2.å®‰è£…&#x2F;æ›´æ–°å®‰è£… 1$ go get github.com/gin-gonic/gin æ›´æ–° 1$ go get -u github.com/gin-gonic/gin 3.Hello World1234567891011121314151617181920package mainimport ( &quot;github.com/gin-gonic/gin&quot;)func main() &#123; // æ¡†æ¶ g := gin.Default() // è·¯ç”± g.GET(&quot;/t&quot;, test) // æœåŠ¡ç«¯å£ g.Run(&quot;:4000&quot;)&#125;func test(c *gin.Context) &#123; c.String(200, &quot;Hallo!&quot;)&#125; è¿è¡Œ 1$ go run main.go è®¿é—® http://127.0.0.1:4000/t ï¼Œé¡µé¢è¾“å‡ºHallo!ã€‚ 4.è·¯ç”±Ginæ”¯æŒçš„è·¯ç”±æ–¹å¼å’Œå¤§éƒ¨åˆ†ä¸»æµæ¡†æ¶åŸºæœ¬ä¸€è‡´ã€‚ 12345678910111213func main() &#123; g := gin.Default() g.GET(&quot;/someGet&quot;, getting) g.POST(&quot;/somePost&quot;, posting) g.PUT(&quot;/somePut&quot;, putting) g.DELETE(&quot;/someDelete&quot;, deleting) g.PATCH(&quot;/somePatch&quot;, patching) g.HEAD(&quot;/someHead&quot;, head) g.OPTIONS(&quot;/someOptions&quot;, options) g.Run(&quot;:4000&quot;)&#125; GinåŒæ ·ä¹Ÿæ”¯æŒè·¯ç”±å‚æ•°ï¼Œä¸è¿‡ä¸æ”¯æŒè·¯ç”±æ­£åˆ™è¡¨è¾¾å¼ã€‚ 1234567891011121314151617181920func main() &#123; g := gin.Default() // æ­¤ handler åªèƒ½åŒ¹é… /user/&#123;PARAM&#125; g.GET(&quot;/user/:name&quot;, func(c *gin.Context) &#123; name := c.Param(&quot;name&quot;) c.String(http.StatusOK, &quot;Hello %s&quot;, name) &#125;) // æ­¤ handler ä¼šåŒ¹é… /user/&#123;PARAM&#125;/ å’Œ /user/&#123;PARAM&#125;/&#123;ACTION_2&#125; // å¦‚æœè®¿é—® /user/&#123;PARAM&#125;ï¼Œåœ¨æ²¡æœ‰ &quot;/user/:name&quot; è·¯ç”±çš„æƒ…å†µä¸‹ï¼Œä¼šé‡å®šå‘è‡³ /user/&#123;PARAM&#125;/ åŒ¹é…å½“å‰è·¯ç”±ã€‚ g.GET(&quot;/user/:name/*action&quot;, func(c *gin.Context) &#123; name := c.Param(&quot;name&quot;) action := c.Param(&quot;action&quot;) message := name + &quot; is &quot; + action c.String(http.StatusOK, message) &#125;) g.Run(&quot;:4000&quot;)&#125; 5.è·¯ç”±ç»„Ginåœ¨è·¯ç”±åˆ†ç»„ä¸Šçš„åšæ³•å’Œå…¶ä»–æ¡†æ¶ä¹Ÿéƒ½æ˜¯ä¸€è‡´çš„ï¼Œå†æ¬¡ä½“ç°äº†Ginç®€å•æ˜“ç”¨æå®¹æ˜“ä¸Šæ‰‹çš„ä¼˜ç‚¹ã€‚ 1234567891011121314151617func main() &#123; g := gin.Default() userGroup := g.Group(&quot;/user&quot;) &#123; userGroup.POST(&quot;/login&quot;, ctrls.Login) userGroup.POST(&quot;/logout&quot;, ctrls.Logout) &#125; reportGroup := g.Group(&quot;/report&quot;) &#123; reportGroup.POST(&quot;/revenue&quot;, ctrls.RevenueReport) reportGroup.POST(&quot;/cost&quot;, ctrls.CostReport) &#125; g.Run(&quot;:4000&quot;)&#125; 6.ä¸­é—´ä»¶Ginçš„ä¸­é—´ä»¶åˆ†ä¸ºï¼šå…¨å±€ï¼Œè·¯ç”±ç»„ï¼Œè·¯ç”±çº§åˆ«ã€‚ 123456789101112131415func main() &#123; g := gin.Default() // å…¨å±€ä¸­é—´ä»¶ g.Use(middleware) // è·¯ç”±ç»„ä¸­é—´ä»¶ routerGroup := g.Group(&quot;/user&quot;, middleware) &#123; // è·¯ç”±ä¸­é—´ä»¶ routerGroup.GET(&quot;/login&quot;, middleware, ctrls.Login) &#125; g.Run(&quot;:4000&quot;)&#125; 7.å‚æ•°Ginå¦‚ä½•è·å–è¯·æ±‚å‚æ•°ï¼Ÿä¸‹é¢çš„ç®€å•ä¾‹å­ï¼š 123456789101112131415161718192021222324func main() &#123; g := gin.Default() // URLå‚æ•° // URLï¼š/user?email=mark@im.com g.GET(&quot;/user&quot;, func(c *gin.Context) &#123; // ä½¿ç”¨ DefaultQuery æˆ–è€… Query email := c.DefaultQuery(&quot;email&quot;, &quot;default value&quot;) email = c.Query(&quot;email&quot;) c.String(http.StatusOK, &quot;Hallo, %s&quot;, email) &#125;) // POSTå‚æ•° g.POST(&quot;/user/login&quot;, func(c *gin.Context) &#123; // ä½¿ç”¨ DefaultPostForm æˆ–è€… PostForm email := c.PostForm(&quot;email&quot;) email = c.DefaultPostForm(&quot;email&quot;, &quot;default value&quot;) c.String(http.StatusOK, &quot;Hallo, %s&quot;, email) &#125;) g.Run(&quot;:4000&quot;)&#125; æœ€åGinæ”¯æŒçš„æ“ä½œè¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šæ•°æ®ç»‘å®šã€æ•°æ®éªŒè¯ã€ä¸Šä¼ æ–‡ä»¶ã€é™æ€èµ„æºåµŒå…¥ç­‰ã€‚ Ginæ²¡æœ‰æä¾›çš„ç»„ä»¶ä¹Ÿæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šORMã€Consoleã€æ—¥å¿—æ»šåŠ¨åˆ†å‰²ç­‰ã€‚ ä»è€…è§ä»æ™ºè€…è§æ™ºï¼ŒGinä¸“æ³¨åšHTTP WEBæ¡†æ¶çš„æ ¸å¿ƒï¼Œæ›´å¤šæ‰©å±•éœ€è¦å¼€å‘äººå‘˜è‡ªå·±å»é€‰æ‹©ï¼Œç»„ä»¶åŒ–çš„è®¾è®¡æ— ç–‘æ˜¯å¥½çš„ã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"golang","slug":"golang","permalink":"http://xupin.im/tags/golang/"}]},{"title":"ESå­¦ä¹ ç¬”è®° - å®ç°åˆ—åˆ†ç»„ç»Ÿè®¡","date":"2019-12-16T16:00:00.000Z","path":"2019/12/17/elasticsearch-group/","text":"Elasticsearchæ˜¯Elastic Stackæ ¸å¿ƒçš„åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ã€‚ 1.èƒŒæ™¯å› ä¸ºä¸šåŠ¡è°ƒæ•´é‡‡ç”¨äº†ESä½œä¸ºæ•°æ®åº“ï¼Œæ‰€ä»¥éœ€è¦äº†è§£ESå¯¹äºè¿™ä¸€å—çš„è®¾è®¡å¦‚ä½•å®ç°ç±»ä¼¼Mysqlä¸­Group Byçš„æŸ¥è¯¢çš„æ•ˆæœã€‚ 2.å®ç°æ–¹å¼ESå®ç°Group Byæœ‰ä¸¤ç§æ–¹å¼ï¼šTermsAggã€CompositeAggï¼Œå®ƒä»¬ä¹Ÿå…·æœ‰ä¸åŒç¨‹åº¦çš„ä¼˜ç¼ºç‚¹ã€‚ TermsAggçš„ä½¿ç”¨æ–¹å¼éå¸¸ç²—æš´ï¼Œç›´æ¥è¿›è¡Œæ¡¶åµŒå¥—å³å¯ï¼Œå¦‚ä¸‹: TermsAggè¯·æ±‚DSLè¯­å¥ 12345678910111213141516171819&#123; &quot;aggregations&quot;: &#123; &quot;group_app&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;app&quot;, &quot;size&quot;: 1000000 &#125;, &quot;aggregations&quot;: &#123; &quot;group_campaign_id&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;campaign_id&quot;, &quot;size&quot;: 1000000 &#125; &#125; &#125; &#125; &#125;, &quot;size&quot;: 0&#125; TermsAggæ‰§è¡Œç»“æœ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859&#123; &quot;took&quot;: 142, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 5, &quot;successful&quot;: 5, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: 175033, &quot;max_score&quot;: 0.0, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;group_app&quot;: &#123; &quot;doc_count_error_upper_bound&quot;: 0, &quot;sum_other_doc_count&quot;: 0, &quot;buckets&quot;: [ &#123; &quot;key&quot;: &quot;com.aa.bb.cc&quot;, &quot;doc_count&quot;: 59929, &quot;group_campaign_id&quot;: &#123; &quot;doc_count_error_upper_bound&quot;: 0, &quot;sum_other_doc_count&quot;: 0, &quot;buckets&quot;: [ &#123; &quot;key&quot;: &quot;Campaign_118&quot;, &quot;doc_count&quot;: 56466 &#125;, &#123; &quot;key&quot;: &quot;Campaign_119&quot;, &quot;doc_count&quot;: 1937 &#125; ] &#125; &#125;, &#123; &quot;key&quot;: &quot;com.dd.ee.ff&quot;, &quot;doc_count&quot;: 23231, &quot;group_campaign_id&quot;: &#123; &quot;doc_count_error_upper_bound&quot;: 0, &quot;sum_other_doc_count&quot;: 0, &quot;buckets&quot;: [ &#123; &quot;key&quot;: &quot;Campaign_120&quot;, &quot;doc_count&quot;: 16692 &#125;, &#123; &quot;key&quot;: &quot;Campaign_121&quot;, &quot;doc_count&quot;: 5336 &#125; ] &#125; &#125; ] &#125; &#125;&#125; CompositeAggçš„ä½¿ç”¨æ–¹å¼ç•¥å¾®æœ‰ä¸€äº›ä¸åŒï¼Œä¸‹é¢ï¼š CompositeAggè¯·æ±‚DSLè¯­å¥ 1234567891011121314151617181920212223242526&#123; &quot;aggregations&quot;: &#123; &quot;group_by&quot;: &#123; &quot;composite&quot;: &#123; &quot;sources&quot;: [ &#123; &quot;app&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;app&quot; &#125; &#125; &#125;, &#123; &quot;campaign_id&quot;: &#123; &quot;terms&quot;: &#123; &quot;field&quot;: &quot;campaign_id&quot; &#125; &#125; &#125; ], &quot;size&quot;: 1000 &#125; &#125; &#125;, &quot;size&quot;: 0&#125; CompositeAggæ‰§è¡Œç»“æœ 123456789101112131415161718192021222324252627282930313233343536373839&#123; &quot;took&quot;: 14, &quot;timed_out&quot;: false, &quot;_shards&quot;: &#123; &quot;total&quot;: 5, &quot;successful&quot;: 5, &quot;skipped&quot;: 0, &quot;failed&quot;: 0 &#125;, &quot;hits&quot;: &#123; &quot;total&quot;: 175033, &quot;max_score&quot;: 0.0, &quot;hits&quot;: [] &#125;, &quot;aggregations&quot;: &#123; &quot;group_by&quot;: &#123; &quot;after_key&quot;: &#123; &quot;app&quot;: &quot;com.dd.ee.ff&quot;, &quot;campaign_id&quot;: &quot;Campaign_120&quot; &#125;, &quot;buckets&quot;: [ &#123; &quot;key&quot;: &#123; &quot;app&quot;: &quot;com.aa.bb.cc&quot;, &quot;campaign_id&quot;: &quot;Campaign_119&quot; &#125;, &quot;doc_count&quot;: 182 &#125;, &#123; &quot;key&quot;: &#123; &quot;app&quot;: &quot;com.dd.ee.ff&quot;, &quot;campaign_id&quot;: &quot;Campaign_120&quot; &#125;, &quot;doc_count&quot;: 40 &#125; ] &#125; &#125;&#125; 3.ä¼˜ç¼ºç‚¹TermsAgg ä¼˜ç‚¹ï¼šä½¿ç”¨ç®€å•ã€æ²¡æœ‰æ•°æ®é‡é™åˆ¶ã€‚ ç¼ºç‚¹ï¼šæ•°æ®ç»“æ„å±‚æ¬¡æ·±ã€ä¸æ”¯æŒåˆ†é¡µã€‚ CompositeAgg ä¼˜ç‚¹ï¼šä½¿ç”¨ç®€å•ã€æ•°æ®ç»“æ„æ¸…æ™°å¯è¯»ï¼Œæ”¯æŒåˆ†é¡µã€‚ ç¼ºç‚¹ï¼šæœ‰æ•°æ®é‡é™åˆ¶ã€‚ æœ€åè‡³äºESè¿™ä¸¤ç§åˆ†ç»„æ–¹å¼çš„æ€§èƒ½æ–¹é¢è¿˜æ²¡æœ‰ç ”ç©¶ï¼Œåç»­å­¦ä¹ ç¬”è®°ä¼šæ›´æ–°æ€§èƒ½ä¸Šé¢çš„å·®å¼‚ã€‚ https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html &#x2F;&#x2F; é™„ä¸ŠESå®˜æ–¹æ–‡æ¡£","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"elasticsearch","slug":"elasticsearch","permalink":"http://xupin.im/tags/elasticsearch/"}]},{"title":"Nginxå­¦ä¹ ç¬”è®° - ä»£ç†","date":"2019-12-16T16:00:00.000Z","path":"2019/12/17/nginx-proxy/","text":"ä»£ç†é€šå¸¸ç”¨äºåœ¨å‡ å°æœåŠ¡å™¨ä¹‹é—´åˆ†é…è´Ÿè½½ï¼Œæ— ç¼æ˜¾ç¤ºæ¥è‡ªä¸åŒç½‘ç«™çš„å†…å®¹æˆ–é€šè¿‡é™¤ HTTP ä¹‹å¤–çš„åè®®å°†å¤„ç†è¯·æ±‚ä¼ é€’ç»™åº”ç”¨æœåŠ¡å™¨ã€‚ 1.ä»£ç†çš„å¸¸ç”¨åœºæ™¯åŠä¼˜ç‚¹æ­£å‘ä»£ç† gfw ç§‘å­¦ä¸Šç½‘ã€‚ å®¢æˆ·ç«¯è®¿é—®é‰´æƒã€‚ åå‘ä»£ç† è´Ÿè½½å‡è¡¡ã€‚ ä¿è¯å†…ç½‘çš„å®‰å…¨ï¼Œé˜»æ­¢ web æ”»å‡»ã€‚ 2.æ­£å‘ä»£ç†å’Œåå‘ä»£ç†æœ‰ä»€ä¹ˆä¸åŒæ¯”è¾ƒé€šä¿—çš„æ¥è§£é‡Šï¼šæ­£å‘ä»£ç†ä»£ç†çš„æ˜¯å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯ä¸çŸ¥é“å®é™…å‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯ã€åå‘ä»£ç†ä»£ç†çš„æ˜¯æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯ä¸çŸ¥é“å®é™…æ¥æ”¶è¯·æ±‚çš„æœåŠ¡ç«¯ã€‚ ä¸€å¼ å›¾è¡¨ç¤ºï¼ˆæ¥æºï¼šçŸ¥ä¹ wplulalaï¼‰","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"nginx","slug":"nginx","permalink":"http://xupin.im/tags/nginx/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - ç´¢å¼•","date":"2019-12-16T11:30:00.000Z","path":"2019/12/16/mysql-index/","text":"ç´¢å¼•ç”¨äºå¿«é€ŸæŸ¥æ‰¾å…·æœ‰ç‰¹å®šåˆ—å€¼çš„è¡Œã€‚æ²¡æœ‰ç´¢å¼•ï¼ŒMySQLå¿…é¡»ä»ç¬¬ä¸€è¡Œå¼€å§‹ï¼Œç„¶åé€šè¯»æ•´ä¸ªè¡¨ä»¥æ‰¾åˆ°ç›¸å…³çš„è¡Œã€‚å¦‚æœè¡¨ä¸­æœ‰ç›¸å…³â€‹â€‹åˆ—çš„ç´¢å¼•ï¼ŒMySQLå¯ä»¥å¿«é€Ÿç¡®å®šè¦åœ¨æ•°æ®æ–‡ä»¶ä¸­é—´æŸ¥æ‰¾çš„ä½ç½®ï¼Œè€Œä¸å¿…æŸ¥çœ‹æ‰€æœ‰æ•°æ®ã€‚è¿™æ¯”é¡ºåºè¯»å–æ¯ä¸€è¡Œè¦å¿«å¾—å¤šã€‚InnoDBå’ŒMyIsamåªæ”¯æŒBtreeï¼Œå› æ­¤é»˜è®¤å‡æ˜¯Btreeï¼ŒMemoryå’ŒHeapæ”¯æŒHashå’ŒBtreeï¼Œå¦‚æ— æ˜ç¡®å£°æ˜ï¼Œåˆ™é»˜è®¤ç´¢å¼•å‡æ˜¯Hashï¼ˆåŒ…æ‹¬ä¸»é”®ï¼‰ã€‚ 1.Mysqlæœ‰å“ªäº›å¸¸ç”¨çš„ç´¢å¼• ä¸»é”®ç´¢å¼•ï¼šæ•°æ®åˆ—ä¸å…è®¸é‡å¤ï¼Œä¸å…è®¸ä¸ºnullï¼Œä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ã€‚ å”¯ä¸€ç´¢å¼•ï¼šæ•°æ®åˆ—ä¸å…è®¸é‡å¤ï¼Œå…è®¸ä¸ºnullï¼Œä¸€ä¸ªè¡¨å…è®¸å¤šä¸ªåˆ—åˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚ æ™®é€šç´¢å¼•ï¼šåŸºæœ¬çš„ç´¢å¼•ç±»å‹ï¼Œæ²¡æœ‰å”¯ä¸€æ€§çš„é™åˆ¶ï¼Œå…è®¸ä¸ºnullã€‚ å…¨æ–‡ç´¢å¼•ï¼šå…¨æ–‡ç´¢å¼•æ˜¯ç›®å‰å®ç°å¤§æ•°æ®æœç´¢çš„å…³é”®æŠ€æœ¯ã€‚ 2.Mysqlç´¢å¼•çš„å»ºç«‹åŸåˆ™Mysqlçš„ç´¢å¼•éµå¾ªæœ€å·¦åŸåˆ™ï¼Œåœ¨åˆ›å»ºå¤šåˆ—ç´¢å¼•æ—¶ï¼Œè¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œwhereæ¡ä»¶ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„ä¸€åˆ—æ”¾åœ¨æœ€å·¦è¾¹ã€‚ 12345678910111213index(a,b,c)where a = v // ä½¿ç”¨awhere a = v and b = v // ä½¿ç”¨a,bwhere a = v and b = v and c = v // ä½¿ç”¨a,b,cwhere b = v // æœªä½¿ç”¨ç´¢å¼•where a = v and c = v // ä½¿ç”¨awhere b = v and c = v // æœªä½¿ç”¨ç´¢å¼•where a &gt; v // æ˜¯å¦ä½¿ç”¨ç´¢å¼•ï¼Œå–å†³äºæŸ¥è¯¢ç»“æœé›†ï¼Œå¦‚æœå…¨è¡¨æ‰«æé€Ÿåº¦æ¯”ç´¢å¼•é€Ÿåº¦å¿«ï¼Œé‚£ä¹ˆä¸ä½¿ç”¨ç´¢å¼•ã€‚where a like &quot;v%&quot; // ä½¿ç”¨awhere a like &quot;%v%&quot; // ä¸é€‚ç”¨ç´¢å¼• 3.å¦‚ä½•åˆ†æSQLè¯­å¥æ‰§è¡Œæ€§èƒ½ä»¥ä¸‹æ˜¯ä¸¤ç§åˆ†æSQLæ€§èƒ½çš„å¸¸ç”¨æ–¹å¼ï¼Œexplainã€show profiles&#x2F;show profileã€‚ explain + SQLè¯­å¥ï¼Œè·å–SQLåˆ†ææ•°æ® select_typeï¼šå¯¹åº”SQLè¯­å¥çš„æŸ¥è¯¢å¤æ‚åº¦ã€‚ tableï¼šæ­£åœ¨è®¿é—®çš„è¡¨ã€‚ partitionsï¼šæ•°æ®æ‰€åœ¨çš„åˆ†åŒºã€‚ typeï¼šè¡¨ç¤ºæ˜¯å¦ç”¨ä¸Šç´¢å¼•ï¼Œä»¥åŠç´¢å¼•æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œæ­¤å­—æ®µå†³å®šç´¢å¼•çš„æ€§èƒ½ã€‚ALL&lt;TYPE&lt;RANGE&lt;REF&lt;CONST possible_keysï¼šæŸ¥è¯¢æ¡ä»¶å­˜åœ¨çš„ç´¢å¼•ã€‚ keyï¼šè§¦å‘çš„ç´¢å¼•ã€‚ key_lenï¼šç´¢å¼•å­—æ®µçš„é•¿åº¦ã€‚ refï¼šç´¢å¼•è®¿é—®ï¼Œè¿”å›æ‰€æœ‰åŒ¹é…æŸä¸ªå•å€¼çš„è¡Œã€‚ rowsï¼šæ‰§è¡ŒæŸ¥è¯¢å¿…é¡»æ£€æŸ¥çš„è¡Œæ•°ï¼Œåœ¨InnoDBä¸­æ­¤å€¼ä¸ç²¾ç¡®ã€‚ filteredï¼šæ¡ä»¶è¿‡æ»¤å‡ºçš„è¡Œæ•°çš„ç™¾åˆ†æ¯”ã€‚ extraï¼šæŸ¥è¯¢åˆ†æç»“æœçš„é¢å¤–ä¿¡æ¯ï¼Œå¾ˆé‡è¦ e.g. Using indexã€Using where â€¦ show profilesè·å¾—å½“å‰ä¼šè¯ä¸­æ‰§è¡Œçš„SQLè¯­å¥ï¼Œå­—æ®µä¸ºï¼šQuery_ID, Duration, Queryï¼Œshow profile all for query {Query_ID} 4.Mysqlä¸­ç´¢å¼•å»ºç«‹å¸¸è§é—®é¢˜ ä¸ºç»å¸¸éœ€è¦æ’åºã€åˆ†ç»„å’Œè”åˆæ“ä½œçš„å­—æ®µå»ºç«‹ç´¢å¼• ä¸ºå¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µå»ºç«‹ç´¢å¼• ç´¢å¼•åˆ—å€¼ä¿è¯å”¯ä¸€æ€§ ç´¢å¼•å»ºç«‹çš„æ•°é‡ä¸è¦è¿‡å¤š ç´¢å¼•åˆ—ä¸è¦ä½¿ç”¨å‡½æ•°æˆ–è€…è¡¨è¾¾å¼ è¡Œé”ä¾èµ–ç´¢å¼•çš„å»ºç«‹ æ™®é€šç´¢å¼•çš„æ•°æ®é‡å¤ç‡è¿‡é«˜ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ æœ€å·¦åŸåˆ™","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - äº‹åŠ¡éš”ç¦»çº§åˆ«","date":"2019-12-05T04:30:00.000Z","path":"2019/12/05/mysql-transaction/","text":"ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿäº‹åŠ¡ï¼ˆTransactionï¼‰ä¸€èˆ¬æ˜¯æŒ‡è¦åšçš„æˆ–æ‰€åšçš„äº‹æƒ…ã€‚åœ¨è®¡ç®—æœºæœ¯è¯­ä¸­æ˜¯æŒ‡è®¿é—®å¹¶å¯èƒ½æ›´æ–°æ•°æ®åº“ä¸­å„ç§æ•°æ®é¡¹çš„ä¸€ä¸ªç¨‹åºæ‰§è¡Œå•å…ƒ(unit)ï¼Œå…·æœ‰4ä¸ªç‰¹æ€§ï¼šåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ï¼Œç®€ç§°ACIDã€‚ é‚£ä¹ˆMysqlçš„äº‹åŠ¡éš”ç¦»çº§åˆ«åˆæ˜¯ä»€ä¹ˆå‘¢ï¼ŸMysqlçš„äº‹åŠ¡éš”ç¦»çº§åˆ«åˆ†åˆ«æ˜¯4ç§ï¼šæœªæäº¤è¯»ï¼ˆRead Uncommittedï¼‰ã€å·²æäº¤è¯»ï¼ˆRead Committedï¼‰ã€Repeatable Readï¼ˆå¯é‡å¤è¯»ï¼‰ã€Serializableï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰ã€‚å¯ä»¥ç®€å•ç†è§£ä¸ºMysqläº‹åŠ¡çš„4ç§æ‰§è¡Œæ ‡å‡†ã€‚ ä¸€ã€ACIDç‰¹æ€§ åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¸­åŒ…æ‹¬çš„è¯¸æ“ä½œè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åšã€‚ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡å¿…é¡»æ˜¯ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚ä¸€è‡´æ€§ä¸åŸå­æ€§æ˜¯å¯†åˆ‡ç›¸å…³çš„ã€‚ éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°ã€‚å³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹å¹¶å‘çš„å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„å„ä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½äº’ç›¸å¹²æ‰°ã€‚ æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šæŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±åº”è¯¥æ˜¯æ°¸ä¹…æ€§çš„ã€‚æ¥ä¸‹æ¥çš„å…¶ä»–æ“ä½œæˆ–æ•…éšœä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚ äºŒã€Mysqläº‹åŠ¡éš”ç¦»çº§åˆ« æœªæäº¤è¯»ï¼ˆRead Uncommittedï¼‰ï¼ŒæŒ‡å½“å‰äº‹åŠ¡å¯ä»¥è¯»å–åˆ°å…¶ä»–äº‹åŠ¡è¿˜æœªæäº¤çš„æ•°æ®å˜åŒ–ï¼Œæœ€å®¹æ˜“å¸¦æ¥çš„é—®é¢˜æ˜¯è„è¯»ï¼ˆDirty Readï¼‰ï¼Œå¾ˆå°‘åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒã€‚ å·²æäº¤è¯»ï¼ˆRead Committedï¼‰ï¼Œå¤§éƒ¨åˆ†æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«ä½†ä¸åŒ…æ‹¬Mysqlï¼ŒæŒ‡å½“å‰äº‹åŠ¡å¯ä»¥è¯»å–å…¶ä»–äº‹åŠ¡å·²æäº¤çš„æ•°æ®å˜åŒ–ï¼Œå…·æœ‰éš”ç¦»æ€§çš„åŸºæœ¬æ ‡å‡†ï¼Œä½†æ˜¯åœ¨å‡ºç°äº¤å‰äº‹åŠ¡çš„å¹¶å‘æ“ä½œåœºæ™¯ä¸­ä¼šå‘ç”Ÿä¸¤æ¬¡è¯»å–çš„æ•°æ®ç»“æœé›†ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå³ä¸å¯é‡å¤è¯»ï¼ˆNonrepeatable Readï¼‰ã€‚ Repeatable Readï¼ˆå¯é‡å¤è¯»ï¼‰ï¼ŒMysqlæ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼Œè¿™é‡Œé¡ºä¾¿è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆMysqlçš„éš”ç¦»çº§åˆ«ä¸æ˜¯Read Committedï¼Œå› ä¸ºåœ¨Mysql5.0ä¹‹å‰æ—¥å¿—æ ¼å¼åªæœ‰statementè¿™ä¸€ç§ï¼Œè¿™ç§æ ¼å¼å¯¼è‡´ä¸»ä»å¤åˆ¶ä¸€è‡´æ€§å¾ˆéš¾å¾—åˆ°ä¿è¯ã€‚è¿™ç§éš”ç¦»çº§åˆ«å¯ä»¥è§£å†³Nonrepeatable Readçš„é—®é¢˜ï¼Œä½†å¦‚æœä¹Ÿå‡ºç°åœ¨äº¤å‰äº‹åŠ¡çš„å¹¶å‘æ“ä½œåœºæ™¯ä¼šå‡ºç°å¹»è¯»ï¼ˆPhantom Readï¼‰çš„ç°è±¡ï¼Œè¿™ä¸€è¡Œä¸ºçŠ¶æ€æ˜¯å½“å‰äº‹åŠ¡ä¸èƒ½åŠæ—¶æœ‰æ•ˆçš„è¯»å–å…¶ä»–äº‹åŠ¡çš„æ•°æ®å˜åŒ–ã€‚ Serializableï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰ï¼ŒMysqläº‹åŠ¡éš”ç¦»æœ€é«˜çº§åˆ«ï¼Œæœ›æ–‡ç”Ÿä¹‰å¤§æ¦‚æ„æ€æ˜¯äº‹åŠ¡çš„æ‰§è¡Œæ˜¯æœ‰åºï¼ˆä¸²è¡ŒåŒ–é¡ºåºï¼‰çš„ï¼Œä¸å­˜åœ¨äº‹åŠ¡äº¤å‰æ‰§è¡Œçš„åœºæ™¯ä»è€Œè§£å†³äº†Phantom Readçš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨é«˜å¹¶å‘çš„ä¸šåŠ¡åœºæ™¯ä¸‹è¯·æ±‚ä¼šå‡ºç°é˜»å¡ã€è¶…æ—¶ã€é”ç«ŸæŠ¢çš„é—®é¢˜ï¼Œç³»ç»Ÿçš„å¯ç”¨æ€§ä¹Ÿéšä¹‹é™ä½ã€‚ æ”¶å°¾ https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html &#x2F;&#x2F; Mysqläº‹åŠ¡å®˜æ–¹æ–‡æ¡£","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Mysqlå­¦ä¹ ç¬”è®° - æ‚²è§‚é”/ä¹è§‚é”","date":"2019-12-04T11:30:00.000Z","path":"2019/12/04/mysql-locking/","text":"ä»€ä¹ˆæ˜¯é”ï¼Ÿåœ¨å¤šè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ç¼–ç¨‹ä¸­ä¸ºäº†æ•°æ®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§ï¼Œå¦‚æœä¸€èµ„æºè¢«æŸè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ä¸Šé”ï¼Œé‚£ä¹ˆåœ¨é‡Šæ”¾é”ä¹‹å‰å…¶ä»–è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰æ— æ³•è¿›è¡Œæ“ä½œæˆ–è€…ç­‰å¾…è·å–ï¼ˆä¸Šï¼‰é”ã€‚ ä¸€ã€æ‚²è§‚é”æ‚²è§‚é”ï¼ˆPessimistic lockingï¼‰ï¼Œé¡¾åæ€ä¹‰å¯¹å¾…ä»»ä½•äº‹åŠ¡éƒ½æŒæ‚²è§‚æ€åº¦ï¼Œåšä»»ä½•äº‹æƒ…éƒ½ä¼šè®¤ä¸ºä¼šæœ‰ç«æŠ¢è¡Œä¸º~æ‰€ä»¥åœ¨è¿›è¡Œä»»ä½•æ“ä½œä¹‹å‰éƒ½è¦åšå¥½ä¸‡å…¨å‡†å¤‡ï¼ˆä¸Šé”ï¼‰æ‰ä¼šç»§ç»­æ‰§è¡Œåç»­çš„æ“ä½œã€‚é€šå¸¸æ˜¯åˆ©ç”¨ç³»ç»Ÿæä¾›çš„é”æœºåˆ¶æ¥å®ç°ã€‚æ¯”å¦‚ï¼š 12Mysqlä¸­çš„ä¸Šé”å‘½ä»¤ï¼šfor updateã€lock in share modeç­‰Redisä¸­çš„ä¸€äº›æ“ä½œå‘½ä»¤ï¼šsetnxã€getsetç­‰ï¼ˆåŸå­æ“ä½œï¼‰ äºŒã€ä¹è§‚é”ä¹è§‚é”ï¼ˆOptimistic lockingï¼‰ï¼Œå’Œæ‚²è§‚é”ç›¸åå¯¹å¾…ä»»ä½•äº‹åŠ¡éƒ½æŒä¹è§‚æ€åº¦ï¼Œåªä¼šåœ¨æœ€åå³å°†æ‰§è¡Œæ“ä½œçš„æ—¶åˆ»å‰æ‰ä¼šè¿›è¡ŒéªŒè¯ã€‚é€šå¸¸æ˜¯é€šè¿‡ç¨‹åºé…åˆæ¥å®ç°ã€‚æ¯”å¦‚ï¼š 1update `orders` set hash = md5(now()) where uid = 1 and hash = &#123;lastHash&#125;; ä¸‰ã€ä¼˜ç¼ºç‚¹æ‚²è§‚é”ä¼˜ç‚¹å¾ˆé²œæ˜ï¼Œå› ä¸ºæ¯æ¬¡æ‰§è¡Œçš„æ“ä½œéƒ½æ˜¯ç‹¬å çš„ï¼Œæ•°æ®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§ã€å®‰å…¨æ€§è¾ƒé«˜ã€‚ä½†ç¼ºç‚¹åŒæ ·çªå‡ºï¼Œæ¯æ¬¡æ“ä½œéƒ½ä¼šäº§ç”Ÿä¸Šé”çš„å¼€é”€ï¼Œåœ¨å¹¶å‘è¯·æ±‚æ¯”è¾ƒå¯†é›†çš„æƒ…å†µä¸‹å®¹æ˜“é˜»å¡æˆ–è€…é©³å›è¯·æ±‚ï¼Œç”šè‡³æ˜¯é€ æˆæ­»é”ï¼Œä¹Ÿå¤§å¤§é™ä½äº†ç³»ç»Ÿçš„æ€§èƒ½ã€‚ ä¹è§‚é”ä¼˜ç‚¹æ˜¯çœå»äº†é”çš„å¼€é”€ï¼Œèƒ½è¾ƒé«˜çš„æé«˜ç³»ç»Ÿååé‡ï¼Œç¼ºç‚¹æ˜¯å¦‚æœå‡ºç°åœ¨å¹¶å‘é«˜ä¸”ç«ŸæŠ¢ï¼ˆå†²çªï¼‰è¡Œä¸ºæ¯”è¾ƒå¤šçš„åœºæ™¯ä¸‹æ•°æ®çš„ä¸€è‡´æ€§å¾ˆéš¾ä¿è¯ã€‚","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"mysql","slug":"mysql","permalink":"http://xupin.im/tags/mysql/"}]},{"title":"Rediså­¦ä¹ ç¬”è®° - æŒä¹…åŒ–æ–¹å¼","date":"2019-12-03T07:30:00.000Z","path":"2019/12/03/redis-aof-rdb/","text":"Redisæ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç ï¼ˆBSDè®¸å¯ï¼‰çš„å†…å­˜ä¸­æ•°æ®ç»“æ„å­˜å‚¨ï¼Œç”¨ä½œæ•°æ®åº“ï¼Œç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚ ä¸€ã€Redisæ•°æ®å­˜å‚¨çš„æ–¹å¼æœ‰ä¸¤ç§12å•çº¯çš„ç¼“å­˜æ¨¡å¼, æ•´ä¸ªæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸéšç€Redis Serverçš„åœæ­¢è€Œæ¶ˆå¤±ã€‚persistenceæ¨¡å¼, æ•°æ®ä¼šæŒç»­å¤‡ä»½åˆ°ç£ç›˜æ–‡ä»¶ã€‚ äºŒã€Rediså¦‚ä½•å®ç°æŒä¹…åŒ–å­˜å‚¨ï¼ŸRedisæä¾›äº†ä¸¤ç§æ–¹å¼ã€‚12RDB(Redis DataBase)AOF(Append-only file) ä¸‰ã€RDBRDBçš„å·¥ä½œåŸç†æœ‰ç‚¹åƒè¿ç»´è„šæœ¬è‡ªåŠ¨åŒ–å®šæ—¶å¤‡ä»½æ•°æ®ä¸€æ ·ï¼Œå½“å†…å­˜ä¸­çš„æ•°æ®åˆ°è¾¾é…ç½®çš„é˜ˆå€¼å°±ä¼šæ‰§è¡ŒDUMPæ“ä½œå¤‡ä»½æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶,å¤‡ä»½æˆåŠŸç»“æŸåé‡å‘½åä¸ºdump.rdbæ–‡ä»¶ã€‚ 123ä¼˜ç‚¹ï¼šforkå­è¿›ç¨‹æ¥è¿›è¡Œå¤‡ä»½,çˆ¶è¿›ç¨‹ä¸ä¼šè¿›è¡Œioæ“ä½œã€‚æ¢å¤æ•°æ®æ—¶çš„é€Ÿåº¦å¾ˆå¿«ã€‚ç¼ºç‚¹ï¼šè¿™ç§æ–¹å¼æ˜¯æ¯éš”ä¸€æ¬¡æ‰ä¼šè¿›è¡Œå¤‡ä»½,å‡å¦‚ä¸‹ä¸€æ¬¡å¤‡ä»½å‰downæœºä¼šä¸¢å¤±éƒ¨åˆ†æ•°æ®ã€‚è€Œä¸”å¦‚æœå¤‡ä»½çš„æ•°æ®æ¯”è¾ƒå¤§ï¼Œforkçš„å­è¿›ç¨‹å°†ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œè¿™æ®µæ—¶é—´å†…ä¼šå¯¼è‡´çˆ¶è¿›ç¨‹é˜»å¡ã€‚è¡¥å……ï¼šå› ä¸ºè¿™ç§æ¯éš”ä¸€æ®µæ—¶é—´å»å¤‡ä»½ä¸€æ¬¡çš„æ–¹å¼ï¼Œç±»ä¼¼å¿«ç…§ã€‚æ‰€ä»¥åˆå« Snapshotã€‚ å››ã€AOFAOFçš„å·¥ä½œåŸç†æ˜¯è®²å†™æ“ä½œï¼ˆæ•°æ®ï¼‰æ ¼å¼åŒ–è¿½åŠ åˆ°æ—¥å¿—å°¾éƒ¨ï¼Œè¯¥æ—¥å¿—æ–‡ä»¶ä¿å­˜äº†æ‰€æœ‰çš„å†å²æ“ä½œæ•°æ®ï¼Œè¿™ä¸€ç‚¹éå¸¸ç±»ä¼¼Mysqlä¸­çš„bin.logã€‚ 12ä¼˜ç‚¹ï¼šAOFè¿™ç§æ–¹å¼å¯ä»¥ä¿è¯è¾ƒé«˜çš„æ•°æ®å®Œæ•´æ€§ï¼Œå¯ä»¥è®¾ç½®ä¸åŒçš„ç­–ç•¥ï¼Œæ¯”å¦‚ä¸ä¿å­˜ï¼Œæ¯ä¸€ç§’é’Ÿä¿å­˜ä¸€æ¬¡ï¼Œæˆ–è€…æ¯æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ä¿å­˜ä¸€æ¬¡ã€‚AOFçš„é»˜è®¤ç­–ç•¥ä¸ºæ¯ä¸€ç§’é’Ÿä¿å­˜ä¸€æ¬¡, å°±ç®—å‡ºç°downæœºæœ€å¤šä¹Ÿå°±ä¸¢å¤±1ç§’é’Ÿçš„æ•°æ®, AOFå¤‡ä»½æ•°æ®å› ä¸ºæ˜¯åœ¨åå°çº¿ç¨‹æ‰§è¡Œforkå­è¿›ç¨‹, æ‰€ä»¥ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚ç¼ºç‚¹ï¼šå¯¹äºåŒæ ·è§„æ¨¡çš„æ•°æ®å¤‡ä»½çš„æ–‡ä»¶ä½“ç§¯AOFè¦å¤§äºRDBã€‚åœ¨å¤‡ä»½é€Ÿåº¦ä¸Šé¢ä¹Ÿä¼šæ…¢äºRDBï¼Œæ¢å¤é€Ÿåº¦åŒæ ·ä¹Ÿæ²¡æœ‰RDBå¿«ã€‚ äº”ã€AOFå¤‡ä»½è§¦å‘æœºåˆ¶1231. RedisæœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯bgrewriteaofæŒ‡ä»¤è¯·æ±‚ï¼Œå¦‚æœå½“å‰æ²¡æœ‰åœ¨è¿›è¡Œå¤‡ä»½é‚£ä¹ˆç«‹å³è¿›è¡Œå¤‡ä»½ï¼Œå¦åˆ™ç­‰å¾…å¤‡ä»½å®Œæ¯•ä¹‹åå†æ‰§è¡Œå¤‡ä»½ã€‚2. Redis confé…ç½®äº†auto-aof-rewrite-percentageå’Œauto-aof-rewrite-min-sizeå‚æ•°ï¼Œå¹¶ä¸”å½“å‰AOFæ–‡ä»¶å¤§å°server.aof_current_sizeå¤§äºauto-aof-rewrite-min-sizeï¼Œä¸”AOFæ–‡ä»¶å¤§å°çš„å¢é•¿ç‡å¤§äºauto-aof-rewrite-percentageæ—¶è§¦å‘å¤‡ä»½ã€‚3. ä½¿ç”¨config set appendonly yeså‘½ä»¤æ—¶ï¼Œè°ƒç”¨startAppendOnly()å‡½æ•°è§¦å‘å¤‡ä»½ã€‚ å…­ã€é‚£ç©¶ç«Ÿä½¿ç”¨å“ªç§æ–¹å¼ï¼Ÿ12RDB ä¼šæœ‰ä¸¢å¤±æ•°æ®é£é™©ï¼Œå¤‡ä»½æ–‡ä»¶ä½“ç§¯å°ï¼Œæ•°æ®å¤‡ä»½/æ¢å¤é€Ÿåº¦å¿«ã€‚AOF æ•°æ®å®Œæ•´æ€§æ›´åŠ å®‰å…¨ï¼Œä½†æ˜¯é¢‘ç¹å¤‡ä»½éœ€è¦è¿‡å¤šçš„ioæ“ä½œæ€§èƒ½ä¼šå—åˆ°å½±å“ï¼Œå¤‡ä»½æ–‡ä»¶ä½“ç§¯è¾ƒå¤§ï¼Œæ•°æ®æ¢å¤é€Ÿåº¦æ…¢ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬æ˜ç™½AOF, RDBçš„ä¼˜ç¼ºç‚¹ä¹‹åå¯ä»¥æ¦‚æ‹¬å‡º: AOFé€‚åˆçƒ­å¤‡ï¼ŒRDBé€‚åˆå†·å¤‡ï¼ŒRedis4.0ä»¥åå…è®¸ä½¿ç”¨aof-use-rdb-preambleé…ç½®é¡¹æ‰“å¼€RDB-AOFæ··åˆæŒä¹…åŒ–ã€‚ ä¸ƒã€RDB&#x2F;AOFæ··åˆä½¿ç”¨çš„ä¹‹åå¤‡ä»½æ–‡ä»¶çš„å˜åŒ–å½“RDBå’ŒAOFåŒæ—¶å¼€å¯ä¹‹å 121. Redisé»˜è®¤ä¼šä¼˜å…ˆåŠ è½½AOFçš„é…ç½®æ–‡ä»¶ã€‚2. AOFå¤‡ä»½æ–‡ä»¶çš„å†…å®¹æ ¼å¼å‘ç”Ÿæ”¹å˜ï¼Œå¤‡ä»½æ–‡ä»¶å‰åŠæ®µæ˜¯RDBæ ¼å¼çš„å…¨é‡æ•°æ®ååŠæ®µæ˜¯Rediså‘½ä»¤æ ¼å¼çš„å¢é‡æ•°æ®ã€‚ å…«ã€AOFæ–‡ä»¶å†…å®¹æ ¼å¼AOFæ–‡ä»¶å†…å®¹æ ¼å¼æ˜¯Redisé€šè®¯åè®®RESPï¼ˆREdis Serialization Protocolï¼‰æ ¼å¼çš„å‘½ä»¤æ–‡æœ¬å­˜å‚¨ï¼Œåœ¨æ­¤ä¸å±•å¼€å­¦ä¹ åç»­ä¼šä¸“é—¨å­¦ä¹ Redisçš„RESPåè®®ã€‚ æœ€åé™„ä¸ŠRediså¯¹äºæŒä¹…åŒ–æ–¹å¼è¯´æ˜çš„æ–‡æ¡£ https://redis.io/topics/persistence","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"redis","slug":"redis","permalink":"http://xupin.im/tags/redis/"}]},{"title":"PHPå­¦ä¹ ç¬”è®° - Google FCM","date":"2017-02-27T16:00:00.000Z","path":"2017/02/28/google-msg-push/","text":"Firebase æ˜¯ä¸€ä¸ªç§»åŠ¨å¹³å°ï¼Œå¯ä»¥å¸®åŠ©æ‚¨å¿«é€Ÿå¼€å‘é«˜å“è´¨åº”ç”¨ï¼Œæ‰©å¤§ç”¨æˆ·ç¾¤ï¼Œå¹¶èµšå–æ›´å¤šæ”¶ç›Šã€‚Firebase ç”±å¤šç§äº’è¡¥åŠŸèƒ½ç»„æˆï¼Œæ‚¨å¯ä»¥è‡ªè¡Œç»„åˆå’ŒåŒ¹é…è¿™äº›åŠŸèƒ½ä»¥æ»¡è¶³è‡ªå·±çš„éœ€æ±‚ã€‚ 1.è·å– Google æ¨é€çš„ KEY(Google åº”ç”¨åå°) AIzaSyCm5Vufc1FAtWE1kupGhVDRb0ThkCoWC7d &#x2F;&#x2F; è¿™ä¸ªæ˜¯æˆ‘çš„ 2.PHP æ¨é€ä»£ç 1234567891011121314151617181920212223242526272829303132// åˆå§‹åŒ–ç¯å¢ƒ$url = &#x27;https://fcm.googleapis.com/fcm/send&#x27;;$ch = curl_init($url);curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);curl_setopt($ch, CURLOPT_POST, 1);$header = array( &#x27;Content-Type: application/json&#x27;, &#x27;Authorization: key=AIzaSyCm5Vufc1FAtWE1kupGhVDRb0ThkCoWC7d&#x27; // è¿™é‡Œæ˜¯åˆšæ‰çš„KEY);curl_setopt($ch, CURLOPT_HTTPHEADER, $header);// æ„å»ºæ¶ˆæ¯ä½“,jsonç¼–ç $content = json_encode([&#x27;notification&#x27;=&gt;[ &#x27;title&#x27; =&gt; &#x27;è¿™é‡Œæ˜¯æ ‡é¢˜&#x27;, &#x27;body&#x27; =&gt; &#x27;è¿™é‡Œæ˜¯å†…å®¹&#x27;, &#x27;icon&#x27; =&gt; &#x27;è¿™é‡Œæ˜¯åå°è®¾ç½®çš„iconName&#x27;],&#x27;to&#x27;=&gt;&#x27;è®¾å¤‡æ ‡è¯†(Google SDKå¯ä»¥è·å–)&#x27;,&#x27;registration_ids&#x27;=&gt;[&#x27;è®¾å¤‡æ ‡è¯†&#x27;,&#x27;è®¾å¤‡æ ‡è¯†&#x27;] // å¦‚æœè¦æ¨é€å¤šå°è®¾å¤‡,å¯ä»¥ä½¿ç”¨æ­¤å­—æ®µ,æœ€å¤šæ”¯æŒ1000å°è®¾å¤‡]);curl_setopt($ch, CURLOPT_POSTFIELDS, $content);$ret = json_decode(curl_exec($ch), true);$ret[&#x27;success&#x27;]; // æ¨é€æˆåŠŸæ•°$ret[&#x27;failure&#x27;]; // æ¨é€å¤±è´¥æ•° 3.è¿”å›å€¼ç¤ºä¾‹1234567891011121314151617&#123; &quot;multicast_id&quot;: 7669649331143639654, &quot;success&quot;: 3, &quot;failure&quot;: 0, &quot;canonical_ids&quot;: 0, &quot;results&quot;: [ &#123; &quot;message_id&quot;: &quot;0:1488360060090224%6490a2d16490a2d1&quot; &#125;, &#123; &quot;message_id&quot;: &quot;0:1488360060095871%6490a2d16490a2d1&quot; &#125;, &#123; &quot;message_id&quot;: &quot;0:1488360060090765%6490a2d16490a2d1&quot; &#125; ]&#125; 4.Google(FCM) æ–‡æ¡£ https://firebase.google.com/docs","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"google fcm","slug":"google-fcm","permalink":"http://xupin.im/tags/google-fcm/"}]},{"title":"PHPå­¦ä¹ ç¬”è®° - Apple APNS","date":"2017-02-21T16:00:00.000Z","path":"2017/02/22/apple-msg-push/","text":"1.åˆæˆè¯ä¹¦(éœ€è¦ä¸¤ä¸ªæ–‡ä»¶*.cer,*.p12,è‹¹æœå¼€å‘è€…åå°è·å–) ios.cer,ios.p12 &#x2F;&#x2F; æˆ‘è¿™é‡Œçš„æ–‡ä»¶å 123456$ openssl x509 -in ios.cer -inform der -out ios_cer.pem$ openssl pkcs12 -nocerts -out ios_p12.pem -in ios.p12Enter Import Password: // è¿™é‡Œè¾“å…¥Appleåå°æ–‡ä»¶å¯¼å‡ºæ—¶çš„å¯†ç MAC verified OKEnter PEM pass phrase: // è¿™é‡Œè¾“å…¥æ–°çš„pemå¯†ç (ç”¨äºä»£ç ä¸­),æˆ‘è¾“å…¥çš„æ˜¯123456789$ cat ios_cer.pem ios_p12.pem &gt; key.pem 2.PHP æ¨é€ä»£ç 12345678910111213141516171819202122232425// åˆå§‹åŒ–ç¯å¢ƒ$ctx = stream_context_create();stream_context_set_option($ctx, &#x27;ssl&#x27;, &#x27;local_cert&#x27;, &#x27;assets/key/key.pem&#x27;); // keyæ–‡ä»¶çš„è·¯å¾„stream_context_set_option($ctx, &#x27;ssl&#x27;, &#x27;passphrase&#x27;, &#x27;123456789&#x27;); // ç”Ÿæˆpemè¾“å…¥çš„å¯†ç // å»ºç«‹APNSè¿æ¥$fp = stream_socket_client( &#x27;ssl://gateway.push.apple.com:2195&#x27;, $err, $errstr, 60, STREAM_CLIENT_CONNECT|STREAM_CLIENT_PERSISTENT, $ctx);// æ„å»ºæ¶ˆæ¯ä½“,jsonç¼–ç $payload = json_encode( array( &#x27;aps&#x27;=&gt;array(&#x27;alert&#x27; =&gt; &#x27;è¿™é‡Œæ˜¯å†…å®¹&#x27;, &#x27;sound&#x27; =&gt; &#x27;è¿™é‡Œæ˜¯æç¤ºå£°éŸ³&#x27;)));// è½¬æ¢äºŒè¿›åˆ¶$msg = chr(0) . pack(&#x27;n&#x27;, 32) . pack(&#x27;H*&#x27;, &#x27;è®¾å¤‡æ ‡è¯†(Apple SDKå¯ä»¥è·å–)&#x27;) . pack(&#x27;n&#x27;, strlen($payload)) . $payload;// å‘é€æ¶ˆæ¯$result = fwrite($fp, $msg, strlen($msg));if(!$result)&#123; // æ¨é€å¤±è´¥&#125;else&#123; // æ¨é€æˆåŠŸ&#125;fclose($fp); 3.APNS æ–‡æ¡£ https://developer.apple.com/notifications/","tags":[{"name":"develop","slug":"develop","permalink":"http://xupin.im/tags/develop/"},{"name":"apns","slug":"apns","permalink":"http://xupin.im/tags/apns/"}]}]